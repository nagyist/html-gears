(function(a,b){"function"===typeof define&&define.amd?define(["exports"],b):"object"===typeof exports?b(exports):b(a)})(this,function(a){if(!a.Promise){var b=function(a){this._state=0;this._timeout=this._value=null;this._cb={fulfilled:[],rejected:[]};this._thenPromises=[];a&&this._invokeResolver(a)};b.resolve=function(a){return new this(function(b,f){b(a)})};b.reject=function(a){return new this(function(b,f){f(a)})};b.all=b.when=function(a){return new this(function(b,f){var g=0,h=[];a.forEach(function(a,
c){g++;a.then(function(a){h[c]=a;g--;g||b(h)},function(a){g=1/0;f(a)})})})};b.race=function(a){return new this(function(b,f){a.forEach(function(a){a.then(b,f)})})};b.prototype.then=function(a,e){this._cb.fulfilled.push(a);this._cb.rejected.push(e);var f=new b;this._thenPromises.push(f);0<this._state&&this._schedule();return f};b.prototype.fulfill=function(a){if(0!==this._state)return this;this._state=1;this._value=a;this._thenPromises.length&&this._schedule();return this};b.prototype.reject=function(a){if(0!==
this._state)return this;this._state=2;this._value=a;this._thenPromises.length&&this._schedule();return this};b.prototype.resolve=function(a){if(a===this)this.reject(new TypeError("Promise resolved by its own instance"));else if(a instanceof this.constructor)a.chain(this);else{var b;if(null===a||"undefined"===typeof a||"object"!==typeof a&&"function"!==typeof a)this.fulfill(a);else{try{b=a.then}catch(k){this.reject(k);return}if("function"===typeof b){var f=!1,g=function(a){f||(f=!0,this.resolve(a))},
h=function(a){f||(f=!0,this.reject(a))};try{b.call(a,g.bind(this),h.bind(this))}catch(k){f||this.reject(k)}}else this.fulfill(a)}}};b.prototype.chain=function(a){return this.then(function(b){a.resolve(b)},function(b){a.reject(b)})};b.prototype["catch"]=function(a){return this.then(null,a)};b.prototype._schedule=function(){this._timeout||(this._timeout=setTimeout(this._processQueue.bind(this),0))};b.prototype._processQueue=function(){for(this._timeout=null;this._thenPromises.length;){var a=this._cb.fulfilled.shift(),
b=this._cb.rejected.shift();this._executeCallback(1===this._state?a:b)}};b.prototype._executeCallback=function(a){var b=this._thenPromises.shift();if("function"!==typeof a)1===this._state?b.fulfill(this._value):b.reject(this._value);else try{var f=a(this._value);b.resolve(f)}catch(g){b.reject(g)}};b.prototype._invokeResolver=function(a){try{a(this.resolve.bind(this),this.reject.bind(this))}catch(b){this.reject(b)}};a.Promise=b}});/*
 CC0-1.0
*/
window.requestAnimationFrame||(window.requestAnimationFrame=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.requestAnimationFrame||(window.requestAnimationFrame=function(a){window.setTimeout(function(){a(window.performance.now())},17)}));window.performance||(window.performance={});window.performance.now||(window.performance.now=function(){return 1E3*(new Date).getTime()-window.performance._startTime},window.performance._startTime=1E3*(new Date).getTime());
var H3DU={renderLoop:function(a){a(window.performance.now());var b=function(c){window.requestAnimationFrame(b);a(c)};window.requestAnimationFrame(b)},createCanvasElement:function(a,b,c){var e=document.createElement("canvas");a&&a.appendChild(e);if(null===b||"undefined"===typeof b)e.width=Math.ceil(e.clientWidth)+"";else{if(0>b)throw Error("width negative");e.width=Math.ceil(b)+""}if(null===c||"undefined"===typeof c)e.height=Math.ceil(e.clientHeight)+"";else{if(0>c)throw Error("height negative");e.height=
Math.ceil(c)+""}return e},get3DOr2DContext:function(a){if(!a||!a.getContext)return null;var b=null,c={preserveDrawingBuffer:!0,alpha:!1};c.antialias=window.devicePixelRatio&&1<window.devicePixelRatio?!1:!0;try{b=a.getContext("webgl",c)}catch(e){b=null}if(!b)try{b=a.getContext("experimental-webgl",c)}catch(e){b=null}if(!b)try{b=a.getContext("moz-webgl",c)}catch(e){b=null}if(!b)try{b=a.getContext("webkit-3d",c)}catch(e){b=null}if(!b)try{b=a.getContext("2d",c)}catch(e){b=null}H3DU.is3DContext(b)&&(b.getExtension("OES_element_index_uint"),
b.getExtension("OES_standard_derivatives"));return b},get3DContext:function(a,b){var c=H3DU.get3DOr2DContext(a),e=null;!c&&window.WebGLShader?e="Failed to initialize graphics support required by this page.":window.WebGLShader&&!H3DU.is3DContext(c)?e="This page requires WebGL, but it failed to start. Your computer might not support WebGL.":c&&H3DU.is3DContext(c)||(e="This page requires a WebGL-supporting browser.");return e?((b||window.alert)(e),null):c},is3DContext:function(a){return a&&"compileShader"in
a},getPromiseResultsAll:function(a,b,c){return H3DU.getPromiseResults(a,b,c).then(function(a){return 0<a.failures.length?Promise.reject(a):Promise.resolve(a.successes)})},getPromiseResults:function(a,b,c){function e(a,b,c){return function(e){a&&a(e);b.successes[c]=e;return!0}}function f(a,b,c){return function(e){a&&a(e);b.failures[c]=e;return!0}}if(!a||0===a.length)return Promise.resolve({successes:[],failures:[],results:[]});for(var g={successes:[],failures:[],results:[]},h=[],k=0;k<a.length;k++){var l=
k;h.push(a[k].then(e(b,g,l),f(c,g,l)))}return Promise.all(h).then(function(a){for(var b=0;b<g.successes.length;b++)"undefined"===typeof g.successes[b]&&(g.successes.splice(b,1),--b);for(b=0;b<g.failures.length;b++)"undefined"===typeof g.failures[b]&&(g.failures.splice(b,1),--b);g.results=a;return Promise.resolve(g)})},loadFileFromUrl:function(a,b){var c=b||"text";return new Promise(function(b,f){var g=new XMLHttpRequest;g.onreadystatechange=function(g){g=g.target;if(4===g.readyState)if(200<=g.status&&
300>g.status){var k="",k="xml"===c?g.responseXML:"json"===c?"response"in g?g.response:JSON.parse(g.responseText):"arraybuffer"===c?g.response:g.responseText+"";b({url:a,data:k})}else f({url:a})};g.onerror=function(b){f({url:a,error:b})};g.open("get",a,!0);g.responseType=c;g.send()})},getTimePosition:function(a,b,c){if("undefined"===typeof a.time||null===a.time)return a.time=b,a.lastTime=b,0;if("undefined"===typeof a.lastTime||null===a.lastTime)a.lastTime=b;return 1*(b-a.time)%c/c},newFrames:function(a,
b){if("undefined"===typeof a.time||null===a.time)return a.time=b,a.lastTime=b,0;if("undefined"===typeof a.lastTime||null===a.lastTime)return a.lastTime=b,0;var c=b-a.lastTime;a.lastTime=b;return 60*c/1E3}};
(function(a){var b=function(a){var b=1*a[0],c=1*a[1],e=1*a[2],c=0>c?0:255<c?255:c,e=0>e?0:255<e?255:e;if(0===e)return[c,c,c];a=0;a=127.5>=c?c*(255+e)/255:c+e-c*e/255;var f=2*c-a;if(0>b||360<=b)b=(b%360+360)%360;var g=b+120;360<=g&&(g-=360);c=60>g?f+(a-f)*g/60:180>g?a:240>g?f+(a-f)*(240-g)/60:f;g=b;e=60>g?f+(a-f)*g/60:180>g?a:240>g?f+(a-f)*(240-g)/60:f;g=b-120;0>g&&(g+=360);b=60>g?f+(a-f)*g/60:180>g?a:240>g?f+(a-f)*(240-g)/60:f;return[0>c?0:255<c?255:c,0>e?0:255<e?255:e,0>b?0:255<b?255:b]},c=function(a){function e(a){var b;
return 255*(0>(b=parseFloat(a))?0:100<b?100:b)/100}function l(a){var b;return 255*(0>(b=parseFloat(a))?0:1<b?1:b)}function n(a){var b;return 0>(b=parseInt(a,10))?0:255<b?255:b}function p(a){a=parseFloat(m[1]);if(0>a||360<=a)a=(a%360+360)%360;return a}var m=null;if(!a)return null;var q;if(null!==(m=/^#([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})$/.exec(a)))return[parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16),255];if(null!==(m=/^#([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})$/.exec(a)))return[parseInt(m[1],
16),parseInt(m[2],16),parseInt(m[3],16),parseInt(m[4],16)];if(null!==(m=/^rgb\(\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*\)$/.exec(a)))return[e(m[1]),e(m[2]),e(m[3]),255];if(null!==(m=/^rgb\(\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*\)$/.exec(a)))return[n(m[1]),n(m[2]),n(m[3]),255];if(null!==(m=/^rgba\(\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(a)))return[e(m[1]),
e(m[2]),e(m[3]),l(m[4])];if(null!==(m=/^rgba\(\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(a)))return[n(m[1]),n(m[2]),n(m[3]),l(m[4])];if(null!==(m=/^#([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})$/.exec(a))){var r=parseInt(m[1],16);a=parseInt(m[2],16);q=parseInt(m[3],16);return[r+(r<<4),a+(a<<4),q+(q<<4),255]}if(null!==(m=/^#([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})$/.exec(a)))return r=parseInt(m[1],16),a=parseInt(m[2],16),
q=parseInt(m[3],16),d=parseInt(m[4],16),[r+(r<<4),a+(a<<4),q+(q<<4),d+(d<<4)];if(null!==(m=/^hsl\(\s*([\+\-]?\d+(?:\.\d+)?)\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*\)$/.exec(a)))return a=b([p(m[1]),e(m[3]),e(m[2])]),[a[0],a[1],a[2],255];if(null!==(m=/^hsla\(\s*([\+\-]?\d+(?:\.\d+)?)\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(a)))return a=b([p(m[1]),e(m[3]),e(m[2])]),[a[0],a[1],a[2],l(m[4])];g();a=a.toLowerCase();0<=a.indexOf("grey")&&
(a=a.replace("grey","gray"));q=f[a];return"string"===typeof q?c(q):"transparent"===a?[0,0,0,0]:null},e=function(a){a[0]=0>a[0]?0:Math.min(a[0],1);a[1]=0>a[1]?0:Math.min(a[1],1);a[2]=0>a[2]?0:Math.min(a[2],1);a[3]=0>a[3]?0:Math.min(a[3],1);return a};a.toGLColor=function(a,b,f,g){return null===a||"undefined"===typeof a?[0,0,0,0]:"string"===typeof a?(a=c(a)||[0,0,0,0],b=1/255,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,e(a)):"number"===typeof a&&"number"===typeof b&&"number"===typeof f?[a,b,f,"number"!==typeof g?
1:g]:a.constructor===Array?e([a[0]||0,a[1]||0,a[2]||0,"number"!==typeof a[3]?1:a[3]]):e(a||[0,0,0,0])};var f=null,g=function(){if(!f){var a="aliceblue f0f8ff antiquewhite faebd7 aqua 00ffff aquamarine 7fffd4 azure f0ffff beige f5f5dc bisque ffe4c4 black 000000 blanchedalmond ffebcd blue 0000ff blueviolet 8a2be2 brown a52a2a burlywood deb887 cadetblue 5f9ea0 chartreuse 7fff00 chocolate d2691e coral ff7f50 cornflowerblue 6495ed cornsilk fff8dc crimson dc143c cyan 00ffff darkblue 00008b darkcyan 008b8b darkgoldenrod b8860b darkgray a9a9a9 darkgreen 006400 darkkhaki bdb76b darkmagenta 8b008b darkolivegreen 556b2f darkorange ff8c00 darkorchid 9932cc darkred 8b0000 darksalmon e9967a darkseagreen 8fbc8f darkslateblue 483d8b darkslategray 2f4f4f darkturquoise 00ced1 darkviolet 9400d3 deeppink ff1493 deepskyblue 00bfff dimgray 696969 dodgerblue 1e90ff firebrick b22222 floralwhite fffaf0 forestgreen 228b22 fuchsia ff00ff gainsboro dcdcdc ghostwhite f8f8ff gold ffd700 goldenrod daa520 gray 808080 green 008000 greenyellow adff2f honeydew f0fff0 hotpink ff69b4 indianred cd5c5c indigo 4b0082 ivory fffff0 khaki f0e68c lavender e6e6fa lavenderblush fff0f5 lawngreen 7cfc00 lemonchiffon fffacd lightblue add8e6 lightcoral f08080 lightcyan e0ffff lightgoldenrodyellow fafad2 lightgray d3d3d3 lightgreen 90ee90 lightpink ffb6c1 lightsalmon ffa07a lightseagreen 20b2aa lightskyblue 87cefa lightslategray 778899 lightsteelblue b0c4de lightyellow ffffe0 lime 00ff00 limegreen 32cd32 linen faf0e6 magenta ff00ff maroon 800000 mediumaquamarine 66cdaa mediumblue 0000cd mediumorchid ba55d3 mediumpurple 9370d8 mediumseagreen 3cb371 mediumslateblue 7b68ee mediumspringgreen 00fa9a mediumturquoise 48d1cc mediumvioletred c71585 midnightblue 191970 mintcream f5fffa mistyrose ffe4e1 moccasin ffe4b5 navajowhite ffdead navy 000080 oldlace fdf5e6 olive 808000 olivedrab 6b8e23 orange ffa500 orangered ff4500 orchid da70d6 palegoldenrod eee8aa palegreen 98fb98 paleturquoise afeeee palevioletred d87093 papayawhip ffefd5 peachpuff ffdab9 peru cd853f pink ffc0cb plum dda0dd powderblue b0e0e6 purple 800080 rebeccapurple 663399 red ff0000 rosybrown bc8f8f royalblue 4169e1 saddlebrown 8b4513 salmon fa8072 sandybrown f4a460 seagreen 2e8b57 seashell fff5ee sienna a0522d silver c0c0c0 skyblue 87ceeb slateblue 6a5acd slategray 708090 snow fffafa springgreen 00ff7f steelblue 4682b4 tan d2b48c teal 008080 thistle d8bfd8 tomato ff6347 turquoise 40e0d0 violet ee82ee wheat f5deb3 white ffffff whitesmoke f5f5f5 yellow ffff00 yellowgreen 9acd32".split(" ");
f={};for(var b=0;b<a.length;b+=2)f[a[b]]="#"+a[b+1]}}})(H3DU);H3DU._toContext=function(a){return a&&a.getContext?a.getContext():a};H3DU._isPowerOfTwo=function(a){if(Math.floor(a)!==a||0>=a)return!1;for(;1<a&&0===(a&1);)a>>=1;return 1===a};H3DU._isIdentityExceptTranslate=function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&1===a[15]};H3DU.Transform=function(){this.scale=[1,1,1];this.position=[0,0,0];this.rotation=H3DU.Math.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;this.matrix=H3DU.Math.mat4identity()};H3DU.Transform.prototype.getScale=function(){return this.complexMatrix?[this.matrix[0],this.matrix[5],this.matrix[10]]:this.scale.slice(0,3)};H3DU.Transform.prototype.getPosition=function(){return this.complexMatrix?[this.matrix[12],this.matrix[13],this.matrix[14]]:this.position.slice(0,3)};
H3DU.Transform.prototype.getQuaternion=function(){return this.complexMatrix?H3DU.Math.quatNormInPlace(H3DU.Math.quatFromMat4(this.matrix)):this.rotation.slice(0,4)};H3DU.Transform.prototype.reset=function(){this.matrix=H3DU.Math.mat4identity();this.position=[0,0,0];this.scale=[1,1,1];this.rotation=H3DU.Math.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;return this};
H3DU.Transform.prototype.setMatrix=function(a){this._matrixDirty=!1;this.complexMatrix=!0;this.matrix=a.slice(0,16);this.position=[this.matrix[12],this.matrix[13],this.matrix[14]];this.rotation=H3DU.Math.quatFromMat4(this.matrix);this.rotation=H3DU.Math.quatNormInPlace(this.rotation);this.scale=[this.matrix[0],this.matrix[5],this.matrix[10]];this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&
0===a[14]&&1===a[15];return this};H3DU.Transform.prototype.isIdentity=function(){if(this._matrixDirty)if(this.complexMatrix)this.getMatrix();else return 0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]&&H3DU.Math.quatIsIdentity(this.rotation);return this._isIdentity};H3DU.Transform.prototype.resetTransform=function(){return this.reset()};
H3DU.Transform.prototype.setScale=function(a,b,c){if(this.complexMatrix)return this;this.scale=null===a||"undefined"===typeof a||null!==b&&"undefined"!==typeof b||null!==c&&"undefined"!==typeof c?[a,b,c]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];this._matrixDirty=!0;return this};
H3DU.Transform.prototype.setPosition=function(a,b,c){if(this.complexMatrix)return this;this.position=null===a||"undefined"===typeof a||null!==b&&"undefined"!==typeof b||null!==c&&"undefined"!==typeof c?[a,b,c]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];this._matrixDirty=!0;return this};
H3DU.Transform.prototype.movePosition=function(a,b,c){if(this.complexMatrix)return this;null===a||"undefined"===typeof a||null!==b&&"undefined"!==typeof b||null!==c&&"undefined"!==typeof c?(this.position[0]+=a,this.position[1]+=b,this.position[2]+=c):"number"!==typeof a?(this.position[0]+=a[0],this.position[1]+=a[1],this.position[2]+=a[2]):(this.position[0]+=a,this.position[1]+=a,this.position[2]+=a);this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];
this._matrixDirty=!0;return this};H3DU.Transform.prototype.setQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=a.slice(0,4);H3DU.Math.quatNormInPlace(this.rotation);this._matrixDirty=!0;return this};H3DU.Transform.prototype.setOrientation=function(a,b,c,e){return this.setQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,e))};
H3DU.Transform.prototype.multQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=H3DU.Math.quatNormInPlace(H3DU.Math.quatMultiply(this.rotation,a));this._matrixDirty=!0;return this};H3DU.Transform.prototype.multOrientation=function(a,b,c,e){return this.multQuaternion(H3DU.Math.quatFromAxisAngle(a,b,c,e))};
H3DU.Transform.prototype.getMatrix=function(){if(this._matrixDirty)if(this._matrixDirty=!1,H3DU.Math.quatIsIdentity(this.rotation))this.matrix=[this.scale[0],0,0,0,0,this.scale[1],0,0,0,0,this.scale[2],0,this.position[0],this.position[1],this.position[2],1],this._isIdentity=0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];else{this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,this.position[0],this.position[1],this.position[2],1];this.matrix=
H3DU.Math.mat4multiply(this.matrix,H3DU.Math.quatToMat4(this.rotation));H3DU.Math.mat4scaleInPlace(this.matrix,this.scale);var a=this.matrix;this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]}else if(this._isIdentity)return H3DU.Math.mat4identity();return this.matrix.slice(0,16)};
H3DU.Transform.prototype.copy=function(){var a=new H3DU.Transform;a.scale=this.scale.slice(0,this.scale.length);a.position=this.position.slice(0,this.scale.length);a.complexMatrix=this.complexMatrix;a._matrixDirty=this._matrixDirty;a.matrix=this.matrix.slice(0,this.matrix.length);return a};H3DU.ShaderInfo=function(a,b){if(null===a||"undefined"===typeof a)a=H3DU.ShaderProgram.getDefaultVertex();if(null===b||"undefined"===typeof b)b=H3DU.ShaderProgram.getDefaultFragment();this.vertexShader=a;this.fragmentShader=b;this.uniformValues={}};H3DU.ShaderInfo.prototype.copy=function(){var a=new H3DU.ShaderInfo(this.vertexShader,this.fragmentShader);a.setUniforms(this.uniformValues);return a};
H3DU.ShaderInfo.prototype.setUniforms=function(a){H3DU.ShaderInfo._setUniformsInternal(a,this.uniformValues,null);return this};
H3DU.ShaderInfo._setUniformInternal=function(a,b,c,e){isCurrentProgram=null;a=a[c];var f=b[c];if("number"===typeof a){var g=!1;null===f||"undefined"===typeof f?(b[c]=f=a,g=!0):f!==a&&(f=a,b[c]=a,g=!0);g&&e&&(e[c]=f)}else if(3===a.length)if(!f)b[c]=a.slice(0,a.length),e&&(e[c]=a.slice(0,a.length));else{if(f[0]!==a[0]||f[1]!==a[1]||f[2]!==a[2])f[0]=a[0],f[1]=a[1],f[2]=a[2],e&&(e[c]=f.slice(0,f.length))}else if(2===a.length)if(!f)b[c]=a.slice(0,a.length),e&&(e[c]=a.slice(0,a.length));else{if(f[0]!==
a[0]||f[1]!==a[1])f[0]=a[0],f[1]=a[1],e&&(e[c]=f.slice(0,f.length))}else if(4===a.length)if(!f)b[c]=a.slice(0,a.length),e&&(e[c]=a.slice(0,a.length));else{if(f[0]!==a[0]||f[1]!==a[1]||f[2]!==a[2]||f[3]!==a[3])f[0]=a[0],f[1]=a[1],f[2]=a[2],f[3]=a[3],e&&(e[c]=f.slice(0,f.length))}else 16===a.length?f?H3DU.ShaderInfo._copyIfDifferent(a,f,16)&&e&&(e[c]=f.slice(0,f.length)):(b[c]=a.slice(0,a.length),e&&(e[c]=a.slice(0,a.length))):9===a.length&&(f?H3DU.ShaderInfo._copyIfDifferent(a,f,9)&&e&&(e[c]=f.slice(0,
f.length)):(b[c]=a.slice(0,a.length),e&&(e[c]=a.slice(0,a.length))))};H3DU.ShaderInfo._setUniformsInternal=function(a,b,c){var e;if("undefined"!==typeof Object.keys)for(var f=Object.keys(a),g=0;g<f.length;g++)e=f[g],H3DU.ShaderInfo._setUniformInternal(a,b,e,c);else for(e in a)H3DU.ShaderInfo._setUniformInternal(a,b,e,c)};H3DU.ShaderProgram=function(a,b,c){this._init(a,new H3DU.ShaderInfo(b,c))};H3DU.ShaderProgram._fromShaderInfo=function(a,b){var c=new H3DU.ShaderProgram(null);c._init(a,b);return c};
H3DU.ShaderProgram.prototype._init=function(a,b){if(a&&(a=a.getContext?a.getContext():a,this.shaderInfo=b,this.context=a,this.prog=H3DU.ShaderProgram._compileShaders(a,b.vertexShader,b.fragmentShader),this.uniformValues={},this.actives={},this.attributes=[],this.uniformTypes={},this.savedUniforms={},this.attributeNames=[],H3DU.ShaderInfo._setUniformsInternal(this.shaderInfo.uniformValues,this.uniformValues,this.savedUniforms),this.CURRENT_PROGRAM=35725,this.FLOAT=5126,"undefined"!==typeof this.prog&&
null!==this.prog)){for(var c=null,e={},f=a.getProgramParameter(this.prog,a.ACTIVE_ATTRIBUTES),g=0;g<f;++g)if(c=a.getActiveAttrib(this.prog,g),null!==c&&"undefined"!==typeof c){var c=c.name,h=a.getAttribLocation(this.prog,c);0<=h&&(this.attributes.push(h),e[c]=h,this.attributeNames.push([c,h]))}f=a.getProgramParameter(this.prog,a.ACTIVE_UNIFORMS);for(g=0;g<f;++g)h=this.context.getActiveUniform(this.prog,g),null!==h&&"undefined"!==typeof h&&(c=h.name,e[c]=this.context.getUniformLocation(this.prog,c),
this.uniformTypes[c]=h.type);this.actives=e}};H3DU.ShaderProgram.prototype._disableOthers=function(a){for(var b={},c=0;c<a.length;c++)b[a[c][0]]=!0;for(c=0;c<this.attributeNames.length;c++)a=this.attributeNames[c],b[a[0]]||this.context.disableVertexAttribArray(a[1])};H3DU.ShaderProgram.prototype.dispose=function(){this.program&&this.context.deleteProgram(this.program);this.program=this.context=null;this.actives={};this.attributes={};this.uniformTypes={}};H3DU.ShaderProgram.prototype.getContext=function(){return this.context};
H3DU.ShaderProgram.prototype._setUniformInternal=function(a,b){var c=this.get(b);if(null!==c&&"undefined"!==typeof c){var e=a[b];"number"===typeof e?this.uniformTypes[b]===this.FLOAT?this.context.uniform1f(c,e):this.context.uniform1i(c,e):3===e.length?this.context.uniform3fv(c,e):2===e.length?this.context.uniform2fv(c,e):4===e.length?this.context.uniform4fv(c,e):16===e.length?this.context.uniformMatrix4fv(c,!1,e):9===e.length&&this.context.uniformMatrix3fv(c,!1,e)}};
H3DU.ShaderProgram.prototype.get=function(a){a=this.actives[a];return null===a||"undefined"===typeof a?null:a};H3DU.ShaderProgram.prototype.getUniform=function(a){var b="string"===typeof a?this.get(a):a;if(null===b||"number"===typeof b)return null;a=this.uniformValues[a];return null===a||"undefined"===typeof a?this.context.getUniform(this.program,b):a instanceof Array?a.slice(0,a.length):a};
H3DU.ShaderProgram.prototype._setSavedUniforms=function(){var a,b=0;if("undefined"!==typeof Object.keys)for(var c=Object.keys(this.savedUniforms),b=c.length,e=0;e<b;e++)a=c[e],this._setUniformInternal(this.savedUniforms,a);else for(a in this.savedUniforms)this._setUniformInternal(this.savedUniforms,a),b++;return b};H3DU.ShaderProgram.prototype.use=function(){this.context.useProgram(this.prog);0<this._setSavedUniforms()&&(this.savedUniforms={});return this};
H3DU.ShaderProgram.prototype._update=function(){H3DU.ShaderInfo._setUniformsInternal(this.shaderInfo.uniformValues,this.uniformValues,this.savedUniforms);return this};H3DU.ShaderProgram.prototype.setUniforms=function(a){H3DU.ShaderInfo._setUniformsInternal(a,this.uniformValues,this.savedUniforms);this.context.getParameter(this.CURRENT_PROGRAM)===this.prog&&0<this._setSavedUniforms()&&(this.savedUniforms={});return this};
H3DU.ShaderInfo._copyIfDifferent=function(a,b,c){for(var e=0;e<c;e++)if(a[e]!==b[e]){b[e]=a[e];for(e+=1;e<c;e++)b[e]=a[e];return!0}return!1};
H3DU.ShaderProgram._compileShaders=function(a,b,c){function e(a,b,c){var e=a.createShader(b);a.shaderSource(e,c);a.compileShader(e);if(!a.getShaderParameter(e,a.COMPILE_STATUS)){c=c.split("\n");for(var f=0;f<c.length;f++)c[f]="/* "+(f+1)+" */   "+c[f];console.log(c.join("\n"));console.log((b===a.VERTEX_SHADER?"vertex: ":"fragment: ")+a.getShaderInfoLog(e));return null}return e}b=b&&0!==b.length?e(a,a.VERTEX_SHADER,b):null;c=c&&0!==c.length?e(a,a.FRAGMENT_SHADER,c):null;var f=null;null!==b&&"undefined"!==
typeof b&&null!==c&&"undefined"!==typeof c&&(f=a.createProgram(),a.attachShader(f,b),a.attachShader(f,c),a.linkProgram(f),a.getProgramParameter(f,a.LINK_STATUS)||(console.log("link: "+a.getProgramInfoLog(f)),a.deleteProgram(f),f=null),a.detachShader(f,b),a.detachShader(f,c));null!==b&&"undefined"!==typeof b&&a.deleteShader(b);null!==c&&"undefined"!==typeof c&&a.deleteShader(c);return f};H3DU.ShaderProgram.fragmentShaderHeader=function(){return"#ifdef GL_ES\n#ifndef GL_FRAGMENT_PRECISION_HIGH\nprecision mediump float;\n#else\nprecision highp float;\n#endif\n#endif\n"};
H3DU.ShaderProgram.makeEffectFragment=function(a){var b=H3DU.ShaderProgram.fragmentShaderHeader(),b=b+"uniform sampler2D sampler;\nuniform vec2 textureSize;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n"+a;return b+="\n\nvoid main(){\n // normalize coordinates to 0..1\n vec2 uv=gl_FragCoord.xy/textureSize.xy;\n gl_FragColor=textureEffect(sampler,uv,textureSize);\n}"};
H3DU.ShaderProgram.makeCopyEffect=function(){var a=H3DU.ShaderProgram.fragmentShaderHeader(),a=a+"uniform sampler2D sampler;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n\n\nvoid main(){\n gl_FragColor=texture2D(sampler,uvVar);\n}";return new H3DU.ShaderInfo(H3DU.ShaderProgram.getBasicVertex(),a)};H3DU.ShaderProgram.makeEffect=function(a,b){return new H3DU.ShaderInfo(H3DU.ShaderProgram.getBasicVertex(),H3DU.ShaderProgram.makeEffectFragment(b))};
H3DU.ShaderProgram.getInvertEffect=function(){return H3DU.ShaderProgram.makeEffect(null,"vec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize){\n vec4 color=texture2D(sampler,uvCoord);\n vec4 ret; ret.xyz=vec3(1.0,1.0,1.0)-color.xyz; ret.w=color.w; return ret;\n}")};H3DU.ShaderProgram.getEdgeDetectEffect=function(){return H3DU.ShaderProgram.makeEffect(null,"float luma(vec3 color) {\n return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;\n}\nconst vec4 edge_color=vec4(0.,0,0,1);\nconst vec4 back_color=vec4(1.,1,1,1);\nvec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize){\nfloat dx = 1.0 / float(textureSize.x);\nfloat dy = 1.0 / float(textureSize.y);\nfloat s00 = luma(texture2D(sampler, uvCoord + vec2(-dx,dy)).rgb);\nfloat s10 = luma(texture2D(sampler, uvCoord + vec2(-dx,0.0)).rgb);\nfloat s20 = luma(texture2D(sampler, uvCoord + vec2(-dx,-dy)).rgb);\nfloat s01 = luma(texture2D(sampler, uvCoord + vec2(0.0,dy)).rgb);\nfloat s21 = luma(texture2D(sampler, uvCoord + vec2(0.0,-dy)).rgb);\nfloat s02 = luma(texture2D(sampler, uvCoord + vec2(dx, dy)).rgb);\nfloat s12 = luma(texture2D(sampler, uvCoord + vec2(dx, 0.0)).rgb);\nfloat s22 = luma(texture2D(sampler, uvCoord + vec2(dx, -dy)).rgb);\nfloat sx = s00 + 2.0 * s10 + s20 - (s02 + 2.0 * s12 + s22);\nfloat sy = s00 + 2.0 * s01 + s02 - (s20 + 2.0 * s21 + s22);\nfloat dist = sx * sx + sy * sy;\nif(dist > 0.4) {\nreturn edge_color;\n} else {\nreturn back_color;\n}}")};
H3DU.ShaderProgram.getBasicVertex=function(){};H3DU.ShaderProgram.getDefaultVertex=function(){return"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\n#ifdef COLORATTR\nattribute vec3 colorAttr;\nvarying vec3 colorAttrVar;\n#endif\nattribute vec3 tangent;\nattribute vec3 bitangent;\nuniform mat4 projection;\nuniform mat4 modelViewMatrix;\n#ifdef SHADING\nuniform mat3 normalMatrix; /* internal */\n#ifdef NORMAL_MAP\nuniform mat4 world;\nvarying mat3 tbnMatrixVar;\n#endif\nvarying vec4 viewPositionVar;\nvarying vec3 transformedNormalVar;\n#endif\nvarying vec2 uvVar;\nvoid main(){\nvec4 positionVec4;\npositionVec4.w=1.0;\npositionVec4.xyz=position;\ngl_PointSize=1.0;\ngl_Position=(projection*modelViewMatrix)*positionVec4;\n#ifdef COLORATTR\ncolorAttrVar=colorAttr;\n#endif\nuvVar=uv;\n#ifdef SHADING\ntransformedNormalVar=normalize(normalMatrix*normal);\n#ifdef NORMAL_MAP\ntbnMatrixVar=mat3(normalize(vec3(world*vec4(tangent,0.0))),\n   normalize(bitangent),transformedNormalVar);\n#endif\nviewPositionVar=modelViewMatrix*positionVec4;\n#endif\n}"};
H3DU.ShaderProgram.getDefaultFragment=function(){var a,b=H3DU.ShaderProgram.fragmentShaderHeader()+"uniform vec4 md;\n#ifdef SHADING\nstruct light {\n vec4 position; /* source light direction/position, in camera/eye space */\n vec4 diffuse; /* source light diffuse color */\n#ifdef SPECULAR\n vec4 specular; /* source light specular color */\n#endif\n vec4 radius; /* light radius */\n};\nuniform vec3 sceneAmbient;\nuniform light lights["+H3DU.Lights.MAX_LIGHTS+"];\nuniform vec3 ma;\nuniform vec3 me;\n#ifdef SPECULAR\nuniform vec3 ms;\nuniform float mshin;\n#ifdef SPECULAR_MAP\nuniform sampler2D specularMap;\n#endif\n#ifdef NORMAL_MAP\nuniform sampler2D normalMap;\n#endif\n#endif\n#endif\n#ifdef TEXTURE\nuniform sampler2D sampler;\n#endif\nvarying vec2 uvVar;\n#ifdef COLORATTR\nvarying vec3 colorAttrVar;\n#endif\n#ifdef SHADING\nvarying vec4 viewPositionVar;\nvarying vec3 transformedNormalVar;\n#ifdef NORMAL_MAP\nvarying mat3 tbnMatrixVar;\n#endif\nvec4 calcLightPower(light lt, vec4 vertexPosition){\n vec3 sdir;\n float attenuation;\n if(lt.position.w == 0.0){ /* directional light */\n  sdir=normalize((lt.position).xyz);\n  attenuation=1.0;\n } else { /* point light */\n  vec3 vertexToLight=(lt.position-vertexPosition).xyz;\n  float dsSquared=dot(vertexToLight,vertexToLight);\n  sdir=inversesqrt(dsSquared)*vertexToLight;\n  if(lt.radius.x == 0.0) {\n    attenuation=1.0; /* Unlimited extent */\n  } else {\n   float radiusPow4=lt.radius.x; /* Radius is light's radius to power of 4 */\n   float distPow4=dsSquared*dsSquared;\n   float attenDivisor=max(0.0001,dsSquared);\n   float cut=clamp(1.0-distPow4/radiusPow4,0.0,1.0);\n   attenuation=(cut*cut)/attenDivisor;\n  }\n }\n return vec4(sdir,attenuation);\n}\n#endif\nvoid main(){\n vec3 normal;\n#ifdef TEXTURE\n   vec4 baseColor=texture2D(sampler,uvVar);\n#else\n#ifdef COLORATTR\n   vec4 baseColor;\n   baseColor.w=1.0;\n   baseColor.xyz=colorAttrVar;\n#else\n   vec4 baseColor=md;\n#endif\n#endif\n#ifdef SHADING\n#ifdef NORMAL_MAP\nnormal = normalize(tbnMatrixVar*(2.0*texture2D(normalMap,uvVar).rgb - vec3(1.0)));\n#else\nnormal = normalize(transformedNormalVar);\n#endif\nvec4 lightPower["+
H3DU.Lights.MAX_LIGHTS+"];\nfloat lightCosines["+H3DU.Lights.MAX_LIGHTS+"];\n",b=b+"if(baseColor.a == 0.0)discard;\nvec3 materialAmbient=ma; /* ambient*/\nvec3 lightedColor=sceneAmbient*materialAmbient; /* ambient*/\n // diffuse\n vec3 materialDiffuse=baseColor.rgb;\n";for(a=0;a<H3DU.Lights.MAX_LIGHTS;a++)b+="lightPower["+a+"]=calcLightPower(lights["+a+"],viewPositionVar);\n",b+=" /* Lambert diffusion term */\n",b+="lightCosines["+a+"]=clamp(dot(normal,lightPower["+a+"].xyz),0.0,1.0);\n",b+="lightedColor+=lights["+
a+"].diffuse.xyz*lightCosines["+a+"]*\n",b+="   lightPower["+a+"].w*materialDiffuse;\n";b+="#ifdef SPECULAR\nbool spectmp;\nvec3 materialSpecular=ms;\n#ifdef SPECULAR_MAP\nmaterialSpecular*=texture2D(specularMap,uvVar).rgb;\n#endif\n// specular reflection\nif(materialSpecular.x!=0. || materialSpecular.y!=0. || materialSpecular.z!=0.){\nvec3 viewDirection=normalize((-viewPositionVar).xyz);\n";for(a=0;a<H3DU.Lights.MAX_LIGHTS;a++)b+="  spectmp = lightCosines["+a+"] > 0.0;\n  if (spectmp) {\n    /* Blinn-Phong specular term */\n    float specular=clamp(dot(normalize(viewDirection+lightPower["+
a+"].xyz),normal),0.0,1.0);\n    specular=pow(specular,mshin);\n    lightedColor+=materialSpecular*specular*lightPower["+a+"].w*lights["+a+"].specular.xyz;\n  }\n";b+="}\n#endif\n";return b+=" // emission\n lightedColor+=me;\n baseColor=vec4(lightedColor,baseColor.a);\n#endif\n gl_FragColor=baseColor;\n}"};H3DU.Meshes={};
H3DU.Meshes.createBox=function(a,b,c,e){a*=.5;b*=.5;c*=.5;a=[-a,-b,c,-1,0,0,1,0,-a,b,c,-1,0,0,1,1,-a,b,-c,-1,0,0,0,1,-a,-b,-c,-1,0,0,0,0,a,-b,-c,1,0,0,1,0,a,b,-c,1,0,0,1,1,a,b,c,1,0,0,0,1,a,-b,c,1,0,0,0,0,a,-b,-c,0,-1,0,1,0,a,-b,c,0,-1,0,1,1,-a,-b,c,0,-1,0,0,1,-a,-b,-c,0,-1,0,0,0,a,b,c,0,1,0,1,0,a,b,-c,0,1,0,1,1,-a,b,-c,0,1,0,0,1,-a,b,c,0,1,0,0,0,-a,-b,-c,0,0,-1,1,0,-a,b,-c,0,0,-1,1,1,a,b,-c,0,0,-1,0,1,a,-b,-c,0,0,-1,0,0,a,-b,c,0,0,1,1,0,a,b,c,0,0,1,1,1,-a,b,c,0,0,1,0,1,-a,-b,c,0,0,1,0,0];if(e)for(e=
0;e<a.length;e+=8)a[e+3]=-a[e+3],a[e+4]=-a[e+4],a[e+5]=-a[e+5];return new H3DU.Mesh(a,[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.TEXCOORDS_BIT)};
H3DU.Meshes.createCylinder=function(a,b,c,e,f,g,h){var k=new H3DU.Mesh;if(null===e||"undefined"===typeof e)e=32;if(null===f||"undefined"===typeof f)f=1;if(2>=e)throw Error("too few slices");if(1>f)throw Error("too few stacks");if(0>c)throw Error("negative height");if(0>=a&&0>=b||0===c)return k;for(var l=h?-1:1,n=[0,1],p=[0],m=H3DU.Math.PiTimes2,q=1;q<e;q++){var r=1*q/e,t=m*r,u=Math.cos(t);n.push(0<=t&&6.283185307179586>t?3.141592653589793>=t?Math.sqrt(1-u*u):-Math.sqrt(1-u*u):Math.sin(t),u);p.push(r)}n.push(0,
1);p.push(1);e*=2;if(0<c)for(m=0,r=a,q=0,a===b?(u=0,t=l):(q=Math.atan2(a-b,c),t=Math.cos(q),u=0<=q&&6.283185307179586>q?3.141592653589793>=q?Math.sqrt(1-t*t):-Math.sqrt(1-t*t):Math.sin(q),u*=l,t*=l),l=1/f,q=0;q<f;q++){var v=m,y=q+1==f?1:(q+1)*l,B=c*v,x=c*y,E=r,A=a+(b-a)*y,m=y,r=A;k.mode(H3DU.Mesh.TRIANGLE_STRIP);k.texCoord2(1,v);k.normal3(0,t,u);k.vertex3(0,E,B);k.texCoord2(1,y);k.normal3(0,t,u);k.vertex3(0,A,x);for(var w=2,J=1;w<=e;w+=2,J++){var C=p[J],z,D;z=n[w];D=n[w+1];k.texCoord2(1-C,v);k.normal3(z*
t,D*t,u);k.vertex3(z*E,D*E,B);k.texCoord2(1-C,y);k.normal3(z*t,D*t,u);k.vertex3(z*A,D*A,x)}}return g?k.recalcNormals(g,h):k};
H3DU.Meshes.createLathe=function(a,b,c,e){var f=new H3DU.Mesh;if(4>a.length)throw Error("too few points");if(null===b||"undefined"===typeof b)b=32;if(2>=b)throw Error("too few slices");if(0!=a.length%1)throw Error("points array length is not an even number");for(var g=0;g<a.length;g+=2)if(0>a[g<<1])throw Error("point's x is less than 0");for(var h=[0,1],k=[0],l=H3DU.Math.PiTimes2,g=1;g<b;g++){var n=1*g/b,p=l*n,m=Math.cos(p);h.push(0<=p&&6.283185307179586>p?3.141592653589793>=p?Math.sqrt(1-m*m):-Math.sqrt(1-
m*m):Math.sin(p),m);k.push(n)}h.push(0,1);k.push(1);b*=2;for(var q=0,l=a.length/2-1,n=1/l,g=0;g<l;g++){var p=q,m=g+1==l?1:(g+1)*n,q=g<<1,r=a[q+1],t=a[q+3],u=Math.min(r,t),r=Math.max(r,t),t=a[q],v=a[q+2],q=m;f.mode(H3DU.Mesh.TRIANGLE_STRIP);f.texCoord2(1,p);f.vertex3(0,t,u);f.texCoord2(1,m);f.vertex3(0,v,r);for(var y=2,B=1;y<=b;y+=2,B++){var x=k[B],E,A;E=h[y];A=h[y+1];f.texCoord2(1-x,p);f.vertex3(E*t,A*t,u);f.texCoord2(1-x,m);f.vertex3(E*v,A*v,r)}}return f.recalcNormals(c,e)};
H3DU.Meshes.createClosedCylinder=function(a,b,c,e,f,g,h){f=H3DU.Meshes.createCylinder(a,b,c,e,f,g,h);a=H3DU.Meshes.createDisk(0,a,e,2,!h).reverseWinding();b=H3DU.Meshes.createDisk(0,b,e,2,h);b.transform(H3DU.Math.mat4translated(0,0,c));return f.merge(a).merge(b)};H3DU.Meshes.createDisk=function(a,b,c,e,f){return H3DU.Meshes.createPartialDisk(a,b,c,e,0,360,f)};
H3DU.Meshes.createPartialDisk=function(a,b,c,e,f,g,h){var k=new H3DU.Mesh;if(null===c||"undefined"===typeof c)c=32;if(null===e||"undefined"===typeof e)e=1;if(null===f||"undefined"===typeof f)f=0;if(null===g||"undefined"===typeof g)g=360;if(2>=c)throw Error("too few slices");if(1>e)throw Error("too few loops");if(a>b)throw Error("inner greater than outer");0>a&&(a=0);0>b&&(b=0);if(0===b||0===g)return k;var l=360===g&&0===f,n=0>g?-1:1;0>g&&(g=-g);g%=360;0===g&&(g=360);var p=[],m=[],q=H3DU.Math.PiTimes2;
g=360===g?q:g*H3DU.Math.PiDividedBy180;f*=H3DU.Math.PiDividedBy180;0>n&&(g=-g);for(n=0;n<=c;n++){var r=1*n/c,t=1===r&&g===q?f:f+g*r,t=0>t?q- -t%q:t%q,u=Math.cos(t);p.push(0<=t&&6.283185307179586>t?3.141592653589793>=t?Math.sqrt(1-u*u):-Math.sqrt(1-u*u):Math.sin(t),u);m.push(r)}l&&(p[0]=0,p[1]=1,p[p.length-1]=1,p[p.length-2]=0,m[0]=0,m[m.length-1]=1);c*=2;f=b-a;l=a;h?k.normal3(0,0,-1):k.normal3(0,0,1);for(n=0;n<e;n++){h=l;m=a+(n+1)/e*f;q=h/b;g=m/b;l=m;r=0===n&&0===a;k.mode(r?H3DU.Mesh.TRIANGLE_FAN:
H3DU.Mesh.TRIANGLE_STRIP);var v;if(r)for(t=c/2,r=c,v=t;0<=r;r-=2,v--)t=p[r],u=p[r+1],r===c&&(k.texCoord2(.5*(1+t*q),.5*(1+u*q)),k.vertex3(t*h,u*h,0)),k.texCoord2(.5*(1+t*g),.5*(1+u*g)),k.vertex3(t*m,u*m,0);else for(v=r=0;r<=c;r+=2,v++)t=p[r],u=p[r+1],k.texCoord2(.5*(1+t*g),.5*(1+u*g)),k.vertex3(t*m,u*m,0),k.texCoord2(.5*(1+t*q),.5*(1+u*q)),k.vertex3(t*h,u*h,0)}return k};
H3DU.Meshes.createTorus=function(a,b,c,e,f,g){var h=new H3DU.Mesh;if(null===e||"undefined"===typeof e)e=16;if(null===c||"undefined"===typeof c)c=16;if(3>e)throw Error("crosswise is less than 3");if(3>c)throw Error("lengthwise is less than 3");if(0>a||0>b)throw Error("inner or outer is less than 0");if(0===b||0===a)return h;for(var k=H3DU.Math.PiTimes2,l=[],n=[],p,m,q=0;q<e;q++)m=q*k/e,p=Math.cos(m),m=0<=m&&6.283185307179586>m?3.141592653589793>=m?Math.sqrt(1-p*p):-Math.sqrt(1-p*p):Math.sin(m),l.push(m,
p);l.push(l[0]);l.push(l[1]);for(q=0;q<c;q++)m=q*k/c,p=Math.cos(m),m=0<=m&&6.283185307179586>m?3.141592653589793>=m?Math.sqrt(1-p*p):-Math.sqrt(1-p*p):Math.sin(m),n.push(m,p);n.push(n[0]);n.push(n[1]);for(k=0;k<c;k++){p=k/c;var r=(k+1)/c,t=n[2*k],u=n[2*k+1],v=n[2*k+2],y=n[2*k+3];h.mode(H3DU.Mesh.TRIANGLE_STRIP);for(q=0;q<=e;q++){m=q/e;var B=l[2*q],x=l[2*q+1],E=x*(b+y*a),A=B*(b+y*a),w=v*a,J=y*x,C=y*B,z=v;h.normal3(J,C,z);h.texCoord2(m,r);h.vertex3(E,A,w);E=x*(b+u*a);A=B*(b+u*a);w=t*a;J=u*x;C=u*B;z=
t;h.normal3(J,C,z);h.texCoord2(m,p);h.vertex3(E,A,w)}}return f?h.recalcNormals(f,g):h};
H3DU.Meshes.createPlane=function(a,b,c,e,f){var g=new H3DU.Mesh;if(null===a||"undefined"===typeof a)a=1;if(null===b||"undefined"===typeof b)b=1;if(null===c||"undefined"===typeof c)c=1;if(null===e||"undefined"===typeof e)e=1;if(0>a||0>b)throw Error("width or height is less than 0");if(0>=e||0>=c)throw Error("widthDiv or heightDiv is 0 or less");if(0===a||0===b)return g;var h=.5*-a,k=.5*-b;f?g.normal3(0,0,-1):g.normal3(0,0,1);for(f=0;f<e;f++){g.mode(H3DU.Mesh.TRIANGLE_STRIP);var l=f/e,n=(f+1)/e,p=k+
b*l,m=k+b*n;g.texCoord2(0,n);g.vertex3(h,m,0);g.texCoord2(0,l);g.vertex3(h,p,0);for(var q=0;q<c;q++){var r=(q+1)/c,t=h+a*r;g.texCoord2(r,n);g.vertex3(t,m,0);g.texCoord2(r,l);g.vertex3(t,p,0)}}return g};H3DU.Meshes.createSphere=function(a,b,c,e,f){return H3DU.Meshes._createCapsule(a,0,b,c,1,e,f)};H3DU.Meshes.createCapsule=function(a,b,c,e,f,g,h){if(null===e||"undefined"===typeof e)e=8;if(1>e)throw Error("too few stacks");return H3DU.Meshes._createCapsule(a,b,c,2*e,f,g,h)};
H3DU.Meshes._createCapsule=function(a,b,c,e,f,g,h){function k(a,b,c,e,f,g){a.normal3(c*b,e*b,f*b);a.vertex3(c,e,f+g)}var l=new H3DU.Mesh;if(null===c||"undefined"===typeof c)c=16;if(null===e||"undefined"===typeof e)e=16;if(null===f||"undefined"===typeof f)f=1;if(null===a||"undefined"===typeof a)a=1;if(null===b||"undefined"===typeof b)b=1;if(2>e)throw Error("too few stacks");if(2>=c)throw Error("too few slices");if(1>f&&0<b)throw Error("too few middle stacks");if(0>b)throw Error("negative length");
if(0>a)throw Error("negative radius");if(0===a)return l;for(var n=.5*b,p=e/2,m=h?-1:1,q=[0,1],r=[],t=[],u=[0],v,y,B=H3DU.Math.PiTimes2,x=1;x<c;x++){var E=1*x/c;v=B*E;var A=Math.cos(v);v=0<=v&&6.283185307179586>v?3.141592653589793>=v?Math.sqrt(1-A*A):-Math.sqrt(1-A*A):Math.sin(v);q.push(v,A);u.push(E)}q.push(0,1);u.push(1);B=2*a;B/=B+b;E=[];for(x=1;x<e;x++){var w=1*x/e;v=Math.PI*w;A=Math.cos(v);v=0<=v&&6.283185307179586>v?3.141592653589793>=v?Math.sqrt(1-A*A):-Math.sqrt(1-A*A):Math.sin(v);r.push(v);
E.push(-A);t.push(w)}r.push(0);t.push(1);E.push(1);c*=2;for(var A=-1,J=v=0,x=0;x<e;x++){var C=E[x],z=t[x];y=a*A;var w=a*C,D=x<p?-n:n,K=v,H=a*r[x],M=J,N=z;0<b&&(M=x<p?J*B:1-(1-J)*B,N=x<p?z*B:1-(1-z)*B);A=C;J=z;v=H;x===e-1||0===x?l.mode(H3DU.Mesh.TRIANGLES):(l.mode(H3DU.Mesh.TRIANGLE_STRIP),l.texCoord2(1,M),k(l,m,0,K,y,D),l.texCoord2(1,N),k(l,m,0,H,w,D));for(var L=0,O=0,G=1,F,I,z=2,P=1;z<=c;z+=2,P++)C=u[P],x===e-1?(F=L+.5*(C-L),l.texCoord2(1-L,M),k(l,m,O*K,G*K,y,D),l.texCoord2(1-F,N),k(l,m,0,H,w,D),
F=q[z],I=q[z+1],l.texCoord2(1-C,M),k(l,m,F*K,I*K,y,D),O=F,G=I,L=C):0===x?(F=L+.5*(C-L),l.texCoord2(1-F,M),k(l,m,0,K,y,D),l.texCoord2(1-L,N),k(l,m,O*H,G*H,w,D),F=q[z],I=q[z+1],l.texCoord2(1-C,N),k(l,m,F*H,I*H,w,D),O=F,G=I,L=C):(F=q[z],I=q[z+1],l.texCoord2(1-C,M),k(l,m,F*K,I*K,y,D),l.texCoord2(1-C,N),k(l,m,F*H,I*H,w,D));if(x+1===p&&0<b)for(D=.5*B,K=2*n,L=1-D,O=1-B,G=0;G<f;G++){y=-n+(0===G?0:K*G/f);var Q=G===f-1?n:-n+K*(G+1)/f,M=D+(0===G?0:O*G/f),N=G===f-1?L:D+O*(G+1)/f;l.mode(H3DU.Mesh.TRIANGLE_STRIP);
l.texCoord2(1,M);k(l,m,0,H,w,y);l.texCoord2(1,N);k(l,m,0,H,w,Q);z=2;for(P=1;z<=c;z+=2,P++)C=u[P],F=q[z],I=q[z+1],l.texCoord2(1-C,M),k(l,m,F*H,I*H,w,y),l.texCoord2(1-C,N),k(l,m,F*H,I*H,w,Q)}}return g?l.recalcNormals(g,h):l.normalizeNormals()};
H3DU.Meshes.createPointedStar=function(a,b,c,e){var f=new H3DU.Mesh;if(2>a||0>b||0>c||0>=b&&0>=c)return f;f.mode(H3DU.Mesh.TRIANGLE_FAN);var g=0,h=0,k=H3DU.Math.PiTimes2,l=1/(2*a),n=1/Math.max(b,c);f.normal3(0,0,e?-1:1).texCoord2(.5,.5).vertex2(0,0);for(e=0;e<2*a;e++){var p=k*e*l,m=Math.cos(p),q=0===(e&1)?b:c,p=-(0<=p&&6.283185307179586>p?3.141592653589793>=p?Math.sqrt(1-m*m):-Math.sqrt(1-m*m):Math.sin(p))*q,m=m*q,q=.5*(1+p*n),r=.5*(1+m*n);0===e&&(g=p,h=m);f.texCoord2(q,r).vertex2(p,m)}f.texCoord2(.5*
(1+g*n),.5*(1+h*n)).vertex2(g,h);return f};this.H3DU.Meshes=H3DU.Meshes;H3DU.Scene3D=function(a){var b=a;"function"===typeof a.getContext&&(b=HTMLCanvasElement&&b.constructor===HTMLCanvasElement?H3DU.get3DContext(a):H3DU._toContext(b));this.context=b;this.textureCache={};this._textureLoader=new H3DU.TextureLoader;this._meshLoader=new H3DU.BufferedMesh._MeshLoader;this._renderedOutsideScene=!1;this.shapes=[];this._errors=!1;this._frontFace=H3DU.Scene3D.CCW;this._cullFace=H3DU.Scene3D.NONE;this.clearColor=[0,0,0,1];this.fboFilter=null;this._subScene=new H3DU.Batch3D;this._subScene.getLights().setDefaults();
this._programs=new H3DU.Scene3D.ProgramCache;this.useDevicePixelRatio=!1;this._pixelRatio=1;this.autoResize=!0;this.width=Math.ceil(1*this.context.canvas.clientWidth);this.height=Math.ceil(1*this.context.canvas.clientHeight);this.context.canvas.width=this.width;this.context.canvas.height=this.height;if(this._is3d=H3DU.is3DContext(this.context))this._programs.getProgram(H3DU.Scene3D.LIGHTING_ENABLED|H3DU.Scene3D.SPECULAR_ENABLED|H3DU.Scene3D.SPECULAR_MAP_ENABLED,this.context),this.context.viewport(0,
0,this.width,this.height),this.context.enable(this.context.BLEND),this.context.blendFunc(this.context.SRC_ALPHA,this.context.ONE_MINUS_SRC_ALPHA),this.context.enable(this.context.DEPTH_TEST),this.context.depthFunc(this.context.LEQUAL),this.context.disable(this.context.CULL_FACE),this.context.clearDepth(1),this._setClearColor(),this._setFace()};H3DU.Scene3D.prototype.getCanvas=function(){return this.context.canvas};H3DU.Scene3D.LIGHTING_ENABLED=1;H3DU.Scene3D.SPECULAR_MAP_ENABLED=2;
H3DU.Scene3D.NORMAL_ENABLED=4;H3DU.Scene3D.SPECULAR_ENABLED=8;H3DU.Scene3D.TEXTURE_ENABLED=16;H3DU.Scene3D.COLORATTR_ENABLED=32;H3DU.Scene3D._materialToFlags=function(a){var b;b=0|(a.basic?0:H3DU.Scene3D.LIGHTING_ENABLED);b|=0!=a.specular[0]||0!=a.specular[1]||0!=a.specular[2]?H3DU.Scene3D.SPECULAR_ENABLED:0;b|=a.specularMap?H3DU.Scene3D.SPECULAR_MAP_ENABLED:0;b|=a.normalMap?H3DU.Scene3D.NORMAL_ENABLED:0;return b|=a.texture?H3DU.Scene3D.TEXTURE_ENABLED:0};
H3DU.Scene3D.ProgramCache=function(){this._programs=[];this._customPrograms=[]};H3DU.Scene3D.ProgramCache.prototype.dispose=function(){for(var a=0;a<this._customPrograms.length;a++){var b=this._customPrograms[a];b[2].dispose()}for(a=0;a<this._programs.length;a++)(b=this._programs[a])&&b.dispose();this._customPrograms=[];this._programs=[]};
H3DU.Scene3D.ProgramCache.prototype.getCustomProgram=function(a,b){if(!b)throw Error();if(a instanceof H3DU.ShaderProgram)return a;for(var c=0;c<this._customPrograms.length;c++){var e=this._customPrograms[c];if(e[0]==a&&e[1]==b)return e[2]._update(),e[2]}c=H3DU.ShaderProgram._fromShaderInfo(b,a);this._customPrograms.push([a,b,c]);return c};
H3DU.Scene3D.ProgramCache.prototype.getProgram=function(a,b){if(!b)throw Error();var c=this._programs[a];if(c)for(var e=0;e<c.length;e++){if(c[e][0]==b)return c[e][1]}else this._programs[a]=[];c="";0!=(a&H3DU.Scene3D.LIGHTING_ENABLED)&&(c+="#define SHADING\n");0!=(a&H3DU.Scene3D.SPECULAR_ENABLED)&&(c+="#define SPECULAR\n");0!=(a&H3DU.Scene3D.NORMAL_ENABLED)&&(c+="#define NORMAL_MAP\n");0!=(a&H3DU.Scene3D.TEXTURE_ENABLED)&&(c+="#define TEXTURE\n");0!=(a&H3DU.Scene3D.COLORATTR_ENABLED)&&(c+="#define COLORATTR\n");
0!=(a&H3DU.Scene3D.SPECULAR_MAP_ENABLED)&&(c+="#define SPECULAR_MAP\n#define SPECULAR\n");c=new H3DU.ShaderProgram(b,c+H3DU.ShaderProgram.getDefaultVertex(),c+H3DU.ShaderProgram.getDefaultFragment());this._programs[a].push([b,c]);return c};H3DU.Scene3D.prototype.getContext=function(){return this.context};H3DU.Scene3D.NONE=0;H3DU.Scene3D.BACK=1;H3DU.Scene3D.FRONT=2;H3DU.Scene3D.FRONT_AND_BACK=3;H3DU.Scene3D.CCW=0;H3DU.Scene3D.CW=1;
H3DU.Scene3D.prototype.cullFace=function(a){this._cullFace=a===H3DU.Scene3D.BACK||a===H3DU.Scene3D.FRONT||a===H3DU.Scene3D.FRONT_AND_BACK?a:0;return this};
H3DU.Scene3D.prototype._setFace=function(){if(this._is3d)return this._cullFace===H3DU.Scene3D.BACK?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.BACK)):this._cullFace===H3DU.Scene3D.FRONT?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.FRONT)):this._cullFace===H3DU.Scene3D.FRONT_AND_BACK?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.FRONT_AND_BACK)):this.context.disable(this.context.CULL_FACE),this._frontFace===
H3DU.Scene3D.CW?this.context.frontFace(this.context.CW):this.context.frontFace(this.context.CCW),this};H3DU.Scene3D.prototype.frontFace=function(a){this._frontFace=a===H3DU.Scene3D.CW?a:0;return this};H3DU.Scene3D.prototype.setAutoResize=function(a){this.autoResize=!!a;return this};
H3DU.Scene3D.prototype.setUseDevicePixelRatio=function(a){var b=!!this.useDevicePixelRatio;this._pixelRatio=(this.useDevicePixelRatio=!!a)&&window.devicePixelRatio?window.devicePixelRatio:1;b!==this.useDevicePixelRatio&&this.setDimensions(this.width,this.height);return this};H3DU.Scene3D.prototype.getClearColor=function(){return this.clearColor.slice(0,4)};H3DU.Scene3D.prototype.useProgram=function(a){console.warn("The 'useProgram' method is obsolete.  Instead of this method, use the 'setShader' program of individual shapes to set the shader programs they use.")};
H3DU.Scene3D.prototype.setDimensions=function(a,b){if(0>a||0>b)throw Error("width or height negative");this.width=Math.ceil(a);this.height=Math.ceil(b);this.context.canvas.width=this.width*this._pixelRatio;this.context.canvas.height=this.height*this._pixelRatio;this._is3d&&this.context.viewport(0,0,this.width*this._pixelRatio,this.height*this._pixelRatio);"undefined"!==typeof this.fbo&&this.fbo&&(this.fbo.dispose(),this.fbo=this.createBuffer(),this.fboQuad&&this.fboQuad.setMaterial(this.fbo))};
H3DU.Scene3D.prototype.getWidth=function(){return this.width};H3DU.Scene3D.prototype.getHeight=function(){return this.height};H3DU.Scene3D.prototype.getAspect=function(){var a=this.getHeight();return 0>=a?1:this.getWidth()/a};H3DU.Scene3D.prototype.getClientWidth=function(){return this.context.canvas.clientWidth};H3DU.Scene3D.prototype.getClientHeight=function(){return this.context.canvas.clientHeight};
H3DU.Scene3D.prototype.getClientAspect=function(){var a=this.getClientHeight();return 0>=a?1:this.getClientWidth()/a};H3DU.Scene3D.prototype.createBuffer=function(){return new H3DU.FrameBuffer(this.context,this.getWidth(),this.getHeight())};H3DU.Scene3D.prototype.getProjectionMatrix=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene._projectionMatrix.slice(0,16)};
H3DU.Scene3D.prototype.getViewMatrix=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._viewMatrix.slice(0,16)};H3DU.Scene3D.prototype.setPerspective=function(a,b,c,e){return this.setProjectionMatrix(H3DU.Math.mat4perspective(a,b,c,e))};
H3DU.Scene3D.prototype.setOrthoAspect=function(a,b,c,e,f,g,h){if(null===h||"undefined"===typeof h)h=this.getClientAspect();0===h&&(h=1);return this.setProjectionMatrix(H3DU.Math.mat4orthoAspect(a,b,c,e,f,g,h))};H3DU.Scene3D.prototype.setOrtho2DAspect=function(a,b,c,e,f){return this.setOrthoAspect(a,b,c,e,-1,1,f)};H3DU.Scene3D.prototype.setFrustum=function(a,b,c,e,f,g){return this.setProjectionMatrix(H3DU.Math.mat4frustum(a,b,e,c,f,g))};
H3DU.Scene3D.prototype.setOrtho=function(a,b,c,e,f,g){return this.setProjectionMatrix(H3DU.Math.mat4ortho(a,b,c,e,f,g))};H3DU.Scene3D.prototype.setOrtho2D=function(a,b,c,e){return this.setProjectionMatrix(H3DU.Math.mat4ortho(a,b,c,e,-1,1))};H3DU.Scene3D.prototype._setClearColor=function(){this._is3d&&this.context.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]);return this};
H3DU.Scene3D.prototype.dispose=function(){this._programs.dispose();this._textureLoader.dispose();this._meshLoader.dispose()};H3DU.Scene3D.prototype.setClearColor=function(a,b,c,e){this.clearColor=H3DU.toGLColor(a,b,c,e);return this._setClearColor()};H3DU.Scene3D.prototype.loadTexture=function(a){return this._textureLoader.loadTexture(a)};
H3DU.Scene3D.prototype.loadAndMapTexture=function(a){var b=null;if(a.constructor===H3DU.Texture)return this.loadAndMapTexture(a.name);var b=this.loadTexture(a),c=this;return b.then(function(a){c._textureLoader.mapTexture(a,c);return a})};H3DU.Scene3D.prototype.loadAndMapTextures=function(a,b,c){for(var e=[],f=0;f<a.length;f++)e.push(this.loadAndMapTexture(a[f]));return H3DU.getPromiseResults(e,b,c)};
H3DU.Scene3D.prototype.clear=function(){this._is3d&&this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT|this.context.STENCIL_BUFFER_BIT)};H3DU.Scene3D.prototype.clearDepth=function(){this._is3d&&this.context.clear(this.context.DEPTH_BUFFER_BIT)};H3DU.Scene3D.prototype.vertexCount=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.vertexCount()};
H3DU.Scene3D.prototype.primitiveCount=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.primitiveCount()};H3DU.Scene3D.prototype.setProjectionMatrix=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.setProjectionMatrix(a);return this};
H3DU.Scene3D.prototype.setViewMatrix=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.setViewMatrix(a);return this};H3DU.Scene3D.prototype.setLookAt=function(a,b,c){return this.setViewMatrix(H3DU.Math.mat4lookat(a,b,c))};
H3DU.Scene3D.prototype.addShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.addShape(a);return this};H3DU.Scene3D.prototype.makeShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return new H3DU.Shape(a)};
H3DU.Scene3D.prototype.removeShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.removeShape(a);return this};H3DU.Scene3D.prototype.getLights=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.getLights()};
H3DU.Scene3D.prototype.setDirectionalLight=function(a,b,c,e){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setDirectionalLight(a,b,c,e);return this};H3DU.Scene3D.prototype.setLightParams=function(a,b){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setParams(a,b);return this};
H3DU.Scene3D.prototype.setAmbient=function(a,b,c,e){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setAmbient(a,b,c,e);return this};H3DU.Scene3D.prototype.setPointLight=function(a,b,c,e){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setPointLight(a,b,c,e);return this};
H3DU.Scene3D.prototype._clearForPass=function(a){var b=0;a.clearColor&&(b|=this.context.COLOR_BUFFER_BIT);a.clearDepth&&(b|=this.context.DEPTH_BUFFER_BIT);a.clearStencil&&(b|=this.context.STENCIL_BUFFER_BIT);this._is3d&&0!=b&&this.context.clear(b)};
H3DU.Scene3D.prototype.render=function(a){if(a instanceof H3DU.Batch3D)return this.render([new H3DU.RenderPass3D(a)]);if(this.autoResize){var b=this.context.canvas;b.height===Math.ceil(b.clientHeight)*this._pixelRatio&&b.width===Math.ceil(b.clientWidth)*this._pixelRatio||this.setDimensions(b.clientWidth,b.clientHeight)}this._setFace();var b=this.getClientWidth(),c=this.getClientHeight();if(null==a)this._is3d&&this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT),this._subScene.resize(b,
c),this._subScene.render(this);else{this._renderedOutsideScene=!0;for(var e=0;e<a.length;e++){var f=a[e];f.frameBuffer&&f.frameBuffer.bind();this._clearForPass(f);a[e].subScene.resize(b,c);a[e].subScene.render(this);f.frameBuffer&&f.frameBuffer.unbind()}}this._is3d&&this.context.flush();return this};
H3DU.Scene3D.prototype.useFilter=function(a){console.warn("The useFilter method has no effect. Use the {@link H3DU.Batch3D.forFilter} method to create a subscene for rendering filter effects from a frame buffer.");return this};H3DU.Scene3D.supportsDerivatives=function(a){a=a.getContext?a.getContext():a;return a.getExtension("OES_standard_derivatives")?!0:!1};H3DU.Lights=function(){this.lights=[];this.sceneAmbient=[.2,.2,.2]};H3DU.Lights.prototype.setDefaults=function(){this.lights=[(new H3DU.LightSource).setParams({ambient:[0,0,0,1],position:[0,0,1,0],diffuse:[1,1,1,1],specular:[1,1,1],radius:0})];this.sceneAmbient=[.2,.2,.2]};H3DU.Lights.MAX_LIGHTS=3;H3DU.Lights._createNewLight=function(a){var b=new H3DU.LightSource;0!==a&&(b.diffuse=[0,0,0,0],b.specular=[0,0,0]);return b};H3DU.Lights.prototype.getCount=function(){return this.lights.length};
H3DU.Lights.prototype.getLight=function(a){var b=this.lights.length;this.lights[a]||(this.lights[a]=H3DU.Lights._createNewLight(a));if(2<=this.lights.length-b)for(;b<this.lights.length;b++)this.lights[b]||(this.lights[b]=H3DU.Lights._createNewLight(b));return this.lights[a]};H3DU.Lights.prototype.setParams=function(a,b){this.getLight(a).setParams(b);return this};
H3DU.Lights.prototype.setDirectionalLight=function(a,b,c,e){b=this.setParams(a,{position:[b[0],b[1],b[2],0]});null!=c&&(b=b.setParams(a,{diffuse:c}));null!=e&&(b=b.setParams(a,{specular:e}));return b};H3DU.Lights.prototype.setPointLight=function(a,b,c,e){b=this.setParams(a,{position:[b[0],b[1],b[2],1]});null!=c&&(b=b.setParams(a,{diffuse:c}));null!=e&&(b=b.setParams(a,{specular:e}));return b};H3DU.Lights.prototype.setAmbient=function(a,b,c,e){this.sceneAmbient=H3DU.toGLColor(a,b,c,e);return this};H3DU.Batch3D=function(){this._projectionMatrix=H3DU.Math.mat4identity();this._viewMatrix=H3DU.Math.mat4identity();this.lights=new H3DU.Lights;this._frustum=this._projectionUpdater=null;this.shapes=[]};H3DU.Batch3D._PerspectiveView=function(a,b,c,e){this.fov=b;this.near=c;this.far=e;this.scene=a;this.lastAspect=null;this.update=function(a,b){var c=1*a/b;c!=this.lastAspect&&(this.lastAspect=c,this.scene.setProjectionMatrix(H3DU.Math.mat4perspective(this.fov,c,this.near,this.far)))};this.update()};
H3DU.Batch3D._OrthoView=function(a,b,c,e,f,g,h){this.a=b;this.b=c;this.c=e;this.d=f;this.e=g;this.f=h;this.scene=a;this.lastAspect=null;this.update=function(a,b){var c=1*a/b;c!=this.lastAspect&&(this.lastAspect=c,this.scene.setProjectionMatrix(H3DU.Math.mat4orthoAspect(this.a,this.b,this.c,this.d,this.e,this.f,c)))};this.update()};
H3DU.Batch3D._setupMatrices=function(a,b,c,e,f){var g={};f&&(g.view=c,g.projection=b,g.viewMatrix=c,g.projectionMatrix=b,viewInvW=a.get("projView"),null!==viewInvW&&"undefined"!==typeof viewInvW&&(b=H3DU.Math.mat4multiply(b,c),g.projView=b));b=H3DU.Math.mat4inverseTranspose3(e);g.world=e;g.modelMatrix=e;g.normalMatrix=b;b=a.get("modelViewMatrix");null!==b&&"undefined"!==typeof b&&(H3DU._isIdentityExceptTranslate(c)?(e=e.slice(0,16),e[12]+=c[12],e[13]+=c[13],e[14]+=c[14]):e=H3DU.Math.mat4multiply(c,
e),g.modelViewMatrix=e,b=H3DU.Math.mat4inverseTranspose3(e),g.world=e,g.modelMatrix=e,g.normalMatrix=b);a.setUniforms(g)};H3DU.Batch3D._isSameMatrix=function(a,b){return a[0]==b[0]&&a[1]==b[1]&&a[2]==b[2]&&a[3]==b[3]&&a[4]==b[4]&&a[5]==b[5]&&a[6]==b[6]&&a[7]==b[7]&&a[8]==b[8]&&a[9]==b[9]&&a[10]==b[10]&&a[11]==b[11]&&a[12]==b[12]&&a[13]==b[13]&&a[14]==b[14]&&a[15]==b[15]};
H3DU.Batch3D.prototype.setProjectionMatrix=function(a){H3DU.Batch3D._isSameMatrix(this._projectionMatrix,a)||(this._projectionMatrix=a.slice(0,16),this._frustum=null);return this};H3DU.Batch3D.prototype.perspectiveAspect=function(a,b,c){this._projectionUpdater=new H3DU.Batch3D._PerspectiveView(this,a,b,c);return this};H3DU.Batch3D.prototype.setLookAt=function(a,b,c){return this.setViewMatrix(H3DU.Math.mat4lookat(a,b,c))};
H3DU.Batch3D.prototype.orthoAspect=function(a,b,c,e,f,g){this._projectionUpdater=new H3DU.Batch3D._OrthoView(this,a,b,c,e,f,g);return this};H3DU.Batch3D.prototype.ortho2DAspect=function(a,b,c,e){return this.orthoAspect(a,b,c,e,-1,1)};H3DU.Batch3D.prototype.setViewMatrix=function(a){H3DU.Batch3D._isSameMatrix(this._viewMatrix,a)||(this._viewMatrix=a.slice(0,16),this._frustum=null);return this};H3DU.Batch3D.prototype.getProjectionMatrix=function(){return this._projectionMatrix.slice(0,16)};
H3DU.Batch3D.prototype.getViewMatrix=function(){return this._viewMatrix.slice(0,16)};H3DU.Batch3D.prototype._getFrustum=function(){if(null==this._frustum){var a=H3DU.Math.mat4multiply(this._projectionMatrix,this._viewMatrix);this._frustum=H3DU.Math.mat4toFrustumPlanes(a)}return this._frustum};H3DU.Batch3D.prototype.getLights=function(){return this.lights};H3DU.Batch3D.prototype.addShape=function(a){a.parent=null;this.shapes.push(a);return this};
H3DU.Batch3D.prototype.vertexCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].vertexCount();return a};H3DU.Batch3D.prototype.primitiveCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].primitiveCount();return a};H3DU.Batch3D.prototype.removeShape=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b]===a&&(this.shapes.splice(b,1),b--);return this};
H3DU.Batch3D.prototype._renderShape=function(a,b){if(a.constructor===H3DU.ShapeGroup){if(a.visible)for(var c=0;c<a.shapes.length;c++)this._renderShape(a.shapes[c],b)}else if(a.visible&&!a.isCulled(this._getFrustum())){var c=null,e=0;a.material instanceof H3DU.Material&&(a.material.shader&&(c=b.scene._programs.getCustomProgram(a.material.shader,b.context)),e=H3DU.Scene3D._materialToFlags(a.material));a._hasColorAttr()&&(e|=H3DU.Scene3D.COLORATTR_ENABLED);null==c&&(c=b.scene._programs.getProgram(e,
b.context));e=!1;b.prog!=c&&(c.use(),e=!0,(new H3DU._LightsBinder(this.lights)).bind(c,this._viewMatrix),b.prog=c);H3DU.Batch3D._setupMatrices(c,this._projectionMatrix,this._viewMatrix,a.getMatrix(),e);H3DU.Batch3D._getMaterialBinder(a.material).bind(c,b.context,b.scene._textureLoader);b.scene._meshLoader.draw(a.bufferedMesh,c)}};H3DU.Batch3D.prototype.resize=function(a,b){this._projectionUpdater&&this._projectionUpdater.update(a,b)};
H3DU.Batch3D.prototype.render=function(a){var b={};b.scene=a;b.context=a.getContext();for(a=0;a<this.shapes.length;a++)this._renderShape(this.shapes[a],b);return this};H3DU.Batch3D.forFilter=function(a,b,c){null==c&&(c=H3DU.ShaderProgram.makeCopyEffect(a));a=new H3DU.Batch3D(a);var e=new H3DU.Mesh([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0],[0,1,2,2,1,3],H3DU.Mesh.TEXCOORDS_BIT),e=new H3DU.Shape(e);e.setTexture(b);e.setShader(c);a.addShape(e);return a};
H3DU.Batch3D._getMaterialBinder=function(a){return a&&a instanceof H3DU.Material?new H3DU._MaterialBinder(a):{bind:function(a){}}};H3DU.Material=function(a,b,c,e,f){null!==a&&"undefined"!==typeof a&&(a=H3DU.toGLColor(a));null!==b&&"undefined"!==typeof b&&(b=H3DU.toGLColor(b));null!==c&&"undefined"!==typeof c&&(c=H3DU.toGLColor(c));null!==f&&"undefined"!==typeof f&&(f=H3DU.toGLColor(f));this.shininess=null===e||"undefined"===typeof e?0:Math.min(Math.max(0,e),128);this.ambient=a?a.slice(0,3):[.2,.2,.2];this.diffuse=b?b.slice(0,b.length):[.8,.8,.8,1];this.specular=c?c.slice(0,3):[0,0,0];this.emission=f?f.slice(0,3):[0,0,0];this.normalMap=
this.specularMap=this.texture=null;this.basic=!1;this.shader=null};H3DU.Material.prototype.copy=function(){return(new H3DU.Material(this.ambient.slice(0,this.ambient.length),this.diffuse.slice(0,this.diffuse.length),this.specular.slice(0,this.specular.length),this.shininess,this.emission.slice(0,this.emission.length))).setParams({texture:this.texture,specularMap:this.specularMap,normalMap:this.normalMap,basic:this.basic,shader:this.shader})};
H3DU.Material.prototype.setParams=function(a){var b;"undefined"!==typeof a.ambient&&null!==a.ambient&&(this.ambient=H3DU.toGLColor(a.ambient),3<this.ambient.length&&(this.ambient=this.ambient.slice(0,3)));"undefined"!==typeof a.diffuse&&null!==a.diffuse&&(this.diffuse=H3DU.toGLColor(a.diffuse),4<this.diffuse.length&&(this.diffuse=this.diffuse.slice(0,4)));"undefined"!==typeof a.specular&&null!==a.specular&&(this.specular=H3DU.toGLColor(a.specular),3<this.specular.length&&(this.specular=this.specular.slice(0,
3)));"undefined"!==typeof a.emission&&null!==a.emission&&(this.emission=H3DU.toGLColor(a.emission),3<this.emission.length&&(this.emission=this.emission.slice(0,3)));"undefined"!==typeof a.shininess&&null!==a.shininess&&(this.shininess=a.shininess);"undefined"!==typeof a.texture&&null!==a.texture&&(b=a.texture,this.texture="string"===typeof b?new H3DU.Texture(b):b);"undefined"!==typeof a.specularMap&&null!==a.specularMap&&(b=a.specularMap,this.specularMap="string"===typeof b?new H3DU.Texture(b):b);
"undefined"!==typeof a.normalMap&&null!==a.normalMap&&(b=a.normalMap,this.normalMap="string"===typeof b?new H3DU.Texture(b):b);"undefined"!=typeof a.basic&&null!==a.basic&&(this.basic=a.basic);"undefined"!=typeof a.shader&&null!==a.shader&&(this.shader=a.shader);return this};H3DU.Material.fromColor=function(a,b,c,e){a=H3DU.toGLColor(a,b,c,e);return new H3DU.Material(a,a)};H3DU.Material.fromTexture=function(a){return(new H3DU.Material).setParams({texture:a})};H3DU.Material.forShader=function(a){return(new H3DU.Material).setParams({shader:a})};H3DU._MaterialBinder=function(a){this.mshade=a};H3DU._MaterialBinder._textureSizeZeroZero=[0,0];
H3DU._MaterialBinder.prototype.bind=function(a,b,c){if(!this.mshade)return this;4!==this.mshade.diffuse.length&&console.warn("creating new diffuse array");3!==this.mshade.ambient.length&&console.warn("creating new ambient array");3!==this.mshade.specular.length&&console.warn("creating new specular array");3!==this.mshade.emission.length&&console.warn("creating new emission array");var e={textureSize:H3DU._MaterialBinder._textureSizeZeroZero,md:4===this.mshade.diffuse.length?this.mshade.diffuse:[this.mshade.diffuse[0],
this.mshade.diffuse[1],this.mshade.diffuse[2],4>this.mshade.diffuse.length?1:this.mshade.diffuse[3]]};this.mshade.basic||(e.mshin=this.mshade.shininess,e.ma=3===this.mshade.ambient.length?this.mshade.ambient:[this.mshade.ambient[0],this.mshade.ambient[1],this.mshade.ambient[2]],e.ms=3===this.mshade.specular.length?this.mshade.specular:[this.mshade.specular[0],this.mshade.specular[1],this.mshade.specular[2]],e.me=3===this.mshade.emission.length?this.mshade.emission:[this.mshade.emission[0],this.mshade.emission[1],
this.mshade.emission[2]]);a.setUniforms(e);H3DU._MaterialBinder.bindTexture(this.mshade.texture,b,a,0,c);H3DU._MaterialBinder.bindTexture(this.mshade.specularMap,b,a,1,c);H3DU._MaterialBinder.bindTexture(this.mshade.normalMap,b,a,2,c);return this};
H3DU._LoadedTexture=function(a,b){this.context=b=H3DU._toContext(b);this.loadedTexture=b.createTexture();b.activeTexture(b.TEXTURE0);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,1);b.bindTexture(b.TEXTURE_2D,this.loadedTexture);"src"in a.image?b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a.image):b.texImage2D(b.TEXTURE_2D,0,b.RGBA,a.width,a.height,0,b.RGBA,b.UNSIGNED_BYTE,a.image);H3DU._isPowerOfTwo(a.width)&&H3DU._isPowerOfTwo(a.height)?b.generateMipmap(b.TEXTURE_2D):(b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE))};H3DU._LoadedTexture.prototype.dispose=function(){this.loadedTexture&&this.context.deleteTexture(this.loadedTexture)};
H3DU._MaterialBinder.bindTexture=function(a,b,c,e,f){if(a){var g=a instanceof H3DU.FrameBuffer,h=null;if(!g)if("undefined"!==typeof a.image&&null!==a.image||0!==a.loadStatus)h=f.mapTexture(a,b);else{var k=this;a.loadImage().then(function(a){k.bind(c)});return}if(null!=h||g){var l={};0===e&&(l.sampler=e,l.textureSize=[a.width,a.height]);1===e&&(l.specularMap=e);2===e&&(l.normalMap=e);c.setUniforms(l);b.activeTexture(b.TEXTURE0+e);g?(b.bindTexture(b.TEXTURE_2D,a.colorTexture),a.colorTexture&&(b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE))):(b.bindTexture(b.TEXTURE_2D,h.loadedTexture),f._setMaxAnisotropy(b),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR),e=b.CLAMP_TO_EDGE,H3DU._isPowerOfTwo(a.width)&&H3DU._isPowerOfTwo(a.height)?(a.clamp||(e=b.REPEAT),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR_MIPMAP_LINEAR)):
b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,e),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,e))}}};H3DU._LightsBinder=function(a){this.lights=a};H3DU._LightsBinder.emptyW1=[0,0,0,1];H3DU._LightsBinder.emptyW0=[0,0,0,0];H3DU._LightsBinder.emptyAtten=[1,0,0,0];
H3DU._LightsBinder.prototype.bind=function(a,b){var c=this.lights;if(!c||!a)return this;var e={};e.sceneAmbient=3===c.sceneAmbient.length?c.sceneAmbient:c.sceneAmbient.slice(0,3);for(var f=0;f<c.lights.length;f++){var g=c.lights[f],h="lights["+f+"]";e[h+".diffuse"]=4===g.diffuse.length?g.diffuse:[g.diffuse[0],g.diffuse[1],g.diffuse[2],1];e[h+".specular"]=4===g.specular.length?g.specular:[g.specular[0],g.specular[1],g.specular[2],1];var k=H3DU.Math.mat4transform(b,c.lights[f].position);e[h+".position"]=
k;e[h+".radius"]=[Math.max(0,g.radius*g.radius*g.radius*g.radius),0,0,0]}for(f=c.lights.length;f<H3DU.Lights.MAX_LIGHTS;f++)h="lights["+f+"]",e[h+".diffuse"]=H3DU._LightsBinder.emptyW1,e[h+".specular"]=H3DU._LightsBinder.emptyW1,e[h+".position"]=H3DU._LightsBinder.emptyW0,e[h+".radius"]=H3DU._LightsBinder.emptyW0;a.setUniforms(e);return this};H3DU.Shape=function(a){if(null===a||"undefined"===typeof a)throw Error("mesh is null");a instanceof H3DU.Mesh?this.bufferedMesh=new H3DU.MeshBuffer(a):(!H3DU.Shape._bufferedMeshWarning&&a instanceof H3DU.BufferedMesh&&(console.warn("Using an H3DU.BufferedMesh in H3DU.Shape objects is deprecated."),H3DU.Shape._bufferedMeshWarning=!0),this.bufferedMesh=a);this.transform=new H3DU.Transform;this.material=new H3DU.Material;this.parent=null;this.visible=!0};
H3DU.Shape.prototype._hasColorAttr=function(){var a=this.bufferedMesh;return a&&a instanceof H3DU.MeshBuffer&&a._getAttribute("colorAttr")};H3DU.Shape._bufferedMeshWarning=!1;H3DU.Shape.prototype.vertexCount=function(){return this.bufferedMesh?this.bufferedMesh.vertexCount():0};H3DU.Shape.prototype.primitiveCount=function(){return this.bufferedMesh?this.bufferedMesh.primitiveCount():0};H3DU.Shape.prototype.setVisible=function(a){this.visible=!!a;return this};H3DU.Shape.prototype.getVisible=function(){return this.visible};
H3DU.Shape.prototype.setColor=function(a,b,c,e){a=H3DU.toGLColor(a,b,c,e);return this.setMaterialParams({ambient:a,diffuse:a})};H3DU.Shape.prototype.setTexture=function(a){return this.setMaterialParams({texture:a})};H3DU.Shape.prototype.setShader=function(a){return this.setMaterialParams({shader:a})};H3DU.Shape.prototype.setMaterialParams=function(a){this.material?this.material.setParams(a):this.material=(new Material).setParams(a);return this};
H3DU.Shape.prototype.setTextureAndColor=function(a,b,c,e,f){b=H3DU.toGLColor(b,c,e,f);return this.setMaterialParams({texture:a,ambient:b,diffuse:b})};H3DU.Shape.prototype.setMaterial=function(a){this.material=a;return this};H3DU.Shape.prototype.copy=function(){var a=new H3DU.Shape(this.bufferedMesh);a.material=this.material.copy();a.transform=this.getTransform().copy();return a};H3DU.Shape.prototype.getTransform=function(){return this.transform};
H3DU.Shape.prototype.getBounds=function(){if(!this.bufferedMesh)return[0,0,0,-1,-1,-1];var a=this.bufferedMesh.getBounds?this.bufferedMesh.getBounds():this.bufferedMesh._getBounds(),b=this.getMatrix();if(H3DU.Math.mat4isIdentity(b))return a.slice(0,6);var c=H3DU.Math.mat4transformVec3(b,a[0],a[1],a[2]),a=H3DU.Math.mat4transformVec3(b,a[3],a[4],a[5]);return[Math.min(c[0],a[0]),Math.min(c[1],a[1]),Math.min(c[2],a[2]),Math.max(c[0],a[0]),Math.max(c[1],a[1]),Math.max(c[2],a[2])]};
H3DU.Shape.prototype.isCulled=function(a){return this.bufferedMesh&&this.visible?!H3DU.Math.frustumHasBox(a,this.getBounds()):!0};H3DU.Shape.prototype.setTransform=function(a){this.transform=a.copy();return this};H3DU.Shape.prototype.setScale=function(a,b,c){this.getTransform().setScale(a,b,c);return this};H3DU.Shape.prototype.setPosition=function(a,b,c){this.getTransform().setPosition(a,b,c);return this};H3DU.Shape.prototype.setQuaternion=function(a){this.getTransform().setQuaternion(a);return this};
H3DU.Shape.prototype.getMatrix=function(){var a=this.getTransform(),b=a.isIdentity();if(null!==this.parent)var c=this.parent.getMatrix(),a=b?c:H3DU.Math.mat4isIdentity(c)?a.getMatrix():H3DU.Math.mat4multiply(c,a.getMatrix());else a=a.getMatrix();return a};H3DU.FrameBuffer=function(a,b,c){if(0>b||0>c)throw Error("width or height negative");this.context=a=a.getContext?a.getContext():a;this.textureUnit=3;this._init(a,b,c)};
H3DU.FrameBuffer.prototype._init=function(a,b,c){this.buffer=a.createFramebuffer();this.colorTexture=a.createTexture();this.width=Math.ceil(b);this.height=Math.ceil(c);this.context.activeTexture(this.context.TEXTURE0+this.textureUnit);this.context.bindTexture(this.context.TEXTURE_2D,this.colorTexture);this.context.pixelStorei(this.context.UNPACK_FLIP_Y_WEBGL,1);this.context.texImage2D(this.context.TEXTURE_2D,0,this.context.RGBA,this.width,this.height,0,this.context.RGBA,this.context.UNSIGNED_BYTE,
null);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE);this.depthbuffer=this.context.createRenderbuffer();b=this.context.getParameter(a.FRAMEBUFFER_BINDING);
this.context.bindFramebuffer(a.FRAMEBUFFER,this.buffer);this.context.bindRenderbuffer(a.RENDERBUFFER,this.depthbuffer);this.context.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.width,this.height);this.context.bindFramebuffer(a.FRAMEBUFFER,b)};H3DU.FrameBuffer.prototype.resize=function(a,b){a=Math.ceil(a);b=Math.ceil(b);if(a!=this.width||b!=this.height)this.dispose(),this._init(this.context,a,b);return this};H3DU.FrameBuffer.prototype.getContext=function(){return this.context};
H3DU.FrameBuffer.prototype.bind=function(){this.context.activeTexture(this.context.TEXTURE0+this.textureUnit);this.context.bindFramebuffer(this.context.FRAMEBUFFER,this.buffer);this.context.framebufferTexture2D(this.context.FRAMEBUFFER,this.context.COLOR_ATTACHMENT0,this.context.TEXTURE_2D,this.colorTexture,0);this.context.framebufferRenderbuffer(this.context.FRAMEBUFFER,this.context.DEPTH_ATTACHMENT,this.context.RENDERBUFFER,this.depthbuffer);return this};
H3DU.FrameBuffer.prototype.unbind=function(){this.context.framebufferTexture2D(this.context.FRAMEBUFFER,this.context.COLOR_ATTACHMENT0,this.context.TEXTURE_2D,null,0);this.context.framebufferRenderbuffer(this.context.FRAMEBUFFER,this.context.DEPTH_ATTACHMENT,this.context.RENDERBUFFER,null);this.context.bindFramebuffer(this.context.FRAMEBUFFER,null)};
H3DU.FrameBuffer.prototype.dispose=function(){null!==this.buffer&&(this.context.getParameter(this.context.FRAMEBUFFER_BINDING)==this.buffer&&this.unbind(),this.context.deleteFramebuffer(this.buffer));null!==this.depthbuffer&&this.context.deleteRenderbuffer(this.depthbuffer);null!==this.colorTexture&&this.context.deleteTexture(this.colorTexture);this.colorTexture=this.depthbuffer=this.buffer=null};(function(a){H3DU.BezierCurve=function(a,c,e){if("undefined"===typeof c&&"undefined"===typeof e)this.uoffset=0,this.umul=1;else{if(c===e)throw Error("u1 and u2 can't be equal");this.uoffset=c;this.umul=1/(e-c)}this.evaluator=H3DU.BSplineCurve.clamped(a,a.length-1)};H3DU.BezierCurve.prototype.evaluate=function(a){return this.evaluator.evaluate((a-this.uoffset)*this.umul)};H3DU.BezierSurface=function(a,c,e,f,g){if("undefined"===typeof c&&"undefined"===typeof e&&"undefined"===typeof f&&"undefined"===
typeof g)this.uoffset=0,this.umul=1,this.voffset=0,this.vmul=1;else{if(c===e)throw Error("u1 and u2 can't be equal");if(f===g)throw Error("v1 and v2 can't be equal");this.uoffset=c;this.umul=1/(e-c);this.voffset=f;this.vmul=1/(g-f)}this.evaluator=H3DU.BSplineSurface.clamped(a,a[0].length-1,a.length-1)};H3DU.BezierSurface.prototype.evaluate=function(a,c,e){return this.evaluator.evaluate((a-this.uoffset)*this.umul,(c-this.voffset)*this.vmul)};H3DU.BSplineCurve=function(a,c,e){if(0>=a.length)throw Error();
if(!c)throw Error();this.bits=e||0;e=c.length-a.length;if(2>e||e>a.length)throw Error();H3DU.BSplineCurve._checkKnots(c);this.cplen=a[0].length;e=1;0!==(this.bits&(H3DU.BSplineCurve.WEIGHTED_BIT|H3DU.BSplineCurve.DIVIDE_BIT))&&(e=2);0!==(this.bits&H3DU.BSplineCurve.WEIGHTED_BIT)&&this.cplen--;if(this.cplen<e)throw Error();this.knots=c;this.buffer=[];this.controlPoints=a};H3DU.BSplineCurve.WEIGHTED_BIT=1;H3DU.BSplineCurve.DIVIDE_BIT=2;H3DU.BSplineCurve.HOMOGENEOUS_BIT=4;H3DU.BSplineCurve.WEIGHTED_DIVIDE_BITS=
3;H3DU.BSplineCurve._checkKnots=function(a){for(var c=1;c<a.length;c++)if(a[c]<a[c-1])throw Error();if(a[0]===a[a.length-1])throw Error();};H3DU.BSplineCurve._getFactors=function(a,c,e,f,g){for(var h=1,k=0;k<f;k++)g[k]=0;if(c===a[0])g[0]=1;else if(c===a[a.length-1])g[f-1]=1;else{f=-1;for(k=0;k<=a.length;k++)if(a[k]<=c&&c<a[k+1]){f=k;break}if(!(0>f)){var l=[],h=f-1;l[f]=1;for(var n=2;n<=e;n++,h--){for(k=h;k<=f;k++){var p=0,m=0,q=k<=h?0:l[k],r=k>=f?0:l[k+1];0!==q&&(m=a[k+n-1]-a[k],p+=0===m?0:q*(c-a[k])/
m);0!==r&&(q=a[k+n],m=q-a[k+1],p+=0===m?0:r*(q-c)/m);g[k]=p}if(n<e)for(k=h;k<=f;k++)l[k]=g[k]}}}};H3DU.BSplineCurve.prototype.evaluate=function(a){var c=this.controlPoints.length,e=this.knots.length-c;a=this.knots[e-1]+a*(this.knots[c]-this.knots[e-1]);H3DU.BSplineCurve._getFactors(this.knots,a,e,c,this.buffer);a=[];var f,g;if(0!==(this.bits&H3DU.BSplineCurve.WEIGHTED_BIT)){var h=0;for(f=0;f<c;f++)h+=this.buffer[f]*this.controlPoints[f][this.cplen];for(var k=0!==(this.bits&H3DU.BSplineCurve.HOMOGENEOUS_BIT),
e=0;e<this.cplen+1;e++){for(f=g=0;f<c;f++){var l=this.buffer[f];k||(l*=this.controlPoints[f][this.cplen]);g+=this.controlPoints[f][e]*l}a[e]=g/h}if(0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)){for(e=0;e<this.cplen;e++)a[e]/=a[this.cplen];a=a.slice(0,this.cplen)}}else{a=[];for(e=0;e<this.cplen;e++){for(f=g=0;f<c;f++)g+=this.controlPoints[f][e]*this.buffer[f];a[e]=g}if(0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)){for(e=0;e<this.cplen-1;e++)a[e]/=a[this.cplen-1];a=a.slice(0,this.cplen-1)}}return a};
H3DU.BSplineSurface=function(a,c,e,f){var g=a.length;if(0>=g)throw Error();var h=a[0].length;if(0>=h)throw Error();var k=a[0][0].length,l=1;this.bits=f||0;0!==(this.bits&(H3DU.BSplineCurve.WEIGHTED_BIT|H3DU.BSplineCurve.DIVIDE_BIT))&&(l=2);0!==(this.bits&(H3DU.BSplineCurve.WEIGHTED_BIT|H3DU.BSplineCurve.HOMOGENEOUS_BIT))&&k--;if(k<l)throw Error();if(!c||!e)throw Error();this.orderU=c.length-h;this.orderV=e.length-g;this.vcplen=g;this.ucplen=h;this.cplen=k;if(2>this.orderU||this.orderU>h)throw Error();
if(2>this.orderV||this.orderV>g)throw Error();H3DU.BSplineCurve._checkKnots(c);H3DU.BSplineCurve._checkKnots(e);this.knotsU=c;this.knotsV=e;this.bufferU=[];this.bufferV=[];this.controlPoints=a};H3DU.BSplineCurve.clamped=function(a,c,e){return new H3DU.BSplineCurve(a,H3DU.BSplineCurve.clampedKnots(a.length,c),e)};H3DU.BSplineCurve.uniform=function(a,c,e){return new H3DU.BSplineCurve(a,H3DU.BSplineCurve.uniformKnots(a.length,c),e)};H3DU.BSplineSurface.clamped=function(a,c,e,f){return new H3DU.BSplineSurface(a,
H3DU.BSplineCurve.clampedKnots(a[0].length,c),H3DU.BSplineCurve.clampedKnots(a.length,e),f)};H3DU.BSplineSurface.uniform=function(a,c,e,f){return new H3DU.BSplineSurface(a,H3DU.BSplineCurve.uniformKnots(a[0].length,c),H3DU.BSplineCurve.uniformKnots(a.length,e),f)};H3DU.BSplineCurve.uniformKnots=function(a,c){"object"===typeof a&&(a=a.length);if(null===c||"undefined"===typeof c)c=3;if(a<c+1)throw Error("too few control points for degree "+c+" curve");for(var e=c+1,f=[],g=0;g<a+e;g++)f.push(g);return f};
H3DU.BSplineCurve.clampedKnots=function(a,c){"object"===typeof a&&(a=a.length);if(null===c||"undefined"===typeof c)c=3;if(a<c+1)throw Error("too few control points for degree "+c+" curve");for(var e=c+1,f=a-e,g=[],h=0;h<e;h++)g.push(0);for(h=0;h<f;h++)g.push(h+1);for(h=0;h<e;h++)g.push(f+1);return g};H3DU.BSplineSurface.prototype.evaluate=function(a,c){a=this.knotsU[this.orderU-1]+a*(this.knotsU[this.ucplen]-this.knotsU[this.orderU-1]);c=this.knotsV[this.orderV-1]+c*(this.knotsV[this.vcplen]-this.knotsV[this.orderV-
1]);var e=this.bufferU,f=this.bufferV,g,h,k,l,n;H3DU.BSplineCurve._getFactors(this.knotsU,a,this.orderU,this.ucplen,this.bufferU);H3DU.BSplineCurve._getFactors(this.knotsV,c,this.orderV,this.vcplen,this.bufferV);var p=[];if(0!==(this.bits&H3DU.BSplineCurve.WEIGHTED_BIT)){var m=0,q=0!==(this.bits&H3DU.BSplineCurve.HOMOGENEOUS_BIT);for(g=0;g<this.ucplen;g++)for(h=0;h<this.vcplen;h++)k=e[g]*f[h]*this.controlPoints[h][g][this.cplen],m+=k;for(l=0;l<this.cplen+1;l++){for(g=m=n=0;g<this.ucplen;g++)for(h=
0;h<this.vcplen;h++)k=e[g]*f[h],q||(k*=this.controlPoints[h][g][this.cplen]),n+=this.controlPoints[h][g][l]*k;p[l]=0===m?n:n/m}if(0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)){for(l=0;l<this.cplen;l++)p[l]/=p[this.cplen];p=p.slice(0,this.cplen)}}else{for(l=0;l<this.cplen;l++){for(g=n=0;g<this.ucplen;g++)for(h=0;h<this.vcplen;h++)n+=this.controlPoints[h][g][l]*e[g]*f[h];p[l]=n}if(0!==(this.bits&H3DU.BSplineCurve.DIVIDE_BIT)){for(l=0;l<this.cplen-1;l++)p[l]/=p[this.cplen-1];p=p.slice(0,this.cplen-1)}}return p};
H3DU.CurveEval=function(){this.vertexCurve=this.texCoordCurve=this.normalCurve=this.colorCurve=null};H3DU.CurveEval.prototype.vertex=function(a){this.vertexCurve=a;return this};H3DU.CurveEval.prototype.normal=function(a){this.normalCurve=a;return this};H3DU.CurveEval.prototype.color=function(a){this.colorCurve=a;return this};H3DU.CurveEval.prototype.texCoord=function(a){this.texCoordCurve=a;return this};H3DU.CurveEval.prototype.evalOne=function(a,c){var e=null,f=null,g=null;this.colorCurve&&(e=this.colorCurve.evaluate(c));
this.texCoordCurve&&(g=this.texCoordCurve.evaluate(c),1===g.length&&g.push(0));this.normalCurve&&(f=this.normalCurve.evaluate(c));if(this.vertexCurve){var h=e?a.color.slice(0,3):null,k=f?a.normal.slice(0,3):null,l=g?a.texCoord.slice(0,2):null;e&&a.color3(e[0],e[1],e[2]);f&&a.normal3(f[0],f[1],f[2]);g&&a.texCoord2(g[0],g[1]);e=this.vertexCurve.evaluate(c);2===e.length?a.vertex3(e[0],e[1],0):a.vertex3(e[0],e[1],e[2]);h&&a.color3(h[0],h[1],h[2]);k&&a.normal3(k[0],k[1],k[2]);l&&a.texCoord2(l[0],l[1])}return this};
H3DU.CurveEval.prototype.evalCurve=function(a,c,e,f,g){"undefined"===typeof e&&(e=24);if(0>=e)throw Error("invalid n");"undefined"===typeof f&&"undefined"===typeof g&&(f=0,g=1);if(null===c||"undefined"===typeof c)c=H3DU.Mesh.LINES;if(c===H3DU.Mesh.POINTS)a.mode(H3DU.Mesh.POINTS);else if(c===H3DU.Mesh.LINES)a.mode(H3DU.Mesh.LINE_STRIP);else return this;c=(g-f)/e;for(g=0;g<=e;g++)this.evalOne(a,f+g*c);return this};H3DU.SurfaceEval=function(){this.vertexSurface=this.texCoordSurface=this.normalSurface=
this.colorSurface=null;this.autoNormal=!1};H3DU.SurfaceEval.prototype.setAutoNormal=function(a){this.autoNormal=!!a;return this};H3DU.SurfaceEval.prototype.vertex=function(a){this.vertexSurface=a;return this};H3DU.SurfaceEval.prototype.normal=function(a){this.normalSurface=a;return this};H3DU.SurfaceEval.prototype.color=function(a){this.colorSurface=a;return this};H3DU.SurfaceEval.prototype.texCoord=function(a){this.texCoordSurface=a;return this};H3DU.SurfaceEval.prototype.evalOne=function(a,c,e){var f=
[];this._saveValues(a,f,0);this._record(c,e,f,8);this._playBack(a,f,8);this._restoreValues(a,f,0);return this};H3DU.SurfaceEval.prototype._recordAndPlayBack=function(a,c,e,f,g){this._record(c,e,f,g);this._playBack(a,f,g)};H3DU.SurfaceEval.prototype._saveValues=function(a,c,e){this.colorSurface&&(c[e+3]=a.color[0],c[e+4]=a.color[1],c[e+5]=a.color[2]);if(this.normalSurface||this.autoNormal)c[e+0]=a.normal[0],c[e+1]=a.normal[1],c[e+2]=a.normal[2];this.texCoordSurface&&(c[e+6]=a.texCoord[0],c[e+7]=a.texCoord[1])};
H3DU.SurfaceEval.prototype._restoreValues=function(a,c,e){this.colorSurface&&a.color3(c[e+3],c[e+4],c[e+5]);(this.normalSurface||this.autoNormal)&&a.normal3(c[e+0],c[e+1],c[e+2]);this.texCoordSurface&&a.texCoord2(c[e+6],c[e+7])};H3DU.SurfaceEval.prototype._record=function(a,c,e,f){var g=null;this.colorSurface&&(g=this.colorSurface.evaluate(a,c),e[f+6]=g[0],e[f+7]=g[1],e[f+8]=g[2]);this.texCoordSurface&&(g=this.texCoordSurface.evaluate(a,c),e[f+9]=g[0],e[f+10]=1>=g.length?0:g[1]);this.normalSurface&&
!this.autoNormal&&(g=this.normalSurface.evaluate(a,c),e[f+3]=g[0],e[f+4]=g[1],e[f+5]=g[2]);if(this.vertexSurface&&(g=this.vertexSurface.evaluate(a,c),e[f]=g[0],e[f+1]=g[1],e[f+2]=g[2],this.autoNormal)){var h=1E-5,k=1E-5,l=this.vertexSurface.evaluate(a+h,c);0===l[0]&&0===l[1]&&0===l[2]&&(h=-h,l=this.vertexSurface.evaluate(a+h,c));var n=this.vertexSurface.evaluate(a,c+k);0===n[0]&&0===n[1]&&0===n[2]&&(k=-k,n=this.vertexSurface.evaluate(a,c+k));H3DU.Math.vec3subInPlace(n,g);H3DU.Math.vec3subInPlace(l,
g);H3DU.Math.vec3scaleInPlace(l,1/h);H3DU.Math.vec3scaleInPlace(n,1/k);H3DU.Math.vec3normInPlace(l);H3DU.Math.vec3normInPlace(n);0===H3DU.Math.vec3length(l)?l=n:0!==H3DU.Math.vec3length(n)?(l=H3DU.Math.vec3cross(l,n),H3DU.Math.vec3normInPlace(l)):l[2]===g[2]&&(l=[0,0,1]);e[f+3]=l[0];e[f+4]=l[1];e[f+5]=l[2]}};H3DU.SurfaceEval.prototype._playBack=function(a,c,e){this.vertexSurface&&(this.colorSurface&&a.color3(c[e+6],c[e+7],c[e+8]),(this.normalSurface||this.autoNormal)&&a.normal3(c[e+3],c[e+4],c[e+
5]),this.texCoordSurface&&a.texCoord2(c[e+9],c[e+10]),a.vertex3(c[e+0],c[e+1],c[e+2]))};H3DU.SurfaceEval.prototype.evalSurface=function(a,c,e,f,g,h,k,l){"undefined"===typeof e&&(e=24);"undefined"===typeof f&&(f=24);if(0>=e)throw Error("invalid un");if(0>=f)throw Error("invalid vn");if(null===c||"undefined"===typeof c)c=H3DU.Mesh.TRIANGLES;"undefined"===typeof k&&"undefined"===typeof l&&(k=0,l=1);"undefined"===typeof g&&"undefined"===typeof h&&(g=0,h=1);h=(h-g)/e;l=(l-k)/f;var n,p,m;if(c===H3DU.Mesh.TRIANGLES){var q=
[],r=[];this._saveValues(a,q,0);for(c=0;c<f;c++)for(a.mode(H3DU.Mesh.TRIANGLE_STRIP),m=n=0;n<=e;n++,m+=11)p=n*h+g,0===c?this._recordAndPlayBack(a,p,c*l+k,q,8):this._playBack(a,r,m),c===f-1?this._recordAndPlayBack(a,p,(c+1)*l+k,q,8):this._recordAndPlayBack(a,p,(c+1)*l+k,r,m);this._restoreValues(a,q,0)}else if(c===H3DU.Mesh.POINTS)for(a.mode(H3DU.Mesh.POINTS),c=0;c<=f;c++)for(n=0;n<=e;n++)p=n*h+g,this.evalOne(a,p,c*l+k);else if(c===H3DU.Mesh.LINES){for(c=0;c<=f;c++)for(a.mode(H3DU.Mesh.LINE_STRIP),
n=0;n<=e;n++)p=n*h+g,this.evalOne(a,p,c*l+k);for(c=0;c<=e;c++)for(a.mode(H3DU.Mesh.LINE_STRIP),n=0;n<=f;n++)this.evalOne(a,c*h+g,n*l+k)}return this};a.H3DU.SurfaceEval=H3DU.SurfaceEval;a.H3DU.CurveEval=H3DU.CurveEval;a.H3DU.BezierCurve=H3DU.BezierCurve;a.H3DU.BezierSurface=H3DU.BezierSurface;a.H3DU.BSplineCurve=H3DU.BSplineCurve;a.H3DU.BSplineSurface=H3DU.BSplineSurface})(this);H3DU.Texture=function(a){this.image=null;this.loadStatus=0;this.name=a;this.width=0;this.clamp=!1;this.height=0};H3DU.Texture.prototype.setClamp=function(a){this.clamp=a;return this};H3DU.Texture.loadTexture=function(a,b){if(b&&b[a])return Promise.resolve(b[a]);var c=new H3DU.Texture(a);b&&(b[a]=c);return c.loadImage().then(function(a){return a},function(a){return Promise.reject(a.name)})};
H3DU.Texture.fromUint8Array=function(a,b,c){if(0>b)throw Error("width less than 0");if(0>c)throw Error("height less than 0");if(a.length<b*c*4)throw Error("array too short for texture");var e=new H3DU.Texture("");e.image=a;e.width=Math.ceil(b);e.height=Math.ceil(c);e.loadStatus=2;return e};
H3DU.Texture.loadTga=function(a){return H3DU.loadFileFromUrl(a,"arraybuffer").then(function(a){var c=new DataView(a.data);c.getUint8(0);c.getUint8(1);var e=c.getUint8(2);if(2!==e&&3!==e)return Promise.reject(Error("unsupported image type"));var f=c.getUint16(8,!0),g=c.getUint16(10,!0);if(0!==f||0!==g)return Promise.reject(Error("unsupported origins"));f=c.getUint16(12,!0);g=c.getUint16(14,!0);if(0===f||0===g)return Promise.reject(Error("invalid width or height"));var h=c.getUint8(16);if(!(32===h&&
2===e||24===h&&2===e||8===h&&3===e))return Promise.reject(Error("unsupported pixelsize"));var k=f*g;if(k>a.data.length)return Promise.reject(Error("size too big"));var l=new Uint8Array(4*k),n=18,p=0;if(32===h&&2===e)for(p=e=0;e<k;e++,p+=4)l[p+2]=c.getUint8(n),l[p+1]=c.getUint8(n+1),l[p]=c.getUint8(n+2),l[p+3]=c.getUint8(n+3),n+=4;else if(24===h&&2===e)for(p=e=0;e<k;e++,p+=4)l[p+2]=c.getUint8(n),l[p+1]=c.getUint8(n+1),l[p]=c.getUint8(n+2),l[p+3]=255,n+=3;else if(8===h&&3===e)for(p=e=0;e<k;e++,p+=4)h=
c.getUint8(n),l[p]=h,l[p+1]=h,l[p+2]=h,l[p+3]=255,n++;a.data=null;return{width:f,height:g,image:l}})};
H3DU.Texture.prototype.loadImage=function(){if(null!==this.image)return Promise.resolve(this);var a=this,b=this.name;a.loadStatus=1;return/\.tga$/i.test(b)?H3DU.Texture.loadTga(b).then(function(b){a.image=b.image;a.width=b.width;a.height=b.height;a.loadStatus=2;return a},function(c){a.loadStatus=-1;return Promise.reject({name:b,error:c})}):new Promise(function(c,e){var f=new Image;f.onload=function(b){b=b.target;a.image=b;a.width=b.width;a.height=b.height;a.loadStatus=2;f.onload=null;f.onerror=null;
c(a)};f.onerror=function(c){a.loadStatus=-1;f.onload=null;f.onerror=null;e({name:b,error:c})};f.src=b})};H3DU.Texture.prototype.dispose=function(){this.height=this.width=0;this.name="";this.image&&("undefined"!==typeof image.onload&&null!==image.onload&&(image.onload=null),"undefined"!==typeof image.onerror&&null!==image.onerror&&(image.onerror=null));this.image=null;this.clamp=!1;this.loadStatus=0};H3DU.Texture.prototype.getName=function(){return name};H3DU.BufferedMesh=function(a,b){b=H3DU._toContext(b);this._bounds=a instanceof H3DU.MeshBuffer?a._bounds:a.getBoundingBox();this._initialize(a,b)};
H3DU.BufferedMesh.prototype._initialize=function(a,b){var c=a instanceof H3DU.MeshBuffer?a:new H3DU.MeshBuffer(a);this.arrayObjectExt=b.getExtension("OES_vertex_array_object");this.arrayObjectExtContext=b;this.smb=c;this.verts=b.createBuffer();if(!this.verts)throw Error("can't create buffer");this.indices=b.createBuffer();if(!this.indices)throw Error("can't create face buffer");this.vao=null;this.arrayObjectExt&&(this.vao=this.arrayObjectExt.createVertexArrayOES());for(var e=null,f=c._getAttributes(),
g=0;g<f.length;g++){var h=f[g][2];if(h&&e&&e!=h)throw Error("Not yet supported");h&&(e=h)}e||(e=new Float32Array([]));b.bindBuffer(b.ARRAY_BUFFER,this.verts);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indices);b.bufferData(b.ARRAY_BUFFER,e,b.STATIC_DRAW);b.bufferData(b.ELEMENT_ARRAY_BUFFER,c.indices,b.STATIC_DRAW);e=b.UNSIGNED_SHORT;4===c.indexBufferSize?e=b.UNSIGNED_INT:1===c.indexBufferSize&&(e=b.UNSIGNED_BYTE);this.type=e;this.context=b;this._lastKnownProgram=null;this._attribLocations=[]};
H3DU.BufferedMesh.prototype._getVaoExtension=function(a){return this.arrayObjectExtContext==a?this.arrayObjectExt:a.getExtension("OES_vertex_array_object")};H3DU.BufferedMesh.prototype._getBounds=function(){return this._bounds};H3DU.BufferedMesh.prototype.getContext=function(){return this.context};H3DU.BufferedMesh.prototype.getFormat=function(){return this.smb.format};
H3DU.BufferedMesh.prototype.dispose=function(){null!==this.verts&&this.context.deleteBuffer(this.verts);null!==this.indices&&this.context.deleteBuffer(this.indices);null!==this.vao&&this.arrayObjectExt.deleteVertexArrayOES(this.vao);this._lastKnownProgram=this.vao=this.smb=this.indices=this.verts=null;this._attribLocations=[]};
H3DU.BufferedMesh.prototype._getAttribLocations=function(a,b){if(this._lastKnownProgram!=a){this._lastKnownProgram=a;var c=this.smb._getAttributes();this._attribLocations=[];for(var e=0;e<c.length;e++){var f=a.get(c[e][0]);null==f&&(f=-1);this._attribLocations[e]=f}return!0}return!1};
H3DU.BufferedMesh.prototype._prepareDraw=function(a,b){var c=this._getAttribLocations(a,b),e=this._getVaoExtension(b);this.vao?e.bindVertexArrayOES(this.vao):c=!0;if(c){b.bindBuffer(b.ARRAY_BUFFER,this.verts);b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,this.indices);c=this.smb._getAttributes();for(e=0;e<this._attribLocations.length;e++){var f=this._attribLocations[e];0<=f&&(b.enableVertexAttribArray(f),b.vertexAttribPointer(f,c[e][3],b.FLOAT,!1,4*c[e][4],4*c[e][1]))}a._disableOthers(c)}};
H3DU.BufferedMesh.prototype.draw=function(a){var b=a.getContext();if(null===this.verts||null===this.face)throw Error("mesh buffer disposed");if(b!==this.context)throw Error("can't bind mesh: context mismatch");this._prepareDraw(a,b);a=b.TRIANGLES;0!==(this.smb.format&H3DU.Mesh.LINES_BIT)&&(a=b.LINES);0!==(this.smb.format&H3DU.Mesh.POINTS_BIT)&&(a=b.POINTS);b.drawElements(a,this.smb.facesLength,this.type,0);b=this._getVaoExtension(b);this.vao&&b.bindVertexArrayOES(null)};
H3DU.BufferedMesh.prototype.vertexCount=function(){return this.smb.numVertices};H3DU.BufferedMesh.prototype.primitiveCount=function(){return this.smb.primitiveCount()};H3DU.BufferedMesh._MeshLoader=function(){this.meshes=[]};
H3DU.BufferedMesh._MeshLoader.prototype.draw=function(a,b){if(a instanceof H3DU.BufferedMesh)a.draw(b);else{for(var c=b.getContext(),e=0;e<this.meshes.length;e++){var f=this.meshes[e];if(f[0]==a&&f[1]==c){f[2].draw(b);return}}e=new H3DU.BufferedMesh(a,b);this.meshes.push([a,c,e]);e.draw(b)}};H3DU.BufferedMesh._MeshLoader.prototype.dispose=function(){for(var a=0;a<this.meshes.length;a++)this.meshes[a][2].dispose();this.meshes=[]};if("undefined"===typeof H3DU||null===H3DU)exports.H3DU={};
H3DU.Math={vec3cross:function(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]]},vec3dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},vec3add:function(a,b){return[a[0]+b[0],a[1]+b[1],a[2]+b[2]]},vec3sub:function(a,b){return[a[0]-b[0],a[1]-b[1],a[2]-b[2]]},vec3negate:function(a){return[-a[0],-a[1],-a[2]]},vec3negateInPlace:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a},vec3mul:function(a,b){return[a[0]*b[0],a[1]*b[1],a[2]*b[2]]},vec3addInPlace:function(a,b){var c=
b[1],e=b[2];a[0]+=b[0];a[1]+=c;a[2]+=e;return a},vec3subInPlace:function(a,b){var c=b[1],e=b[2];a[0]-=b[0];a[1]-=c;a[2]-=e;return a},vec3mulInPlace:function(a,b){var c=b[1],e=b[2];a[0]*=b[0];a[1]*=c;a[2]*=e;return a},vec3scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;return a},vec3scale:function(a,b){return H3DU.Math.vec3scaleInPlace([a[0],a[1],a[2]],b)},vec3lerp:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c]},vec4dot:function(a,b){return a[0]*b[0]+a[1]*b[1]+
a[2]*b[2]+a[3]*b[3]},vec4scaleInPlace:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;return a},vec4lerp:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c,a[2]+(b[2]-a[2])*c,a[3]+(b[3]-a[3])*c]},vec3normInPlace:function(a){var b=a[0],c=a[1],e=a[2],b=Math.sqrt(b*b+c*c+e*e);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b);return a},vec4normInPlace:function(a){var b=a[0],c=a[1],e=a[2],f=a[3],b=Math.sqrt(b*b+c*c+e*e+f*f);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b);return a},vec3norm:function(a){return H3DU.Math.vec3normInPlace([a[0],
a[1],a[2]])},vec4norm:function(a){return H3DU.Math.vec4normInPlace([a[0],a[1],a[2],a[3]])},vec3length:function(a){var b=a[0],c=a[1];a=a[2];return Math.sqrt(b*b+c*c+a*a)},vec4length:function(a){var b=a[0],c=a[1],e=a[2];a=a[3];return Math.sqrt(b*b+c*c+e*e+a*a)},mat3identity:function(){return[1,0,0,0,1,0,0,0,1]},mat4identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},quatIdentity:function(){return[0,0,0,1]},mat4copy:function(a){return a.slice(0,16)},vec3copy:function(a){return a.slice(0,3)},
vec4copy:function(a){return a.slice(0,4)},vec3assign:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},vec4assign:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},mat4isIdentity:function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mat4invert:function(a){var b=a[0]*a[10],c=a[0]*a[11],e=a[0]*a[5],f=a[0]*a[6],g=a[0]*a[7],h=a[0]*a[9],k=a[10]*a[12],l=a[10]*
a[13],n=a[10]*a[15],p=a[11]*a[12],m=a[11]*a[13],q=a[11]*a[14],r=a[1]*a[4],t=a[1]*a[6],u=a[1]*a[7],v=a[1]*a[8],y=a[2]*a[4],B=a[2]*a[5],x=a[2]*a[7],E=a[2]*a[8],A=a[2]*a[9],w=a[3]*a[4],J=a[3]*a[5],C=a[3]*a[6],z=a[3]*a[8],D=a[3]*a[9],K=a[4]*a[9],H=a[5]*a[8],M=a[6]*a[8],N=a[6]*a[9],L=a[7]*a[8],O=a[7]*a[9],G=r-e,F=t-B,I=u-J,P=y-f,e=e-r,t=B-t,B=x-C,r=w-g,u=J-u,x=C-x,f=f-y,y=g-w,g=a[9]*a[12]*x+k*I+p*t+a[8]*a[13]*B+l*r+m*f+a[8]*a[14]*u+a[9]*a[14]*y+q*G+a[8]*a[15]*F+a[9]*a[15]*P+n*e;if(0===g)return H3DU.Math.mat4identity();
g=1/g;w=[];w[0]=a[6]*m-a[7]*l+O*a[14]-a[5]*q-N*a[15]+a[5]*n;w[1]=a[3]*l-a[2]*m-D*a[14]+a[1]*q+A*a[15]-a[1]*n;w[2]=a[13]*B+a[14]*u+a[15]*F;w[3]=a[9]*x+a[10]*I+a[11]*t;w[4]=a[7]*k-a[6]*p-L*a[14]+a[4]*q+M*a[15]-a[4]*n;w[5]=a[2]*p-a[3]*k+a[14]*(z-c)+a[15]*(b-E);w[6]=a[12]*x+a[14]*y+a[15]*P;w[7]=a[8]*B+a[10]*r+a[11]*f;w[8]=a[5]*p-O*a[12]+L*a[13]-a[4]*m+a[15]*(K-H);w[9]=D*a[12]-a[1]*p+a[13]*(c-z)+a[15]*(v-h);w[10]=a[12]*I+a[13]*r+a[15]*e;w[11]=a[8]*u+a[9]*y+a[11]*G;w[12]=N*a[12]-a[5]*k-M*a[13]+a[4]*l+a[14]*
(H-K);w[13]=a[1]*k-A*a[12]+a[13]*(E-b)+a[14]*(h-v);w[14]=a[12]*t+a[13]*f+a[14]*G;w[15]=a[8]*F+a[9]*P+a[10]*e;for(a=0;16>a;a++)w[a]*=g;return w},quatConjugate:function(a){return[-a[0],-a[1],-a[2],a[3]]},quatInvert:function(a){var b=1/H3DU.Math.quatDot(a,a);return H3DU.Math.vec4scaleInPlace(H3DU.Math.quatConjugate(a),b)},quatIsIdentity:function(a){return 0===a[0]&&0===a[1]&&0===a[2]&&1===a[3]},quatToMat4:function(a){var b,c,e,f,g,h,k,l,n;b=2*a[0];c=2*a[1];e=2*a[2];f=b*a[0];g=b*a[1];h=b*a[2];k=c*a[1];
l=e*a[1];n=e*a[2];b*=a[3];c*=a[3];a=e*a[3];return[1-(k+n),g+a,h-c,0,g-a,1-(f+n),l+b,0,h+c,l-b,1-(f+k),0,0,0,0,1]},quatToAxisAngle:function(a){var b=a[3],c=1-b*b;return 0<c?(c=1/Math.sqrt(c),[a[0]*c,a[1]*c,a[2]*c,Math.acos(b)*H3DU.Math.Num360DividedByPi]):[0,1,0,0]},quatFromVectors:function(a,b){var c=H3DU.Math.vec3cross(a,b),e=Math.sqrt(H3DU.Math.vec3dot(a,a))*Math.sqrt(H3DU.Math.vec3dot(b,b));0===e&&(e=1);c[3]=e+H3DU.Math.vec3dot(a,b);return H3DU.Math.quatNormInPlace(c)},quatFromAxisAngle:function(a,
b,c,e){var f;"undefined"!==typeof c&&"undefined"!==typeof e?(f=b,b=e):"undefined"===typeof b?(f=a[0],c=a[1],b=a[2]):(f=b[0],c=b[1],b=b[2]);e=(0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy360;a=Math.cos(e);e=0<=e&&6.283185307179586>e?3.141592653589793>=e?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(e);f=H3DU.Math.vec3normInPlace([f,c,b]);f=[f[0],f[1],f[2],a];f[0]*=e;f[1]*=e;f[2]*=e;return f},quatFromTaitBryan:function(a,b,c,e){var f,g;if(null===e||"undefined"===typeof e)e=H3DU.Math.RollPitchYaw;
if(0>e||6<=e)throw Error("invalid mode");a.constructor===Array?(c=(0<=a[2]&&360>a[2]?a[2]:a[2]%360+(0>a[2]?360:0))*H3DU.Math.PiDividedBy360,f=(0<=a[0]&&360>a[0]?a[0]:a[0]%360+(0>a[0]?360:0))*H3DU.Math.PiDividedBy360,g=(0<=a[1]&&360>a[1]?a[1]:a[1]%360+(0>a[1]?360:0))*H3DU.Math.PiDividedBy360):(c=(0<=c&&360>c?c:c%360+(0>c?360:0))*H3DU.Math.PiDividedBy360,f=(0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy360,g=(0<=b&&360>b?b:b%360+(0>b?360:0))*H3DU.Math.PiDividedBy360);a=Math.cos(f);f=0<=f&&6.283185307179586>
f?3.141592653589793>=f?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(f);b=Math.cos(g);g=0<=g&&6.283185307179586>g?3.141592653589793>=g?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(g);var h=Math.cos(c);c=0<=c&&6.283185307179586>c?3.141592653589793>=c?Math.sqrt(1-h*h):-Math.sqrt(1-h*h):Math.sin(c);var k;e===H3DU.Math.PitchYawRoll||e===H3DU.Math.PitchRollYaw?(k=[c*g,h*g,c*b,h*b],e===H3DU.Math.PitchYawRoll&&(k[0]=-k[0]),e=[k[3]*f+k[0]*a,k[1]*a+k[2]*f,k[2]*a-k[1]*f,k[3]*a-k[0]*f]):e===H3DU.Math.YawPitchRoll||
e===H3DU.Math.YawRollPitch?(k=[h*f,c*f,c*a,h*a],e===H3DU.Math.YawRollPitch&&(k[1]=-k[1]),e=[k[0]*b-k[2]*g,k[3]*g+k[1]*b,k[2]*b+k[0]*g,k[3]*b-k[1]*g]):(k=[b*f,g*a,g*f,b*a],e===H3DU.Math.RollPitchYaw&&(k[2]=-k[2]),e=[k[0]*h+k[1]*c,k[1]*h-k[0]*c,k[3]*c+k[2]*h,k[3]*h-k[2]*c]);return e},quatToTaitBryan:function(a,b){var c=a[3],e,f,g,h=1;if(null===b||"undefined"===typeof b)b=H3DU.Math.RollPitchYaw;if(0>b||6<=b)throw Error("invalid mode");b===H3DU.Math.RollPitchYaw?(e=a[1],f=a[0],g=a[2],h=-1):b===H3DU.Math.PitchYawRoll?
(e=a[2],f=a[1],g=a[0],h=-1):b===H3DU.Math.PitchRollYaw?(e=a[1],f=a[2],g=a[0]):b===H3DU.Math.YawPitchRoll?(e=a[2],f=a[0],g=a[1]):b===H3DU.Math.YawRollPitch?(e=a[0],f=a[2],g=a[1],h=-1):(e=a[0],f=a[1],g=a[2]);var k=f*f,l=Math.atan2(2*(c*e-h*f*g),1-2*(e*e+k)),n=2*(c*f+h*e*g);1<n&&(n=1);-1>n&&(n=-1);n=Math.asin(n);f=Math.atan2(2*(c*g-h*e*f),1-2*(k+g*g));l*=H3DU.Math.Num180DividedByPi;n*=H3DU.Math.Num180DividedByPi;f*=H3DU.Math.Num180DividedByPi;if(1E-6>Math.abs(n-90)||1E-6>Math.abs(n+90))f=0,l=Math.atan2(e,
c)*H3DU.Math.Num180DividedByPi,isNaN(l)&&(l=0);c=[];b===H3DU.Math.RollPitchYaw?(c[0]=n,c[1]=l,c[2]=f):b===H3DU.Math.PitchYawRoll?(c[0]=f,c[1]=n,c[2]=l):b===H3DU.Math.PitchRollYaw?(c[0]=f,c[1]=l,c[2]=n):b===H3DU.Math.YawPitchRoll?(c[0]=n,c[1]=f,c[2]=l):b===H3DU.Math.YawRollPitch?(c[0]=l,c[1]=f,c[2]=n):(c[0]=l,c[1]=n,c[2]=f);return c},quatNlerp:function(a,b,c){var e=1-c,f=a[0]*e,g=a[1]*e,h=a[2]*e,e=a[3]*e,k=b[0]*c,l=b[1]*c,n=b[2]*c;c*=b[3];return 0>a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]?H3DU.Math.quatNormInPlace([f-
k,g-l,h-n,e-c]):H3DU.Math.quatNormInPlace([f+k,g+l,h+n,e+c])},quatSlerp:function(a,b,c){var e=H3DU.Math.quatDot(a,b),f=b;0>e&&(f=[-b[0],-b[1],-b[2],-b[3]],e=H3DU.Math.quatDot(a,f));b=0;if(-1<e)if(1>e){if(b=Math.acos(e),0===b)return f.slice(0,4)}else return f.slice(0,4);else b=Math.PI;var g=1/Math.sin(b),e=Math.sin((1-c)*b)*g;c=Math.sin(c*b)*g;return[a[0]*e+f[0]*c,a[1]*e+f[1]*c,a[2]*e+f[2]*c,a[3]*e+f[3]*c]},quatRotate:function(a,b,c,e,f){return H3DU.Math.quatMultiply(a,H3DU.Math.quatFromAxisAngle(b,
c,e,f))},quatTransform:function(a,b){var c=a[1]*b[2]-a[2]*b[1]+b[0]*a[3],e=a[2]*b[0]-a[0]*b[2]+b[1]*a[3],f=a[0]*b[1]-a[1]*b[0]+b[2]*a[3],g=a[0]*b[0]+a[1]*b[1]+a[2]*b[2];return[c*a[3]-(e*a[2]-f*a[1])+a[0]*g,e*a[3]-(f*a[0]-c*a[2])+a[1]*g,f*a[3]-(c*a[1]-e*a[0])+a[2]*g,1]},quatFromMat4:function(a){var b=[],c=a[1],e=a[2],f=a[4],g=a[6],h=a[8],k=a[9],l=a[0]+a[5]+a[10];0<=l?(a=.5*Math.sqrt(l+1),l=.25/a,b[0]=(g-k)*l,b[1]=(h-e)*l,b[2]=(c-f)*l,b[3]=a):a[0]>a[5]&&a[0]>a[10]?(a=.5*Math.sqrt(1+a[0]-a[5]-a[10]),
l=.25/a,b[0]=a,b[1]=(f+c)*l,b[2]=(e+h)*l,b[3]=(g-k)*l):a[5]>a[10]?(a=.5*Math.sqrt(1+a[5]-a[0]-a[10]),l=.25/a,b[0]=(f+c)*l,b[1]=a,b[2]=(k+g)*l,b[3]=(h-e)*l):(a=.5*Math.sqrt(1+a[10]-a[0]-a[5]),l=.25/a,b[0]=(h+e)*l,b[1]=(k+g)*l,b[2]=a,b[3]=(c-f)*l);return b},mat4toMat3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},mat4transpose:function(a){return H3DU.Math.mat4transposeInPlace(a.slice(0,16))},mat4transposeInPlace:function(a){var b=a[1];a[1]=a[4];a[4]=b;b=a[2];a[2]=a[8];a[8]=b;b=
a[3];a[3]=a[12];a[12]=b;b=a[6];a[6]=a[9];a[9]=b;b=a[7];a[7]=a[13];a[13]=b;b=a[11];a[11]=a[14];a[14]=b;return a},mat4inverseTranspose3:function(a){if(0===a[1]&&0===a[2]&&0===a[4]&&0===a[6]&&0===a[8]&&0===a[9])return 1===a[0]&&1===a[5]&&1===a[10]?[1,0,0,0,1,0,0,0,1]:0!==a[0]*a[5]*a[10]?[1/a[0],0,0,0,1/a[5],0,0,0,1/a[10]]:[1,0,0,0,1,0,0,0,1];a=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]];var b=a[0]*a[4]*a[8]+a[3]*a[7]*a[2]+a[6]*a[1]*a[5]-a[6]*a[4]*a[2]-a[3]*a[1]*a[8]-a[0]*a[7]*a[5];if(0===b)return[1,
0,0,0,1,0,0,0,1];b=1/b;return[(-a[5]*a[7]+a[4]*a[8])*b,(a[5]*a[6]-a[3]*a[8])*b,(-a[4]*a[6]+a[3]*a[7])*b,(a[2]*a[7]-a[1]*a[8])*b,(-a[2]*a[6]+a[0]*a[8])*b,(a[1]*a[6]-a[0]*a[7])*b,(-a[2]*a[4]+a[1]*a[5])*b,(a[2]*a[3]-a[0]*a[5])*b,(-a[1]*a[3]+a[0]*a[4])*b]},mat4scale:function(a,b,c,e){var f;"undefined"!==typeof c&&"undefined"!==typeof e?(f=b,b=e):(f=b[0],c=b[1],b=b[2]);return[a[0]*f,a[1]*f,a[2]*f,a[3]*f,a[4]*c,a[5]*c,a[6]*c,a[7]*c,a[8]*b,a[9]*b,a[10]*b,a[11]*b,a[12],a[13],a[14],a[15]]},mat4scaled:function(a,
b,c){return"undefined"!==typeof b&&"undefined"!==typeof c?[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]:[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,1]},mat4transform:function(a,b,c,e,f){var g;"undefined"!==typeof c&&"undefined"!==typeof e&&"undefined"!==typeof f?(g=b,b=f):(g=b[0],c=b[1],e=b[2],b=b[3]);return[g*a[0]+c*a[4]+e*a[8]+b*a[12],g*a[1]+c*a[5]+e*a[9]+b*a[13],g*a[2]+c*a[6]+e*a[10]+b*a[14],g*a[3]+c*a[7]+e*a[11]+b*a[15]]},mat4transformVec3:function(a,b,c,e){var f;"undefined"!==typeof c&&"undefined"!==typeof e?
(f=b,b=e):(f=b[0],c=b[1],b=b[2]);return[f*a[0]+c*a[4]+b*a[8]+a[12],f*a[1]+c*a[5]+b*a[9]+a[13],f*a[2]+c*a[6]+b*a[10]+a[14],f*a[3]+c*a[7]+b*a[11]+a[15]]},mat3transform:function(a,b,c,e){var f;"undefined"!==typeof c&&"undefined"!==typeof e?(f=b,b=e):(f=b[0],c=b[1],b=b[2]);return[f*a[0]+c*a[3]+b*a[6],f*a[1]+c*a[4]+b*a[7],f*a[2]+c*a[5]+b*a[8]]},mat4translated:function(a,b,c){var e;"undefined"!==typeof b&&"undefined"!==typeof c?(e=a,a=c):(e=a[0],b=a[1],a=a[2]);return[1,0,0,0,0,1,0,0,0,0,1,0,e,b,a,1]},mat4translate:function(a,
b,c,e){var f;"undefined"!==typeof c&&"undefined"!==typeof e?(f=b,b=e):(f=b[0],c=b[1],b=b[2]);return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[0]*f+a[4]*c+a[8]*b+a[12],a[1]*f+a[5]*c+a[9]*b+a[13],a[2]*f+a[6]*c+a[10]*b+a[14],a[3]*f+a[7]*c+a[11]*b+a[15]]},mat4perspective:function(a,b,c,e){a=1/Math.tan((0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy360);var f;f=1/(c-e);return[a/b,0,0,0,0,a,0,0,0,0,f*(c+e),-1,0,0,f*c*e*2,0]},mat4lookat:function(a,b,c){c||(c=[0,1,0]);b||(b=
[0,0,0]);b=[b[0]-a[0],b[1]-a[1],b[2]-a[2]];var e=H3DU.Math.vec3length(b);if(1E-6>e)return H3DU.Math.mat4identity();e=1/e;b[0]*=e;b[1]*=e;b[2]*=e;c=H3DU.Math.vec3norm(c);c=H3DU.Math.vec3cross(b,c);H3DU.Math.vec3normInPlace(c);e=H3DU.Math.vec3cross(c,b);H3DU.Math.vec3normInPlace(e);b[0]=-b[0];b[1]=-b[1];b[2]=-b[2];return[c[0],e[0],b[0],0,c[1],e[1],b[1],0,c[2],e[2],b[2],0,-H3DU.Math.vec3dot(a,c),-H3DU.Math.vec3dot(a,e),-H3DU.Math.vec3dot(a,b),1]},mat4ortho:function(a,b,c,e,f,g){var h=1/(b-a),k=1/(e-
c),l=1/(g-f);return[2*h,0,0,0,0,2*k,0,0,0,0,-2*l,0,-(a+b)*h,-(e+c)*k,-(f+g)*l,1]},mat4perspectiveHorizontal:function(a,b,c,e){return H3DU.Math.mat4perspective(H3DU.Math.Num360DividedByPi*Math.atan2(Math.tan((0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy360),b),b,c,e)},mat4ortho2d:function(a,b,c,e){return H3DU.Math.mat4ortho2d(a,b,c,e,-1,1)},mat4ortho2dAspect:function(a,b,c,e,f){return H3DU.Math.mat4orthoAspect(a,b,c,e,-1,1,f)},mat4orthoAspect:function(a,b,c,e,f,g,h){h/=Math.abs((b-a)/(e-
c));var k=Math.abs(b-a),l=Math.abs(e-c);1>h?(h=l/h,e>c?(c-=.5*(h-l),e+=.5*(h-l)):(e-=.5*(h-l),c+=.5*(h-l))):(h*=k,b>a?(a-=.5*(h-k),b+=.5*(h-k)):(b-=.5*(h-k),a+=.5*(h-k)));return H3DU.Math.mat4ortho(a,b,c,e,f,g)},mat4frustum:function(a,b,c,e,f,g){var h=2*f,k=1/(b-a),l=1/(e-c),n=1/(g-f);return[h*k,0,0,0,0,h*l,0,0,(a+b)*k,(e+c)*l,-(g+f)*n,-1,0,0,-(h*g)*n,0]},mat4scaleInPlace:function(a,b,c,e){var f;"undefined"!==typeof c&&"undefined"!==typeof e?(f=b,b=e):(f=b[0],c=b[1],b=b[2]);a[0]*=f;a[1]*=f;a[2]*=
f;a[3]*=f;a[4]*=c;a[5]*=c;a[6]*=c;a[7]*=c;a[8]*=b;a[9]*=b;a[10]*=b;a[11]*=b;return a},mat4multiply:function(a,b){for(var c=[],e=0;16>e;e+=4)for(var f=0;4>f;f++)c[e+f]=b[e]*a[f]+b[e+1]*a[f+4]+b[e+2]*a[f+8]+b[e+3]*a[f+12];return c},quatMultiply:function(a,b){return[a[3]*b[0]+a[0]*b[3]+a[1]*b[2]-a[2]*b[1],a[3]*b[1]+a[1]*b[3]+a[2]*b[0]-a[0]*b[2],a[3]*b[2]+a[2]*b[3]+a[0]*b[1]-a[1]*b[0],a[3]*b[3]-a[0]*b[0]-a[1]*b[1]-a[2]*b[2]]},mat4rotate:function(a,b,c,e,f){var g,h;"undefined"!==typeof e&&"undefined"!==
typeof f?(g=c,h=e,c=f,f=(0<=b&&360>b?b:b%360+(0>b?360:0))*H3DU.Math.PiDividedBy180):"undefined"===typeof c?(g=b[0],h=b[1],c=b[2],f=b[3],f=(0<=f&&360>f?f:f%360+(0>f?360:0))*H3DU.Math.PiDividedBy180):(g=c[0],h=c[1],c=c[2],f=(0<=b&&360>b?b:b%360+(0>b?360:0))*H3DU.Math.PiDividedBy180);b=Math.cos(f);var k=0<=f&&6.283185307179586>f?3.141592653589793>=f?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(f);if(1===g&&0===h&&0===c)return[a[0],a[1],a[2],a[3],b*a[4]+a[8]*k,b*a[5]+a[9]*k,b*a[6]+a[10]*k,b*a[7]+a[11]*
k,b*a[8]-k*a[4],b*a[9]-k*a[5],b*a[10]-k*a[6],b*a[11]-k*a[7],a[12],a[13],a[14],a[15]];if(0===g&&1===h&&0===c)return[b*a[0]-k*a[8],b*a[1]-k*a[9],b*a[2]-k*a[10],b*a[3]-k*a[11],a[4],a[5],a[6],a[7],b*a[8]+a[0]*k,b*a[9]+a[1]*k,b*a[10]+a[2]*k,b*a[11]+a[3]*k,a[12],a[13],a[14],a[15]];if(0===g&&0===h&&1===c)return[b*a[0]+a[4]*k,b*a[1]+a[5]*k,b*a[2]+a[6]*k,b*a[3]+a[7]*k,b*a[4]-k*a[0],b*a[5]-k*a[1],b*a[6]-k*a[2],b*a[7]-k*a[3],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]];if(0===g&&0===h&&0===c)return a.slice(0,
16);f=1/Math.sqrt(g*g+h*h+c*c);g*=f;h*=f;c*=f;var l=h*h;e=1-b;var n=g*h,p=h*c;f=g*k;h*=k;var m=c*k,k=e*p,q=e*n,r=e*g*c;g=b+e*g*g;n=q+m;p=r-h;l=b+e*l;m=q-m;q=k+f;c=b+e*c*c;b=r+h;f=k-f;return[a[0]*g+a[4]*n+a[8]*p,a[1]*g+a[5]*n+a[9]*p,a[10]*p+a[2]*g+a[6]*n,a[11]*p+a[3]*g+a[7]*n,a[0]*m+a[4]*l+a[8]*q,a[1]*m+a[5]*l+a[9]*q,a[10]*q+a[2]*m+a[6]*l,a[11]*q+a[3]*m+a[7]*l,a[0]*b+a[4]*f+a[8]*c,a[1]*b+a[5]*f+a[9]*c,a[10]*c+a[2]*b+a[6]*f,a[11]*c+a[3]*b+a[7]*f,a[12],a[13],a[14],a[15]]},mat4rotated:function(a,b,c,
e){var f;"undefined"!==typeof c&&"undefined"!==typeof e?(f=b,b=e,e=(0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy180):"undefined"===typeof b?(f=a[0],c=a[1],b=a[2],e=a[3],e=(0<=e&&360>e?e:e%360+(0>e?360:0))*H3DU.Math.PiDividedBy180):(f=b[0],c=b[1],b=b[2],e=(0<=a&&360>a?a:a%360+(0>a?360:0))*H3DU.Math.PiDividedBy180);a=Math.cos(e);var g=0<=e&&6.283185307179586>e?3.141592653589793>=e?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(e);if(1===f&&0===c&&0===b)return[1,0,0,0,0,a,g,0,0,-g,a,0,0,0,0,1];
if(0===f&&1===c&&0===b)return[a,0,-g,0,0,1,0,0,g,0,a,0,0,0,0,1];if(0===f&&0===c&&1===b)return[a,g,0,0,-g,a,0,0,0,0,1,0,0,0,0,1];if(0===f&&0===c&&0===b)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];e=1/Math.sqrt(f*f+c*c+b*b);f*=e;c*=e;b*=e;e=f*f;var h=c*c,k=b*b,l=f*b,n=c*b,p=f*g,m=c*g,g=b*g,q=1-a;f=q*f*c;c=q*l;b=q*n;return[a+q*e,f+g,c-m,0,f-g,a+q*h,b+p,0,c+m,b-p,a+q*k,0,0,0,0,1]}};
H3DU.Math.planeNormInPlace=function(a){var b=a[0],c=a[1],e=a[2],b=Math.sqrt(b*b+c*c+e*e);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b);return a};H3DU.Math.planeNorm=function(a){return H3DU.Math.planeNormInPlace(a.slice(0,4))};
H3DU.Math.mat4toFrustumPlanes=function(a){var b=[[],[],[],[],[],[]];b[0]=H3DU.Math.planeNormInPlace([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]]);b[1]=H3DU.Math.planeNormInPlace([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]]);b[2]=H3DU.Math.planeNormInPlace([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]]);b[3]=H3DU.Math.planeNormInPlace([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]]);b[4]=H3DU.Math.planeNormInPlace([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]]);b[5]=H3DU.Math.planeNormInPlace([a[3]-a[2],
a[7]-a[6],a[11]-a[10],a[15]-a[14]]);return b};H3DU.Math.frustumHasSphere=function(a,b,c,e,f){if(0>f)throw Error("radius is negative");for(var g=0;6>g;g++){var h=a[g];if(h[3]+h[0]*b+h[1]*c+h[2]*e<-f)return!1}return!0};H3DU.Math.boxIsEmpty=function(a){return!(a[0]<=a[3]&&a[1]<=a[4]&&a[2]<=a[5])};
H3DU.Math.frustumHasBox=function(a,b){if(H3DU.Math.boxIsEmpty(b))return!1;for(var c=0;6>c;c++){var e=a[c],f=e[3],g=e[0]*b[0],h=e[2]*b[2],k=e[1]*b[1];if(0>=g+k+h+f&&0>=e[0]*b[3]+e[1]*b[4]+e[2]*b[5]+f&&0>=g+e[1]*b[4]+h+f&&0>=g+e[1]*b[4]+e[2]*b[5]+f&&0>=g+k+e[2]*b[5]+f&&0>=e[0]*b[3]+e[1]*b[4]+h+f&&0>=e[0]*b[3]+k+h+f&&0>=e[0]*b[3]+k+e[2]*b[5]+f)return!1}return!0};H3DU.Math.frustumHasPoint=function(a,b,c,e){for(var f=0;6>f;f++)if(0>=a[f][0]*b+a[f][1]*c+a[f][2]*e+a[f][3])return!1;return!0};
H3DU.Math.quatDot=H3DU.Math.vec4dot;H3DU.Math.quatNormInPlace=H3DU.Math.vec4normInPlace;H3DU.Math.quatNorm=H3DU.Math.vec4norm;H3DU.Math.quatLength=H3DU.Math.vec4length;H3DU.Math.quatScaleInPlace=H3DU.Math.vec4scaleInPlace;H3DU.Math.quatCopy=H3DU.Math.vec4copy;H3DU.Math.PiTimes2=6.283185307179586;H3DU.Math.HalfPi=1.5707963267948966;H3DU.Math.PiDividedBy180=.017453292519943295;H3DU.Math.PiDividedBy360=.008726646259971648;H3DU.Math.Num360DividedByPi=114.59155902616465;H3DU.Math.Num180DividedByPi=57.29577951308232;
H3DU.Math.PitchYawRoll=0;H3DU.Math.PitchRollYaw=1;H3DU.Math.YawPitchRoll=2;H3DU.Math.YawRollPitch=3;H3DU.Math.RollPitchYaw=4;H3DU.Math.RollYawPitch=5;H3DU.Math.quatInverse=H3DU.Math.quatInvert;H3DU.RenderPass3D=function(a,b){this.subScene=a;this.clearStencil=this.clearDepth=this.clearColor=!0;this.frameBuffer=null;this.setParams(b)};H3DU.RenderPass3D.prototype.setParams=function(a){a&&("undefined"!==typeof a.clearColor&&(this.clearColor=a.clearColor),"undefined"!==typeof a.clearDepth&&(this.clearDepth=a.clearDepth),"undefined"!==typeof a.clearStencil&&(this.clearStencil=a.clearStencil),"undefined"!==typeof a.frameBuffer&&(this.frameBuffer=a.frameBuffer))};H3DU.ShapeGroup=function(){this.shapes=[];this.parent=null;this.visible=!0;this.transform=new H3DU.Transform};H3DU.ShapeGroup.prototype.addShape=function(a){a.parent=this;this.shapes.push(a);return this};H3DU.ShapeGroup.prototype.setVisible=function(a){this.visible=!!a;return this};H3DU.ShapeGroup.prototype.getVisible=function(){return this.visible};H3DU.ShapeGroup.prototype.getTransform=function(){return this.transform};
H3DU.ShapeGroup.prototype.getMatrix=function(){var a=this.getTransform(),b=a.isIdentity();if(null!==this.parent)var c=this.parent.getMatrix(),a=b?H3DU.Math.mat4multiply(c,a.getMatrix()):H3DU.Math.mat4isIdentity(c)?a.getMatrix():c;else a=a.getMatrix();return a};H3DU.ShapeGroup.prototype.setTransform=function(a){this.transform=a.copy();return this};H3DU.ShapeGroup.prototype.setMaterial=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setMaterial(a);return this};
H3DU.ShapeGroup.prototype.setTexture=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setTexture(a);return this};H3DU.ShapeGroup.prototype.setShader=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setShader(a);return this};H3DU.ShapeGroup.prototype.setMaterialParams=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setMaterialParams(a);return this};
H3DU.ShapeGroup.prototype.removeShape=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b]===a&&(this.shapes.splice(b,1),b--);return this};
H3DU.ShapeGroup.prototype.getBounds=function(){for(var a=[0,0,0,0,0,0],b=!0,c=0;c<this.shapes.length;c++){var e=this.shapes[c].getBounds();H3DU.Math.boxIsEmpty(e)||(b?(a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],a[4]=e[4],a[5]=e[5],b=!1):(a[0]=Math.min(e[0],a[0]),a[1]=Math.min(e[1],a[1]),a[2]=Math.min(e[2],a[2]),a[3]=Math.max(e[3],a[3]),a[4]=Math.max(e[4],a[4]),a[5]=Math.max(e[5],a[5])))}return b?[0,0,0,-1,-1,-1]:a};
H3DU.ShapeGroup.prototype.vertexCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].vertexCount();return a};H3DU.ShapeGroup.prototype.primitiveCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].primitiveCount();return a};H3DU.ShapeGroup.prototype.setPosition=function(a,b,c){this.transform.setPosition(a,b,c);return this};H3DU.ShapeGroup.prototype.setQuaternion=function(a){this.transform.setQuaternion(a);return this};
H3DU.ShapeGroup.prototype.setScale=function(a,b,c){this.transform.setScale(a,b,c);return this};H3DU.Mesh=function(a,b,c){this._initialize(a,b,c);this._elementsDefined=0;this.currentMode=-1;this.normal=[0,0,0];this.color=[0,0,0];this.tangent=[0,0,0];this.bitangent=[0,0,0];this.texCoord=[0,0]};H3DU.Mesh._primitiveType=function(a){return a===H3DU.Mesh.LINES||a===H3DU.Mesh.LINE_STRIP?H3DU.Mesh.LINES:a===H3DU.Mesh.POINTS?H3DU.Mesh.POINTS:H3DU.Mesh.TRIANGLES};H3DU.Mesh._isCompatibleMode=function(a,b){return a===b||H3DU.Mesh._primitiveType(a)===H3DU.Mesh._primitiveType(b)?!0:!1};
H3DU.Mesh._recalcNormalsStart=function(a,b,c,e,f,g){for(c=0;c<a.length;c+=e)if(a[c+f]=0,a[c+f+1]=0,a[c+f+2]=0,!g){var h=[a[c],a[c+1],a[c+2]];b[h]?b[h].push(c+f):b[h]=[c+f]}};
H3DU.Mesh._recalcNormalsFinish=function(a,b,c,e,f,g){c=[];var h=0;if(!g)for(var k in b){var l=b[k];if(l&&l.constructor===Array&&2<=l.length){g=l[0];var n=a[g],p=a[g+1],m=a[g+2];c[0]=n;c[1]=p;c[2]=m;h=3;for(g=1;g<l.length;g++){for(var q=!1,r=a[l[g]],t=a[l[g]+1],u=a[l[g]+2],v=0;v<h;v+=3)if(r===c[v]&&t===c[v+1]&&u===c[v+2]){q=!0;break}q||(c[h++]=r,c[h++]=t,c[h++]=u,n+=r,p+=t,m+=u)}for(g=0;g<l.length;g++)a[l[g]]=n,a[l[g]+1]=p,a[l[g]+2]=m}}for(g=0;g<a.length;g+=e)if(k=a[g+f],c=a[g+f+1],h=a[g+f+2],b=Math.sqrt(k*
k+c*c+h*h))b=1/b,a[g+f]=k*b,a[g+f+1]=c*b,a[g+f+2]=h*b};
H3DU.Mesh._recalcNormals=function(a,b,c,e,f,g){g=g?-1:1;var h={},k;H3DU.Mesh._recalcNormalsStart(a,h,b,c,e,f);for(var l=0;l<b.length;l+=3){var n=b[l]*c,p=b[l+1]*c,m=b[l+2]*c;k=[a[n]-a[m],a[n+1]-a[m+1],a[n+2]-a[m+2]];var q=[a[p]-a[m],a[p+1]-a[m+1],a[p+2]-a[m+2]],r=k[1]*q[2]-k[2]*q[1],t=k[2]*q[0]-k[0]*q[2],q=k[0]*q[1]-k[1]*q[0];k=Math.sqrt(r*r+t*t+q*q);0!==k&&(k=1/k,k*=g,r*=k,t*=k,q*=k,a[n+e]+=r,a[n+e+1]+=t,a[n+e+2]+=q,a[p+e]+=r,a[p+e+1]+=t,a[p+e+2]+=q,a[m+e]+=r,a[m+e+1]+=t,a[m+e+2]+=q)}H3DU.Mesh._recalcNormalsFinish(a,
h,b,c,e,f)};H3DU.Mesh.prototype.mode=function(a){if(0>a)throw Error("invalid mode");if(-1===this.currentMode){var b=0,c=H3DU.Mesh._primitiveType(a);c===H3DU.Mesh.LINES?b|=H3DU.Mesh.LINES_BIT:c===H3DU.Mesh.POINTS&&(b|=H3DU.Mesh.POINTS_BIT);this._initialize([],[],b);this.currentMode=a}else if(H3DU.Mesh._isCompatibleMode(this.currentMode,a))this.newPrimitive(),this.currentMode=a;else throw Error("Storing a different primitive mode in this mesh is no longer supported");return this};
H3DU.Mesh.prototype.merge=function(a){if(!H3DU.Mesh._isCompatibleMode(this.currentMode,a.currentMode))throw Error("Meshes have incompatible types");var b=this.vertexCount(),c=this.indices.length;this.vertices.push.apply(this.vertices,a.vertices);this.indices.push.apply(this.indices,a.indices);for(i=c;i<this.indices.length;i++)this.indices[i]+=b;this.newPrimitive();return this};
H3DU.Mesh.prototype.normal3=function(a,b,c){"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.normal[0]=a,this.normal[1]=b,this.normal[2]=c):(this.normal[0]=a[0],this.normal[1]=a[1],this.normal[2]=a[2]);this._elementsDefined|=H3DU.Mesh.NORMALS_BIT;return this};
H3DU.Mesh.prototype.tangent3=function(a,b,c){"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.tangent[0]=a,this.tangent[1]=b,this.tangent[2]=c):(this.tangent[0]=a[0],this.tangent[1]=a[1],this.tangent[2]=a[2]);this._elementsDefined|=H3DU.Mesh.TANGENTS_BIT;return this};
H3DU.Mesh.prototype.bitangent3=function(a,b,c){"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.bitangent[0]=a,this.bitangent[1]=b,this.bitangent[2]=c):(this.bitangent[0]=a[0],this.bitangent[1]=a[1],this.bitangent[2]=a[2]);this._elementsDefined|=H3DU.Mesh.BITANGENTS_BIT;return this};
H3DU.Mesh.prototype.color3=function(a,b,c){"string"===typeof a?(a=H3DU.toGLColor(a),this.color[0]=a[0],this.color[1]=a[1],this.color[2]=a[2]):"number"===typeof a&&"number"===typeof b&&"number"===typeof c?(this.color[0]=a,this.color[1]=b,this.color[2]=c):(this.color[0]=a[0],this.color[1]=a[1],this.color[2]=a[2]);this._elementsDefined|=H3DU.Mesh.COLORS_BIT;return this};
H3DU.Mesh.prototype.texCoord2=function(a,b){"number"===typeof a&&"number"===typeof b?(this.texCoord[0]=a,this.texCoord[1]=b):(this.texCoord[0]=a[0],this.texCoord[1]=a[1]);this._elementsDefined|=H3DU.Mesh.TEXCOORDS_BIT;return this};H3DU.Mesh.prototype.vertex3=function(a,b,c){null===a||"undefined"===typeof a||null!==b&&"undefined"!==typeof b||null!==c&&"undefined"!==typeof c?this._vertex3(a,b,c,this):"number"!==typeof a?this._vertex3(a[0],a[1],a[2],this):this._vertex3(a,a,a,this);return this};
H3DU.Mesh.prototype.vertex2=function(a,b){return null===a||"undefined"===typeof a||null!==b&&"undefined"!==typeof b?this.vertex3(a,b,0):"number"!==typeof a?this.vertex3(a[0],a[1],0):this.vertex3(a,a,0)};H3DU.Mesh.prototype.setColor3=function(a,b,c){"string"===typeof a&&H3DU.toGLColor(a);this._rebuildVertices(H3DU.Mesh.COLORS_BIT);for(var e=this.getStride(),f=H3DU.Mesh._colorOffset(this.attributeBits);f<this.vertices.length;f+=e)this.vertices[f]=a,this.vertices[f+1]=b,this.vertices[f+2]=c;return this};
H3DU.Mesh.prototype.normalizeNormals=function(){var a=this.getStride(),b=this.vertices,c=H3DU.Mesh._normalOffset(this.attributeBits);if(0>c)return this;for(i=0;i<b.length;i+=a){var e=b[i+c],f=b[i+c+1],g=b[i+c+2],e=Math.sqrt(e*e+f*f+g*g);0!==e&&(e=1/e,b[i+c]*=e,b[i+c+1]*=e,b[i+c+2]*=e)}return this};
H3DU.Mesh.prototype.setVertex=function(a,b,c,e){if(0>a)return this;"undefined"===typeof c&&"undefined"===typeof e&&(c=b[1],e=b[2],b=b[0]);var f=this.vertexCount();a<f&&(a*=this.getStride(),this.vertices[a]=b,this.vertices[a+1]=c,this.vertices[a+2]=e);return this};
H3DU.Mesh.prototype.setVertexNormal=function(a,b,c,e){if(0>a)return this;"undefined"===typeof c&&"undefined"===typeof e&&(c=b[1],e=b[2],b=b[0]);var f=this.vertexCount();a<f&&(this._rebuildVertices(H3DU.Mesh.NORMALS_BIT),a*=this.getStride(),a+=H3DU.Mesh._normalOffset(this.attributeBits),this.vertices[a]=b,this.vertices[a+1]=c,this.vertices[a+2]=e);return this};
H3DU.Mesh.prototype.getVertex=function(a){if(0>a)return null;var b=this.vertexCount();return a<b?(this._rebuildVertices(H3DU.Mesh.NORMALS_BIT),a*=this.getStride(),this.vertices.slice(a,a+3)):null};H3DU.Mesh.prototype.getVertexNormal=function(a){var b=this.vertexCount();return a<b?(this._rebuildVertices(H3DU.Mesh.NORMALS_BIT),a*=this.getStride(),a+=H3DU.Mesh._normalOffset(this.attributeBits),this.vertices.slice(a,a+3)):null};
H3DU.Mesh.prototype._initialize=function(a,b,c){this.vertices=a||[];this.indices=b||[];this.startIndex=0;a=c&H3DU.Mesh.PRIMITIVES_BITS;if(0!==a&&a!==H3DU.Mesh.LINES_BIT&&a!==H3DU.Mesh.POINTS_BIT)throw Error("invalid format");this.attributeBits=null===c||"undefined"===typeof c?0:c;this.vertexCount=function(){return this.vertices.length/this.getStride()};this.getStride=function(){return H3DU.Mesh._getStride(this.attributeBits)};this.newPrimitive=function(a){this.startIndex=this.vertices.length;return this};
this.primitiveType=function(){var a=H3DU.Mesh.TRIANGLES;0!==(this.attributeBits&H3DU.Mesh.LINES_BIT)&&(a=H3DU.Mesh.LINES);0!==(this.attributeBits&H3DU.Mesh.POINTS_BIT)&&(a=H3DU.Mesh.POINTS);return a};this._rebuildVertices=function(a){var b=this.attributeBits;a=b|a&H3DU.Mesh.ATTRIBUTES_BITS;if(a!==b){for(var c=this.getStride(),h,k,l,n=[],p=0;p<this.vertices.length;p+=c){var m=p+3;n.push(this.vertices[p],this.vertices[p+1],this.vertices[p+2]);0!==(a&H3DU.Mesh.NORMALS_BIT)&&(0!==(b&H3DU.Mesh.NORMALS_BIT)?
(h=this.vertices[m],k=this.vertices[m+1],l=this.vertices[m+2],m+=3,n.push(h,k,l)):n.push(0,0,0));0!==(a&H3DU.Mesh.COLORS_BIT)&&(0!==(b&H3DU.Mesh.COLORS_BIT)?(h=this.vertices[m],k=this.vertices[m+1],l=this.vertices[m+2],m+=3,n.push(h,k,l)):n.push(0,0,0));0!==(a&H3DU.Mesh.TEXCOORDS_BIT)&&(0!==(b&H3DU.Mesh.TEXCOORDS_BIT)?(h=this.vertices[m],k=this.vertices[m+1],m+=2,n.push(h,k)):n.push(0,0));0!==(a&H3DU.Mesh.TANGENTS_BIT)&&(0!==(b&H3DU.Mesh.TANGENTS_BIT)?(h=this.vertices[m],k=this.vertices[m+1],l=this.vertices[m+
2],m+=3,n.push(h,k,l)):n.push(0,0,0));0!==(a&H3DU.Mesh.BITANGENTS_BIT)&&(0!==(b&H3DU.Mesh.BITANGENTS_BIT)?(h=this.vertices[m],k=this.vertices[m+1],l=this.vertices[m+2],n.push(h,k,l)):n.push(0,0,0))}this.vertices=n;this.attributeBits=a}};this._setTriangle=function(a,b,c,h,k){var l=c*b,n=h*b,p=k*b,m=0,q=this.vertices;for(a-=b;0<=a&&16>m;a-=b,m++){for(var r=7,t=0;t<b&&0!==r;t++)0!==(r&1)&&q[l+t]!==q[a+t]&&(r&=-2),0!==(r&2)&&q[n+t]!==q[a+t]&&(r&=-3),0!==(r&4)&&q[p+t]!==q[a+t]&&(r&=-5);if(0!==(r&1)){c=
a/b;l=c*b;break}if(0!==(r&2)){h=a/b;n=h*b;break}if(0!==(r&4)){k=a/b;p=k*b;break}}q[l]===q[n]&&q[l+1]===q[n+1]&&q[l+2]===q[n+2]||q[l]===q[p]&&q[l+1]===q[p+1]&&q[l+2]===q[p+2]||q[n]===q[p]&&q[n+1]===q[p+1]&&q[n+2]===q[p+2]||this.indices.push(c,h,k)};this._vertex3=function(a,b,c,h){var k=this.currentMode;if(-1===k)throw Error("mode() not called");this._rebuildVertices(this._elementsDefined);h=this.vertices.length;this.vertices.push(a,b,c);0!==(this.attributeBits&H3DU.Mesh.NORMALS_BIT)&&this.vertices.push(this.normal[0],
this.normal[1],this.normal[2]);0!==(this.attributeBits&H3DU.Mesh.COLORS_BIT)&&this.vertices.push(this.color[0],this.color[1],this.color[2]);0!==(this.attributeBits&H3DU.Mesh.TEXCOORDS_BIT)&&this.vertices.push(this.texCoord[0],this.texCoord[1]);0!==(this.attributeBits&H3DU.Mesh.TANGENTS_BIT)&&this.vertices.push(this.tangent[0],this.tangent[1],this.tangent[2]);0!==(this.attributeBits&H3DU.Mesh.BITANGENTS_BIT)&&this.vertices.push(this.bitangent[0],this.bitangent[1],this.bitangent[2]);a=this.getStride();
k===H3DU.Mesh.QUAD_STRIP&&this.vertices.length-this.startIndex>=4*a&&0===(this.vertices.length-this.startIndex)%(2*a)?(b=this.vertices.length/a-4,this._setTriangle(h,a,b,b+1,b+2),this._setTriangle(h,a,b+2,b+1,b+3)):k===H3DU.Mesh.QUADS&&0===(this.vertices.length-this.startIndex)%(4*a)?(b=this.vertices.length/a-4,this._setTriangle(h,a,b,b+1,b+2),this._setTriangle(h,a,b,b+2,b+3)):k===H3DU.Mesh.TRIANGLES&&0===(this.vertices.length-this.startIndex)%(3*a)?(b=this.vertices.length/a-3,this._setTriangle(h,
a,b,b+1,b+2)):k===H3DU.Mesh.LINES&&0===(this.vertices.length-this.startIndex)%(2*a)?(b=this.vertices.length/a-2,this.indices.push(b,b+1)):k===H3DU.Mesh.TRIANGLE_FAN&&this.vertices.length-this.startIndex>=3*a?(b=this.vertices.length/a-2,c=this.startIndex/a,this._setTriangle(h,a,c,b,b+1)):k===H3DU.Mesh.LINE_STRIP&&this.vertices.length-this.startIndex>=2*a?(b=this.vertices.length/a-2,this.indices.push(b,b+1)):k===H3DU.Mesh.POINTS?(b=this.vertices.length/a-1,this.indices.push(b)):k===H3DU.Mesh.TRIANGLE_STRIP&&
this.vertices.length-this.startIndex>=3*a&&(b=this.vertices.length/a-3,c=this.startIndex/a,0===(b-c&1)?this._setTriangle(h,a,b,b+1,b+2):this._setTriangle(h,a,b+1,b,b+2));return this}};H3DU.Mesh.prototype._makeRedundant=function(){for(var a=[],b=this.getStride(),c=this.indices.length,e=0;e<c;e++){var f=this.indices[e];if(a[f]){for(var g=f*b,h=this.vertices.length/b,k=0;k<b;k++)this.vertices.push(this.vertices[g+k]);this.indices[e]=h}a[f]=!0}return this};
H3DU.Mesh.prototype.primitiveCount=function(){return 0!==(this.attributeBits&H3DU.Mesh.LINES_BIT)?Math.floor(this.indices.length/2):0!==(this.attributeBits&H3DU.Mesh.POINTS_BIT)?this.indices.length:Math.floor(this.indices.length/3)};H3DU.Mesh._addLine=function(a,b,c,e){if(c<e){var f=c;c=e;e=f}(f=b[c])?0>f.indexOf(e)&&(f.push(e),a.push(c,e)):(b[c]=[e],a.push(c,e))};
H3DU.Mesh.prototype.toWireFrame=function(){if(0!==(this.attributeBits&H3DU.Mesh.PRIMITIVES_BITS))return this;for(var a=[],b={},c=0;c<this.indices.length;c+=3){var e=this.indices[c],f=this.indices[c+1],g=this.indices[c+2];H3DU.Mesh._addLine(a,b,e,f);H3DU.Mesh._addLine(a,b,f,g);H3DU.Mesh._addLine(a,b,g,e)}return new H3DU.Mesh(this.vertices,a,this.attributeBits|H3DU.Mesh.LINES_BIT)};
H3DU.Mesh._isIdentityInUpperLeft=function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[8]&&0===a[9]&&1===a[10]?!0:!1};
H3DU.Mesh.prototype.transform=function(a){var b=this.getStride(),c=this.vertices,e=!H3DU.Mesh._isIdentityInUpperLeft(a),f=H3DU.Mesh._normalOffset(this.attributeBits),g=null;0<=f&&e&&(g=H3DU.Math.mat4inverseTranspose3(a));for(var h=0;h<c.length;h+=b){var k=H3DU.Math.mat4transform(a,c[h],c[h+1],c[h+2],1);c[h]=k[0];c[h+1]=k[1];c[h+2]=k[2];0<=f&&e&&(k=H3DU.Math.mat3transform(g,c[h+f],c[h+f+1],c[h+f+2]),H3DU.Math.vec3normInPlace(k),c[h+f]=k[0],c[h+f+1]=k[1],c[h+f+2]=k[2])}this.newPrimitive();return this};
H3DU.Mesh.prototype.enumPrimitives=function(a){var b=this.primitiveType(),c=H3DU.Mesh._normalOffset(this.attributeBits),e=H3DU.Mesh._colorOffset(this.attributeBits),f=H3DU.Mesh._texCoordOffset(this.attributeBits),g=this.getStride(),h=this.vertices,k=3;b===H3DU.Mesh.LINES&&(k=2);b===H3DU.Mesh.POINTS&&(k=1);for(b=0;b<this.indices.length;b+=k){for(var l=[],n=0;n<k;n++){var p=this.indices[b+n]*g,m={};m.position=[h[p],h[p+1],h[p+2]];0<=c&&(m.normal=[h[p+c],h[p+c+1],h[p+c+2]]);0<=e&&(m.color=[h[p+e],h[p+
e+1],h[p+e+2]]);0<=f&&(m.uv=[h[p+f],h[p+f+1]]);l.push(m)}a(l)}return this};H3DU.Mesh.prototype.getBoundingBox=function(){for(var a=!0,b=Number.POSITIVE_INFINITY,b=[b,b,b,-b,-b,-b],c=this.getStride(),e=this.vertices,f=0;f<this.indices.length;f++){var g=this.indices[f]*c;a?(a=!1,b[0]=b[3]=e[g],b[1]=b[4]=e[g+1],b[2]=b[5]=e[g+2]):(b[0]=Math.min(b[0],e[g]),b[3]=Math.max(b[3],e[g]),b[1]=Math.min(b[1],e[g+1]),b[4]=Math.max(b[4],e[g+1]),b[2]=Math.min(b[2],e[g+2]),b[5]=Math.max(b[5],e[g+2]))}return b};
H3DU.Mesh._findTangentAndBitangent=function(a,b,c,e,f){var g=a[c]-a[b],h=a[c+1]-a[b+1],k=a[c+2]-a[b+2],l=a[e]-a[b],n=a[e+1]-a[b+1],p=a[e+2]-a[b+2],m=a[c+f]-a[b+f],q=a[c+f+1]-a[b+f+1];c=a[e+f]-a[b+f];a=a[e+f+1]-a[b+f+1];b=m*a-q*c;if(0===b)return[0,0,0,0,0,0];b=1/b;q=-q;c=-c;return[(a*g+q*l)*b,(a*h+q*n)*b,(a*k+q*p)*b,(c*g+m*l)*b,(c*h+m*n)*b,(c*k+m*p)*b]};
H3DU.Mesh._recalcTangentsInternal=function(a,b,c,e,f,g){for(var h=[0,0,0],k=0;k<b.length;k+=3){h[0]=b[k]*c;h[1]=b[k+1]*c;h[2]=b[k+2]*c;for(var l=H3DU.Mesh._findTangentAndBitangent(a,h[0],h[1],h[2],e),n=0;3>n;n++){var p=l,m=h[n],q=a[m+f],r=a[m+f+1],t=a[m+f+2],u=p[0]*q+p[1]*r+p[2]*t,u=H3DU.Math.vec3normInPlace([p[0]-u*q,p[1]-u*r,p[2]-u*t]),v=p[3]*q+p[4]*r+p[5]*t,y=p[3]*u[0]+p[4]*u[1]+p[5]*u[2],p=H3DU.Math.vec3normInPlace([p[3]-v*q-y*u[0],p[4]-v*r-y*u[1],p[5]-v*t-y*u[2]]);a[m+g]=u[0];a[m+g+1]=u[1];a[m+
g+2]=u[2];a[m+g+3]=p[0];a[m+g+4]=p[1];a[m+g+5]=p[2]}}};
H3DU.Mesh.prototype.recalcTangents=function(){if(this.primitiveType()!==H3DU.Mesh.TRIANGLES)return this;var a=H3DU.Mesh.TANGENTS_BIT|H3DU.Mesh.BITANGENTS_BIT,b=0!==(this.attributeBits&H3DU.Mesh.ATTRIBUTES_BITS&~a),c=H3DU.Mesh._texCoordOffset(this.attributeBits),e=H3DU.Mesh._normalOffset(this.attributeBits);if(0>c||0>e)return this;this._rebuildVertices(a);b&&this._makeRedundant();this.primitiveType()===H3DU.Mesh.TRIANGLES&&(a=H3DU.Mesh._tangentOffset(this.attributeBits),H3DU.Mesh._recalcTangentsInternal(this.vertices,
this.indices,this.getStride(),c,e,a));return this};H3DU.Mesh.prototype.reverseNormals=function(){var a=this.getStride(),b=this.vertices,c=H3DU.Mesh._normalOffset(this.attributeBits);if(0>c)return this;for(i=0;i<b.length;i+=a){var e=b[i+c+1],f=b[i+c+2];b[i+c]=-b[i+c];b[i+c+1]=-e;b[i+c+2]=-f}return this};
H3DU.Mesh.prototype.reverseWinding=function(){if(0!==(this.attributeBits&H3DU.Mesh.PRIMITIVES_BITS))return this;for(var a=0;a<this.indices.length;a+=3){var b=this.indices[a+2];this.indices[a+2]=this.indices[a+1];this.indices[a+1]=b}return this};
H3DU.Mesh.prototype.recalcNormals=function(a,b){var c=this.primitiveType();c!==H3DU.Mesh.LINES&&c!==H3DU.Mesh.POINTS&&(c=0!==(this.attributeBits&H3DU.Mesh.ATTRIBUTES_BITS&~H3DU.Mesh.NORMALS_BIT),this._rebuildVertices(H3DU.Mesh.NORMALS_BIT),(c||a)&&this._makeRedundant(),H3DU.Mesh._recalcNormals(this.vertices,this.indices,this.getStride(),3,a,b));return this};
H3DU.Mesh._getStride=function(a){var b=[3,6,6,9,5,8,8,11][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)];0!==(a&H3DU.Mesh.TANGENTS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.BITANGENTS_BIT)&&(b+=3);return b};H3DU.Mesh._normalOffset=function(a){return[-1,3,-1,3,-1,3,-1,3][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)]};
H3DU.Mesh._tangentOffset=function(a){var b=3;if(0===(a&H3DU.Mesh.TANGENTS_BIT))return-1;0!==(a&H3DU.Mesh.NORMALS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.COLORS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.TEXCOORDS_BIT)&&(b+=2);return b};H3DU.Mesh._bitangentOffset=function(a){var b=3;if(0===(a&H3DU.Mesh.BITANGENTS_BIT))return-1;0!==(a&H3DU.Mesh.NORMALS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.COLORS_BIT)&&(b+=3);0!==(a&H3DU.Mesh.TEXCOORDS_BIT)&&(b+=2);0!==(a&H3DU.Mesh.TANGENTS_BIT)&&(b+=3);return b};
H3DU.Mesh._colorOffset=function(a){return[-1,-1,3,6,-1,-1,3,6][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)]};H3DU.Mesh._texCoordOffset=function(a){return[-1,-1,-1,-1,3,6,6,9][a&(H3DU.Mesh.NORMALS_BIT|H3DU.Mesh.COLORS_BIT|H3DU.Mesh.TEXCOORDS_BIT)]};H3DU.Mesh.ATTRIBUTES_BITS=255;H3DU.Mesh.PRIMITIVES_BITS=768;H3DU.Mesh.NORMALS_BIT=1;H3DU.Mesh.COLORS_BIT=2;H3DU.Mesh.TEXCOORDS_BIT=4;H3DU.Mesh.TANGENTS_BIT=8;H3DU.Mesh.BITANGENTS_BIT=16;H3DU.Mesh.LINES_BIT=256;
H3DU.Mesh.POINTS_BIT=512;H3DU.Mesh.TRIANGLES=4;H3DU.Mesh.QUAD_STRIP=8;H3DU.Mesh.QUADS=7;H3DU.Mesh.LINES=1;H3DU.Mesh.TRIANGLE_FAN=6;H3DU.Mesh.TRIANGLE_STRIP=5;H3DU.Mesh.LINE_STRIP=3;H3DU.Mesh.POINTS=0;this.H3DU.Mesh=H3DU.Mesh;H3DU.TextureLoader=function(){this.loadedTextures=[];this.textureImages={};this.maxAnisotropy=[]};H3DU.TextureLoader.prototype.getTexture=function(a){return this.textureImages[a]||null};H3DU.TextureLoader.prototype.loadTexture=function(a){return H3DU.Texture.loadTexture(a,this.textureImages)};
H3DU.TextureLoader.prototype._setMaxAnisotropy=function(a){a=a.getContext?a.getContext():a;for(var b=this.maxAnisotropy,c=0;c<b.length;c++)if(b[c][0]==a)if(0<=b[c][2])a.texParameteri(a.TEXTURE_2D,b[c][2],b[c][1]);else return;var e=a.getExtension("EXT_texture_filter_anisotropic")||a.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||a.getExtension("MOZ_EXT_texture_filter_anisotropic");if(e)return c=e.TEXTURE_MAX_ANISOTROPY_EXT,e=a.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT),b.push([a,e,c]),
a.texParameteri(a.TEXTURE_2D,c,e),e;b.push([a,1,-1,null]);return 1};H3DU.TextureLoader.prototype.loadTexturesAll=function(a,b,c){for(var e=[],f=0;f<a.length;f++)e.push(this.loadTexture(a[f]));return H3DU.getPromiseResultsAll(e,b,c)};H3DU.TextureLoader.prototype.loadAndMapTexture=function(a,b){b=b.getContext?b.getContext():b;var c=this;return this.loadTexture(a).then(function(a){c.mapTexture(a,b);return Promise.resolve(a)})};
H3DU.TextureLoader.prototype.loadAndMapTexturesAll=function(a,b,c,e){b=b.getContext?b.getContext():b;for(var f=[],g=0;g<a.length;g++)f.push(this.loadAndMapTexture(a[g],b));return H3DU.getPromiseResultsAll(f,c,e)};H3DU.TextureLoader.prototype.mapTextures=function(a,b){b=b.getContext?b.getContext():b;for(var c=0;c<a.length;c++)this.mapTexture(a[c],b);return this};
H3DU.TextureLoader.prototype.mapTexture=function(a,b){b=b.getContext?b.getContext():b;for(var c=this.loadedTextures,e=0;e<c.length;e++)if(c[e][0]==a&&c[e][1]==b)return c[e][2];e=new H3DU._LoadedTexture(a,b);c.push([a,b,e]);return e};H3DU.TextureLoader.prototype.dispose=function(){for(var a in this.textureImages)this.textureImages[a].dispose();for(a=0;a<lt.length;a++)this.loadedTextures[a][2].dispose();this.textureImages={};this.loadedTextures=[];this.maxAnisotropy=[]};H3DU.LightSource=function(a,b,c,e){this.ambient=b||[0,0,0,1];this.position=a?[a[0],a[1],a[2],1]:[0,0,1,0];this.diffuse=c||[1,1,1,1];this.specular=e||[1,1,1];this.radius=0};
H3DU.LightSource.prototype.setParams=function(a){"undefined"!==typeof a.ambient&&"undefined"!==typeof a.ambient&&"undefined"!==typeof a.ambient&&null!==a.ambient&&(this.ambient=H3DU.toGLColor(a.ambient),this.ambient=this.ambient.slice(0,4));if("undefined"!==typeof a.position&&"undefined"!==typeof a.position&&"undefined"!==typeof a.position&&null!==a.position){var b=a.position;this.position=[b[0],b[1],b[2],null===b[3]?0:b[3]]}"undefined"!==typeof a.specular&&"undefined"!==typeof a.specular&&"undefined"!==
typeof a.specular&&null!==a.specular&&(this.specular=H3DU.toGLColor(a.specular));"undefined"!==typeof a.diffuse&&"undefined"!==typeof a.diffuse&&"undefined"!==typeof a.diffuse&&null!==a.diffuse&&(this.diffuse=H3DU.toGLColor(a.diffuse));"undefined"!=typeof a.radius&&(this.radius=a.radius);return this};H3DU.MeshBuffer=function(a){this._bounds=a.getBoundingBox();var b=new Float32Array(a.vertices);65536<=a.vertices.length||65536<=a.indices.length?(this.indexBufferSize=4,this.indices=new Uint32Array(a.indices)):256>=a.vertices.length&&256>=a.indices.length?(this.indexBufferSize=1,this.indices=new Uint8Array(a.indices)):(this.indexBufferSize=2,this.indices=new Uint16Array(a.indices));this.format=a.attributeBits;var c=H3DU.Mesh._getStride(this.format);this.numVertices=a.vertices.length/c;this.facesLength=
a.indices.length;this.attributes=[];this.attributes.push(["position",0,b,3,c]);a=H3DU.Mesh._normalOffset(this.format);0<=a&&this.attributes.push(["normal",a,b,3,c]);a=H3DU.Mesh._colorOffset(this.format);0<=a&&this.attributes.push(["colorAttr",a,b,3,c]);a=H3DU.Mesh._texCoordOffset(this.format);0<=a&&this.attributes.push(["uv",a,b,2,c]);a=H3DU.Mesh._tangentOffset(this.format);0<=a&&this.attributes.push(["tangent",a,b,3,c]);a=H3DU.Mesh._bitangentOffset(this.format);0<=a&&this.attributes.push(["bitangent",
a,b,3,c])};H3DU.MeshBuffer.prototype._getAttributes=function(){return this.attributes};H3DU.MeshBuffer.prototype._getAttribute=function(a){for(var b=0;b<this.attributes.length;b++)if(this.attributes[b][0]==a)return this.attributes[b];return null};H3DU.MeshBuffer.prototype.primitiveCount=function(){return 0!==(this.format&H3DU.Mesh.LINES_BIT)?Math.floor(this.facesLength/2):0!==(this.format&H3DU.Mesh.POINTS_BIT)?this.facesLength:Math.floor(this.facesLength/3)};
H3DU.MeshBuffer.prototype.getBounds=function(){if(!this._bounds){var a=!0,b=Number.POSITIVE_INFINITY,b=[b,b,b,-b,-b,-b],c=this.getAttribute("position");if(!c||3>c[3])return b;for(var e=c[4],f=c[2],c=c[1],g=0;g<this.indices.length;g++){var h=this.indices[g]*e+c;a?(a=!1,b[0]=b[3]=f[h],b[1]=b[4]=f[h+1],b[2]=b[5]=f[h+2]):(b[0]=Math.min(b[0],f[h]),b[3]=Math.max(b[3],f[h]),b[1]=Math.min(b[1],f[h+1]),b[4]=Math.max(b[4],f[h+1]),b[2]=Math.min(b[2],f[h+2]),b[5]=Math.max(b[5],f[h+2]))}}return this._bounds};
H3DU.MeshBuffer.prototype.getFormat=function(){return this.format};H3DU.MeshBuffer.prototype.vertexCount=function(){return this.numVertices};var BezierCurve=H3DU.BezierCurve,BezierSurface=H3DU.BezierSurface,BSplineCurve=H3DU.BezierCurve,BSplineSurface=H3DU.BezierSurface,GLUtil=H3DU,GLMath=H3DU.Math,CurveEval=H3DU.CurveEval,SurfaceEval=H3DU.SurfaceEval,Lights=H3DU.Lights,LightSource=H3DU.LightSource,Material=H3DU.Material,Mesh=H3DU.Mesh,Meshes=H3DU.Meshes,Scene3D=H3DU.Scene3D,ShaderProgram=H3DU.ShaderProgram,Shape=H3DU.Shape,ShapeGroup=H3DU.ShapeGroup,Texture=H3DU.Texture,TextureLoader=H3DU.TextureLoader,Transform=H3DU.Transform,ShaderInfo=
H3DU.ShaderInfo,RenderPass3D=H3DU.RenderPass3D;
