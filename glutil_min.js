/*
 CC0-1.0
 CC0-1.0
*/
(function(b,c){"function"===typeof define&&define.amd?define(["exports"],c):"object"===typeof exports?c(exports):c(b)})(this,function(b){if(!b.Promise){var c=function(a){this._state=0;this._timeout=this._value=null;this._cb={fulfilled:[],rejected:[]};this._thenPromises=[];a&&this._invokeResolver(a)};c.resolve=function(a){return new this(function(d,b){d(a)})};c.reject=function(a){return new this(function(d,b){b(a)})};c.all=c.when=function(a){return new this(function(d,b){var c=0,f=[];a.forEach(function(a,
k){c++;a.then(function(a){f[k]=a;c--;c||d(f)},function(a){c=1/0;b(a)})})})};c.race=function(a){return new this(function(d,b){a.forEach(function(a){a.then(d,b)})})};c.prototype.then=function(a,d){this._cb.fulfilled.push(a);this._cb.rejected.push(d);var b=new c;this._thenPromises.push(b);0<this._state&&this._schedule();return b};c.prototype.fulfill=function(a){if(0!==this._state)return this;this._state=1;this._value=a;this._thenPromises.length&&this._schedule();return this};c.prototype.reject=function(a){if(0!==
this._state)return this;this._state=2;this._value=a;this._thenPromises.length&&this._schedule();return this};c.prototype.resolve=function(a){if(a===this)this.reject(new TypeError("Promise resolved by its own instance"));else if(a instanceof this.constructor)a.chain(this);else{var d;if(null===a||"undefined"===typeof a||"object"!==typeof a&&"function"!==typeof a)this.fulfill(a);else{try{d=a.then}catch(b){this.reject(b);return}if("function"===typeof d){var c=!1,g=function(a){c||(c=!0,this.resolve(a))},
f=function(a){c||(c=!0,this.reject(a))};try{d.call(a,g.bind(this),f.bind(this))}catch(b){c||this.reject(b)}}else this.fulfill(a)}}};c.prototype.chain=function(a){return this.then(function(d){a.resolve(d)},function(d){a.reject(d)})};c.prototype["catch"]=function(a){return this.then(null,a)};c.prototype._schedule=function(){this._timeout||(this._timeout=setTimeout(this._processQueue.bind(this),0))};c.prototype._processQueue=function(){for(this._timeout=null;this._thenPromises.length;){var a=this._cb.fulfilled.shift(),
d=this._cb.rejected.shift();this._executeCallback(1===this._state?a:d)}};c.prototype._executeCallback=function(a){var d=this._thenPromises.shift();if("function"!==typeof a)1===this._state?d.fulfill(this._value):d.reject(this._value);else try{var b=a(this._value);d.resolve(b)}catch(c){d.reject(c)}};c.prototype._invokeResolver=function(a){try{a(this.resolve.bind(this),this.reject.bind(this))}catch(d){this.reject(d)}};b.Promise=c}});
(function(b,c){"function"===typeof define&&define.amd?define(["exports"],c):"object"===typeof exports?c(exports):c(b)})(this,function(b){if(!b.GLMath){var c={vec3cross:function(a,d){return[a[1]*d[2]-a[2]*d[1],a[2]*d[0]-a[0]*d[2],a[0]*d[1]-a[1]*d[0]]},vec3dot:function(a,d){return a[0]*d[0]+a[1]*d[1]+a[2]*d[2]},vec3add:function(a,d){return[a[0]+d[0],a[1]+d[1],a[2]+d[2]]},vec3sub:function(a,d){return[a[0]-d[0],a[1]-d[1],a[2]-d[2]]},vec3negate:function(a){return[-a[0],-a[1],-a[2]]},vec3negateInPlace:function(a){a[0]=
-a[0];a[1]=-a[1];a[2]=-a[2];return a},vec3mul:function(a,d){return[a[0]*d[0],a[1]*d[1],a[2]*d[2]]},vec3addInPlace:function(a,d){var b=d[1],c=d[2];a[0]+=d[0];a[1]+=b;a[2]+=c;return a},vec3subInPlace:function(a,d){var b=d[1],c=d[2];a[0]-=d[0];a[1]-=b;a[2]-=c;return a},vec3mulInPlace:function(a,d){var b=d[1],c=d[2];a[0]*=d[0];a[1]*=b;a[2]*=c;return a},vec3scaleInPlace:function(a,d){a[0]*=d;a[1]*=d;a[2]*=d;return a},vec3scale:function(a,d){return c.vec3scaleInPlace([a[0],a[1],a[2]],d)},vec3lerp:function(a,
d,b){return[a[0]+(d[0]-a[0])*b,a[1]+(d[1]-a[1])*b,a[2]+(d[2]-a[2])*b]},vec4dot:function(a,d){return a[0]*d[0]+a[1]*d[1]+a[2]*d[2]+a[3]*d[3]},vec4scaleInPlace:function(a,d){a[0]*=d;a[1]*=d;a[2]*=d;a[3]*=d;return a},vec4lerp:function(a,d,b){return[a[0]+(d[0]-a[0])*b,a[1]+(d[1]-a[1])*b,a[2]+(d[2]-a[2])*b,a[3]+(d[3]-a[3])*b]},vec3normInPlace:function(a){var d=a[0],b=a[1],c=a[2],d=Math.sqrt(d*d+b*b+c*c);0!==d&&(d=1/d,a[0]*=d,a[1]*=d,a[2]*=d);return a},vec4normInPlace:function(a){var d=a[0],b=a[1],c=a[2],
f=a[3],d=Math.sqrt(d*d+b*b+c*c+f*f);0!==d&&(d=1/d,a[0]*=d,a[1]*=d,a[2]*=d,a[3]*=d);return a},vec3norm:function(a){return c.vec3normInPlace([a[0],a[1],a[2]])},vec4norm:function(a){return c.vec4normInPlace([a[0],a[1],a[2],a[3]])},vec3length:function(a){var d=a[0],b=a[1];a=a[2];return Math.sqrt(d*d+b*b+a*a)},vec4length:function(a){var d=a[0],b=a[1],c=a[2];a=a[3];return Math.sqrt(d*d+b*b+c*c+a*a)},mat3identity:function(){return[1,0,0,0,1,0,0,0,1]},mat4identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,
0,0,0,0,1]},quatIdentity:function(){return[0,0,0,1]},mat4copy:function(a){return a.slice(0,16)},vec3copy:function(a){return a.slice(0,3)},vec4copy:function(a){return a.slice(0,4)},vec3assign:function(a,d){a[0]=d[0];a[1]=d[1];a[2]=d[2];return a},vec4assign:function(a,d){a[0]=d[0];a[1]=d[1];a[2]=d[2];a[3]=d[3];return a},mat4isIdentity:function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===
a[14]&&1===a[15]},mat4invert:function(a){var d=a[0]*a[10],b=a[0]*a[11],g=a[0]*a[5],f=a[0]*a[6],h=a[0]*a[7],k=a[0]*a[9],l=a[10]*a[12],p=a[10]*a[13],m=a[10]*a[15],q=a[11]*a[12],t=a[11]*a[13],n=a[11]*a[14],r=a[1]*a[4],u=a[1]*a[6],x=a[1]*a[7],v=a[1]*a[8],y=a[2]*a[4],A=a[2]*a[5],z=a[2]*a[7],I=a[2]*a[8],B=a[2]*a[9],w=a[3]*a[4],C=a[3]*a[5],G=a[3]*a[6],J=a[3]*a[8],E=a[3]*a[9],L=a[4]*a[9],M=a[5]*a[8],K=a[6]*a[8],N=a[6]*a[9],F=a[7]*a[8],D=a[7]*a[9],H=r-g,O=u-A,P=x-C,Q=y-f,g=g-r,u=A-u,A=z-G,r=w-h,x=C-x,z=G-
z,f=f-y,y=h-w,h=a[9]*a[12]*z+l*P+q*u+a[8]*a[13]*A+p*r+t*f+a[8]*a[14]*x+a[9]*a[14]*y+n*H+a[8]*a[15]*O+a[9]*a[15]*Q+m*g;if(0===h)return c.mat4identity();h=1/h;w=[];w[0]=a[6]*t-a[7]*p+D*a[14]-a[5]*n-N*a[15]+a[5]*m;w[1]=a[3]*p-a[2]*t-E*a[14]+a[1]*n+B*a[15]-a[1]*m;w[2]=a[13]*A+a[14]*x+a[15]*O;w[3]=a[9]*z+a[10]*P+a[11]*u;w[4]=a[7]*l-a[6]*q-F*a[14]+a[4]*n+K*a[15]-a[4]*m;w[5]=a[2]*q-a[3]*l+a[14]*(J-b)+a[15]*(d-I);w[6]=a[12]*z+a[14]*y+a[15]*Q;w[7]=a[8]*A+a[10]*r+a[11]*f;w[8]=a[5]*q-D*a[12]+F*a[13]-a[4]*t+
a[15]*(L-M);w[9]=E*a[12]-a[1]*q+a[13]*(b-J)+a[15]*(v-k);w[10]=a[12]*P+a[13]*r+a[15]*g;w[11]=a[8]*x+a[9]*y+a[11]*H;w[12]=N*a[12]-a[5]*l-K*a[13]+a[4]*p+a[14]*(M-L);w[13]=a[1]*l-B*a[12]+a[13]*(I-d)+a[14]*(k-v);w[14]=a[12]*u+a[13]*f+a[14]*H;w[15]=a[8]*O+a[9]*Q+a[10]*g;for(a=0;16>a;a++)w[a]*=h;return w},quatConjugate:function(a){return[-a[0],-a[1],-a[2],a[3]]},quatInvert:function(a){var d=1/c.quatDot(a,a);return c.vec4scaleInPlace(c.quatConjugate(a),d)},quatIsIdentity:function(a){return 0===a[0]&&0===
a[1]&&0===a[2]&&1===a[3]},quatToMat4:function(a){var d,b,c,f,h,k,l,p,m;d=2*a[0];b=2*a[1];c=2*a[2];f=d*a[0];h=d*a[1];k=d*a[2];l=b*a[1];p=c*a[1];m=c*a[2];d*=a[3];b*=a[3];a=c*a[3];return[1-(l+m),h+a,k-b,0,h-a,1-(f+m),p+d,0,k+b,p-d,1-(f+l),0,0,0,0,1]},quatToAxisAngle:function(a){var b=a[3],e=1-b*b;return 0<e?(e=1/Math.sqrt(e),[a[0]*e,a[1]*e,a[2]*e,Math.acos(b)*c.Num360DividedByPi]):[0,1,0,0]},quatFromVectors:function(a,b){var e=c.vec3cross(a,b),g=Math.sqrt(c.vec3dot(a,a))*Math.sqrt(c.vec3dot(b,b));0===
g&&(g=1);e[3]=g+c.vec3dot(a,b);return c.quatNormInPlace(e)},quatFromAxisAngle:function(a,b,e,g){var f;"undefined"!==typeof e&&"undefined"!==typeof g?(f=b,b=g):"undefined"===typeof b?(f=a[0],e=a[1],b=a[2]):(f=b[0],e=b[1],b=b[2]);g=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.PiDividedBy360;a=Math.cos(g);g=0<=g&&6.283185307179586>g?3.141592653589793>=g?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(g);f=c.vec3normInPlace([f,e,b]);f=[f[0],f[1],f[2],a];f[0]*=g;f[1]*=g;f[2]*=g;return f},quatFromTaitBryan:function(a,
b,e,g){var f,h;if(null===g||"undefined"===typeof g)g=c.RollPitchYaw;if(0>g||6<=g)throw Error("invalid mode");a.constructor===Array?(e=(0<=a[2]&&360>a[2]?a[2]:a[2]%360+(0>a[2]?360:0))*c.PiDividedBy360,f=(0<=a[0]&&360>a[0]?a[0]:a[0]%360+(0>a[0]?360:0))*c.PiDividedBy360,h=(0<=a[1]&&360>a[1]?a[1]:a[1]%360+(0>a[1]?360:0))*c.PiDividedBy360):(e=(0<=e&&360>e?e:e%360+(0>e?360:0))*c.PiDividedBy360,f=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.PiDividedBy360,h=(0<=b&&360>b?b:b%360+(0>b?360:0))*c.PiDividedBy360);a=Math.cos(f);
f=0<=f&&6.283185307179586>f?3.141592653589793>=f?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(f);b=Math.cos(h);h=0<=h&&6.283185307179586>h?3.141592653589793>=h?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(h);var k=Math.cos(e);e=0<=e&&6.283185307179586>e?3.141592653589793>=e?Math.sqrt(1-k*k):-Math.sqrt(1-k*k):Math.sin(e);var l;g===c.PitchYawRoll||g===c.PitchRollYaw?(l=[e*h,k*h,e*b,k*b],g===c.PitchYawRoll&&(l[0]=-l[0]),g=[l[3]*f+l[0]*a,l[1]*a+l[2]*f,l[2]*a-l[1]*f,l[3]*a-l[0]*f]):g===c.YawPitchRoll||g===
c.YawRollPitch?(l=[k*f,e*f,e*a,k*a],g===c.YawRollPitch&&(l[1]=-l[1]),g=[l[0]*b-l[2]*h,l[3]*h+l[1]*b,l[2]*b+l[0]*h,l[3]*b-l[1]*h]):(l=[b*f,h*a,h*f,b*a],g===c.RollPitchYaw&&(l[2]=-l[2]),g=[l[0]*k+l[1]*e,l[1]*k-l[0]*e,l[3]*e+l[2]*k,l[3]*k-l[2]*e]);return g},quatToTaitBryan:function(a,b){var e=a[3],g,f,h,k=1;if(null===b||"undefined"===typeof b)b=c.RollPitchYaw;if(0>b||6<=b)throw Error("invalid mode");b===c.RollPitchYaw?(g=a[1],f=a[0],h=a[2],k=-1):b===c.PitchYawRoll?(g=a[2],f=a[1],h=a[0],k=-1):b===c.PitchRollYaw?
(g=a[1],f=a[2],h=a[0]):b===c.YawPitchRoll?(g=a[2],f=a[0],h=a[1]):b===c.YawRollPitch?(g=a[0],f=a[2],h=a[1],k=-1):(g=a[0],f=a[1],h=a[2]);var l=f*f,p=Math.atan2(2*(e*g-k*f*h),1-2*(g*g+l)),m=2*(e*f+k*g*h);1<m&&(m=1);-1>m&&(m=-1);m=Math.asin(m);f=Math.atan2(2*(e*h-k*g*f),1-2*(l+h*h));p*=c.Num180DividedByPi;m*=c.Num180DividedByPi;f*=c.Num180DividedByPi;if(1E-6>Math.abs(m-90)||1E-6>Math.abs(m+90))f=0,p=Math.atan2(g,e)*c.Num180DividedByPi,isNaN(p)&&(p=0);e=[];b===c.RollPitchYaw?(e[0]=m,e[1]=p,e[2]=f):b===
c.PitchYawRoll?(e[0]=f,e[1]=m,e[2]=p):b===c.PitchRollYaw?(e[0]=f,e[1]=p,e[2]=m):b===c.YawPitchRoll?(e[0]=m,e[1]=f,e[2]=p):b===c.YawRollPitch?(e[0]=p,e[1]=f,e[2]=m):(e[0]=p,e[1]=m,e[2]=f);return e},quatNlerp:function(a,b,e){var g=1-e,f=a[0]*g,h=a[1]*g,k=a[2]*g,g=a[3]*g,l=b[0]*e,p=b[1]*e,m=b[2]*e;e*=b[3];return 0>a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]?c.quatNormInPlace([f-l,h-p,k-m,g-e]):c.quatNormInPlace([f+l,h+p,k+m,g+e])},quatSlerp:function(a,b,e){var g=c.quatDot(a,b),f=b;0>g&&(f=[-b[0],-b[1],-b[2],
-b[3]],g=c.quatDot(a,f));b=0;if(-1<g)if(1>g){if(b=Math.acos(g),0===b)return f.slice(0,4)}else return f.slice(0,4);else b=Math.PI;var h=1/Math.sin(b),g=Math.sin((1-e)*b)*h;e=Math.sin(e*b)*h;return[a[0]*g+f[0]*e,a[1]*g+f[1]*e,a[2]*g+f[2]*e,a[3]*g+f[3]*e]},quatRotate:function(a,b,e,g,f){return c.quatMultiply(a,c.quatFromAxisAngle(b,e,g,f))},quatTransform:function(a,b){var c=a[1]*b[2]-a[2]*b[1]+b[0]*a[3],g=a[2]*b[0]-a[0]*b[2]+b[1]*a[3],f=a[0]*b[1]-a[1]*b[0]+b[2]*a[3],h=a[0]*b[0]+a[1]*b[1]+a[2]*b[2];return[c*
a[3]-(g*a[2]-f*a[1])+a[0]*h,g*a[3]-(f*a[0]-c*a[2])+a[1]*h,f*a[3]-(c*a[1]-g*a[0])+a[2]*h,1]},quatFromMat4:function(a){var b=[],c=a[1],g=a[2],f=a[4],h=a[6],k=a[8],l=a[9],p=a[0]+a[5]+a[10];0<=p?(a=.5*Math.sqrt(p+1),p=.25/a,b[0]=(h-l)*p,b[1]=(k-g)*p,b[2]=(c-f)*p,b[3]=a):a[0]>a[5]&&a[0]>a[10]?(a=.5*Math.sqrt(1+a[0]-a[5]-a[10]),p=.25/a,b[0]=a,b[1]=(f+c)*p,b[2]=(g+k)*p,b[3]=(h-l)*p):a[5]>a[10]?(a=.5*Math.sqrt(1+a[5]-a[0]-a[10]),p=.25/a,b[0]=(f+c)*p,b[1]=a,b[2]=(l+h)*p,b[3]=(k-g)*p):(a=.5*Math.sqrt(1+a[10]-
a[0]-a[5]),p=.25/a,b[0]=(k+g)*p,b[1]=(l+h)*p,b[2]=a,b[3]=(c-f)*p);return b},mat4toMat3:function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},mat4transpose:function(a){return c.mat4transposeInPlace(a.slice(0,16))},mat4transposeInPlace:function(a){var b=a[1];a[1]=a[4];a[4]=b;b=a[2];a[2]=a[8];a[8]=b;b=a[3];a[3]=a[12];a[12]=b;b=a[6];a[6]=a[9];a[9]=b;b=a[7];a[7]=a[13];a[13]=b;b=a[11];a[11]=a[14];a[14]=b;return a},mat4inverseTranspose3:function(a){if(0===a[1]&&0===a[2]&&0===a[4]&&0===a[6]&&
0===a[8]&&0===a[9])return 1===a[0]&&1===a[5]&&1===a[10]?[1,0,0,0,1,0,0,0,1]:0!==a[0]*a[5]*a[10]?[1/a[0],0,0,0,1/a[5],0,0,0,1/a[10]]:[1,0,0,0,1,0,0,0,1];a=[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]];var b=a[0]*a[4]*a[8]+a[3]*a[7]*a[2]+a[6]*a[1]*a[5]-a[6]*a[4]*a[2]-a[3]*a[1]*a[8]-a[0]*a[7]*a[5];if(0===b)return[1,0,0,0,1,0,0,0,1];b=1/b;return[(-a[5]*a[7]+a[4]*a[8])*b,(a[5]*a[6]-a[3]*a[8])*b,(-a[4]*a[6]+a[3]*a[7])*b,(a[2]*a[7]-a[1]*a[8])*b,(-a[2]*a[6]+a[0]*a[8])*b,(a[1]*a[6]-a[0]*a[7])*b,(-a[2]*a[4]+
a[1]*a[5])*b,(a[2]*a[3]-a[0]*a[5])*b,(-a[1]*a[3]+a[0]*a[4])*b]},mat4scale:function(a,b,c,g){var f;"undefined"!==typeof c&&"undefined"!==typeof g?(f=b,b=g):(f=b[0],c=b[1],b=b[2]);return[a[0]*f,a[1]*f,a[2]*f,a[3]*f,a[4]*c,a[5]*c,a[6]*c,a[7]*c,a[8]*b,a[9]*b,a[10]*b,a[11]*b,a[12],a[13],a[14],a[15]]},mat4scaled:function(a,b,c){return"undefined"!==typeof b&&"undefined"!==typeof c?[a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1]:[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,1]},mat4transform:function(a,b,c,g,f){var h;"undefined"!==
typeof c&&"undefined"!==typeof g&&"undefined"!==typeof f?(h=b,b=f):(h=b[0],c=b[1],g=b[2],b=b[3]);return[h*a[0]+c*a[4]+g*a[8]+b*a[12],h*a[1]+c*a[5]+g*a[9]+b*a[13],h*a[2]+c*a[6]+g*a[10]+b*a[14],h*a[3]+c*a[7]+g*a[11]+b*a[15]]},mat4transformVec3:function(a,b,c,g){var f;"undefined"!==typeof c&&"undefined"!==typeof g?(f=b,b=g):(f=b[0],c=b[1],b=b[2]);return[f*a[0]+c*a[4]+b*a[8]+a[12],f*a[1]+c*a[5]+b*a[9]+a[13],f*a[2]+c*a[6]+b*a[10]+a[14],f*a[3]+c*a[7]+b*a[11]+a[15]]},mat3transform:function(a,b,c,g){var f;
"undefined"!==typeof c&&"undefined"!==typeof g?(f=b,b=g):(f=b[0],c=b[1],b=b[2]);return[f*a[0]+c*a[3]+b*a[6],f*a[1]+c*a[4]+b*a[7],f*a[2]+c*a[5]+b*a[8]]},mat4translated:function(a,b,c){var g;"undefined"!==typeof b&&"undefined"!==typeof c?(g=a,a=c):(g=a[0],b=a[1],a=a[2]);return[1,0,0,0,0,1,0,0,0,0,1,0,g,b,a,1]},mat4translate:function(a,b,c,g){var f;"undefined"!==typeof c&&"undefined"!==typeof g?(f=b,b=g):(f=b[0],c=b[1],b=b[2]);return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[0]*
f+a[4]*c+a[8]*b+a[12],a[1]*f+a[5]*c+a[9]*b+a[13],a[2]*f+a[6]*c+a[10]*b+a[14],a[3]*f+a[7]*c+a[11]*b+a[15]]},mat4perspective:function(a,b,e,g){a=1/Math.tan((0<=a&&360>a?a:a%360+(0>a?360:0))*c.PiDividedBy360);var f;f=1/(e-g);return[a/b,0,0,0,0,a,0,0,0,0,f*(e+g),-1,0,0,f*e*g*2,0]},mat4lookat:function(a,b,e){e||(e=[0,1,0]);b||(b=[0,0,0]);b=[b[0]-a[0],b[1]-a[1],b[2]-a[2]];var g=c.vec3length(b);if(1E-6>g)return c.mat4identity();g=1/g;b[0]*=g;b[1]*=g;b[2]*=g;e=c.vec3norm(e);e=c.vec3cross(b,e);c.vec3normInPlace(e);
g=c.vec3cross(e,b);c.vec3normInPlace(g);b[0]=-b[0];b[1]=-b[1];b[2]=-b[2];return[e[0],g[0],b[0],0,e[1],g[1],b[1],0,e[2],g[2],b[2],0,-c.vec3dot(a,e),-c.vec3dot(a,g),-c.vec3dot(a,b),1]},mat4ortho:function(a,b,c,g,f,h){var k=1/(b-a),l=1/(g-c),p=1/(h-f);return[2*k,0,0,0,0,2*l,0,0,0,0,-2*p,0,-(a+b)*k,-(g+c)*l,-(f+h)*p,1]},mat4perspectiveHorizontal:function(a,b,e,g){return c.mat4perspective(c.Num360DividedByPi*Math.atan2(Math.tan((0<=a&&360>a?a:a%360+(0>a?360:0))*c.PiDividedBy360),b),b,e,g)},mat4ortho2d:function(a,
b,e,g){return c.mat4ortho2d(a,b,e,g,-1,1)},mat4ortho2dAspect:function(a,b,e,g,f){return c.mat4orthoAspect(a,b,e,g,-1,1,f)},mat4orthoAspect:function(a,b,e,g,f,h,k){k/=Math.abs(b-a)/Math.abs(g-e);return 1>k?c.mat4ortho(a,b,e/k,g/k,f,h):c.mat4ortho(a*k,b*k,e,g,f,h)},mat4frustum:function(a,b,c,g,f,h){var k=2*f,l=1/(b-a),p=1/(g-c),m=1/(h-f);return[k*l,0,0,0,0,k*p,0,0,(a+b)*l,(g+c)*p,-(h+f)*m,-1,0,0,-(k*h)*m,0]},mat4scaleInPlace:function(a,b,c,g){var f;"undefined"!==typeof c&&"undefined"!==typeof g?(f=
b,b=g):(f=b[0],c=b[1],b=b[2]);a[0]*=f;a[1]*=f;a[2]*=f;a[3]*=f;a[4]*=c;a[5]*=c;a[6]*=c;a[7]*=c;a[8]*=b;a[9]*=b;a[10]*=b;a[11]*=b;return a},mat4multiply:function(a,b){for(var c=[],g=0;16>g;g+=4)for(var f=0;4>f;f++)c[g+f]=b[g]*a[f]+b[g+1]*a[f+4]+b[g+2]*a[f+8]+b[g+3]*a[f+12];return c},quatMultiply:function(a,b){return[a[3]*b[0]+a[0]*b[3]+a[1]*b[2]-a[2]*b[1],a[3]*b[1]+a[1]*b[3]+a[2]*b[0]-a[0]*b[2],a[3]*b[2]+a[2]*b[3]+a[0]*b[1]-a[1]*b[0],a[3]*b[3]-a[0]*b[0]-a[1]*b[1]-a[2]*b[2]]},mat4rotate:function(a,b,
e,g,f){var h,k;"undefined"!==typeof g&&"undefined"!==typeof f?(h=e,k=g,e=f,f=(0<=b&&360>b?b:b%360+(0>b?360:0))*c.PiDividedBy180):"undefined"===typeof e?(h=b[0],k=b[1],e=b[2],f=b[3],f=(0<=f&&360>f?f:f%360+(0>f?360:0))*c.PiDividedBy180):(h=e[0],k=e[1],e=e[2],f=(0<=b&&360>b?b:b%360+(0>b?360:0))*c.PiDividedBy180);b=Math.cos(f);var l=0<=f&&6.283185307179586>f?3.141592653589793>=f?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(f);if(1===h&&0===k&&0===e)return[a[0],a[1],a[2],a[3],b*a[4]+a[8]*l,b*a[5]+a[9]*
l,b*a[6]+a[10]*l,b*a[7]+a[11]*l,b*a[8]-l*a[4],b*a[9]-l*a[5],b*a[10]-l*a[6],b*a[11]-l*a[7],a[12],a[13],a[14],a[15]];if(0===h&&1===k&&0===e)return[b*a[0]-l*a[8],b*a[1]-l*a[9],b*a[2]-l*a[10],b*a[3]-l*a[11],a[4],a[5],a[6],a[7],b*a[8]+a[0]*l,b*a[9]+a[1]*l,b*a[10]+a[2]*l,b*a[11]+a[3]*l,a[12],a[13],a[14],a[15]];if(0===h&&0===k&&1===e)return[b*a[0]+a[4]*l,b*a[1]+a[5]*l,b*a[2]+a[6]*l,b*a[3]+a[7]*l,b*a[4]-l*a[0],b*a[5]-l*a[1],b*a[6]-l*a[2],b*a[7]-l*a[3],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]];if(0===
h&&0===k&&0===e)return a.slice(0,16);f=1/Math.sqrt(h*h+k*k+e*e);h*=f;k*=f;e*=f;var p=k*k;g=1-b;var m=h*k,q=k*e;f=h*l;k*=l;var t=e*l,l=g*q,n=g*m,r=g*h*e;h=b+g*h*h;m=n+t;q=r-k;p=b+g*p;t=n-t;n=l+f;e=b+g*e*e;b=r+k;f=l-f;return[a[0]*h+a[4]*m+a[8]*q,a[1]*h+a[5]*m+a[9]*q,a[10]*q+a[2]*h+a[6]*m,a[11]*q+a[3]*h+a[7]*m,a[0]*t+a[4]*p+a[8]*n,a[1]*t+a[5]*p+a[9]*n,a[10]*n+a[2]*t+a[6]*p,a[11]*n+a[3]*t+a[7]*p,a[0]*b+a[4]*f+a[8]*e,a[1]*b+a[5]*f+a[9]*e,a[10]*e+a[2]*b+a[6]*f,a[11]*e+a[3]*b+a[7]*f,a[12],a[13],a[14],a[15]]},
mat4rotated:function(a,b,e,g){var f;"undefined"!==typeof e&&"undefined"!==typeof g?(f=b,b=g,g=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.PiDividedBy180):"undefined"===typeof b?(f=a[0],e=a[1],b=a[2],g=a[3],g=(0<=g&&360>g?g:g%360+(0>g?360:0))*c.PiDividedBy180):(f=b[0],e=b[1],b=b[2],g=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.PiDividedBy180);a=Math.cos(g);var h=0<=g&&6.283185307179586>g?3.141592653589793>=g?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(g);if(1===f&&0===e&&0===b)return[1,0,0,0,0,a,h,0,0,-h,a,0,0,0,
0,1];if(0===f&&1===e&&0===b)return[a,0,-h,0,0,1,0,0,h,0,a,0,0,0,0,1];if(0===f&&0===e&&1===b)return[a,h,0,0,-h,a,0,0,0,0,1,0,0,0,0,1];if(0===f&&0===e&&0===b)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];g=1/Math.sqrt(f*f+e*e+b*b);f*=g;e*=g;b*=g;g=f*f;var k=e*e,l=b*b,p=f*b,m=e*b,q=f*h,t=e*h,h=b*h,n=1-a;f=n*f*e;e=n*p;b=n*m;return[a+n*g,f+h,e-t,0,f-h,a+n*k,b+q,0,e+t,b-q,a+n*l,0,0,0,0,1]},planeNormInPlace:function(a){var b=a[0],c=a[1],g=a[2],b=Math.sqrt(b*b+c*c+g*g);0!==b&&(b=1/b,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=
b);return a},planeNorm:function(a){return c.planeNormInPlace(a.slice(0,4))},mat4toFrustumPlanes:function(a){var b=[[],[],[],[],[],[]];b[0]=c.planeNormInPlace([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]]);b[1]=c.planeNormInPlace([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]]);b[2]=c.planeNormInPlace([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]]);b[3]=c.planeNormInPlace([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]]);b[4]=c.planeNormInPlace([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]]);b[5]=c.planeNormInPlace([a[3]-
a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]]);return b},frustumHasSphere:function(a,b,c,g,f){if(0>f)throw Error("radius is negative");for(var h=0;6>h;h++){var k=a[h];if(k[3]+k[0]*b+k[1]*c+k[2]*g<-f)return!1}return!0},boxIsEmpty:function(a){return!(a[0]<=a[3]&&a[1]<=a[4]&&a[2]<=a[5])},frustumHasBox:function(a,b){if(c.boxIsEmpty(b))return!1;for(var e=0;6>e;e++){var g=a[e],f=g[3],h=g[0]*b[0],k=g[2]*b[2],l=g[1]*b[1];if(0>=h+l+k+f&&0>=g[0]*b[3]+g[1]*b[4]+g[2]*b[5]+f&&0>=h+g[1]*b[4]+k+f&&0>=h+g[1]*b[4]+g[2]*
b[5]+f&&0>=h+l+g[2]*b[5]+f&&0>=g[0]*b[3]+g[1]*b[4]+k+f&&0>=g[0]*b[3]+l+k+f&&0>=g[0]*b[3]+l+g[2]*b[5]+f)return!1}return!0},frustumHasPoint:function(a,b,c,g){for(var f=0;6>f;f++)if(0>=a[f][0]*b+a[f][1]*c+a[f][2]*g+a[f][3])return!1;return!0}};c.quatDot=c.vec4dot;c.quatNormInPlace=c.vec4normInPlace;c.quatNorm=c.vec4norm;c.quatLength=c.vec4length;c.quatScaleInPlace=c.vec4scaleInPlace;c.quatCopy=c.vec4copy;c.PiTimes2=6.283185307179586;c.HalfPi=1.5707963267948966;c.PiDividedBy180=.017453292519943295;c.PiDividedBy360=
.008726646259971648;c.Num360DividedByPi=114.59155902616465;c.Num180DividedByPi=57.29577951308232;c.PitchYawRoll=0;c.PitchRollYaw=1;c.YawPitchRoll=2;c.YawRollPitch=3;c.RollPitchYaw=4;c.RollYawPitch=5;c.quatInverse=c.quatInvert;b.GLMath=c}});
(function(b,c){"function"===typeof define&&define.amd?define(["exports"],c):"object"===typeof exports?c(exports):c(b)})(this,function(b){function c(a,b,c,d){this.ambient=b||[0,0,0,1];this.position=a?[a[0],a[1],a[2],1]:[0,0,1,0];this.diffuse=c||[1,1,1,1];this.specular=d||[1,1,1]}function a(){this.lights=[new c];this.sceneAmbient=[.2,.2,.2]}function d(a){var b=a;"function"===typeof a.getContext&&(b=HTMLCanvasElement&&b.constructor===HTMLCanvasElement?f.get3DContext(a):f._toContext(b));this.context=
b;this.textureCache={};this._renderedOutsideScene=!1;this.shapes=[];this._frontFace=d.CCW;this._cullFace=d.NONE;this.clearColor=[0,0,0,1];this.fboFilter=null;this._subScene=new Subscene3D(this);this._programs=new d.ProgramCache(b);this.useDevicePixelRatio=!1;this._pixelRatio=1;this.autoResize=!0;this.width=Math.ceil(1*this.context.canvas.clientWidth);this.height=Math.ceil(1*this.context.canvas.clientHeight);this.context.canvas.width=this.width;this.context.canvas.height=this.height;this._is3d=f.is3DContext(this.context);
this._init3DContext()}function e(){this.shapes=[];this.parent=null;this.visible=!0;this.transform=new Transform}function g(a){if(null===a||"undefined"===typeof a)throw Error("mesh is null");this.bufferedMesh=a;this.transform=new Transform;this.material=new Material;this.parent=null;this.visible=!0}if(!b.GLUtil){window.requestAnimationFrame||(window.requestAnimationFrame=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.requestAnimationFrame||
(window.requestAnimationFrame=function(a){window.setTimeout(function(){a(window.performance.now())},17)}));window.performance||(window.performance={});window.performance.now||(window.performance.now=function(){return 1E3*(new Date).getTime()-window.performance._startTime},window.performance._startTime=1E3*(new Date).getTime());var f={renderLoop:function(a){a(window.performance.now());var b=function(c){window.requestAnimationFrame(b);a(c)};window.requestAnimationFrame(b)},createCanvasElement:function(a,
b,c){var d=document.createElement("canvas");a&&a.appendChild(d);if(null===b||"undefined"===typeof b)d.width=Math.ceil(d.clientWidth)+"";else{if(0>b)throw Error("width negative");d.width=Math.ceil(b)+""}if(null===c||"undefined"===typeof c)d.height=Math.ceil(d.clientHeight)+"";else{if(0>c)throw Error("height negative");d.height=Math.ceil(c)+""}return d},get3DOr2DContext:function(a){if(!a||!a.getContext)return null;var b=null,c={preserveDrawingBuffer:!0};c.antialias=window.devicePixelRatio&&1<window.devicePixelRatio?
!1:!0;try{b=a.getContext("webgl",c)}catch(d){b=null}if(!b)try{b=a.getContext("experimental-webgl",c)}catch(d){b=null}if(!b)try{b=a.getContext("moz-webgl",c)}catch(d){b=null}if(!b)try{b=a.getContext("webkit-3d",c)}catch(d){b=null}if(!b)try{b=a.getContext("2d",c)}catch(d){b=null}f.is3DContext(b)&&(b.getExtension("OES_element_index_uint"),b.getExtension("OES_standard_derivatives"));return b},get3DContext:function(a,b){var c=f.get3DOr2DContext(a),d=null;!c&&window.WebGLShader?d="Failed to initialize graphics support required by this page.":
window.WebGLShader&&!f.is3DContext(c)?d="This page requires WebGL, but it failed to start. Your computer might not support WebGL.":c&&f.is3DContext(c)||(d="This page requires a WebGL-supporting browser.");return d?((b||window.alert)(d),null):c},is3DContext:function(a){return a&&"compileShader"in a},getPromiseResults:function(a,b,c){function d(a,b,c){return function(k){a&&a(k);b.successes[c]=k;return!0}}function h(a,b,c){return function(k){a&&a(k);b.failures[c]=k;return!0}}if(!a||0===a.length)return Promise.resolve({successes:[],
failures:[],results:[]});for(var e={successes:[],failures:[],results:[]},g=[],f=0;f<a.length;f++){var u=f;g.push(a[f].then(d(b,e,u),h(c,e,u)))}return Promise.all(g).then(function(a){for(var b=0;b<e.successes.length;b++)"undefined"===typeof e.successes[b]&&(e.successes.splice(b,1),--b);for(b=0;b<e.failures.length;b++)"undefined"===typeof e.failures[b]&&(e.failures.splice(b,1),--b);e.results=a;return Promise.resolve(e)})},loadFileFromUrl:function(a,b){var c=b||"text";return new Promise(function(b,d){var l=
new XMLHttpRequest;l.onreadystatechange=function(l){l=l.target;if(4===l.readyState)if(200<=l.status&&300>l.status){var e="",e="xml"===c?l.responseXML:"json"===c?"response"in l?l.response:JSON.parse(l.responseText):"arraybuffer"===c?l.response:l.responseText+"";b({url:a,data:e})}else d({url:a})};l.onerror=function(b){d({url:a,error:b})};l.open("get",a,!0);l.responseType=c;l.send()})},getTimePosition:function(a,b,c){if("undefined"===typeof a.time||null===a.time)return a.time=b,a.lastTime=b,0;if("undefined"===
typeof a.lastTime||null===a.lastTime)a.lastTime=b;return 1*(b-a.time)%c/c},newFrames:function(a,b){if("undefined"===typeof a.time||null===a.time)return a.time=b,a.lastTime=b,0;if("undefined"===typeof a.lastTime||null===a.lastTime)return a.lastTime=b,0;var c=b-a.lastTime;a.lastTime=b;return 60*c/1E3}};(function(a){var b=function(a){var b=1*a[0],c=1*a[1],k=1*a[2],c=0>c?0:255<c?255:c,k=0>k?0:255<k?255:k;if(0===k)return[c,c,c];a=0;127.5>=c?a=c*(255+k)/255:(a=c*k/255,a=c+k-a);var d=2*c-a;if(0>b||360<=
b)b=(b%360+360)%360;var l=b+120;360<=l&&(l-=360);c=60>l?d+(a-d)*l/60:180>l?a:240>l?d+(a-d)*(240-l)/60:d;l=b;k=60>l?d+(a-d)*l/60:180>l?a:240>l?d+(a-d)*(240-l)/60:d;l=b-120;0>l&&(l+=360);b=60>l?d+(a-d)*l/60:180>l?a:240>l?d+(a-d)*(240-l)/60:d;return[0>c?0:255<c?255:c,0>k?0:255<k?255:k,0>b?0:255<b?255:b]},c=function(a){function k(a){var b;return 255*(0>(b=parseFloat(a))?0:100<b?100:b)/100}function d(a){var b;return 255*(0>(b=parseFloat(a))?0:1<b?1:b)}function f(a){var b;return 0>(b=parseInt(a,10))?0:
255<b?255:b}function g(a){a=parseFloat(m[1]);if(0>a||360<=a)a=(a%360+360)%360;return a}var m=null;if(!a)return null;var A;if(null!==(m=/^#([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})$/.exec(a)))return[parseInt(m[1],16),parseInt(m[2],16),parseInt(m[3],16),255];if(null!==(m=/^rgb\(\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*\)$/.exec(a)))return[k(m[1]),k(m[2]),k(m[3]),255];if(null!==(m=/^rgb\(\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*\)$/.exec(a)))return[f(m[1]),
f(m[2]),f(m[3]),255];if(null!==(m=/^rgba\(\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(a)))return[k(m[1]),k(m[2]),k(m[3]),d(m[4])];if(null!==(m=/^rgba\(\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(a)))return[f(m[1]),f(m[2]),f(m[3]),d(m[4])];if(null!==(m=/^#([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})$/.exec(a))){var z=parseInt(m[1],16);a=parseInt(m[2],16);A=parseInt(m[3],
16);return[z+(z<<4),a+(a<<4),A+(A<<4),255]}if(null!==(m=/^hsl\(\s*([\+\-]?\d+(?:\.\d+)?)\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*\)$/.exec(a)))return a=b([g(m[1]),k(m[3]),k(m[2])]),[a[0],a[1],a[2],255];if(null!==(m=/^hsla\(\s*([\+\-]?\d+(?:\.\d+)?)\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(a)))return a=b([g(m[1]),k(m[3]),k(m[2])]),[a[0],a[1],a[2],d(m[4])];h();a=a.toLowerCase();0<=a.indexOf("grey")&&(a=a.replace("grey",
"gray"));A=e[a];return"string"===typeof A?c(A):"transparent"===a?[0,0,0,0]:null},d=function(a){a[0]=0>a[0]?0:Math.min(a[0],1);a[1]=0>a[1]?0:Math.min(a[1],1);a[2]=0>a[2]?0:Math.min(a[2],1);a[3]=0>a[3]?0:Math.min(a[3],1);return a};a.toGLColor=function(a,b,k,l){return null===a||"undefined"===typeof a?[0,0,0,0]:"string"===typeof a?(a=c(a)||[0,0,0,0],b=1/255,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,d(a)):"number"===typeof a&&"number"===typeof b&&"number"===typeof k?[a,b,k,"number"!==typeof l?1:l]:a.constructor===
Array?d([a[0]||0,a[1]||0,a[2]||0,"number"!==typeof a[3]?1:a[3]]):d(a||[0,0,0,0])};var e=null,h=function(){if(!e){var a="aliceblue f0f8ff antiquewhite faebd7 aqua 00ffff aquamarine 7fffd4 azure f0ffff beige f5f5dc bisque ffe4c4 black 000000 blanchedalmond ffebcd blue 0000ff blueviolet 8a2be2 brown a52a2a burlywood deb887 cadetblue 5f9ea0 chartreuse 7fff00 chocolate d2691e coral ff7f50 cornflowerblue 6495ed cornsilk fff8dc crimson dc143c cyan 00ffff darkblue 00008b darkcyan 008b8b darkgoldenrod b8860b darkgray a9a9a9 darkgreen 006400 darkkhaki bdb76b darkmagenta 8b008b darkolivegreen 556b2f darkorange ff8c00 darkorchid 9932cc darkred 8b0000 darksalmon e9967a darkseagreen 8fbc8f darkslateblue 483d8b darkslategray 2f4f4f darkturquoise 00ced1 darkviolet 9400d3 deeppink ff1493 deepskyblue 00bfff dimgray 696969 dodgerblue 1e90ff firebrick b22222 floralwhite fffaf0 forestgreen 228b22 fuchsia ff00ff gainsboro dcdcdc ghostwhite f8f8ff gold ffd700 goldenrod daa520 gray 808080 green 008000 greenyellow adff2f honeydew f0fff0 hotpink ff69b4 indianred cd5c5c indigo 4b0082 ivory fffff0 khaki f0e68c lavender e6e6fa lavenderblush fff0f5 lawngreen 7cfc00 lemonchiffon fffacd lightblue add8e6 lightcoral f08080 lightcyan e0ffff lightgoldenrodyellow fafad2 lightgray d3d3d3 lightgreen 90ee90 lightpink ffb6c1 lightsalmon ffa07a lightseagreen 20b2aa lightskyblue 87cefa lightslategray 778899 lightsteelblue b0c4de lightyellow ffffe0 lime 00ff00 limegreen 32cd32 linen faf0e6 magenta ff00ff maroon 800000 mediumaquamarine 66cdaa mediumblue 0000cd mediumorchid ba55d3 mediumpurple 9370d8 mediumseagreen 3cb371 mediumslateblue 7b68ee mediumspringgreen 00fa9a mediumturquoise 48d1cc mediumvioletred c71585 midnightblue 191970 mintcream f5fffa mistyrose ffe4e1 moccasin ffe4b5 navajowhite ffdead navy 000080 oldlace fdf5e6 olive 808000 olivedrab 6b8e23 orange ffa500 orangered ff4500 orchid da70d6 palegoldenrod eee8aa palegreen 98fb98 paleturquoise afeeee palevioletred d87093 papayawhip ffefd5 peachpuff ffdab9 peru cd853f pink ffc0cb plum dda0dd powderblue b0e0e6 purple 800080 rebeccapurple 663399 red ff0000 rosybrown bc8f8f royalblue 4169e1 saddlebrown 8b4513 salmon fa8072 sandybrown f4a460 seagreen 2e8b57 seashell fff5ee sienna a0522d silver c0c0c0 skyblue 87ceeb slateblue 6a5acd slategray 708090 snow fffafa springgreen 00ff7f steelblue 4682b4 tan d2b48c teal 008080 thistle d8bfd8 tomato ff6347 turquoise 40e0d0 violet ee82ee wheat f5deb3 white ffffff whitesmoke f5f5f5 yellow ffff00 yellowgreen 9acd32".split(" ");
e={};for(var b=0;b<a.length;b+=2)e[a[b]]="#"+a[b+1]}}})(f);f._toContext=function(a){return a&&a.getContext?a.getContext():a};f._isPowerOfTwo=function(a){if(Math.floor(a)!==a||0>=a)return!1;for(;1<a&&0===(a&1);)a>>=1;return 1===a};f._isIdentityExceptTranslate=function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&1===a[15]};c.prototype.setParams=function(a){"undefined"!==typeof a.ambient&&"undefined"!==typeof a.ambient&&
"undefined"!==typeof a.ambient&&null!==a.ambient&&(this.ambient=f.toGLColor(a.ambient),this.ambient=this.ambient.slice(0,4));if("undefined"!==typeof a.position&&"undefined"!==typeof a.position&&"undefined"!==typeof a.position&&null!==a.position){var b=a.position;this.position=[b[0],b[1],b[2],null===b[3]?0:b[3]]}"undefined"!==typeof a.specular&&"undefined"!==typeof a.specular&&"undefined"!==typeof a.specular&&null!==a.specular&&(this.specular=f.toGLColor(a.specular));"undefined"!==typeof a.diffuse&&
"undefined"!==typeof a.diffuse&&"undefined"!==typeof a.diffuse&&null!==a.diffuse&&(this.diffuse=f.toGLColor(a.diffuse));return this};a.MAX_LIGHTS=3;a._createNewLight=function(a){var b=new c;0!==a&&(b.diffuse=[0,0,0,0],b.specular=[0,0,0]);return b};a.prototype.getCount=function(){return this.lights.length};a.prototype.getLight=function(b){var c=this.lights.length;this.lights[b]||(this.lights[b]=a._createNewLight(b));if(2<=this.lights.length-c)for(;c<this.lights.length;c++)this.lights[c]||(this.lights[c]=
a._createNewLight(c));return this.lights[b]};a.prototype.setParams=function(a,b){this.getLight(a).setParams(b);return this};a.prototype.setDirectionalLight=function(a,b,c,d){a=this.setParams(a,{position:[b[0],b[1],b[2],0]});null!=c&&(a=a.setParams({diffuse:c}));null!=d&&(a=a.setParams({specular:d}));return a};a.prototype.setPointLight=function(a,b){var c=this.setParams(a,{position:[b[0],b[1],b[2],1]});null!=diffuse&&(c=c.setParams({diffuse:diffuse}));null!=specular&&(c=c.setParams({specular:specular}));
return c};a.prototype.setAmbient=function(a,b,c,d){this.sceneAmbient=f.toGLColor(a,b,c,d);return this};var h=function(a){this.image=null;this.loadStatus=0;this.loadedTexture=null;this.name=a;this.width=0;this.clamp=!1;this.height=0};h.prototype.setClamp=function(a){this.clamp=a;return this};h.loadTexture=function(a,b){if(b&&b[a])return Promise.resolve(b[a]);var c=new h(a);b&&(b[a]=c);return c.loadImage().then(function(a){return a},function(a){return Promise.reject(a.name)})};h.fromUint8Array=function(a,
b,c){if(0>b)throw Error("width less than 0");if(0>c)throw Error("height less than 0");if(a.length<b*c*4)throw Error("array too short for texture");var d=new h("");d.image=a;d.width=Math.ceil(b);d.height=Math.ceil(c);d.loadStatus=2;return d};h.loadTga=function(a){return f.loadFileFromUrl(a,"arraybuffer").then(function(a){var b=new DataView(a.data);b.getUint8(0);b.getUint8(1);var c=b.getUint8(2);if(2!==c&&3!==c)return Promise.reject(Error("unsupported image type"));var d=b.getUint16(8,!0),k=b.getUint16(10,
!0);if(0!==d||0!==k)return Promise.reject(Error("unsupported origins"));d=b.getUint16(12,!0);k=b.getUint16(14,!0);if(0===d||0===k)return Promise.reject(Error("invalid width or height"));var e=b.getUint8(16);if(!(32===e&&2===c||24===e&&2===c||8===e&&3===c))return Promise.reject(Error("unsupported pixelsize"));var h=d*k;if(h>a.data.length)return Promise.reject(Error("size too big"));var f=new Uint8Array(4*h),g=18,v=0;if(32===e&&2===c)for(v=c=0;c<h;c++,v+=4)f[v+2]=b.getUint8(g),f[v+1]=b.getUint8(g+1),
f[v]=b.getUint8(g+2),f[v+3]=b.getUint8(g+3),g+=4;else if(24===e&&2===c)for(v=c=0;c<h;c++,v+=4)f[v+2]=b.getUint8(g),f[v+1]=b.getUint8(g+1),f[v]=b.getUint8(g+2),f[v+3]=255,g+=3;else if(8===e&&3===c)for(v=c=0;c<h;c++,v+=4)e=b.getUint8(g),f[v]=e,f[v+1]=e,f[v+2]=e,f[v+3]=255,g++;a.data=null;return{width:d,height:k,image:f}})};h.prototype.loadImage=function(){if(null!==this.image)return Promise.resolve(this);var a=this,b=this.name;a.loadStatus=1;return/\.tga$/i.test(b)?h.loadTga(b).then(function(b){a.image=
b.image;a.width=b.width;a.height=b.height;a.loadStatus=2;return a},function(c){a.loadStatus=-1;return Promise.reject({name:b,error:c})}):new Promise(function(c,d){var e=new Image;e.onload=function(b){b=b.target;a.image=b;a.width=b.width;a.height=b.height;a.loadStatus=2;c(a)};e.onerror=function(c){a.loadStatus=-1;d({name:b,error:c})};e.src=b})};h.prototype.dispose=function(){null!==this.loadedTexture&&(this.loadedTexture.dispose(),this.loadedTexture=null)};h.prototype.getName=function(){return name};
d.prototype._init3DContext=function(){this._is3d&&(this._programs.getProgram(d.LIGHTING_ENABLED|d.SPECULAR_ENABLED|d.SPECULAR_MAP_ENABLED),this.context.viewport(0,0,this.width,this.height),this.context.enable(this.context.BLEND),this.context.blendFunc(this.context.SRC_ALPHA,this.context.ONE_MINUS_SRC_ALPHA),this.context.enable(this.context.DEPTH_TEST),this.context.depthFunc(this.context.LEQUAL),this.context.disable(this.context.CULL_FACE),this.context.clearDepth(1),this._setClearColor(),this.context.clear(this.context.COLOR_BUFFER_BIT|
this.context.DEPTH_BUFFER_BIT),this._setIdentityMatrices())};d.LIGHTING_ENABLED=1;d.SPECULAR_MAP_ENABLED=2;d.NORMAL_ENABLED=4;d.SPECULAR_ENABLED=8;d._materialToFlags=function(a){var b;b=0|(a.basic?0:d.LIGHTING_ENABLED);b|=0!=a.specular[0]||0!=a.specular[1]||0!=a.specular[2]?d.SPECULAR_ENABLED:0;b|=a.specularMap?d.SPECULAR_MAP_ENABLED:0;return b|=a.normalMap?d.NORMAL_ENABLED:0};d.ProgramCache=function(a){this.context=a;this._programs=[]};d.ProgramCache.prototype.getProgram=function(a){if(this._programs[a])return this._programs[a];
var b="";0!=(a&d.LIGHTING_ENABLED)&&(b+="#define SHADING\n");0!=(a&d.SPECULAR_ENABLED)&&(b+="#define SPECULAR\n");0!=(a&d.NORMAL_ENABLED)&&(b+="#define NORMAL_MAP\n");0!=(a&d.SPECULAR_MAP_ENABLED)&&(b+="#define SPECULAR_MAP\n#define SPECULAR\n");b=new ShaderProgram(this.context,b+ShaderProgram.getDefaultVertex(),b+ShaderProgram.getDefaultFragment());return this._programs[a]=b};d.prototype.getContext=function(){return this.context};d.NONE=0;d.BACK=1;d.FRONT=2;d.FRONT_AND_BACK=3;d.CCW=0;d.CW=1;d.prototype.cullFace=
function(a){this._cullFace=a===d.BACK||a===d.FRONT||a===d.FRONT_AND_BACK?a:0;return this};d.prototype._setFace=function(){if(this._is3d)return this._cullFace===d.BACK?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.BACK)):this._cullFace===d.FRONT?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.FRONT)):this._cullFace===d.FRONT_AND_BACK?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.FRONT_AND_BACK)):this.context.disable(this.context.CULL_FACE),
this._frontFace===d.CW?this.context.frontFace(this.context.CW):this.context.frontFace(this.context.CCW),this};d.prototype.frontFace=function(a){this._frontFace=a===d.CW?a:0;return this};d.prototype.setAutoResize=function(a){this.autoResize=!!a;return this};d.prototype.setUseDevicePixelRatio=function(a){var b=!!this.useDevicePixelRatio;this._pixelRatio=(this.useDevicePixelRatio=!!a)&&window.devicePixelRatio?window.devicePixelRatio:1;b!==this.useDevicePixelRatio&&this.setDimensions(this.width,this.height);
return this};d.prototype.getClearColor=function(){return this.clearColor.slice(0,4)};d.prototype.useProgram=function(a){console.warn("The 'useProgram' method is obsolete.  Instead of this method, use the 'setShader' program of individual shapes to set the shader programs they use.")};d.prototype.setDimensions=function(a,b){if(0>a||0>b)throw Error("width or height negative");this.width=Math.ceil(a);this.height=Math.ceil(b);this.context.canvas.width=this.width*this._pixelRatio;this.context.canvas.height=
this.height*this._pixelRatio;this._is3d&&this.context.viewport(0,0,this.width*this._pixelRatio,this.height*this._pixelRatio);"undefined"!==typeof this.fbo&&this.fbo&&(this.fbo.dispose(),this.fbo=this.createBuffer(),this.fboQuad&&this.fboQuad.setMaterial(this.fbo))};d.prototype.getWidth=function(){return this.width};d.prototype.getHeight=function(){return this.height};d.prototype.getAspect=function(){return this.getWidth()/this.getHeight()};d.prototype.getClientAspect=function(){var a=this.context.canvas.clientHeight;
return 0>=a?1:this.context.canvas.clientWidth/a};d.prototype.createBuffer=function(){return new FrameBuffer(this.context,this.getWidth(),this.getHeight())};d.prototype.getProjectionMatrix=function(){if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this.Subscene3D._projectionMatrix.slice(0,16)};d.prototype.getViewMatrix=function(){if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");
return this._viewMatrix.slice(0,16)};d.prototype.setPerspective=function(a,b,c,d){return this.setProjectionMatrix(GLMath.mat4perspective(a,b,c,d))};d.prototype.setOrthoAspect=function(a,b,c,d,e,h,f){if(null===f||"undefined"===typeof f)f=this.getClientAspect();0===f&&(f=1);return this.setProjectionMatrix(GLMath.mat4orthoAspect(a,b,c,d,e,h,f))};d.prototype.setOrtho2DAspect=function(a,b,c,d,e){return this.setOrthoAspect(a,b,c,d,-1,1,e)};d.prototype.setFrustum=function(a,b,c,d,e,h){return this.setProjectionMatrix(GLMath.mat4frustum(a,
b,d,c,e,h))};d.prototype.setOrtho=function(a,b,c,d,e,h){return this.setProjectionMatrix(GLMath.mat4ortho(a,b,c,d,e,h))};d.prototype.setOrtho2D=function(a,b,c,d){return this.setProjectionMatrix(GLMath.mat4ortho(a,b,c,d,-1,1))};d.prototype._setClearColor=function(){this._is3d&&this.context.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]);return this};d.prototype.setClearColor=function(a,b,c,d){this.clearColor=f.toGLColor(a,b,c,d);return this._setClearColor()};
d.prototype.loadTexture=function(a){return h.loadTexture(a,this.textureCache)};d.prototype.loadAndMapTexture=function(a){var b=this.context,c=null,c=a.constructor===h?a.loadImage():h.loadTexture(a,this.textureCache);return c.then(function(a){a.loadedTexture=new LoadedTexture(a,b);return a})};d.prototype.loadAndMapTextures=function(a,b,c){for(var d=[],e=0;e<a.length;e++)d.push(this.loadAndMapTexture(a[e]));return f.getPromiseResults(d,b,c)};d.prototype._setIdentityMatrices=function(){this._projectionMatrix=
GLMath.mat4identity();this._viewMatrix=GLMath.mat4identity();this._updateFrustum()};d.prototype._updateFrustum=function(){var a=GLMath.mat4multiply(this._projectionMatrix,this._viewMatrix);this._frustum=GLMath.mat4toFrustumPlanes(a)};d.prototype.vertexCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].vertexCount();return a};d.prototype.primitiveCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].primitiveCount();return a};d.prototype.setProjectionMatrix=
function(a){if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.setProjectionMatrix(a);return this};d.prototype.setViewMatrix=function(a){if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.setViewMatrix(a);return this};d.prototype.setLookAt=function(a,b,c){return this.setViewMatrix(GLMath.mat4lookat(a,b,c))};d.prototype.addShape=function(a){this._subScene.addShape(a);
return this};d.prototype.makeShape=function(a){a=new BufferedMesh(a,this.context);return new g(a)};d.prototype.removeShape=function(a){this._subScene.removeShape(a);return this};d.prototype.getLightSource=function(){if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.getLightSource()};d.prototype.setDirectionalLight=function(a,b,c,d){if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");
this.getLightSource().setDirectionalLight(a,b,c,d);return this};d.prototype.setLightParams=function(a,b){if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLightSource().setParams(a,b);return this};d.prototype.setAmbient=function(a,b,c,d){if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLightSource().setAmbient(a,b,c,d);return this};d.prototype.setPointLight=
function(a,b,c,d){if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLightSource().setPointLight(a,b,c,d);return this};d.prototype.clear=function(){this._is3d&&this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT|this.context.STENCIL_BUFFER_BIT)};d.prototype.clearDepth=function(){this._is3d&&this.context.clear(this.context.DEPTH_BUFFER_BIT)};d.prototype.render=function(a){if(this.autoResize){var b=this.context.canvas;
b.height===Math.ceil(b.clientHeight)*this._pixelRatio&&b.width===Math.ceil(b.clientWidth)*this._pixelRatio||this.setDimensions(b.clientWidth,b.clientHeight)}this._setFace();a||(a=this._subScene,this._is3d&&this.clear());a!=this._subScene&&(this._renderedOutsideScene=!0);a.render();this._is3d&&this.context.flush();return this};d.prototype.useFilter=function(a){null===a||"undefined"===typeof a?this.fboFilter=null:(this.fboFilter="string"===typeof a?ShaderProgram.makeEffect(this.context,a):a,"undefined"!==
typeof this.fbo&&this.fbo||(this.fbo=this.createBuffer()),"undefined"!==typeof this.fboQuad&&this.fboQuad||(a=new Mesh([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0],[0,1,2,2,1,3],Mesh.TEXCOORDS_BIT),this.fboQuad=this.makeShape(a).setParams({texture:this.fbo,shader:this.fboFilter})));return this};e.prototype.addShape=function(a){a.parent=this;this.shapes.push(a);return this};e.prototype.setVisible=function(a){this.visible=!!a;return this};e.prototype.getVisible=function(){return this.visible};e.prototype.getTransform=
function(){return this.transform};e.prototype.getMatrix=function(){var a=this.getTransform(),b=a.isIdentity();if(null!==this.parent)var c=this.parent.getMatrix(),a=b?GLMath.mat4multiply(c,a.getMatrix()):GLMath.mat4isIdentity(c)?a.getMatrix():c;else a=a.getMatrix();return a};e.prototype.setTransform=function(a){this.transform=a.copy();return this};e.prototype.setMaterial=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b].setMaterial(a);return this};e.prototype.setShader=function(a){for(var b=
0;b<this.shapes.length;b++)this.shapes[b].setShader(a);return this};e.prototype.removeShape=function(a){for(var b=0;b<this.shapes.length;b++)this.shapes[b]===a&&(this.shapes.splice(b,1),b--);return this};e.prototype.getBounds=function(){for(var a=[0,0,0,0,0,0],b=!0,c=0;c<this.shapes.length;c++){var d=this.shapes[c].getBounds();GLMath.boxIsEmpty(d)||(b?(a[0]=d[0],a[1]=d[1],a[2]=d[2],a[3]=d[3],a[4]=d[4],a[5]=d[5],b=!1):(a[0]=Math.min(d[0],a[0]),a[1]=Math.min(d[1],a[1]),a[2]=Math.min(d[2],a[2]),a[3]=
Math.max(d[3],a[3]),a[4]=Math.max(d[4],a[4]),a[5]=Math.max(d[5],a[5])))}return b?[0,0,0,-1,-1,-1]:a};e.prototype.vertexCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].vertexCount();return a};e.prototype.primitiveCount=function(){for(var a=0,b=0;b<this.shapes.length;b++)a+=this.shapes[b].primitiveCount();return a};e.prototype.setPosition=function(a,b,c){this.transform.setPosition(a,b,c);return this};e.prototype.setQuaternion=function(a){this.transform.setQuaternion(a);return this};
e.prototype.setScale=function(a,b,c){this.transform.setScale(a,b,c);return this};g.prototype.vertexCount=function(){return this.bufferedMesh?this.bufferedMesh.vertexCount():0};g.prototype.primitiveCount=function(){return this.bufferedMesh?this.bufferedMesh.primitiveCount():0};g.prototype.setVisible=function(a){this.visible=!!a;return this};g.prototype.getVisible=function(){return this.visible};g.prototype.setColor=function(a,b,c,d){this.material?(a=f.toGLColor(a,b,c,d),this.material.setParams({ambient:a,
diffuse:a})):this.material=Material.fromColor(a,b,c,d);return this};g.prototype.setTexture=function(a){this.material?this.material.setParams({texture:a}):this.material=Material.fromTexture(a);return this};g.prototype.setShader=function(a){this.material?this.material.setParams({shader:a}):this.material=Material.forShader(a);return this};g.prototype.setTextureAndColor=function(a,b,c,d,e){this.material=Material.fromColor(b,c,d,e).setParams({texture:a});return this};g.prototype.setMaterial=function(a){this.material=
a;return this};g.prototype.copy=function(){var a=new g(this.bufferedMesh);a.material=this.material.copy();a.transform=this.getTransform().copy();return a};g.prototype.getTransform=function(){return this.transform};g.prototype.getBounds=function(){if(!this.bufferedMesh)return[0,0,0,-1,-1,-1];var a=this.bufferedMesh._getBounds(),b=this.getMatrix();if(GLMath.mat4isIdentity(b))return a.slice(0,6);var c=GLMath.mat4transformVec3(b,a[0],a[1],a[2]),a=GLMath.mat4transformVec3(b,a[3],a[4],a[5]);return[Math.min(c[0],
a[0]),Math.min(c[1],a[1]),Math.min(c[2],a[2]),Math.max(c[0],a[0]),Math.max(c[1],a[1]),Math.max(c[2],a[2])]};g.prototype.isCulled=function(a){return this.bufferedMesh&&this.visible?!GLMath.frustumHasBox(a,this.getBounds()):!0};g.prototype.setTransform=function(a){this.transform=a.copy();return this};g.prototype.setScale=function(a,b,c){this.getTransform().setScale(a,b,c);return this};g.prototype.setPosition=function(a,b,c){this.getTransform().setPosition(a,b,c);return this};g.prototype.setQuaternion=
function(a){this.getTransform().setQuaternion(a);return this};g.prototype.getMatrix=function(){var a=this.getTransform(),b=a.isIdentity();if(null!==this.parent)var c=this.parent.getMatrix(),a=b?c:GLMath.mat4isIdentity(c)?a.getMatrix():GLMath.mat4multiply(c,a.getMatrix());else a=a.getMatrix();return a};b.ShapeGroup=e;b.Lights=a;b.LightSource=c;b.Texture=h;b.Material=Material;b.Shape=g;b.Scene3D=d;b.GLUtil=f}});
function Transform(){this.scale=[1,1,1];this.position=[0,0,0];this.rotation=GLMath.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;this.matrix=GLMath.mat4identity()}Transform.prototype.getScale=function(){return this.complexMatrix?[this.matrix[0],this.matrix[5],this.matrix[10]]:this.scale.slice(0,3)};Transform.prototype.getPosition=function(){return this.complexMatrix?[this.matrix[12],this.matrix[13],this.matrix[14]]:this.position.slice(0,3)};
Transform.prototype.getQuaternion=function(){return this.complexMatrix?GLMath.quatNormInPlace(GLMath.quatFromMat4(this.matrix)):this.rotation.slice(0,4)};Transform.prototype.reset=function(){this.matrix=GLMath.mat4identity();this.position=[0,0,0];this.scale=[1,1,1];this.rotation=GLMath.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;return this};
Transform.prototype.setMatrix=function(b){this._matrixDirty=!1;this.complexMatrix=!0;this.matrix=b.slice(0,16);this.position=[this.matrix[12],this.matrix[13],this.matrix[14]];this.rotation=GLMath.quatFromMat4(this.matrix);this.rotation=GLMath.quatNormInPlace(this.rotation);this.scale=[this.matrix[0],this.matrix[5],this.matrix[10]];this._isIdentity=1===b[0]&&0===b[1]&&0===b[2]&&0===b[3]&&0===b[4]&&1===b[5]&&0===b[6]&&0===b[7]&&0===b[8]&&0===b[9]&&1===b[10]&&0===b[11]&&0===b[12]&&0===b[13]&&0===b[14]&&
1===b[15];return this};Transform.prototype.isIdentity=function(){if(this._matrixDirty)if(this.complexMatrix)this.getMatrix();else return 0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]&&GLMath.quatIsIdentity(this.rotation);return this._isIdentity};Transform.prototype.resetTransform=function(){return this.resetTransform()};
Transform.prototype.setScale=function(b,c,a){if(this.complexMatrix)return this;this.scale=null===b||"undefined"===typeof b||null!==c&&"undefined"!==typeof c||null!==a&&"undefined"!==typeof a?[b,c,a]:"number"!==typeof b?[b[0],b[1],b[2]]:[b,b,b];this._isIdentity=this._isIdentity&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];this._matrixDirty=!0;return this};
Transform.prototype.setPosition=function(b,c,a){if(this.complexMatrix)return this;this.position=null===b||"undefined"===typeof b||null!==c&&"undefined"!==typeof c||null!==a&&"undefined"!==typeof a?[b,c,a]:"number"!==typeof b?[b[0],b[1],b[2]]:[b,b,b];this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];this._matrixDirty=!0;return this};
Transform.prototype.movePosition=function(b,c,a){if(this.complexMatrix)return this;null===b||"undefined"===typeof b||null!==c&&"undefined"!==typeof c||null!==a&&"undefined"!==typeof a?(this.position[0]+=b,this.position[1]+=c,this.position[2]+=a):"number"!==typeof b?(this.position[0]+=b[0],this.position[1]+=b[1],this.position[2]+=b[2]):(this.position[0]+=b,this.position[1]+=b,this.position[2]+=b);this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];this._matrixDirty=
!0;return this};Transform.prototype.setQuaternion=function(b){if(this.complexMatrix)return this;this.rotation=b.slice(0,4);GLMath.quatNormInPlace(this.rotation);this._matrixDirty=!0;return this};Transform.prototype.setOrientation=function(b,c,a,d){return this.setQuaternion(GLMath.quatFromAxisAngle(b,c,a,d))};Transform.prototype.multQuaternion=function(b){if(this.complexMatrix)return this;this.rotation=GLMath.quatNormInPlace(GLMath.quatMultiply(this.rotation,b));this._matrixDirty=!0;return this};
Transform.prototype.multOrientation=function(b,c,a,d){return this.multQuaternion(GLMath.quatFromAxisAngle(b,c,a,d))};
Transform.prototype.getMatrix=function(){if(this._matrixDirty)if(this._matrixDirty=!1,GLMath.quatIsIdentity(this.rotation))this.matrix=[this.scale[0],0,0,0,0,this.scale[1],0,0,0,0,this.scale[2],0,this.position[0],this.position[1],this.position[2],1],this._isIdentity=0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];else{this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,this.position[0],this.position[1],this.position[2],1];this.matrix=GLMath.mat4multiply(this.matrix,
GLMath.quatToMat4(this.rotation));GLMath.mat4scaleInPlace(this.matrix,this.scale);var b=this.matrix;this._isIdentity=1===b[0]&&0===b[1]&&0===b[2]&&0===b[3]&&0===b[4]&&1===b[5]&&0===b[6]&&0===b[7]&&0===b[8]&&0===b[9]&&1===b[10]&&0===b[11]&&0===b[12]&&0===b[13]&&0===b[14]&&1===b[15]}else if(this._isIdentity)return GLMath.mat4identity();return this.matrix.slice(0,16)};
Transform.prototype.copy=function(){var b=new Transform;b.scale=this.scale.slice(0,this.scale.length);b.position=this.position.slice(0,this.scale.length);b.complexMatrix=this.complexMatrix;b._matrixDirty=this._matrixDirty;b.matrix=this.matrix.slice(0,this.matrix.length);return b};var SubMesh=function(b,c,a){this._initialize(b,c,a)};
function Mesh(b,c,a){this.subMeshes=null!==b&&"undefined"!==typeof b?[new SubMesh(b,c,a)]:[];this._elementsDefined=0;this.currentMode=-1;this.normal=[0,0,0];this.color=[0,0,0];this.tangent=[0,0,0];this.bitangent=[0,0,0];this.texCoord=[0,0]}Mesh._primitiveType=function(b){return b===Mesh.LINES||b===Mesh.LINE_STRIP?Mesh.LINES:b===Mesh.POINTS?Mesh.POINTS:Mesh.TRIANGLES};Mesh._isCompatibleMode=function(b,c){return b===c||Mesh._primitiveType(b)===Mesh._primitiveType(c)?!0:!1};
Mesh._recalcNormalsStart=function(b,c,a,d,e,g){for(a=0;a<b.length;a+=d)if(b[a+e]=0,b[a+e+1]=0,b[a+e+2]=0,!g){var f=[b[a],b[a+1],b[a+2]];c[f]?c[f].push(a+e):c[f]=[a+e]}};
Mesh._recalcNormalsFinish=function(b,c,a,d,e,g){a=[];var f=0;if(!g)for(var h in c){var k=c[h];if(k&&k.constructor===Array&&2<=k.length){g=k[0];var l=b[g],p=b[g+1],m=b[g+2];a[0]=l;a[1]=p;a[2]=m;f=3;for(g=1;g<k.length;g++){for(var q=!1,t=b[k[g]],n=b[k[g]+1],r=b[k[g]+2],u=0;u<f;u+=3)if(t===a[u]&&n===a[u+1]&&r===a[u+2]){q=!0;break}q||(a[f++]=t,a[f++]=n,a[f++]=r,l+=t,p+=n,m+=r)}for(g=0;g<k.length;g++)b[k[g]]=l,b[k[g]+1]=p,b[k[g]+2]=m}}for(g=0;g<b.length;g+=d)if(h=b[g+e],a=b[g+e+1],f=b[g+e+2],c=Math.sqrt(h*
h+a*a+f*f))c=1/c,b[g+e]=h*c,b[g+e+1]=a*c,b[g+e+2]=f*c};
Mesh._recalcNormals=function(b,c,a,d,e,g){g=g?-1:1;var f={},h;Mesh._recalcNormalsStart(b,f,c,a,d,e);for(var k=0;k<c.length;k+=3){var l=c[k]*a,p=c[k+1]*a,m=c[k+2]*a;h=[b[l]-b[m],b[l+1]-b[m+1],b[l+2]-b[m+2]];var q=[b[p]-b[m],b[p+1]-b[m+1],b[p+2]-b[m+2]],t=h[1]*q[2]-h[2]*q[1],n=h[2]*q[0]-h[0]*q[2],q=h[0]*q[1]-h[1]*q[0];h=Math.sqrt(t*t+n*n+q*q);0!==h&&(h=1/h,h*=g,t*=h,n*=h,q*=h,b[l+d]+=t,b[l+d+1]+=n,b[l+d+2]+=q,b[p+d]+=t,b[p+d+1]+=n,b[p+d+2]+=q,b[m+d]+=t,b[m+d+1]+=n,b[m+d+2]+=q)}Mesh._recalcNormalsFinish(b,
f,c,a,d,e)};Mesh.prototype.mode=function(b){if(0>b)throw Error("invalid mode");if(-1!==this.currentMode&&Mesh._isCompatibleMode(this.currentMode,b))this.subMeshes[this.subMeshes.length-1].newPrimitive();else{var c=0,a=Mesh._primitiveType(b);a===Mesh.LINES?c|=Mesh.LINES_BIT:a===Mesh.POINTS&&(c|=Mesh.POINTS_BIT);this.subMeshes.push(new SubMesh([],[],c))}this.currentMode=b;return this};
Mesh.prototype.merge=function(b){for(var c=this.subMeshes[this.subMeshes.length-1],a=c?c.attributeBits&Mesh.PRIMITIVES_BITS:0,d=0;d<b.subMeshes.length;d++){var e=b.subMeshes[d];if(0!==e.indices.length)if(!c||(e.attributeBits&Mesh.PRIMITIVES_BITS)!==a||196605<c.vertices.length+e.vertices.length||c.attributeBits!==e.attributeBits)c=new SubMesh(e.vertices.slice(0,e.vertices.length),e.indices.slice(0,e.indices.length),e.attributeBits),this.subMeshes.push(c),a=c.attributeBits&Mesh.PRIMITIVES_BITS;else{var g=
c.vertexCount(),d=c.indices.length;c.vertices.push.apply(c.vertices,e.vertices);for(c.indices.push.apply(c.indices,e.indices);d<c.indices.length;d++)c.indices[d]+=g}}c.newPrimitive();return this};Mesh.prototype.normal3=function(b,c,a){"number"===typeof b&&"number"===typeof c&&"number"===typeof a?(this.normal[0]=b,this.normal[1]=c,this.normal[2]=a):(this.normal[0]=b[0],this.normal[1]=b[1],this.normal[2]=b[2]);this._elementsDefined|=Mesh.NORMALS_BIT;return this};
Mesh.prototype.tangent3=function(b,c,a){"number"===typeof b&&"number"===typeof c&&"number"===typeof a?(this.tangent[0]=b,this.tangent[1]=c,this.tangent[2]=a):(this.tangent[0]=b[0],this.tangent[1]=b[1],this.tangent[2]=b[2]);this._elementsDefined|=Mesh.TANGENTS_BIT;return this};
Mesh.prototype.bitangent3=function(b,c,a){"number"===typeof b&&"number"===typeof c&&"number"===typeof a?(this.bitangent[0]=b,this.bitangent[1]=c,this.bitangent[2]=a):(this.bitangent[0]=b[0],this.bitangent[1]=b[1],this.bitangent[2]=b[2]);this._elementsDefined|=Mesh.BITANGENTS_BIT;return this};Mesh.prototype.transform=function(b){for(var c=0;c<this.subMeshes.length;c++)this.subMeshes[c].transform(b);return this};
Mesh.prototype.color3=function(b,c,a){"string"===typeof b?(b=GLUtil.toGLColor(b),this.color[0]=b[0],this.color[1]=b[1],this.color[2]=b[2]):"number"===typeof b&&"number"===typeof c&&"number"===typeof a?(this.color[0]=b,this.color[1]=c,this.color[2]=a):(this.color[0]=b[0],this.color[1]=b[1],this.color[2]=b[2]);this._elementsDefined|=Mesh.COLORS_BIT;return this};
Mesh.prototype.texCoord2=function(b,c){"number"===typeof b&&"number"===typeof c?(this.texCoord[0]=b,this.texCoord[1]=c):(this.texCoord[0]=b[0],this.texCoord[1]=b[1]);this._elementsDefined|=Mesh.TEXCOORDS_BIT;return this};
Mesh.prototype.vertex3=function(b,c,a){0===this.subMeshes.length&&this.subMeshes.push(new SubMesh);var d=this.subMeshes[this.subMeshes.length-1];null===b||"undefined"===typeof b||null!==c&&"undefined"!==typeof c||null!==a&&"undefined"!==typeof a?d.vertex3(b,c,a,this):"number"!==typeof b?d.vertex3(b[0],b[1],b[2],this):d.vertex3(b,b,b,this);return this};
Mesh.prototype.vertex2=function(b,c){return null===b||"undefined"===typeof b||null!==c&&"undefined"!==typeof c?this.vertex3(b,c,0):"number"!==typeof b?this.vertex3(b[0],b[1],0):this.vertex3(b,b,0)};Mesh.prototype.setColor3=function(b,c,a){var d=b;"string"===typeof b&&(b=GLUtil.toGLColor(b),d=b[0],c=b[1],a=b[2]);for(b=0;b<this.subMeshes.length;b++)this.subMeshes[b].setColor3(d,c,a);return this};
Mesh.prototype.recalcTangents=function(){for(var b=0;b<this.subMeshes.length;b++)this.subMeshes[b].primitiveType()===Mesh.TRIANGLES&&this.subMeshes[b].recalcTangents();return this};Mesh.prototype.recalcNormals=function(b,c){for(var a=0;a<this.subMeshes.length;a++){var d=this.subMeshes[a].primitiveType();d!==Mesh.POINTS&&d!==Mesh.LINES&&this.subMeshes[a].recalcNormals(b,c)}return this};
Mesh.prototype.normalizeNormals=function(){for(var b=0;b<this.subMeshes.length;b++){var c=this.subMeshes[b].getStride(),a=this.subMeshes[b].vertices,d=Mesh._normalOffset(this.subMeshes[b].attributeBits);if(!(0>d))for(b=0;b<a.length;b+=c){var e=a[b+d],g=a[b+d+1],f=a[b+d+2],e=Math.sqrt(e*e+g*g+f*f);0!==e&&(e=1/e,a[b+d]*=e,a[b+d+1]*=e,a[b+d+2]*=e)}}return this};Mesh.prototype.toWireFrame=function(){for(var b=new Mesh,c=0;c<this.subMeshes.length;c++)b.subMeshes.push(this.subMeshes[c].toWireFrame());return b};
Mesh.prototype.setVertex=function(b,c,a,d){if(0>b)return this;"undefined"===typeof a&&"undefined"===typeof d&&(a=c[1],d=c[2],c=c[0]);for(var e=0,g=0;g<this.subMeshes.length;g++){var f=this.subMeshes[g],h=f.vertexCount(),h=e+h;if(b<h){b-=e;b*=f.getStride();f.vertices[b]=c;f.vertices[b+1]=a;f.vertices[b+2]=d;break}e=h}return this};
Mesh.prototype.setVertexNormal=function(b,c,a,d){if(0>b)return this;var e=0;"undefined"===typeof a&&"undefined"===typeof d&&(a=c[1],d=c[2],c=c[0]);for(var g=0;g<this.subMeshes.length;g++){var f=this.subMeshes[g],h=f.vertexCount(),h=e+h;if(b<h){b-=e;f._rebuildVertices(Mesh.NORMALS_BIT);b*=f.getStride();b+=Mesh._normalOffset(f.attributeBits);f.vertices[b]=c;f.vertices[b+1]=a;f.vertices[b+2]=d;break}e=h}return this};
Mesh.prototype.getVertex=function(b){if(0>b)return null;for(var c=0,a=0;a<this.subMeshes.length;a++){var d=this.subMeshes[a],e=d.vertexCount(),e=c+e;if(b<e)return b-=c,b*=d.getStride(),d.vertices.slice(b,b+3);c=e}return null};
Mesh.prototype.getVertexNormal=function(b){for(var c=0,a=0;a<this.subMeshes.length;a++){var d=this.subMeshes[a],e=d.vertexCount(),e=c+e;if(b<e)return 0!==(d.attributeBits&Mesh.NORMALS_BIT)?(b-=c,b*=d.getStride(),b+=Mesh._normalOffset(d.attributeBits),d.vertices.slice(b,b+3)):[0,0,0];c=e}return null};Mesh.prototype.vertexCount=function(){for(var b=0,c=0;c<this.subMeshes.length;c++)b+=this.subMeshes[c].vertexCount();return b};
Mesh.prototype.primitiveCount=function(){for(var b=0,c=0;c<this.subMeshes.length;c++)b+=this.subMeshes[c].primitiveCount();return b};
SubMesh.prototype._initialize=function(b,c,a){this.vertices=b||[];this.indices=c||[];this.startIndex=0;b=a&Mesh.PRIMITIVES_BITS;if(0!==b&&b!==Mesh.LINES_BIT&&b!==Mesh.POINTS_BIT)throw Error("invalid format");this.attributeBits=null===a||"undefined"===typeof a?0:a;this.vertexCount=function(){return this.vertices.length/this.getStride()};this.getStride=function(){return Mesh._getStride(this.attributeBits)};this.newPrimitive=function(a){this.startIndex=this.vertices.length;return this};this.primitiveType=
function(){var a=Mesh.TRIANGLES;0!==(this.attributeBits&Mesh.LINES_BIT)&&(a=Mesh.LINES);0!==(this.attributeBits&Mesh.POINTS_BIT)&&(a=Mesh.POINTS);return a};this._rebuildVertices=function(a){var b=this.attributeBits;a=b|a&Mesh.ATTRIBUTES_BITS;if(a!==b){for(var c=this.getStride(),f,h,k,l=[],p=0;p<this.vertices.length;p+=c){var m=p+3;l.push(this.vertices[p],this.vertices[p+1],this.vertices[p+2]);0!==(a&Mesh.NORMALS_BIT)&&(0!==(b&Mesh.NORMALS_BIT)?(f=this.vertices[m],h=this.vertices[m+1],k=this.vertices[m+
2],m+=3,l.push(f,h,k)):l.push(0,0,0));0!==(a&Mesh.COLORS_BIT)&&(0!==(b&Mesh.COLORS_BIT)?(f=this.vertices[m],h=this.vertices[m+1],k=this.vertices[m+2],m+=3,l.push(f,h,k)):l.push(0,0,0));0!==(a&Mesh.TEXCOORDS_BIT)&&(0!==(b&Mesh.TEXCOORDS_BIT)?(f=this.vertices[m],h=this.vertices[m+1],m+=2,l.push(f,h)):l.push(0,0));0!==(a&Mesh.TANGENTS_BIT)&&(0!==(b&Mesh.TANGENTS_BIT)?(f=this.vertices[m],h=this.vertices[m+1],k=this.vertices[m+2],m+=3,l.push(f,h,k)):l.push(0,0,0));0!==(a&Mesh.BITANGENTS_BIT)&&(0!==(b&
Mesh.BITANGENTS_BIT)?(f=this.vertices[m],h=this.vertices[m+1],k=this.vertices[m+2],l.push(f,h,k)):l.push(0,0,0))}this.vertices=l;this.attributeBits=a}};this._setTriangle=function(a,b,c,f,h){var k=c*b,l=f*b,p=h*b,m=0,q=this.vertices;for(a-=b;0<=a&&16>m;a-=b,m++){for(var t=7,n=0;n<b&&0!==t;n++)0!==(t&1)&&q[k+n]!==q[a+n]&&(t&=-2),0!==(t&2)&&q[l+n]!==q[a+n]&&(t&=-3),0!==(t&4)&&q[p+n]!==q[a+n]&&(t&=-5);if(0!==(t&1)){c=a/b;k=c*b;break}if(0!==(t&2)){f=a/b;l=f*b;break}if(0!==(t&4)){h=a/b;p=h*b;break}}q[k]===
q[l]&&q[k+1]===q[l+1]&&q[k+2]===q[l+2]||q[k]===q[p]&&q[k+1]===q[p+1]&&q[k+2]===q[p+2]||q[l]===q[p]&&q[l+1]===q[p+1]&&q[l+2]===q[p+2]||this.indices.push(c,f,h)};this.vertex3=function(a,b,c,f){var h=f.currentMode;if(-1===h)throw Error("mode() not called");this._rebuildVertices(f._elementsDefined);var k=this.vertices.length;this.vertices.push(a,b,c);0!==(this.attributeBits&Mesh.NORMALS_BIT)&&this.vertices.push(f.normal[0],f.normal[1],f.normal[2]);0!==(this.attributeBits&Mesh.COLORS_BIT)&&this.vertices.push(f.color[0],
f.color[1],f.color[2]);0!==(this.attributeBits&Mesh.TEXCOORDS_BIT)&&this.vertices.push(f.texCoord[0],f.texCoord[1]);0!==(this.attributeBits&Mesh.TANGENTS_BIT)&&this.vertices.push(f.tangent[0],f.tangent[1],f.tangent[2]);0!==(this.attributeBits&Mesh.BITANGENTS_BIT)&&this.vertices.push(f.bitangent[0],f.bitangent[1],f.bitangent[2]);a=this.getStride();h===Mesh.QUAD_STRIP&&this.vertices.length-this.startIndex>=4*a&&0===(this.vertices.length-this.startIndex)%(2*a)?(h=this.vertices.length/a-4,this._setTriangle(k,
a,h,h+1,h+2),this._setTriangle(k,a,h+2,h+1,h+3)):h===Mesh.QUADS&&0===(this.vertices.length-this.startIndex)%(4*a)?(h=this.vertices.length/a-4,this._setTriangle(k,a,h,h+1,h+2),this._setTriangle(k,a,h,h+2,h+3)):h===Mesh.TRIANGLES&&0===(this.vertices.length-this.startIndex)%(3*a)?(h=this.vertices.length/a-3,this._setTriangle(k,a,h,h+1,h+2)):h===Mesh.LINES&&0===(this.vertices.length-this.startIndex)%(2*a)?(h=this.vertices.length/a-2,this.indices.push(h,h+1)):h===Mesh.TRIANGLE_FAN&&this.vertices.length-
this.startIndex>=3*a?(h=this.vertices.length/a-2,b=this.startIndex/a,this._setTriangle(k,a,b,h,h+1)):h===Mesh.LINE_STRIP&&this.vertices.length-this.startIndex>=2*a?(h=this.vertices.length/a-2,this.indices.push(h,h+1)):h===Mesh.POINTS?(h=this.vertices.length/a-1,this.indices.push(h)):h===Mesh.TRIANGLE_STRIP&&this.vertices.length-this.startIndex>=3*a&&(h=this.vertices.length/a-3,b=this.startIndex/a,0===(h-b&1)?this._setTriangle(k,a,h,h+1,h+2):this._setTriangle(k,a,h+1,h,h+2));return this}};
SubMesh.prototype.makeRedundant=function(){for(var b=[],c=this.getStride(),a=this.indices.length,d=0;d<a;d++){var e=this.indices[d];if(b[e]){for(var g=e*c,f=this.vertices.length/c,h=0;h<c;h++)this.vertices.push(this.vertices[g+h]);this.indices[d]=f}b[e]=!0}return this};SubMesh.prototype.primitiveCount=function(){return 0!==(this.attributeBits&Mesh.LINES_BIT)?Math.floor(this.indices.length/2):0!==(this.attributeBits&Mesh.POINTS_BIT)?this.indices.length:Math.floor(this.indices.length/3)};
SubMesh.prototype.toWireFrame=function(){function b(a,b,c,d){if(c<d){var e=c;c=d;d=e}(e=b[c])?0>e.indexOf(d)&&(e.push(d),a.push(c,d)):(b[c]=[d],a.push(c,d))}if(0!==(this.attributeBits&Mesh.PRIMITIVES_BITS))return this;for(var c=[],a={},d=0;d<this.indices.length;d+=3){var e=this.indices[d],g=this.indices[d+1],f=this.indices[d+2];b(c,a,e,g);b(c,a,g,f);b(c,a,f,e)}return new SubMesh(this.vertices,c,this.attributeBits|Mesh.LINES_BIT)};
SubMesh._isIdentityInUpperLeft=function(b){return 1===b[0]&&0===b[1]&&0===b[2]&&0===b[4]&&1===b[5]&&0===b[6]&&0===b[8]&&0===b[9]&&1===b[10]?!0:!1};
SubMesh.prototype.transform=function(b){var c=this.getStride(),a=this.vertices,d=!SubMesh._isIdentityInUpperLeft(b),e=Mesh._normalOffset(this.attributeBits),g=null;0<=e&&d&&(g=GLMath.mat4inverseTranspose3(b));for(var f=0;f<a.length;f+=c){var h=GLMath.mat4transform(b,a[f],a[f+1],a[f+2],1);a[f]=h[0];a[f+1]=h[1];a[f+2]=h[2];0<=e&&d&&(h=GLMath.mat3transform(g,a[f+e],a[f+e+1],a[f+e+2]),GLMath.vec3normInPlace(h),a[f+e]=h[0],a[f+e+1]=h[1],a[f+e+2]=h[2])}this.newPrimitive();return this};
Mesh.prototype.reverseWinding=function(){for(var b=0;b<this.subMeshes.length;b++)this.subMeshes[b].reverseWinding();return this};
Mesh.prototype.enumPrimitives=function(b){for(var c=0;c<this.subMeshes.length;c++){var a=this.subMeshes[c],d=a.primitiveType(),e=Mesh._normalOffset(a.attributeBits),g=Mesh._colorOffset(a.attributeBits),f=Mesh._texCoordOffset(a.attributeBits),h=a.getStride(),k=a.vertices,l=3;d===Mesh.LINES&&(l=2);d===Mesh.POINTS&&(l=1);for(d=0;d<a.indices.length;d+=l){for(var p=[],m=0;m<l;m++){var q=a.indices[d+m]*h,t={};t.position=[k[q],k[q+1],k[q+2]];0<=e&&(t.normal=[k[q+e],k[q+e+1],k[q+e+2]]);0<=g&&(t.color=[k[q+
g],k[q+g+1],k[q+g+2]]);0<=f&&(t.uv=[k[q+f],k[q+f+1]]);p.push(t)}b(p)}}return this};
Mesh.prototype.getBoundingBox=function(){for(var b=!0,c=Number.POSITIVE_INFINITY,c=[c,c,c,-c,-c,-c],a=0;a<this.subMeshes.length;a++)for(var d=this.subMeshes[a],e=d.getStride(),g=d.vertices,f=0;f<d.indices.length;f++){var h=d.indices[f]*e;b?(b=!1,c[0]=c[3]=g[h],c[1]=c[4]=g[h+1],c[2]=c[5]=g[h+2]):(c[0]=Math.min(c[0],g[h]),c[3]=Math.max(c[3],g[h]),c[1]=Math.min(c[1],g[h+1]),c[4]=Math.max(c[4],g[h+1]),c[2]=Math.min(c[2],g[h+2]),c[5]=Math.max(c[5],g[h+2]))}return c};
Mesh._findTangentAndBitangent=function(b,c,a,d,e){var g=b[a]-b[c],f=b[a+1]-b[c+1],h=b[a+2]-b[c+2],k=b[d]-b[c],l=b[d+1]-b[c+1],p=b[d+2]-b[c+2],m=b[a+e]-b[c+e],q=b[a+e+1]-b[c+e+1];a=b[d+e]-b[c+e];b=b[d+e+1]-b[c+e+1];c=m*b-q*a;if(0===c)return[0,0,0,0,0,0];c=1/c;q=-q;a=-a;return[(b*g+q*k)*c,(b*f+q*l)*c,(b*h+q*p)*c,(a*g+m*k)*c,(a*f+m*l)*c,(a*h+m*p)*c]};
Mesh._recalcTangentsInternal=function(b,c,a,d,e,g){for(var f=[0,0,0],h=0;h<c.length;h+=3){f[0]=c[h]*a;f[1]=c[h+1]*a;f[2]=c[h+2]*a;for(var k=Mesh._findTangentAndBitangent(b,f[0],f[1],f[2],d),l=0;3>l;l++){var p=k,m=f[l],q=b[m+e],t=b[m+e+1],n=b[m+e+2],r=p[0]*q+p[1]*t+p[2]*n,r=GLMath.vec3normInPlace([p[0]-r*q,p[1]-r*t,p[2]-r*n]),u=p[3]*q+p[4]*t+p[5]*n,x=p[3]*r[0]+p[4]*r[1]+p[5]*r[2],p=GLMath.vec3normInPlace([p[3]-u*q-x*r[0],p[4]-u*t-x*r[1],p[5]-u*n-x*r[2]]);b[m+g]=r[0];b[m+g+1]=r[1];b[m+g+2]=r[2];b[m+
g+3]=p[0];b[m+g+4]=p[1];b[m+g+5]=p[2]}}};SubMesh.prototype.recalcTangents=function(){var b=Mesh.TANGENTS_BIT|Mesh.BITANGENTS_BIT,c=0!==(this.attributeBits&Mesh.ATTRIBUTES_BITS&~b),a=Mesh._texCoordOffset(this.attributeBits),d=Mesh._normalOffset(this.attributeBits);if(0>a||0>d)return this;this._rebuildVertices(b);c&&this.makeRedundant();this.primitiveType()===Mesh.TRIANGLES&&(b=Mesh._tangentOffset(this.attributeBits),Mesh._recalcTangentsInternal(this.vertices,this.indices,this.getStride(),a,d,b));return this};
Mesh.prototype.reverseNormals=function(){for(var b=0;b<this.subMeshes.length;b++){var c=this.subMeshes[b].getStride(),a=this.subMeshes[b].vertices,d=Mesh._normalOffset(this.subMeshes[b].attributeBits);if(!(0>d))for(b=0;b<a.length;b+=c){var e=a[b+d+1],g=a[b+d+2];a[b+d]=-a[b+d];a[b+d+1]=-e;a[b+d+2]=-g}}return this};
SubMesh.prototype.reverseWinding=function(){if(0!==(this.attributeBits&Mesh.PRIMITIVES_BITS))return this;for(var b=0;b<this.indices.length;b+=3){var c=this.indices[b+2];this.indices[b+2]=this.indices[b+1];this.indices[b+1]=c}return this};
SubMesh.prototype.recalcNormals=function(b,c){var a=0!==(this.attributeBits&Mesh.ATTRIBUTES_BITS&~Mesh.NORMALS_BIT);this._rebuildVertices(Mesh.NORMALS_BIT);(a||b)&&this.makeRedundant();a=this.primitiveType();a!==Mesh.LINES&&a!==Mesh.POINTS&&Mesh._recalcNormals(this.vertices,this.indices,this.getStride(),3,b,c);return this};
SubMesh.prototype.setColor3=function(b,c,a){this._rebuildVertices(Mesh.COLORS_BIT);for(var d=this.getStride(),e=Mesh._colorOffset(this.attributeBits);e<this.vertices.length;e+=d)this.vertices[e]=b,this.vertices[e+1]=c,this.vertices[e+2]=a;return this};Mesh._getStride=function(b){var c=[3,6,6,9,5,8,8,11][b&(Mesh.NORMALS_BIT|Mesh.COLORS_BIT|Mesh.TEXCOORDS_BIT)];0!==(b&Mesh.TANGENTS_BIT)&&(c+=3);0!==(b&Mesh.BITANGENTS_BIT)&&(c+=3);return c};
Mesh._normalOffset=function(b){return[-1,3,-1,3,-1,3,-1,3][b&(Mesh.NORMALS_BIT|Mesh.COLORS_BIT|Mesh.TEXCOORDS_BIT)]};Mesh._tangentOffset=function(b){var c=3;if(0===(b&Mesh.TANGENTS_BIT))return-1;0!==(b&Mesh.NORMALS_BIT)&&(c+=3);0!==(b&Mesh.COLORS_BIT)&&(c+=3);0!==(b&Mesh.TEXCOORDS_BIT)&&(c+=2);return c};
Mesh._bitangentOffset=function(b){var c=3;if(0===(b&Mesh.BITANGENTS_BIT))return-1;0!==(b&Mesh.NORMALS_BIT)&&(c+=3);0!==(b&Mesh.COLORS_BIT)&&(c+=3);0!==(b&Mesh.TEXCOORDS_BIT)&&(c+=2);0!==(b&Mesh.TANGENTS_BIT)&&(c+=3);return c};Mesh._colorOffset=function(b){return[-1,-1,3,6,-1,-1,3,6][b&(Mesh.NORMALS_BIT|Mesh.COLORS_BIT|Mesh.TEXCOORDS_BIT)]};Mesh._texCoordOffset=function(b){return[-1,-1,-1,-1,3,6,6,9][b&(Mesh.NORMALS_BIT|Mesh.COLORS_BIT|Mesh.TEXCOORDS_BIT)]};Mesh.ATTRIBUTES_BITS=255;
Mesh.PRIMITIVES_BITS=768;Mesh.NORMALS_BIT=1;Mesh.COLORS_BIT=2;Mesh.TEXCOORDS_BIT=4;Mesh.TANGENTS_BIT=8;Mesh.BITANGENTS_BIT=16;Mesh.LINES_BIT=256;Mesh.POINTS_BIT=512;Mesh.TRIANGLES=4;Mesh.QUAD_STRIP=8;Mesh.QUADS=7;Mesh.LINES=1;Mesh.TRIANGLE_FAN=6;Mesh.TRIANGLE_STRIP=5;Mesh.LINE_STRIP=3;Mesh.POINTS=0;this.Mesh=Mesh;
function Material(b,c,a,d,e){null!==b&&"undefined"!==typeof b&&(b=GLUtil.toGLColor(b));null!==c&&"undefined"!==typeof c&&(c=GLUtil.toGLColor(c));null!==a&&"undefined"!==typeof a&&(a=GLUtil.toGLColor(a));null!==e&&"undefined"!==typeof e&&(e=GLUtil.toGLColor(e));this.shininess=null===d||"undefined"===typeof d?0:Math.min(Math.max(0,d),128);this.ambient=b?b.slice(0,3):[.2,.2,.2];this.diffuse=c?c.slice(0,c.length):[.8,.8,.8,1];this.specular=a?a.slice(0,3):[0,0,0];this.emission=e?e.slice(0,3):[0,0,0];this.normalMap=
this.specularMap=this.texture=null;this.basic=!1;this.shader=null}Material.prototype.copy=function(){return(new Material(this.ambient.slice(0,this.ambient.length),this.diffuse.slice(0,this.diffuse.length),this.specular.slice(0,this.specular.length),this.shininess,this.emission.slice(0,this.emission.length))).setParams({texture:this.texture,specularMap:this.specularMap,normalMap:this.normalMap,basic:this.basic,shader:this.shader})};
Material.prototype.setParams=function(b){var c;"undefined"!==typeof b.ambient&&"undefined"!==typeof b.ambient&&"undefined"!==typeof b.ambient&&null!==b.ambient&&(this.ambient=GLUtil.toGLColor(b.ambient),3<this.ambient.length&&(this.ambient=this.ambient.slice(0,3)));"undefined"!==typeof b.diffuse&&"undefined"!==typeof b.diffuse&&"undefined"!==typeof b.diffuse&&null!==b.diffuse&&(this.diffuse=GLUtil.toGLColor(b.diffuse),4<this.diffuse.length&&(this.diffuse=this.diffuse.slice(0,4)));"undefined"!==typeof b.specular&&
"undefined"!==typeof b.specular&&"undefined"!==typeof b.specular&&null!==b.specular&&(this.specular=GLUtil.toGLColor(b.specular),3<this.specular.length&&(this.specular=this.specular.slice(0,3)));"undefined"!==typeof b.emission&&"undefined"!==typeof b.emission&&"undefined"!==typeof b.emission&&null!==b.emission&&(this.emission=GLUtil.toGLColor(b.emission),3<this.emission.length&&(this.emission=this.emission.slice(0,3)));"undefined"!==typeof b.shininess&&"undefined"!==typeof b.shininess&&"undefined"!==
typeof b.shininess&&null!==b.shininess&&(this.shininess=b.shininess);"undefined"!==typeof b.texture&&"undefined"!==typeof b.texture&&"undefined"!==typeof b.texture&&null!==b.texture&&(c=b.texture,this.texture="string"===typeof c?new Texture(c):c);"undefined"!==typeof b.specularMap&&"undefined"!==typeof b.specularMap&&"undefined"!==typeof b.specularMap&&null!==b.specularMap&&(c=b.specularMap,this.specularMap="string"===typeof c?new Texture(c):c);"undefined"!==typeof b.normalMap&&"undefined"!==typeof b.normalMap&&
"undefined"!==typeof b.normalMap&&null!==b.normalMap&&(c=b.normalMap,this.normalMap="string"===typeof c?new Texture(c):c);"undefined"!=typeof b.basic&&(this.basic=b.basic);"undefined"!=typeof b.shader&&(this.shader=b.shader);return this};Material.fromColor=function(b,c,a,d){b=GLUtil.toGLColor(b,c,a,d);return new Material(b,b)};Material.fromTexture=function(b){return(new Material).setParams({texture:b})};Material.forShader=function(b){return(new Material).setParams({shader:b})};
function Subscene3D(b){this.parent=b;this._projectionMatrix=GLMath.mat4identity();this._viewMatrix=GLMath.mat4identity();this.lightSource=new Lights;this._frustum=null;this.shapes=[]}
Subscene3D._setupMatrices=function(b,c,a,d,e){var g={};e&&(g.view=a,g.projection=c,g.viewMatrix=a,g.projectionMatrix=c,c=b.get("viewInvW"),null!==c&&"undefined"!==typeof c&&(c=GLMath.mat4invert(a),g.viewInvW=[c[12],c[13],c[14],c[15]]));c=b.get("modelViewMatrix");null!==c&&"undefined"!==typeof c&&(GLUtil._isIdentityExceptTranslate(a)?(c=d.slice(0,16),c[12]+=a[12],c[13]+=a[13],c[14]+=a[14]):c=GLMath.mat4multiply(a,d),g.modelViewMatrix=c);a=GLMath.mat4inverseTranspose3(d);g.world=d;g.modelMatrix=d;g.worldViewInvTrans3=
a;g.normalMatrix=a;b.setUniforms(g)};Subscene3D.prototype.setProjectionMatrix=function(b){this._projectionMatrix=b.slice(0,16)};Subscene3D.prototype.setViewMatrix=function(b){this._viewMatrix=b.slice(0,16)};Subscene3D.prototype.getProjectionMatrix=function(){return this._projectionMatrix.slice(0,16)};Subscene3D.prototype.getViewMatrix=function(){return this._viewMatrix.slice(0,16)};
Subscene3D.prototype._getFrustum=function(){if(null==this._frustum){var b=GLMath.mat4multiply(this._projectionMatrix,this._viewMatrix);this._frustum=GLMath.mat4toFrustumPlanes(b)}return this._frustum};Subscene3D.prototype.getLightSource=function(){return this.lightSource};Subscene3D.prototype.addShape=function(b){b.parent=null;this.shapes.push(b);return this};Subscene3D.prototype.removeShape=function(b){for(var c=0;c<this.shapes.length;c++)this.shapes[c]===b&&(this.shapes.splice(c,1),c--);return this};
Subscene3D.prototype._renderShape=function(b,c){if(b.constructor===ShapeGroup){if(b.visible)for(var a=0;a<b.shapes.length;a++)this._renderShape(b.shapes[a],c)}else if(!b.isCulled(this._getFrustum())){var a=null,a=b.material instanceof Material?b.material.shader?b.material.shader:this.parent._programs.getProgram(Scene3D._materialToFlags(b.material)):this.parent._programs.getProgram(0),d=!1;c.prog!=a&&(a.use(),d=!0,(new LightsBinder(this.lightSource)).bind(a),c.prog=a);Subscene3D._setupMatrices(a,this._projectionMatrix,
this._viewMatrix,b.getMatrix(),d);Binders.getMaterialBinder(b.material).bind(a);b.bufferedMesh.draw(a)}};Subscene3D.prototype.render=function(){for(var b={},c=0;c<this.shapes.length;c++)this._renderShape(this.shapes[c],b);return this};
(function(b){var c=function(a,b,c){if("undefined"===typeof b&&"undefined"===typeof c)this.uoffset=0,this.umul=1;else{if(b===c)throw Error("u1 and u2 can't be equal");this.uoffset=b;this.umul=1/(c-b)}this.evaluator=d.clamped(a,a.length-1)};c.prototype.evaluate=function(a){return this.evaluator.evaluate((a-this.uoffset)*this.umul)};var a=function(a,b,c,d,f){if("undefined"===typeof b&&"undefined"===typeof c&&"undefined"===typeof d&&"undefined"===typeof f)this.uoffset=0,this.umul=1,this.voffset=0,this.vmul=
1;else{if(b===c)throw Error("u1 and u2 can't be equal");if(d===f)throw Error("v1 and v2 can't be equal");this.uoffset=b;this.umul=1/(c-b);this.voffset=d;this.vmul=1/(f-d)}this.evaluator=e.clamped(a,a[0].length-1,a.length-1)};a.prototype.evaluate=function(a,b,c){return this.evaluator.evaluate((a-this.uoffset)*this.umul,(b-this.voffset)*this.vmul)};var d=function(a,b,c){if(0>=a.length)throw Error();if(!b)throw Error();this.bits=c||0;c=b.length-a.length;if(2>c||c>a.length)throw Error();d._checkKnots(b);
this.cplen=a[0].length;c=1;0!==(this.bits&(d.WEIGHTED_BIT|d.DIVIDE_BIT))&&(c=2);0!==(this.bits&d.WEIGHTED_BIT)&&this.cplen--;if(this.cplen<c)throw Error();this.knots=b;this.buffer=[];this.controlPoints=a};d.WEIGHTED_BIT=1;d.DIVIDE_BIT=2;d.HOMOGENEOUS_BIT=4;d.WEIGHTED_DIVIDE_BITS=3;d._checkKnots=function(a){for(var b=1;b<a.length;b++)if(a[b]<a[b-1])throw Error();if(a[0]===a[a.length-1])throw Error();};d._getFactors=function(a,b,c,d,e){for(var f=1,g=0;g<d;g++)e[g]=0;if(b===a[0])e[0]=1;else if(b===a[a.length-
1])e[d-1]=1;else{d=-1;for(g=0;g<=a.length;g++)if(a[g]<=b&&b<a[g+1]){d=g;break}if(!(0>d)){var n=[],f=d-1;n[d]=1;for(var r=2;r<=c;r++,f--){for(g=f;g<=d;g++){var u=0,x=0,v=g<=f?0:n[g],y=g>=d?0:n[g+1];0!==v&&(x=a[g+r-1]-a[g],u+=0===x?0:v*(b-a[g])/x);0!==y&&(v=a[g+r],x=v-a[g+1],u+=0===x?0:y*(v-b)/x);e[g]=u}if(r<c)for(g=f;g<=d;g++)n[g]=e[g]}}}};d.prototype.evaluate=function(a){var b=this.controlPoints.length,c=this.knots.length-b;a=this.knots[c-1]+a*(this.knots[b]-this.knots[c-1]);d._getFactors(this.knots,
a,c,b,this.buffer);a=[];var e,f;if(0!==(this.bits&d.WEIGHTED_BIT)){var g=0;for(e=0;e<b;e++)g+=this.buffer[e]*this.controlPoints[e][this.cplen];for(var t=0!==(this.bits&d.HOMOGENEOUS_BIT),c=0;c<this.cplen+1;c++){for(e=f=0;e<b;e++){var n=this.buffer[e];t||(n*=this.controlPoints[e][this.cplen]);f+=this.controlPoints[e][c]*n}a[c]=f/g}if(0!==(this.bits&d.DIVIDE_BIT)){for(c=0;c<this.cplen;c++)a[c]/=a[this.cplen];a=a.slice(0,this.cplen)}}else{a=[];for(c=0;c<this.cplen;c++){for(e=f=0;e<b;e++)f+=this.controlPoints[e][c]*
this.buffer[e];a[c]=f}if(0!==(this.bits&d.DIVIDE_BIT)){for(c=0;c<this.cplen-1;c++)a[c]/=a[this.cplen-1];a=a.slice(0,this.cplen-1)}}return a};var e=function(a,b,c,e){var f=a.length;if(0>=f)throw Error();var g=a[0].length;if(0>=g)throw Error();var t=a[0][0].length,n=1;this.bits=e||0;0!==(this.bits&(d.WEIGHTED_BIT|d.DIVIDE_BIT))&&(n=2);0!==(this.bits&(d.WEIGHTED_BIT|d.HOMOGENEOUS_BIT))&&t--;if(t<n)throw Error();if(!b||!c)throw Error();this.orderU=b.length-g;this.orderV=c.length-f;this.vcplen=f;this.ucplen=
g;this.cplen=t;if(2>this.orderU||this.orderU>g)throw Error();if(2>this.orderV||this.orderV>f)throw Error();d._checkKnots(b);d._checkKnots(c);this.knotsU=b;this.knotsV=c;this.bufferU=[];this.bufferV=[];this.controlPoints=a};d.clamped=function(a,b,c){return new d(a,d.clampedKnots(a.length,b),c)};d.uniform=function(a,b,c){return new d(a,d.uniformKnots(a.length,b),c)};e.clamped=function(a,b,c,f){return new e(a,d.clampedKnots(a[0].length,b),d.clampedKnots(a.length,c),f)};e.uniform=function(a,b,c,f){return new e(a,
d.uniformKnots(a[0].length,b),d.uniformKnots(a.length,c),f)};d.uniformKnots=function(a,b){"object"===typeof a&&(a=a.length);if(null===b||"undefined"===typeof b)b=3;if(a<b+1)throw Error("too few control points for degree "+b+" curve");for(var c=b+1,d=[],e=0;e<a+c;e++)d.push(e);return d};d.clampedKnots=function(a,b){"object"===typeof a&&(a=a.length);if(null===b||"undefined"===typeof b)b=3;if(a<b+1)throw Error("too few control points for degree "+b+" curve");for(var c=b+1,d=a-c,e=[],f=0;f<c;f++)e.push(0);
for(f=0;f<d;f++)e.push(f+1);for(f=0;f<c;f++)e.push(d+1);return e};e.prototype.evaluate=function(a,b){a=this.knotsU[this.orderU-1]+a*(this.knotsU[this.ucplen]-this.knotsU[this.orderU-1]);b=this.knotsV[this.orderV-1]+b*(this.knotsV[this.vcplen]-this.knotsV[this.orderV-1]);var c=this.bufferU,e=this.bufferV,f,g,t,n,r;d._getFactors(this.knotsU,a,this.orderU,this.ucplen,this.bufferU);d._getFactors(this.knotsV,b,this.orderV,this.vcplen,this.bufferV);var u=[];if(0!==(this.bits&d.WEIGHTED_BIT)){var x=0,v=
0!==(this.bits&d.HOMOGENEOUS_BIT);for(f=0;f<this.ucplen;f++)for(g=0;g<this.vcplen;g++)t=c[f]*e[g]*this.controlPoints[g][f][this.cplen],x+=t;for(n=0;n<this.cplen+1;n++){for(f=x=r=0;f<this.ucplen;f++)for(g=0;g<this.vcplen;g++)t=c[f]*e[g],v||(t*=this.controlPoints[g][f][this.cplen]),r+=this.controlPoints[g][f][n]*t;u[n]=0===x?r:r/x}if(0!==(this.bits&d.DIVIDE_BIT)){for(n=0;n<this.cplen;n++)u[n]/=u[this.cplen];u=u.slice(0,this.cplen)}}else{for(n=0;n<this.cplen;n++){for(f=r=0;f<this.ucplen;f++)for(g=0;g<
this.vcplen;g++)r+=this.controlPoints[g][f][n]*c[f]*e[g];u[n]=r}if(0!==(this.bits&d.DIVIDE_BIT)){for(n=0;n<this.cplen-1;n++)u[n]/=u[this.cplen-1];u=u.slice(0,this.cplen-1)}}return u};var g=function(){this.vertexCurve=this.texCoordCurve=this.normalCurve=this.colorCurve=null};g.prototype.vertex=function(a){this.vertexCurve=a;return this};g.prototype.normal=function(a){this.normalCurve=a;return this};g.prototype.color=function(a){this.colorCurve=a;return this};g.prototype.texCoord=function(a){this.texCoordCurve=
a;return this};g.prototype.evalOne=function(a,b){var c=null,d=null,e=null;this.colorCurve&&(c=this.colorCurve.evaluate(b));this.texCoordCurve&&(e=this.texCoordCurve.evaluate(b),1===e.length&&e.push(0));this.normalCurve&&(d=this.normalCurve.evaluate(b));if(this.vertexCurve){var f=c?a.color.slice(0,3):null,g=d?a.normal.slice(0,3):null,n=e?a.texCoord.slice(0,2):null;c&&a.color3(c[0],c[1],c[2]);d&&a.normal3(d[0],d[1],d[2]);e&&a.texCoord2(e[0],e[1]);c=this.vertexCurve.evaluate(b);2===c.length?a.vertex3(c[0],
c[1],0):a.vertex3(c[0],c[1],c[2]);f&&a.color3(f[0],f[1],f[2]);g&&a.normal3(g[0],g[1],g[2]);n&&a.texCoord2(n[0],n[1])}return this};g.prototype.evalCurve=function(a,b,c,d,e){"undefined"===typeof c&&(c=24);if(0>=c)throw Error("invalid n");"undefined"===typeof d&&"undefined"===typeof e&&(d=0,e=1);if(null===b||"undefined"===typeof b)b=Mesh.LINES;if(b===Mesh.POINTS)a.mode(Mesh.POINTS);else if(b===Mesh.LINES)a.mode(Mesh.LINE_STRIP);else return this;b=(e-d)/c;for(e=0;e<=c;e++)this.evalOne(a,d+e*b);return this};
var f=function(){this.vertexSurface=this.texCoordSurface=this.normalSurface=this.colorSurface=null;this.autoNormal=!1};f.prototype.setAutoNormal=function(a){this.autoNormal=!!a;return this};f.prototype.vertex=function(a){this.vertexSurface=a;return this};f.prototype.normal=function(a){this.normalSurface=a;return this};f.prototype.color=function(a){this.colorSurface=a;return this};f.prototype.texCoord=function(a){this.texCoordSurface=a;return this};f.prototype.evalOne=function(a,b,c){var d=[];this._saveValues(a,
d,0);this._record(b,c,d,8);this._playBack(a,d,8);this._restoreValues(a,d,0);return this};f.prototype._recordAndPlayBack=function(a,b,c,d,e){this._record(b,c,d,e);this._playBack(a,d,e)};f.prototype._saveValues=function(a,b,c){this.colorSurface&&(b[c+3]=a.color[0],b[c+4]=a.color[1],b[c+5]=a.color[2]);if(this.normalSurface||this.autoNormal)b[c+0]=a.normal[0],b[c+1]=a.normal[1],b[c+2]=a.normal[2];this.texCoordSurface&&(b[c+6]=a.texCoord[0],b[c+7]=a.texCoord[1])};f.prototype._restoreValues=function(a,
b,c){this.colorSurface&&a.color3(b[c+3],b[c+4],b[c+5]);(this.normalSurface||this.autoNormal)&&a.normal3(b[c+0],b[c+1],b[c+2]);this.texCoordSurface&&a.texCoord2(b[c+6],b[c+7])};f.prototype._record=function(a,b,c,d){var e=null;this.colorSurface&&(e=this.colorSurface.evaluate(a,b),c[d+6]=e[0],c[d+7]=e[1],c[d+8]=e[2]);this.texCoordSurface&&(e=this.texCoordSurface.evaluate(a,b),c[d+9]=e[0],c[d+10]=1>=e.length?0:e[1]);this.normalSurface&&!this.autoNormal&&(e=this.normalSurface.evaluate(a,b),c[d+3]=e[0],
c[d+4]=e[1],c[d+5]=e[2]);if(this.vertexSurface&&(e=this.vertexSurface.evaluate(a,b),c[d]=e[0],c[d+1]=e[1],c[d+2]=e[2],this.autoNormal)){var f=1E-5,g=1E-5,n=this.vertexSurface.evaluate(a+f,b);0===n[0]&&0===n[1]&&0===n[2]&&(f=-f,n=this.vertexSurface.evaluate(a+f,b));var r=this.vertexSurface.evaluate(a,b+g);0===r[0]&&0===r[1]&&0===r[2]&&(g=-g,r=this.vertexSurface.evaluate(a,b+g));GLMath.vec3subInPlace(r,e);GLMath.vec3subInPlace(n,e);GLMath.vec3scaleInPlace(n,1/f);GLMath.vec3scaleInPlace(r,1/g);GLMath.vec3normInPlace(n);
GLMath.vec3normInPlace(r);0===GLMath.vec3length(n)?n=r:0!==GLMath.vec3length(r)?(n=GLMath.vec3cross(n,r),GLMath.vec3normInPlace(n)):n[2]===e[2]&&(n=[0,0,1]);c[d+3]=n[0];c[d+4]=n[1];c[d+5]=n[2]}};f.prototype._playBack=function(a,b,c){this.vertexSurface&&(this.colorSurface&&a.color3(b[c+6],b[c+7],b[c+8]),(this.normalSurface||this.autoNormal)&&a.normal3(b[c+3],b[c+4],b[c+5]),this.texCoordSurface&&a.texCoord2(b[c+9],b[c+10]),a.vertex3(b[c+0],b[c+1],b[c+2]))};f.prototype.evalSurface=function(a,b,c,d,e,
f,g,n){"undefined"===typeof c&&(c=24);"undefined"===typeof d&&(d=24);if(0>=c)throw Error("invalid un");if(0>=d)throw Error("invalid vn");if(null===b||"undefined"===typeof b)b=Mesh.TRIANGLES;"undefined"===typeof g&&"undefined"===typeof n&&(g=0,n=1);"undefined"===typeof e&&"undefined"===typeof f&&(e=0,f=1);f=(f-e)/c;n=(n-g)/d;var r,u,x;if(b===Mesh.TRIANGLES){var v=[],y=[];this._saveValues(a,v,0);for(b=0;b<d;b++)for(a.mode(Mesh.TRIANGLE_STRIP),x=r=0;r<=c;r++,x+=11)u=r*f+e,0===b?this._recordAndPlayBack(a,
u,b*n+g,v,8):this._playBack(a,y,x),b===d-1?this._recordAndPlayBack(a,u,(b+1)*n+g,v,8):this._recordAndPlayBack(a,u,(b+1)*n+g,y,x);this._restoreValues(a,v,0)}else if(b===Mesh.POINTS)for(a.mode(Mesh.POINTS),b=0;b<=d;b++)for(r=0;r<=c;r++)u=r*f+e,this.evalOne(a,u,b*n+g);else if(b===Mesh.LINES){for(b=0;b<=d;b++)for(a.mode(Mesh.LINE_STRIP),r=0;r<=c;r++)u=r*f+e,this.evalOne(a,u,b*n+g);for(b=0;b<=c;b++)for(a.mode(Mesh.LINE_STRIP),r=0;r<=d;r++)this.evalOne(a,b*f+e,r*n+g)}return this};b.SurfaceEval=f;b.CurveEval=
g;b.BezierCurve=c;b.BezierSurface=a;b.BSplineCurve=d;b.BSplineSurface=e})(this);
var Meshes={createBox:function(b,c,a,d){b*=.5;c*=.5;a*=.5;b=[-b,-c,a,-1,0,0,1,0,-b,c,a,-1,0,0,1,1,-b,c,-a,-1,0,0,0,1,-b,-c,-a,-1,0,0,0,0,b,-c,-a,1,0,0,1,0,b,c,-a,1,0,0,1,1,b,c,a,1,0,0,0,1,b,-c,a,1,0,0,0,0,b,-c,-a,0,-1,0,1,0,b,-c,a,0,-1,0,1,1,-b,-c,a,0,-1,0,0,1,-b,-c,-a,0,-1,0,0,0,b,c,a,0,1,0,1,0,b,c,-a,0,1,0,1,1,-b,c,-a,0,1,0,0,1,-b,c,a,0,1,0,0,0,-b,-c,-a,0,0,-1,1,0,-b,c,-a,0,0,-1,1,1,b,c,-a,0,0,-1,0,1,b,-c,-a,0,0,-1,0,0,b,-c,a,0,0,1,1,0,b,c,a,0,0,1,1,1,-b,c,a,0,0,1,0,1,-b,-c,a,0,0,1,0,0];if(d)for(d=
0;d<b.length;d+=8)b[d+3]=-b[d+3],b[d+4]=-b[d+4],b[d+5]=-b[d+5];return new Mesh(b,[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],Mesh.NORMALS_BIT|Mesh.TEXCOORDS_BIT)},createCylinder:function(b,c,a,d,e,g,f){var h=new Mesh;if(null===d||"undefined"===typeof d)d=32;if(null===e||"undefined"===typeof e)e=1;if(2>=d)throw Error("too few slices");if(1>e)throw Error("too few stacks");if(0>a)throw Error("negative height");if(0>=b&&0>=c||0===a)return h;for(var k=
f?-1:1,l=[0,1],p=[0],m=GLMath.PiTimes2,q=1;q<d;q++){var t=1*q/d,n=m*t,r=Math.cos(n);l.push(0<=n&&6.283185307179586>n?3.141592653589793>=n?Math.sqrt(1-r*r):-Math.sqrt(1-r*r):Math.sin(n),r);p.push(t)}l.push(0,1);p.push(1);d*=2;if(0<a)for(m=0,t=b,q=0,b===c?(r=0,n=k):(q=Math.atan2(b-c,a),n=Math.cos(q),r=0<=q&&6.283185307179586>q?3.141592653589793>=q?Math.sqrt(1-n*n):-Math.sqrt(1-n*n):Math.sin(q),r*=k,n*=k),q=0;q<e;q++){var k=m,u=(q+1)/e,x=a*k,v=a*u,y=t,A=b+(c-b)*u,m=u,t=A;h.mode(Mesh.TRIANGLE_STRIP);
h.texCoord2(1,k);h.normal3(0,n,r);h.vertex3(0,y,x);h.texCoord2(1,u);h.normal3(0,n,r);h.vertex3(0,A,v);for(var z=2,I=1;z<=d;z+=2,I++){var B=p[I],w,C;w=l[z];C=l[z+1];h.texCoord2(1-B,k);h.normal3(w*n,C*n,r);h.vertex3(w*y,C*y,x);h.texCoord2(1-B,u);h.normal3(w*n,C*n,r);h.vertex3(w*A,C*A,v)}}return g?h.recalcNormals(g,f):h},createClosedCylinder:function(b,c,a,d,e,g,f){e=Meshes.createCylinder(b,c,a,d,e,g,f);b=Meshes.createDisk(0,b,d,2,!f).reverseWinding();c=Meshes.createDisk(0,c,d,2,f);c.transform(GLMath.mat4translated(0,
0,a));return e.merge(b).merge(c)},createDisk:function(b,c,a,d,e){return Meshes.createPartialDisk(b,c,a,d,0,360,e)},createPartialDisk:function(b,c,a,d,e,g,f){var h=new Mesh;if(null===a||"undefined"===typeof a)a=32;if(null===d||"undefined"===typeof d)d=1;if(null===e||"undefined"===typeof e)e=0;if(null===g||"undefined"===typeof g)g=360;if(2>=a)throw Error("too few slices");if(1>d)throw Error("too few loops");if(b>c)throw Error("inner greater than outer");0>b&&(b=0);0>c&&(c=0);if(0===c||0===g)return h;
var k=360===g&&0===e,l=0>g?-1:1;0>g&&(g=-g);g%=360;0===g&&(g=360);var p=[],m=[],q=GLMath.PiTimes2;g=360===g?q:g*GLMath.PiDividedBy180;e*=GLMath.PiDividedBy180;0>l&&(g=-g);for(l=0;l<=a;l++){var t=1*l/a,n=1===t&&g===q?e:e+g*t,n=0>n?q- -n%q:n%q,r=Math.cos(n);p.push(0<=n&&6.283185307179586>n?3.141592653589793>=n?Math.sqrt(1-r*r):-Math.sqrt(1-r*r):Math.sin(n),r);m.push(t)}k&&(p[0]=0,p[1]=1,p[p.length-1]=1,p[p.length-2]=0,m[0]=0,m[m.length-1]=1);a*=2;e=c-b;k=b;f?h.normal3(0,0,-1):h.normal3(0,0,1);for(l=
0;l<d;l++){f=k;m=b+(l+1)/d*e;q=f/c;g=m/c;k=m;t=0===l&&0===b;h.mode(t?Mesh.TRIANGLE_FAN:Mesh.TRIANGLE_STRIP);var u;if(t)for(n=a/2,t=a,u=n;0<=t;t-=2,u--)n=p[t],r=p[t+1],t===a&&(h.texCoord2(.5*(1+n*q),.5*(1+r*q)),h.vertex3(n*f,r*f,0)),h.texCoord2(.5*(1+n*g),.5*(1+r*g)),h.vertex3(n*m,r*m,0);else for(u=t=0;t<=a;t+=2,u++)n=p[t],r=p[t+1],h.texCoord2(.5*(1+n*g),.5*(1+r*g)),h.vertex3(n*m,r*m,0),h.texCoord2(.5*(1+n*q),.5*(1+r*q)),h.vertex3(n*f,r*f,0)}return h},createTorus:function(b,c,a,d,e,g){var f=new Mesh;
if(null===d||"undefined"===typeof d)d=16;if(null===a||"undefined"===typeof a)a=16;if(3>d)throw Error("crosswise is less than 3");if(3>a)throw Error("lengthwise is less than 3");if(0>b||0>c)throw Error("inner or outer is less than 0");if(0===c||0===b)return f;for(var h=GLMath.PiTimes2,k=[],l=[],p,m,q=0;q<d;q++)m=q*h/d,p=Math.cos(m),m=0<=m&&6.283185307179586>m?3.141592653589793>=m?Math.sqrt(1-p*p):-Math.sqrt(1-p*p):Math.sin(m),k.push(m,p);k.push(k[0]);k.push(k[1]);for(q=0;q<a;q++)m=q*h/a,p=Math.cos(m),
m=0<=m&&6.283185307179586>m?3.141592653589793>=m?Math.sqrt(1-p*p):-Math.sqrt(1-p*p):Math.sin(m),l.push(m,p);l.push(l[0]);l.push(l[1]);for(h=0;h<a;h++){p=h/a;var t=(h+1)/a,n=l[2*h],r=l[2*h+1],u=l[2*h+2],x=l[2*h+3];f.mode(Mesh.TRIANGLE_STRIP);for(q=0;q<=d;q++){m=q/d;var v=k[2*q],y=k[2*q+1],A=y*(c+x*b),z=v*(c+x*b),I=u*b,B=x*y,w=x*v,C=u;f.normal3(B,w,C);f.texCoord2(m,t);f.vertex3(A,z,I);A=y*(c+r*b);z=v*(c+r*b);I=n*b;B=r*y;w=r*v;C=n;f.normal3(B,w,C);f.texCoord2(m,p);f.vertex3(A,z,I)}}return e?f.recalcNormals(e,
g):f},createPlane:function(b,c,a,d,e){var g=new Mesh;if(null===b||"undefined"===typeof b)b=1;if(null===c||"undefined"===typeof c)c=1;if(null===a||"undefined"===typeof a)a=1;if(null===d||"undefined"===typeof d)d=1;if(0>b||0>c)throw Error("width or height is less than 0");if(0>=d||0>=a)throw Error("widthDiv or heightDiv is 0 or less");if(0===b||0===c)return g;var f=.5*-b,h=.5*-c;e?g.normal3(0,0,-1):g.normal3(0,0,1);for(e=0;e<d;e++){g.mode(Mesh.TRIANGLE_STRIP);var k=e/d,l=(e+1)/d,p=h+c*k,m=h+c*l;g.texCoord2(0,
l);g.vertex3(f,m,0);g.texCoord2(0,k);g.vertex3(f,p,0);for(var q=0;q<a;q++){var t=(q+1)/a,n=f+b*t;g.texCoord2(t,l);g.vertex3(n,m,0);g.texCoord2(t,k);g.vertex3(n,p,0)}}return g},createSphere:function(b,c,a,d,e){return Meshes._createCapsule(b,0,c,a,1,d,e)},createCapsule:function(b,c,a,d,e,g,f){if(null===d||"undefined"===typeof d)d=8;if(1>d)throw Error("too few stacks");return Meshes._createCapsule(b,c,a,2*d,e,g,f)},_createCapsule:function(b,c,a,d,e,g,f){function h(a,b,c,d,e,f){a.normal3(c*b,d*b,e*b);
a.vertex3(c,d,e+f)}var k=new Mesh;if(null===a||"undefined"===typeof a)a=16;if(null===d||"undefined"===typeof d)d=16;if(null===e||"undefined"===typeof e)e=1;if(null===b||"undefined"===typeof b)b=1;if(null===c||"undefined"===typeof c)c=1;if(2>d)throw Error("too few stacks");if(2>=a)throw Error("too few slices");if(1>e&&0<c)throw Error("too few middle stacks");if(0>c)throw Error("negative length");if(0>b)throw Error("negative radius");if(0===b)return k;for(var l=.5*c,p=d/2,m=f?-1:1,q=[0,1],t=[],n=[],
r=[0],u,x,v=GLMath.PiTimes2,y=1;y<a;y++){var A=1*y/a;u=v*A;var z=Math.cos(u);q.push(0<=u&&6.283185307179586>u?3.141592653589793>=u?Math.sqrt(1-z*z):-Math.sqrt(1-z*z):Math.sin(u),z);r.push(A)}q.push(0,1);r.push(1);v=2*b;v/=v+c;A=[];for(y=1;y<d;y++)z=1*y/d,u=Math.PI*z,x=Math.sin(u),t.push(x),A.push(-Math.cos(u)),n.push(z);t.push(0);n.push(1);A.push(1);a*=2;u=-1;for(var I=z=0,y=0;y<d;y++){var B=A[y],w=n[y];x=b*u;var C=b*B,G=y<p?-l:l,J=z,E=b*t[y],L=I,M=w;0<c&&(L=y<p?I*v:1-(1-I)*v,M=y<p?w*v:1-(1-w)*v);
u=B;I=w;z=E;y===d-1||0===y?k.mode(Mesh.TRIANGLES):(k.mode(Mesh.TRIANGLE_STRIP),k.texCoord2(1,L),h(k,m,0,J,x,G),k.texCoord2(1,M),h(k,m,0,E,C,G));for(var K=0,N=0,F=1,D,H,w=2,O=1;w<=a;w+=2,O++)B=r[O],y===d-1?(D=K+.5*(B-K),k.texCoord2(1-K,L),h(k,m,N*J,F*J,x,G),k.texCoord2(1-D,M),h(k,m,0,E,C,G),D=q[w],H=q[w+1],k.texCoord2(1-B,L),h(k,m,D*J,H*J,x,G),N=D,F=H,K=B):0===y?(D=K+.5*(B-K),k.texCoord2(1-D,L),h(k,m,0,J,x,G),k.texCoord2(1-K,M),h(k,m,N*E,F*E,C,G),D=q[w],H=q[w+1],k.texCoord2(1-B,M),h(k,m,D*E,H*E,C,
G),N=D,F=H,K=B):(D=q[w],H=q[w+1],k.texCoord2(1-B,L),h(k,m,D*J,H*J,x,G),k.texCoord2(1-B,M),h(k,m,D*E,H*E,C,G));if(y+1===p&&0<c)for(G=.5*v,J=2*l,K=1-G,N=1-v,F=0;F<e;F++){x=-l+(0===F?0:J*F/e);var P=F===e-1?l:-l+J*(F+1)/e,L=G+(0===F?0:N*F/e),M=F===e-1?K:G+N*(F+1)/e;k.mode(Mesh.TRIANGLE_STRIP);k.texCoord2(1,L);h(k,m,0,E,C,x);k.texCoord2(1,M);h(k,m,0,E,C,P);w=2;for(O=1;w<=a;w+=2,O++)B=r[O],D=q[w],H=q[w+1],k.texCoord2(1-B,L),h(k,m,D*E,H*E,C,x),k.texCoord2(1-B,M),h(k,m,D*E,H*E,C,P)}}return g?k.recalcNormals(g,
f):k.normalizeNormals()}};this.Meshes=Meshes;
function FrameBuffer(b,c,a){if(0>c||0>a)throw Error("width or height negative");this.context=b;this.textureUnit=1;this.buffer=b.createFramebuffer();this.colorTexture=b.createTexture();this.width=Math.ceil(c);this.height=Math.ceil(a);this.context.activeTexture(this.context.TEXTURE0+this.textureUnit);this.context.bindTexture(this.context.TEXTURE_2D,this.colorTexture);this.context.pixelStorei(this.context.UNPACK_FLIP_Y_WEBGL,1);this.context.texImage2D(this.context.TEXTURE_2D,0,this.context.RGBA,this.width,
this.height,0,this.context.RGBA,this.context.UNSIGNED_BYTE,null);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE);this.depthbuffer=
this.context.createRenderbuffer();c=this.context.getParameter(b.FRAMEBUFFER_BINDING);this.context.bindFramebuffer(b.FRAMEBUFFER,this.buffer);this.context.bindRenderbuffer(b.RENDERBUFFER,this.depthbuffer);this.context.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,this.width,this.height);this.context.bindFramebuffer(b.FRAMEBUFFER,c)}FrameBuffer.prototype.getContext=function(){return this.context};
FrameBuffer.prototype.bind=function(){this.context.activeTexture(this.context.TEXTURE0+this.textureUnit);this.context.bindFramebuffer(this.context.FRAMEBUFFER,this.buffer);this.context.framebufferTexture2D(this.context.FRAMEBUFFER,this.context.COLOR_ATTACHMENT0,this.context.TEXTURE_2D,this.colorTexture,0);this.context.framebufferRenderbuffer(this.context.FRAMEBUFFER,this.context.DEPTH_ATTACHMENT,this.context.RENDERBUFFER,this.depthbuffer)};
FrameBuffer.prototype.unbind=function(){this.context.framebufferTexture2D(this.context.FRAMEBUFFER,this.context.COLOR_ATTACHMENT0,this.context.TEXTURE_2D,null,0);this.context.framebufferRenderbuffer(this.context.FRAMEBUFFER,this.context.DEPTH_ATTACHMENT,this.context.RENDERBUFFER,null);this.context.bindFramebuffer(this.context.FRAMEBUFFER,null)};
FrameBuffer.prototype.dispose=function(){null!==this.buffer&&(this.context.getParameter(context.FRAMEBUFFER_BINDING)==this.buffer&&this.unbind(),this.context.deleteFramebuffer(this.buffer));null!==this.depthbuffer&&this.context.deleteRenderbuffer(this.depthbuffer);null!==this.colorTexture&&this.context.deleteTexture(this.colorTexture);this.colorTexture=this.depthbuffer=this.buffer=null};
var BufferedSubMesh=function(b,c){var a=c.createBuffer();if(!a)throw Error("can't create buffer");var d=c.createBuffer();if(!d)throw Error("can't create face buffer");this.arrayObjectExt=c.getExtension("OES_vertex_array_object");this.arrayObjectExtContext=c;this.vao=null;this.arrayObjectExt&&(this.vao=this.arrayObjectExt.createVertexArrayOES());c.bindBuffer(c.ARRAY_BUFFER,a);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,d);c.bufferData(c.ARRAY_BUFFER,new Float32Array(b.vertices),c.STATIC_DRAW);var e=c.UNSIGNED_SHORT;
65536<=b.vertices.length||65536<=b.indices.length?(e=c.UNSIGNED_INT,c.bufferData(c.ELEMENT_ARRAY_BUFFER,new Uint32Array(b.indices),c.STATIC_DRAW)):256>=b.vertices.length&&256>=b.indices.length?(e=c.UNSIGNED_BYTE,c.bufferData(c.ELEMENT_ARRAY_BUFFER,new Uint8Array(b.indices),c.STATIC_DRAW)):c.bufferData(c.ELEMENT_ARRAY_BUFFER,new Uint16Array(b.indices),c.STATIC_DRAW);this.verts=a;this.faces=d;this.numVertices=b.vertices.length/b.getStride();this.facesLength=b.indices.length;this.type=e;this.format=
b.attributeBits;this._stride=Mesh._getStride(this.format);this.context=c;this._lastKnownProgram=null;this._attribLocations=[];this._attribsUsed=[0,Mesh._normalOffset(this.format),Mesh._colorOffset(this.format),Mesh._texCoordOffset(this.format),Mesh._tangentOffset(this.format),Mesh._bitangentOffset(this.format)];this._sizes=[3,3,3,2,3,3]};BufferedSubMesh.prototype._getVaoExtension=function(b){return this.arrayObjectExtContext==b?this.arrayObjectExt:b.getExtension("OES_vertex_array_object")};
function BufferedMesh(b,c){this.subMeshes=[];this.context=GLUtil._toContext(c);this._bounds=b.getBoundingBox();for(var a=0;a<b.subMeshes.length;a++){var d=b.subMeshes[a];0!==d.indices.length&&this.subMeshes.push(new BufferedSubMesh(d,this.context))}}BufferedMesh.prototype._getBounds=function(){return this._bounds};BufferedMesh.prototype.getContext=function(){return this.context};BufferedMesh.prototype.getFormat=function(){for(var b=0,c=0;c<this.subMeshes.length;c++)b|=this.subMeshes[c].format;return b};
BufferedMesh.prototype.draw=function(b){for(var c=0;c<this.subMeshes.length;c++)this.subMeshes[c].draw(b)};BufferedMesh.prototype.dispose=function(){for(var b=0;b<this.subMeshes.length;b++)this.subMeshes[b].dispose();this.subMeshes=[]};
BufferedSubMesh.prototype.dispose=function(){null!==this.verts&&this.context.deleteBuffer(this.verts);null!==this.faces&&this.context.deleteBuffer(this.faces);null!==this.vao&&this.arrayObjectExt.deleteVertexArrayOES(this.vao);this._lastKnownProgram=this.vao=this.faces=this.verts=null;this._attribLocations=[]};
BufferedSubMesh.prototype._getAttribLocations=function(b,c){if(this._lastKnownProgram!=b){this._lastKnownProgram=b;this._attribLocations=[b.get("position"),b.get("normal"),b.get("colorAttr"),b.get("uv"),b.get("tangent"),b.get("bitangent")];for(var a=0;6>a;a++)null==this._attribLocations[a]&&(this._attribLocations[a]=-1);return!0}return!1};
BufferedSubMesh.prototype._prepareDraw=function(b,c){var a=this._getAttribLocations(b,c),d=this._getVaoExtension(c);this.vao?d.bindVertexArrayOES(this.vao):a=!0;if(a)for(c.bindBuffer(c.ARRAY_BUFFER,this.verts),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,this.faces),a=0;a<this._attribLocations.length;a++)d=this._attribLocations[a],0<=d&&(0<=this._attribsUsed[a]?(c.enableVertexAttribArray(d),c.vertexAttribPointer(d,this._sizes[a],c.FLOAT,!1,4*this._stride,4*this._attribsUsed[a])):c.disableVertexAttribArray(d));
b.setUniforms({useColorAttr:0<=this._attribsUsed[2]?1:0})};BufferedSubMesh.prototype.draw=function(b){var c=b.getContext();if(null===this.verts||null===this.face)throw Error("mesh buffer disposed");if(c!==this.context)throw Error("can't bind mesh: context mismatch");this._prepareDraw(b,c);b=c.TRIANGLES;0!==(this.format&Mesh.LINES_BIT)&&(b=c.LINES);0!==(this.format&Mesh.POINTS_BIT)&&(b=c.POINTS);c.drawElements(b,this.facesLength,this.type,0);c=this._getVaoExtension(c);this.vao&&c.bindVertexArrayOES(null)};
BufferedSubMesh.prototype.primitiveCount=function(){return 0!==(this.format&Mesh.LINES_BIT)?Math.floor(this.facesLength/2):0!==(this.format&Mesh.POINTS_BIT)?this.facesLength:Math.floor(this.facesLength/3)};BufferedMesh.prototype.vertexCount=function(){for(var b=0,c=0;c<this.subMeshes.length;c++)b+=this.subMeshes[c].numVertices;return b};BufferedMesh.prototype.primitiveCount=function(){for(var b=0,c=0;c<this.subMeshes.length;c++)b+=this.subMeshes[c].primitiveCount();return b};
function ShaderProgram(b,c,a){b=b.getContext?b.getContext():b;if(null===c||"undefined"===typeof c)c=ShaderProgram.getDefaultVertex();if(null===a||"undefined"===typeof a)a=ShaderProgram.getDefaultFragment();this.program=c=ShaderProgram._compileShaders(b,c,a);this.attributes={};this.context=b;this.actives={};this.uniformValues={};this.uniformTypes={};this.savedUniforms={};this.CURRENT_PROGRAM=b.CURRENT_PROGRAM;this.FLOAT=b.FLOAT;if(null!==c&&"undefined"!==typeof c){this.attributes=[];var d=null;a={};
for(var e=b.getProgramParameter(c,b.ACTIVE_ATTRIBUTES),g=0;g<e;++g)if(d=b.getActiveAttrib(c,g),null!==d&&"undefined"!==typeof d){var d=d.name,f=b.getAttribLocation(c,d);0<=f&&(this.attributes.push(f),a[d]=f)}e=b.getProgramParameter(c,b.ACTIVE_UNIFORMS);for(g=0;g<e;++g)b=this.context.getActiveUniform(c,g),null!==b&&"undefined"!==typeof b&&(d=b.name,a[d]=this.context.getUniformLocation(c,d),this.uniformTypes[d]=b.type);this.actives=a}}
ShaderProgram.supportsDerivatives=function(b){b=b.getContext?b.getContext():b;return b.getExtension("OES_standard_derivatives")?!0:!1};ShaderProgram.prototype.dispose=function(){this.program&&this.context.deleteProgram(this.program);this.program=this.context=null;this.actives={};this.attributes={};this.uniformTypes={}};ShaderProgram.prototype.getContext=function(){return this.context};ShaderProgram.prototype.get=function(b){b=this.actives[b];return null===b||"undefined"===typeof b?null:b};
ShaderProgram.prototype.getUniform=function(b){var c="string"===typeof b?this.get(b):b;if(null===c||"number"===typeof c)return null;b=this.uniformValues[b];return null===b||"undefined"===typeof b?this.context.getUniform(this.program,c):b instanceof Array?b.slice(0,b.length):b};ShaderProgram.prototype.use=function(){this.context.useProgram(this.program);this.setUniforms(this.savedUniforms);this.savedUniforms={};return this};ShaderProgram.prototype._log=function(b,c){};
ShaderProgram.prototype._saveIfNotCurrent=function(b,c,a){this._log(c,b);if(null===a||"undefined"===typeof a)a=this.context.getParameter(this.CURRENT_PROGRAM)===this.program;a||(this.savedUniforms[c]="number"===typeof b?b:b.slice(0,b.length),this.uniformValues[c]=null);return a};
ShaderProgram.prototype._setUniform=function(b,c,a){a=null;b=b[c];var d=this.get(c);if(null===d||"undefined"===typeof d)return a;var e=this.uniformValues[c];if("number"===typeof b){var g=!1;null===e||"undefined"===typeof e?(this.uniformValues[c]=e=b,g=!0):e!==b&&(e=b,this.uniformValues[c]=b,g=!0);if(g)if(this.uniformTypes[c]===this.FLOAT){if(!(a=this._saveIfNotCurrent(e,c,a)))return a;this.context.uniform1f(d,e)}else{if(!(a=this._saveIfNotCurrent(e,c,a)))return a;this.context.uniform1i(d,e)}}else if(3===
b.length)if(!e){this.uniformValues[c]=e=b.slice(0,b.length);if(!(a=this._saveIfNotCurrent(e,c,a)))return a;this.context.uniform3fv(d,e)}else{if(e[0]!==b[0]||e[1]!==b[1]||e[2]!==b[2]){e[0]=b[0];e[1]=b[1];e[2]=b[2];if(!(a=this._saveIfNotCurrent(e,c,a)))return a;this.context.uniform3fv(d,e)}}else if(2===b.length)if(!e){this.uniformValues[c]=e=b.slice(0,b.length);if(!(a=this._saveIfNotCurrent(e,c,a)))return a;this.context.uniform2fv(d,e)}else{if(e[0]!==b[0]||e[1]!==b[1]){e[0]=b[0];e[1]=b[1];if(!(a=this._saveIfNotCurrent(e,
c,a)))return a;this.context.uniform2fv(d,e)}}else if(4===b.length)if(!e){this.uniformValues[c]=e=b.slice(0,b.length);if(!(a=this._saveIfNotCurrent(e,c,a)))return a;this.context.uniform4fv(d,e)}else{if(e[0]!==b[0]||e[1]!==b[1]||e[2]!==b[2]||e[3]!==b[3]){e[0]=b[0];e[1]=b[1];e[2]=b[2];e[3]=b[3];if(!(a=this._saveIfNotCurrent(e,c,a)))return a;this.context.uniform4fv(d,e)}}else if(16===b.length)if(!e){this.uniformValues[c]=e=b.slice(0,b.length);if(!(a=this._saveIfNotCurrent(e,c,a)))return a;this.context.uniformMatrix4fv(d,
!1,e)}else{if(ShaderProgram._copyIfDifferent(b,e,16)){if(!(a=this._saveIfNotCurrent(e,c,a)))return a;this.context.uniformMatrix4fv(d,!1,e)}}else if(9===b.length)if(!e){this.uniformValues[c]=e=b.slice(0,b.length);if(!(a=this._saveIfNotCurrent(e,c,a)))return a;this.context.uniformMatrix3fv(d,!1,e)}else if(ShaderProgram._copyIfDifferent(b,e,9)){if(!(a=this._saveIfNotCurrent(e,c,a)))return a;this.context.uniformMatrix3fv(d,!1,e)}return a};
ShaderProgram.prototype.setUniforms=function(b){var c,a=null;if("undefined"!==typeof Object.keys)for(var d=Object.keys(b),e=0;e<d.length;e++)c=d[e],a=this._setUniform(b,c,a);else for(c in b)a=this._setUniform(b,c,a);return this};ShaderProgram._copyIfDifferent=function(b,c,a){for(var d=0;d<a;d++)if(b[d]!==c[d]){c[d]=b[d];for(d+=1;d<a;d++)c[d]=b[d];return!0}return!1};
ShaderProgram._compileShaders=function(b,c,a){function d(a,b,c){var d=a.createShader(b);a.shaderSource(d,c);a.compileShader(d);if(!a.getShaderParameter(d,a.COMPILE_STATUS)){c=c.split("\n");for(var e=0;e<c.length;e++)c[e]="/* "+(e+1)+" */   "+c[e];console.log(c.join("\n"));console.log((b===a.VERTEX_SHADER?"vertex: ":"fragment: ")+a.getShaderInfoLog(d));return null}return d}c=c&&0!==c.length?d(b,b.VERTEX_SHADER,c):null;a=a&&0!==a.length?d(b,b.FRAGMENT_SHADER,a):null;var e=null;null!==c&&"undefined"!==
typeof c&&null!==a&&"undefined"!==typeof a&&(e=b.createProgram(),b.attachShader(e,c),b.attachShader(e,a),b.linkProgram(e),b.getProgramParameter(e,b.LINK_STATUS)||(console.log("link: "+b.getProgramInfoLog(e)),b.deleteProgram(e),e=null),b.detachShader(e,c),b.detachShader(e,a));null!==c&&"undefined"!==typeof c&&b.deleteShader(c);null!==a&&"undefined"!==typeof a&&b.deleteShader(a);return e};ShaderProgram.fragmentShaderHeader=function(){return"#ifdef GL_ES\n#ifndef GL_FRAGMENT_PRECISION_HIGH\nprecision mediump float;\n#else\nprecision highp float;\n#endif\n#endif\n"};
ShaderProgram.makeEffectFragment=function(b){var c=ShaderProgram.fragmentShaderHeader(),c=c+"uniform sampler2D sampler;\nuniform vec2 textureSize;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n"+b;return c+="\n\nvoid main(){\n // normalize coordinates to 0..1\n vec2 uv=gl_FragCoord.xy/textureSize.xy;\n gl_FragColor=textureEffect(sampler,uv,textureSize);\n}"};ShaderProgram.makeEffect=function(b,c){return new ShaderProgram(b,ShaderProgram.getBasicVertex(),ShaderProgram.makeEffectFragment(c))};
ShaderProgram.getInvertEffect=function(b){return ShaderProgram.makeEffect(b,"vec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize){\n vec4 color=texture2D(sampler,uvCoord);\n vec4 ret; ret.xyz=vec3(1.0,1.0,1.0)-color.xyz; ret.w=color.w; return ret;\n}")};ShaderProgram.getEdgeDetectEffect=function(b){return ShaderProgram.makeEffect(b,"float luma(vec3 color) {\n return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;\n}\nconst vec4 edge_color=vec4(0.,0,0,1);\nconst vec4 back_color=vec4(1.,1,1,1);\nvec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize){\nfloat dx = 1.0 / float(textureSize.x);\nfloat dy = 1.0 / float(textureSize.y);\nfloat s00 = luma(texture2D(sampler, uvCoord + vec2(-dx,dy)).rgb);\nfloat s10 = luma(texture2D(sampler, uvCoord + vec2(-dx,0.0)).rgb);\nfloat s20 = luma(texture2D(sampler, uvCoord + vec2(-dx,-dy)).rgb);\nfloat s01 = luma(texture2D(sampler, uvCoord + vec2(0.0,dy)).rgb);\nfloat s21 = luma(texture2D(sampler, uvCoord + vec2(0.0,-dy)).rgb);\nfloat s02 = luma(texture2D(sampler, uvCoord + vec2(dx, dy)).rgb);\nfloat s12 = luma(texture2D(sampler, uvCoord + vec2(dx, 0.0)).rgb);\nfloat s22 = luma(texture2D(sampler, uvCoord + vec2(dx, -dy)).rgb);\nfloat sx = s00 + 2.0 * s10 + s20 - (s02 + 2.0 * s12 + s22);\nfloat sy = s00 + 2.0 * s01 + s02 - (s20 + 2.0 * s21 + s22);\nfloat dist = sx * sx + sy * sy;\nif(dist > 0.4) {\nreturn edge_color;\n} else {\nreturn back_color;\n}}")};
ShaderProgram.getBasicVertex=function(){};ShaderProgram.getDefaultVertex=function(){return"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nattribute vec3 colorAttr;\nattribute vec3 tangent;\nattribute vec3 bitangent;\nuniform mat4 modelViewMatrix;\nuniform mat4 projection;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n#ifdef SHADING\nuniform mat4 world;\nuniform mat3 worldViewInvTrans3; /* internal */\nvarying vec4 worldPositionVar;\n#ifdef NORMAL_MAP\nvarying mat3 tbnMatrixVar;\n#endif\nvarying vec3 transformedNormalVar;\n#endif\nvoid main(){\nvec4 positionVec4;\npositionVec4.w=1.0;\npositionVec4.xyz=position;\ngl_PointSize=1.0;\ngl_Position=(projection*modelViewMatrix)*positionVec4;\ncolorAttrVar=colorAttr;\nuvVar=uv;\n#ifdef SHADING\ntransformedNormalVar=normalize(worldViewInvTrans3*normal);\n#ifdef NORMAL_MAP\ntbnMatrixVar=mat3(normalize(vec3(world*vec4(tangent,0.0))),\n   normalize(bitangent),transformedNormalVar);\n#endif\nworldPositionVar=world*positionVec4;\n#endif\n}"};
ShaderProgram.getDefaultFragment=function(){var b,c=ShaderProgram.fragmentShaderHeader()+"uniform vec4 md;\n#ifdef SHADING\nstruct light {\n vec4 position; /* source light direction */\n vec4 diffuse; /* source light diffuse color */\n#ifdef SPECULAR\n vec4 specular; /* source light specular color */\n#endif\n};\nconst int MAX_LIGHTS = "+Lights.MAX_LIGHTS+"; /* internal */\nuniform vec3 sceneAmbient;\nuniform light lights[MAX_LIGHTS];\nuniform vec3 ma;\nuniform vec3 me;\n#ifdef SPECULAR\nuniform vec3 ms;\nuniform float mshin;\nuniform vec4 viewInvW;\n#ifdef SPECULAR_MAP\nuniform sampler2D specularMap;\n#endif\n#ifdef NORMAL_MAP\nuniform sampler2D normalMap;\n#endif\n#endif\n#endif\nuniform sampler2D sampler;\nuniform vec2 textureSize;\nuniform float useColorAttr;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n#ifdef SHADING\nvarying vec4 worldPositionVar;\nvarying vec3 transformedNormalVar;\n#ifdef NORMAL_MAP\nvarying mat3 tbnMatrixVar;\n#endif\nvec4 calcLightPower(light lt, vec4 vertexPosition){\n vec3 sdir;\n float attenuation;\n if(lt.position.w == 0.0){ /* directional light */\n  sdir=normalize((lt.position).xyz);\n  attenuation=1.0;\n } else { /* point light */\n  vec3 vertexToLight=(lt.position-vertexPosition).xyz;\n  float dist=length(vertexToLight);\n  if(dist == 0.0){\n   sdir=vertexToLight;\n   attenuation=1.0;\n  } else {\n   sdir=vertexToLight/dist; /* normalizes vertexToLight */\n   attenuation=(1.0/dist);\n  }\n }\n return vec4(sdir,attenuation);\n}\n#endif\nvoid main(){\n vec4 tmp;\n vec3 normal;\n float useTexture=sign(textureSize.x+textureSize.y);\n tmp.w=1.0;\n tmp.xyz=colorAttrVar;\n vec4 baseColor=mix(mix(\n   md, /*when textures are not used*/\n   texture2D(sampler,uvVar), /*when textures are used*/\n   useTexture), tmp, useColorAttr);\n#ifdef SHADING\n#ifdef NORMAL_MAP\nnormal = normalize(tbnMatrixVar*(2.0*texture2D(normalMap,uvVar).rgb - vec3(1.0)));\n#else\nnormal = transformedNormalVar;\n#endif\n#define ADD_DIFFUSE(i)  lightedColor+=vec3(lights[i].diffuse)*max(lightCosines[i],0.0)*lightPower[i].w*materialDiffuse;\nvec4 lightPower["+
Lights.MAX_LIGHTS+"];\nfloat lightCosines["+Lights.MAX_LIGHTS+"];\n",c=c+"if(baseColor.a == 0.0)discard;\nvec3 materialAmbient=ma; /* ambient*/\nvec3 lightedColor=sceneAmbient*materialAmbient; /* ambient*/\n // diffuse\n vec3 materialDiffuse=baseColor.rgb;\n";for(b=0;b<Lights.MAX_LIGHTS;b++)c+="lightPower["+b+"]=calcLightPower(lights["+b+"],worldPositionVar);\n",c+="lightCosines["+b+"]=dot(normal,lightPower["+b+"].xyz);\n";for(b=0;b<Lights.MAX_LIGHTS;b++)c+="ADD_DIFFUSE("+b+");\n";c+="#ifdef SPECULAR\nbool spectmp;\nvec3 materialSpecular=ms;\n#ifdef SPECULAR_MAP\nmaterialSpecular*=texture2D(specularMap,uvVar).rgb;\n#endif\n// specular reflection\nif(materialSpecular.x!=0. || materialSpecular.y!=0. || materialSpecular.z!=0.){\nvec3 viewDirection=normalize((viewInvW-worldPositionVar).xyz);\nfloat specular=0.0;\n";
for(b=0;b<Lights.MAX_LIGHTS;b++)c+="  spectmp = lightCosines["+b+"] >= 0.0;\n  if (spectmp) {\n  vec3 lightSpecular=vec3(lights["+b+"].specular);\n    specular=dot (-lightPower["+b+"].xyz - (2.0 * dot (normal, -lightPower["+b+"].xyz)*\n transformedNormalVar), viewDirection);\n    specular=max(specular,0.0);\n    specular=pow(specular,mshin);\n    lightedColor+=materialSpecular*specular*lightPower["+b+"].w*lightSpecular;\n  }\n";c+="}\n#endif\n";return c+=" // emission\n lightedColor+=me;\n baseColor=vec4(lightedColor,baseColor.a);\n#endif\n gl_FragColor=baseColor;\n}"};
function MaterialBinder(b){this.mshade=b}MaterialBinder._textureSizeZeroZero=[0,0];
MaterialBinder.prototype.bind=function(b){if(!this.mshade)return this;4!==this.mshade.diffuse.length&&console.warn("creating new diffuse array");3!==this.mshade.ambient.length&&console.warn("creating new ambient array");3!==this.mshade.specular.length&&console.warn("creating new specular array");3!==this.mshade.emission.length&&console.warn("creating new emission array");var c={textureSize:MaterialBinder._textureSizeZeroZero,md:4===this.mshade.diffuse.length?this.mshade.diffuse:[this.mshade.diffuse[0],
this.mshade.diffuse[1],this.mshade.diffuse[2],4>this.mshade.diffuse.length?1:this.mshade.diffuse[3]]};this.mshade.basic||(c.mshin=this.mshade.shininess,c.ma=3===this.mshade.ambient.length?this.mshade.ambient:[this.mshade.ambient[0],this.mshade.ambient[1],this.mshade.ambient[2]],c.ms=3===this.mshade.specular.length?this.mshade.specular:[this.mshade.specular[0],this.mshade.specular[1],this.mshade.specular[2]],c.me=3===this.mshade.emission.length?this.mshade.emission:[this.mshade.emission[0],this.mshade.emission[1],
this.mshade.emission[2]]);b.setUniforms(c);MaterialBinder.bindTexture(this.mshade.texture,b,0);MaterialBinder.bindTexture(this.mshade.specularMap,b,1);MaterialBinder.bindTexture(this.mshade.normalMap,b,2);return this};
function LoadedTexture(b,c){this.context=c=GLUtil._toContext(c);this.loadedTexture=c.createTexture();c.activeTexture(c.TEXTURE0);c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,1);c.bindTexture(c.TEXTURE_2D,this.loadedTexture);"src"in b.image?c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,b.image):c.texImage2D(c.TEXTURE_2D,0,c.RGBA,b.width,b.height,0,c.RGBA,c.UNSIGNED_BYTE,b.image);GLUtil._isPowerOfTwo(b.width)&&GLUtil._isPowerOfTwo(b.height)?c.generateMipmap(c.TEXTURE_2D):(c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE))}LoadedTexture.prototype.dispose=function(){this.loadedTexture&&this.context.deleteTexture(this.loadedTexture)};function FrameBufferMaterialBinder(b){this.fb=b}
FrameBufferMaterialBinder.prototype.bind=function(b){var c={};c.sampler=this.fb.textureUnit;c.textureSize=[this.fb.width,this.fb.height];b.setUniforms(c);b=b.getContext();b.activeTexture(b.TEXTURE0+this.fb.textureUnit);b.bindTexture(b.TEXTURE_2D,this.fb.colorTexture);this.fb.colorTexture&&(b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,
b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE))};
MaterialBinder.bindTexture=function(b,c,a){if(b){var d=b instanceof FrameBuffer,e=c.getContext();if(!d)if("undefined"!==typeof b.image&&null!==b.image&&("undefined"===typeof b.loadedTexture||null===b.loadedTexture))b.loadedTexture=new LoadedTexture(b,e);else if(!("undefined"!==typeof b.image&&null!==b.image||"undefined"!==typeof b.loadedTexture&&null!==b.loadedTexture)&&0===b.loadStatus){var g=this;b.loadImage().then(function(a){g.bind(c)});return}if(null!=b.loadedTexture||d){var f={};null!=b.anisotropic||
d||(b.anisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic"),"undefined"===typeof b.anisotropic||"undefined"===typeof b.anisotropic||"undefined"===typeof b.anisotropic||null===b.anisotropic?(b.anisotropic={},b.maxAnisotropy=1):b.maxAnisotropy=e.getParameter(b.anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT));0===a&&(f.sampler=a,f.textureSize=[b.width,b.height]);1===a&&(f.specularMap=a);
2===a&&(f.normalMap=a);c.setUniforms(f);e.activeTexture(e.TEXTURE0+a);d?(ctx.bindTexture(ctx.TEXTURE_2D,b.colorTexture),b.colorTexture&&(ctx.texParameteri(ctx.TEXTURE_2D,ctx.TEXTURE_MAG_FILTER,ctx.NEAREST),ctx.texParameteri(ctx.TEXTURE_2D,ctx.TEXTURE_MIN_FILTER,ctx.NEAREST),ctx.texParameteri(ctx.TEXTURE_2D,ctx.TEXTURE_WRAP_S,ctx.CLAMP_TO_EDGE),ctx.texParameteri(ctx.TEXTURE_2D,ctx.TEXTURE_WRAP_T,ctx.CLAMP_TO_EDGE))):(e.bindTexture(e.TEXTURE_2D,b.loadedTexture.loadedTexture),"undefined"!==typeof b.anisotropic.TEXTURE_MAX_ANISOTROPY_EXT&&
e.texParameteri(e.TEXTURE_2D,b.anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,b.maxAnisotropy),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),a=e.CLAMP_TO_EDGE,GLUtil._isPowerOfTwo(b.width)&&GLUtil._isPowerOfTwo(b.height)?(b.clamp||(a=e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR)):e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,a))}}};
function LightsBinder(b){this.lights=b}
LightsBinder.prototype.bind=function(b){var c=this.lights;if(!c||!b)return this;var a={};a.sceneAmbient=c.sceneAmbient.slice(0,3);for(var d=0;d<c.lights.length;d++){var e=c.lights[d];a["lights["+d+"].diffuse"]=[e.diffuse[0],e.diffuse[1],e.diffuse[2],3<e.diffuse.length?e.diffuse[3]:1];a["lights["+d+"].specular"]=[e.specular[0],e.specular[1],e.specular[2],3<e.specular.length?e.specular[3]:1];a["lights["+d+"].position"]=c.lights[d].position}for(d=c.lights.length;d<Lights.MAX_LIGHTS;d++)a["lights["+d+
"].diffuse"]=[0,0,0,1],a["lights["+d+"].specular"]=[0,0,0,1],a["lights["+d+"].position"]=[0,0,0,0];b.setUniforms(a);return this};var Binders={getMaterialBinder:function(b){return b&&b instanceof Material?new MaterialBinder(b):{bind:function(b){}}}};
