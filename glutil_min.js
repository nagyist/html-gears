(function(a,c){"function"===typeof define&&define.amd?define(["exports"],c):"object"===typeof exports?c(exports):c(a)})(this,function(a){if(!a.Promise){var c=function(b){this._state=0;this._timeout=this._value=null;this._cb={fulfilled:[],rejected:[]};this._thenPromises=[];b&&this._invokeResolver(b)};c.resolve=function(b){return new this(function(a,c){a(b)})};c.reject=function(b){return new this(function(a,c){c(b)})};c.all=c.when=function(b){return new this(function(a,c){var f=0,g=[];b.forEach(function(b,
k){f++;b.then(function(b){g[k]=b;f--;f||a(g)},function(b){f=1/0;c(b)})})})};c.race=function(b){return new this(function(a,c){b.forEach(function(b){b.then(a,c)})})};c.prototype.then=function(b,a){this._cb.fulfilled.push(b);this._cb.rejected.push(a);var e=new c;this._thenPromises.push(e);0<this._state&&this._schedule();return e};c.prototype.fulfill=function(b){if(0!==this._state)return this;this._state=1;this._value=b;this._thenPromises.length&&this._schedule();return this};c.prototype.reject=function(b){if(0!==
this._state)return this;this._state=2;this._value=b;this._thenPromises.length&&this._schedule();return this};c.prototype.resolve=function(b){if(b===this)this.reject(new TypeError("Promise resolved by its own instance"));else if(b instanceof this.constructor)b.chain(this);else{var a;if(null===b||"undefined"===typeof b||"object"!==typeof b&&"function"!==typeof b)this.fulfill(b);else{try{a=b.then}catch(c){this.reject(c);return}if("function"===typeof a){var e=!1,f=function(b){e||(e=!0,this.resolve(b))},
g=function(b){e||(e=!0,this.reject(b))};try{a.call(b,f.bind(this),g.bind(this))}catch(c){e||this.reject(c)}}else this.fulfill(b)}}};c.prototype.chain=function(b){return this.then(function(a){b.resolve(a)},function(a){b.reject(a)})};c.prototype["catch"]=function(b){return this.then(null,b)};c.prototype._schedule=function(){this._timeout||(this._timeout=setTimeout(this._processQueue.bind(this),0))};c.prototype._processQueue=function(){for(this._timeout=null;this._thenPromises.length;){var b=this._cb.fulfilled.shift(),
a=this._cb.rejected.shift();this._executeCallback(1===this._state?b:a)}};c.prototype._executeCallback=function(b){var a=this._thenPromises.shift();if("function"!==typeof b)1===this._state?a.fulfill(this._value):a.reject(this._value);else try{var c=b(this._value);a.resolve(c)}catch(f){a.reject(f)}};c.prototype._invokeResolver=function(b){try{b(this.resolve.bind(this),this.reject.bind(this))}catch(a){this.reject(a)}};a.Promise=c}});/*
 CC0-1.0
*/
(function(a,c){"function"===typeof define&&define.amd?define(["exports"],c):"object"===typeof exports?c(exports):c(a)})(this,function(a){if(!a.GLMath){var c={vec3cross:function(b,a){return[b[1]*a[2]-b[2]*a[1],b[2]*a[0]-b[0]*a[2],b[0]*a[1]-b[1]*a[0]]},vec3dot:function(b,a){return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]},vec3add:function(b,a){return[b[0]+a[0],b[1]+a[1],b[2]+a[2]]},vec3sub:function(b,a){return[b[0]-a[0],b[1]-a[1],b[2]-a[2]]},vec3negate:function(b){return[-b[0],-b[1],-b[2]]},vec3negateInPlace:function(b){b[0]=
-b[0];b[1]=-b[1];b[2]=-b[2];return b},vec3mul:function(b,a){return[b[0]*a[0],b[1]*a[1],b[2]*a[2]]},vec3addInPlace:function(b,a){var c=a[1],f=a[2];b[0]+=a[0];b[1]+=c;b[2]+=f;return b},vec3subInPlace:function(b,a){var c=a[1],f=a[2];b[0]-=a[0];b[1]-=c;b[2]-=f;return b},vec3mulInPlace:function(b,a){var c=a[1],f=a[2];b[0]*=a[0];b[1]*=c;b[2]*=f;return b},vec3scaleInPlace:function(b,a){b[0]*=a;b[1]*=a;b[2]*=a;return b},vec3scale:function(b,a){return c.vec3scaleInPlace([b[0],b[1],b[2]],a)},vec3lerp:function(b,
a,c){return[b[0]+(a[0]-b[0])*c,b[1]+(a[1]-b[1])*c,b[2]+(a[2]-b[2])*c]},vec4dot:function(b,a){return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3]},vec4scaleInPlace:function(b,a){b[0]*=a;b[1]*=a;b[2]*=a;b[3]*=a;return b},vec4lerp:function(b,a,c){return[b[0]+(a[0]-b[0])*c,b[1]+(a[1]-b[1])*c,b[2]+(a[2]-b[2])*c,b[3]+(a[3]-b[3])*c]},vec3normInPlace:function(b){var a=b[0],c=b[1],f=b[2],a=Math.sqrt(a*a+c*c+f*f);0!==a&&(a=1/a,b[0]*=a,b[1]*=a,b[2]*=a);return b},vec4normInPlace:function(b){var a=b[0],c=b[1],f=b[2],
g=b[3],a=Math.sqrt(a*a+c*c+f*f+g*g);0!==a&&(a=1/a,b[0]*=a,b[1]*=a,b[2]*=a,b[3]*=a);return b},vec3norm:function(b){return c.vec3normInPlace([b[0],b[1],b[2]])},vec4norm:function(b){return c.vec4normInPlace([b[0],b[1],b[2],b[3]])},vec3length:function(b){var a=b[0],c=b[1];b=b[2];return Math.sqrt(a*a+c*c+b*b)},vec4length:function(b){var a=b[0],c=b[1],f=b[2];b=b[3];return Math.sqrt(a*a+c*c+f*f+b*b)},mat3identity:function(){return[1,0,0,0,1,0,0,0,1]},mat4identity:function(){return[1,0,0,0,0,1,0,0,0,0,1,
0,0,0,0,1]},quatIdentity:function(){return[0,0,0,1]},mat4copy:function(b){return b.slice(0,16)},vec3copy:function(b){return b.slice(0,3)},vec4copy:function(b){return b.slice(0,4)},vec3assign:function(b,a){b[0]=a[0];b[1]=a[1];b[2]=a[2];return b},vec4assign:function(b,a){b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return b},mat4isIdentity:function(b){return 1===b[0]&&0===b[1]&&0===b[2]&&0===b[3]&&0===b[4]&&1===b[5]&&0===b[6]&&0===b[7]&&0===b[8]&&0===b[9]&&1===b[10]&&0===b[11]&&0===b[12]&&0===b[13]&&0===
b[14]&&1===b[15]},mat4invert:function(b){var a=b[0]*b[10],e=b[0]*b[11],f=b[0]*b[5],g=b[0]*b[6],h=b[0]*b[7],k=b[0]*b[9],l=b[10]*b[12],m=b[10]*b[13],n=b[10]*b[15],q=b[11]*b[12],r=b[11]*b[13],p=b[11]*b[14],t=b[1]*b[4],u=b[1]*b[6],v=b[1]*b[7],y=b[1]*b[8],w=b[2]*b[4],B=b[2]*b[5],z=b[2]*b[7],C=b[2]*b[8],I=b[2]*b[9],x=b[3]*b[4],A=b[3]*b[5],D=b[3]*b[6],J=b[3]*b[8],F=b[3]*b[9],L=b[4]*b[9],M=b[5]*b[8],K=b[6]*b[8],N=b[6]*b[9],G=b[7]*b[8],E=b[7]*b[9],H=t-f,O=u-B,P=v-A,Q=w-g,f=f-t,u=B-u,B=z-D,t=x-h,v=A-v,z=D-
z,g=g-w,w=h-x,h=b[9]*b[12]*z+l*P+q*u+b[8]*b[13]*B+m*t+r*g+b[8]*b[14]*v+b[9]*b[14]*w+p*H+b[8]*b[15]*O+b[9]*b[15]*Q+n*f;if(0===h)return c.mat4identity();h=1/h;x=[];x[0]=b[6]*r-b[7]*m+E*b[14]-b[5]*p-N*b[15]+b[5]*n;x[1]=b[3]*m-b[2]*r-F*b[14]+b[1]*p+I*b[15]-b[1]*n;x[2]=b[13]*B+b[14]*v+b[15]*O;x[3]=b[9]*z+b[10]*P+b[11]*u;x[4]=b[7]*l-b[6]*q-G*b[14]+b[4]*p+K*b[15]-b[4]*n;x[5]=b[2]*q-b[3]*l+b[14]*(J-e)+b[15]*(a-C);x[6]=b[12]*z+b[14]*w+b[15]*Q;x[7]=b[8]*B+b[10]*t+b[11]*g;x[8]=b[5]*q-E*b[12]+G*b[13]-b[4]*r+
b[15]*(L-M);x[9]=F*b[12]-b[1]*q+b[13]*(e-J)+b[15]*(y-k);x[10]=b[12]*P+b[13]*t+b[15]*f;x[11]=b[8]*v+b[9]*w+b[11]*H;x[12]=N*b[12]-b[5]*l-K*b[13]+b[4]*m+b[14]*(M-L);x[13]=b[1]*l-I*b[12]+b[13]*(C-a)+b[14]*(k-y);x[14]=b[12]*u+b[13]*g+b[14]*H;x[15]=b[8]*O+b[9]*Q+b[10]*f;for(b=0;16>b;b++)x[b]*=h;return x},quatConjugate:function(b){return[-b[0],-b[1],-b[2],b[3]]},quatInvert:function(b){var a=1/c.quatDot(b,b);return c.vec4scaleInPlace(c.quatConjugate(b),a)},quatIsIdentity:function(b){return 0===b[0]&&0===
b[1]&&0===b[2]&&1===b[3]},quatToMat4:function(b){var a,c,f,g,h,k,l,m,n;a=2*b[0];c=2*b[1];f=2*b[2];g=a*b[0];h=a*b[1];k=a*b[2];l=c*b[1];m=f*b[1];n=f*b[2];a*=b[3];c*=b[3];b=f*b[3];return[1-(l+n),h+b,k-c,0,h-b,1-(g+n),m+a,0,k+c,m-a,1-(g+l),0,0,0,0,1]},quatToAxisAngle:function(b){var a=b[3],e=1-a*a;return 0<e?(e=1/Math.sqrt(e),[b[0]*e,b[1]*e,b[2]*e,Math.acos(a)*c.Num360DividedByPi]):[0,1,0,0]},quatFromVectors:function(b,a){var e=c.vec3cross(b,a),f=Math.sqrt(c.vec3dot(b,b))*Math.sqrt(c.vec3dot(a,a));0===
f&&(f=1);e[3]=f+c.vec3dot(b,a);return c.quatNormInPlace(e)},quatFromAxisAngle:function(b,a,e,f){var g;"undefined"!==typeof e&&"undefined"!==typeof f?(g=a,a=f):"undefined"===typeof a?(g=b[0],e=b[1],a=b[2]):(g=a[0],e=a[1],a=a[2]);f=(0<=b&&360>b?b:b%360+(0>b?360:0))*c.PiDividedBy360;b=Math.cos(f);f=0<=f&&6.283185307179586>f?3.141592653589793>=f?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(f);g=c.vec3normInPlace([g,e,a]);g=[g[0],g[1],g[2],b];g[0]*=f;g[1]*=f;g[2]*=f;return g},quatFromTaitBryan:function(b,
a,e,f){var g,h;if(null===f||"undefined"===typeof f)f=c.RollPitchYaw;if(0>f||6<=f)throw Error("invalid mode");b.constructor===Array?(e=(0<=b[2]&&360>b[2]?b[2]:b[2]%360+(0>b[2]?360:0))*c.PiDividedBy360,g=(0<=b[0]&&360>b[0]?b[0]:b[0]%360+(0>b[0]?360:0))*c.PiDividedBy360,h=(0<=b[1]&&360>b[1]?b[1]:b[1]%360+(0>b[1]?360:0))*c.PiDividedBy360):(e=(0<=e&&360>e?e:e%360+(0>e?360:0))*c.PiDividedBy360,g=(0<=b&&360>b?b:b%360+(0>b?360:0))*c.PiDividedBy360,h=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.PiDividedBy360);b=Math.cos(g);
g=0<=g&&6.283185307179586>g?3.141592653589793>=g?Math.sqrt(1-b*b):-Math.sqrt(1-b*b):Math.sin(g);a=Math.cos(h);h=0<=h&&6.283185307179586>h?3.141592653589793>=h?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(h);var k=Math.cos(e);e=0<=e&&6.283185307179586>e?3.141592653589793>=e?Math.sqrt(1-k*k):-Math.sqrt(1-k*k):Math.sin(e);var l;f===c.PitchYawRoll||f===c.PitchRollYaw?(l=[e*h,k*h,e*a,k*a],f===c.PitchYawRoll&&(l[0]=-l[0]),f=[l[3]*g+l[0]*b,l[1]*b+l[2]*g,l[2]*b-l[1]*g,l[3]*b-l[0]*g]):f===c.YawPitchRoll||f===
c.YawRollPitch?(l=[k*g,e*g,e*b,k*b],f===c.YawRollPitch&&(l[1]=-l[1]),f=[l[0]*a-l[2]*h,l[3]*h+l[1]*a,l[2]*a+l[0]*h,l[3]*a-l[1]*h]):(l=[a*g,h*b,h*g,a*b],f===c.RollPitchYaw&&(l[2]=-l[2]),f=[l[0]*k+l[1]*e,l[1]*k-l[0]*e,l[3]*e+l[2]*k,l[3]*k-l[2]*e]);return f},quatToTaitBryan:function(b,a){var e=b[3],f,g,h,k=1;if(null===a||"undefined"===typeof a)a=c.RollPitchYaw;if(0>a||6<=a)throw Error("invalid mode");a===c.RollPitchYaw?(f=b[1],g=b[0],h=b[2],k=-1):a===c.PitchYawRoll?(f=b[2],g=b[1],h=b[0],k=-1):a===c.PitchRollYaw?
(f=b[1],g=b[2],h=b[0]):a===c.YawPitchRoll?(f=b[2],g=b[0],h=b[1]):a===c.YawRollPitch?(f=b[0],g=b[2],h=b[1],k=-1):(f=b[0],g=b[1],h=b[2]);var l=g*g,m=Math.atan2(2*(e*f-k*g*h),1-2*(f*f+l)),n=2*(e*g+k*f*h);1<n&&(n=1);-1>n&&(n=-1);n=Math.asin(n);g=Math.atan2(2*(e*h-k*f*g),1-2*(l+h*h));m*=c.Num180DividedByPi;n*=c.Num180DividedByPi;g*=c.Num180DividedByPi;if(1E-6>Math.abs(n-90)||1E-6>Math.abs(n+90))g=0,m=Math.atan2(f,e)*c.Num180DividedByPi,isNaN(m)&&(m=0);e=[];a===c.RollPitchYaw?(e[0]=n,e[1]=m,e[2]=g):a===
c.PitchYawRoll?(e[0]=g,e[1]=n,e[2]=m):a===c.PitchRollYaw?(e[0]=g,e[1]=m,e[2]=n):a===c.YawPitchRoll?(e[0]=n,e[1]=g,e[2]=m):a===c.YawRollPitch?(e[0]=m,e[1]=g,e[2]=n):(e[0]=m,e[1]=n,e[2]=g);return e},quatNlerp:function(b,a,e){var f=1-e,g=b[0]*f,h=b[1]*f,k=b[2]*f,f=b[3]*f,l=a[0]*e,m=a[1]*e,n=a[2]*e;e*=a[3];return 0>b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3]?c.quatNormInPlace([g-l,h-m,k-n,f-e]):c.quatNormInPlace([g+l,h+m,k+n,f+e])},quatSlerp:function(b,a,e){var f=c.quatDot(b,a),g=a;0>f&&(g=[-a[0],-a[1],-a[2],
-a[3]],f=c.quatDot(b,g));a=0;if(-1<f)if(1>f){if(a=Math.acos(f),0===a)return g.slice(0,4)}else return g.slice(0,4);else a=Math.PI;var h=1/Math.sin(a),f=Math.sin((1-e)*a)*h;e=Math.sin(e*a)*h;return[b[0]*f+g[0]*e,b[1]*f+g[1]*e,b[2]*f+g[2]*e,b[3]*f+g[3]*e]},quatRotate:function(b,a,e,f,g){return c.quatMultiply(b,c.quatFromAxisAngle(a,e,f,g))},quatTransform:function(b,a){var c=b[1]*a[2]-b[2]*a[1]+a[0]*b[3],f=b[2]*a[0]-b[0]*a[2]+a[1]*b[3],g=b[0]*a[1]-b[1]*a[0]+a[2]*b[3],h=b[0]*a[0]+b[1]*a[1]+b[2]*a[2];return[c*
b[3]-(f*b[2]-g*b[1])+b[0]*h,f*b[3]-(g*b[0]-c*b[2])+b[1]*h,g*b[3]-(c*b[1]-f*b[0])+b[2]*h,1]},quatFromMat4:function(b){var a=[],c=b[1],f=b[2],g=b[4],h=b[6],k=b[8],l=b[9],m=b[0]+b[5]+b[10];0<=m?(b=.5*Math.sqrt(m+1),m=.25/b,a[0]=(h-l)*m,a[1]=(k-f)*m,a[2]=(c-g)*m,a[3]=b):b[0]>b[5]&&b[0]>b[10]?(b=.5*Math.sqrt(1+b[0]-b[5]-b[10]),m=.25/b,a[0]=b,a[1]=(g+c)*m,a[2]=(f+k)*m,a[3]=(h-l)*m):b[5]>b[10]?(b=.5*Math.sqrt(1+b[5]-b[0]-b[10]),m=.25/b,a[0]=(g+c)*m,a[1]=b,a[2]=(l+h)*m,a[3]=(k-f)*m):(b=.5*Math.sqrt(1+b[10]-
b[0]-b[5]),m=.25/b,a[0]=(k+f)*m,a[1]=(l+h)*m,a[2]=b,a[3]=(c-g)*m);return a},mat4toMat3:function(b){return[b[0],b[1],b[2],b[4],b[5],b[6],b[8],b[9],b[10]]},mat4transpose:function(b){return c.mat4transposeInPlace(b.slice(0,16))},mat4transposeInPlace:function(b){var a=b[1];b[1]=b[4];b[4]=a;a=b[2];b[2]=b[8];b[8]=a;a=b[3];b[3]=b[12];b[12]=a;a=b[6];b[6]=b[9];b[9]=a;a=b[7];b[7]=b[13];b[13]=a;a=b[11];b[11]=b[14];b[14]=a;return b},mat4inverseTranspose3:function(b){if(0===b[1]&&0===b[2]&&0===b[4]&&0===b[6]&&
0===b[8]&&0===b[9])return 1===b[0]&&1===b[5]&&1===b[10]?[1,0,0,0,1,0,0,0,1]:0!==b[0]*b[5]*b[10]?[1/b[0],0,0,0,1/b[5],0,0,0,1/b[10]]:[1,0,0,0,1,0,0,0,1];b=[b[0],b[1],b[2],b[4],b[5],b[6],b[8],b[9],b[10]];var a=b[0]*b[4]*b[8]+b[3]*b[7]*b[2]+b[6]*b[1]*b[5]-b[6]*b[4]*b[2]-b[3]*b[1]*b[8]-b[0]*b[7]*b[5];if(0===a)return[1,0,0,0,1,0,0,0,1];a=1/a;return[(-b[5]*b[7]+b[4]*b[8])*a,(b[5]*b[6]-b[3]*b[8])*a,(-b[4]*b[6]+b[3]*b[7])*a,(b[2]*b[7]-b[1]*b[8])*a,(-b[2]*b[6]+b[0]*b[8])*a,(b[1]*b[6]-b[0]*b[7])*a,(-b[2]*b[4]+
b[1]*b[5])*a,(b[2]*b[3]-b[0]*b[5])*a,(-b[1]*b[3]+b[0]*b[4])*a]},mat4scale:function(b,a,c,f){var g;"undefined"!==typeof c&&"undefined"!==typeof f?(g=a,a=f):(g=a[0],c=a[1],a=a[2]);return[b[0]*g,b[1]*g,b[2]*g,b[3]*g,b[4]*c,b[5]*c,b[6]*c,b[7]*c,b[8]*a,b[9]*a,b[10]*a,b[11]*a,b[12],b[13],b[14],b[15]]},mat4scaled:function(b,a,c){return"undefined"!==typeof a&&"undefined"!==typeof c?[b,0,0,0,0,a,0,0,0,0,c,0,0,0,0,1]:[b[0],0,0,0,0,b[1],0,0,0,0,b[2],0,0,0,0,1]},mat4transform:function(b,a,c,f,g){var h;"undefined"!==
typeof c&&"undefined"!==typeof f&&"undefined"!==typeof g?(h=a,a=g):(h=a[0],c=a[1],f=a[2],a=a[3]);return[h*b[0]+c*b[4]+f*b[8]+a*b[12],h*b[1]+c*b[5]+f*b[9]+a*b[13],h*b[2]+c*b[6]+f*b[10]+a*b[14],h*b[3]+c*b[7]+f*b[11]+a*b[15]]},mat4transformVec3:function(b,a,c,f){var g;"undefined"!==typeof c&&"undefined"!==typeof f?(g=a,a=f):(g=a[0],c=a[1],a=a[2]);return[g*b[0]+c*b[4]+a*b[8]+b[12],g*b[1]+c*b[5]+a*b[9]+b[13],g*b[2]+c*b[6]+a*b[10]+b[14],g*b[3]+c*b[7]+a*b[11]+b[15]]},mat3transform:function(b,a,c,f){var g;
"undefined"!==typeof c&&"undefined"!==typeof f?(g=a,a=f):(g=a[0],c=a[1],a=a[2]);return[g*b[0]+c*b[3]+a*b[6],g*b[1]+c*b[4]+a*b[7],g*b[2]+c*b[5]+a*b[8]]},mat4translated:function(b,a,c){var f;"undefined"!==typeof a&&"undefined"!==typeof c?(f=b,b=c):(f=b[0],a=b[1],b=b[2]);return[1,0,0,0,0,1,0,0,0,0,1,0,f,a,b,1]},mat4translate:function(b,a,c,f){var g;"undefined"!==typeof c&&"undefined"!==typeof f?(g=a,a=f):(g=a[0],c=a[1],a=a[2]);return[b[0],b[1],b[2],b[3],b[4],b[5],b[6],b[7],b[8],b[9],b[10],b[11],b[0]*
g+b[4]*c+b[8]*a+b[12],b[1]*g+b[5]*c+b[9]*a+b[13],b[2]*g+b[6]*c+b[10]*a+b[14],b[3]*g+b[7]*c+b[11]*a+b[15]]},mat4perspective:function(b,a,e,f){b=1/Math.tan((0<=b&&360>b?b:b%360+(0>b?360:0))*c.PiDividedBy360);var g;g=1/(e-f);return[b/a,0,0,0,0,b,0,0,0,0,g*(e+f),-1,0,0,g*e*f*2,0]},mat4lookat:function(b,a,e){e||(e=[0,1,0]);a||(a=[0,0,0]);a=[a[0]-b[0],a[1]-b[1],a[2]-b[2]];var f=c.vec3length(a);if(1E-6>f)return c.mat4identity();f=1/f;a[0]*=f;a[1]*=f;a[2]*=f;e=c.vec3norm(e);e=c.vec3cross(a,e);c.vec3normInPlace(e);
f=c.vec3cross(e,a);c.vec3normInPlace(f);a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return[e[0],f[0],a[0],0,e[1],f[1],a[1],0,e[2],f[2],a[2],0,-c.vec3dot(b,e),-c.vec3dot(b,f),-c.vec3dot(b,a),1]},mat4ortho:function(b,a,c,f,g,h){var k=1/(a-b),l=1/(f-c),m=1/(h-g);return[2*k,0,0,0,0,2*l,0,0,0,0,-2*m,0,-(b+a)*k,-(f+c)*l,-(g+h)*m,1]},mat4perspectiveHorizontal:function(b,a,e,f){return c.mat4perspective(c.Num360DividedByPi*Math.atan2(Math.tan((0<=b&&360>b?b:b%360+(0>b?360:0))*c.PiDividedBy360),a),a,e,f)},mat4ortho2d:function(b,
a,e,f){return c.mat4ortho2d(b,a,e,f,-1,1)},mat4ortho2dAspect:function(b,a,e,f,g){return c.mat4orthoAspect(b,a,e,f,-1,1,g)},mat4orthoAspect:function(b,a,e,f,g,h,k){k/=Math.abs((a-b)/(f-e));var l=Math.abs(a-b),m=Math.abs(f-e);1>k?(k=m/k,f>e?(e-=.5*(k-m),f+=.5*(k-m)):(f-=.5*(k-m),e+=.5*(k-m))):(k*=l,a>b?(b-=.5*(k-l),a+=.5*(k-l)):(a-=.5*(k-l),b+=.5*(k-l)));return c.mat4ortho(b,a,e,f,g,h)},mat4frustum:function(b,a,c,f,g,h){var k=2*g,l=1/(a-b),m=1/(f-c),n=1/(h-g);return[k*l,0,0,0,0,k*m,0,0,(b+a)*l,(f+c)*
m,-(h+g)*n,-1,0,0,-(k*h)*n,0]},mat4scaleInPlace:function(b,a,c,f){var g;"undefined"!==typeof c&&"undefined"!==typeof f?(g=a,a=f):(g=a[0],c=a[1],a=a[2]);b[0]*=g;b[1]*=g;b[2]*=g;b[3]*=g;b[4]*=c;b[5]*=c;b[6]*=c;b[7]*=c;b[8]*=a;b[9]*=a;b[10]*=a;b[11]*=a;return b},mat4multiply:function(b,a){for(var c=[],f=0;16>f;f+=4)for(var g=0;4>g;g++)c[f+g]=a[f]*b[g]+a[f+1]*b[g+4]+a[f+2]*b[g+8]+a[f+3]*b[g+12];return c},quatMultiply:function(b,a){return[b[3]*a[0]+b[0]*a[3]+b[1]*a[2]-b[2]*a[1],b[3]*a[1]+b[1]*a[3]+b[2]*
a[0]-b[0]*a[2],b[3]*a[2]+b[2]*a[3]+b[0]*a[1]-b[1]*a[0],b[3]*a[3]-b[0]*a[0]-b[1]*a[1]-b[2]*a[2]]},mat4rotate:function(b,a,e,f,g){var h,k;"undefined"!==typeof f&&"undefined"!==typeof g?(h=e,k=f,e=g,g=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.PiDividedBy180):"undefined"===typeof e?(h=a[0],k=a[1],e=a[2],g=a[3],g=(0<=g&&360>g?g:g%360+(0>g?360:0))*c.PiDividedBy180):(h=e[0],k=e[1],e=e[2],g=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.PiDividedBy180);a=Math.cos(g);var l=0<=g&&6.283185307179586>g?3.141592653589793>=g?Math.sqrt(1-
a*a):-Math.sqrt(1-a*a):Math.sin(g);if(1===h&&0===k&&0===e)return[b[0],b[1],b[2],b[3],a*b[4]+b[8]*l,a*b[5]+b[9]*l,a*b[6]+b[10]*l,a*b[7]+b[11]*l,a*b[8]-l*b[4],a*b[9]-l*b[5],a*b[10]-l*b[6],a*b[11]-l*b[7],b[12],b[13],b[14],b[15]];if(0===h&&1===k&&0===e)return[a*b[0]-l*b[8],a*b[1]-l*b[9],a*b[2]-l*b[10],a*b[3]-l*b[11],b[4],b[5],b[6],b[7],a*b[8]+b[0]*l,a*b[9]+b[1]*l,a*b[10]+b[2]*l,a*b[11]+b[3]*l,b[12],b[13],b[14],b[15]];if(0===h&&0===k&&1===e)return[a*b[0]+b[4]*l,a*b[1]+b[5]*l,a*b[2]+b[6]*l,a*b[3]+b[7]*
l,a*b[4]-l*b[0],a*b[5]-l*b[1],a*b[6]-l*b[2],a*b[7]-l*b[3],b[8],b[9],b[10],b[11],b[12],b[13],b[14],b[15]];if(0===h&&0===k&&0===e)return b.slice(0,16);g=1/Math.sqrt(h*h+k*k+e*e);h*=g;k*=g;e*=g;var m=k*k;f=1-a;var n=h*k,q=k*e;g=h*l;k*=l;var r=e*l,l=f*q,p=f*n,t=f*h*e;h=a+f*h*h;n=p+r;q=t-k;m=a+f*m;r=p-r;p=l+g;e=a+f*e*e;a=t+k;g=l-g;return[b[0]*h+b[4]*n+b[8]*q,b[1]*h+b[5]*n+b[9]*q,b[10]*q+b[2]*h+b[6]*n,b[11]*q+b[3]*h+b[7]*n,b[0]*r+b[4]*m+b[8]*p,b[1]*r+b[5]*m+b[9]*p,b[10]*p+b[2]*r+b[6]*m,b[11]*p+b[3]*r+b[7]*
m,b[0]*a+b[4]*g+b[8]*e,b[1]*a+b[5]*g+b[9]*e,b[10]*e+b[2]*a+b[6]*g,b[11]*e+b[3]*a+b[7]*g,b[12],b[13],b[14],b[15]]},mat4rotated:function(a,d,e,f){var g;"undefined"!==typeof e&&"undefined"!==typeof f?(g=d,d=f,f=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.PiDividedBy180):"undefined"===typeof d?(g=a[0],e=a[1],d=a[2],f=a[3],f=(0<=f&&360>f?f:f%360+(0>f?360:0))*c.PiDividedBy180):(g=d[0],e=d[1],d=d[2],f=(0<=a&&360>a?a:a%360+(0>a?360:0))*c.PiDividedBy180);a=Math.cos(f);var h=0<=f&&6.283185307179586>f?3.141592653589793>=
f?Math.sqrt(1-a*a):-Math.sqrt(1-a*a):Math.sin(f);if(1===g&&0===e&&0===d)return[1,0,0,0,0,a,h,0,0,-h,a,0,0,0,0,1];if(0===g&&1===e&&0===d)return[a,0,-h,0,0,1,0,0,h,0,a,0,0,0,0,1];if(0===g&&0===e&&1===d)return[a,h,0,0,-h,a,0,0,0,0,1,0,0,0,0,1];if(0===g&&0===e&&0===d)return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];f=1/Math.sqrt(g*g+e*e+d*d);g*=f;e*=f;d*=f;f=g*g;var k=e*e,l=d*d,m=g*d,n=e*d,q=g*h,r=e*h,h=d*h,p=1-a;g=p*g*e;e=p*m;d=p*n;return[a+p*f,g+h,e-r,0,g-h,a+p*k,d+q,0,e+r,d-q,a+p*l,0,0,0,0,1]},planeNormInPlace:function(a){var c=
a[0],e=a[1],f=a[2],c=Math.sqrt(c*c+e*e+f*f);0!==c&&(c=1/c,a[0]*=c,a[1]*=c,a[2]*=c,a[3]*=c);return a},planeNorm:function(a){return c.planeNormInPlace(a.slice(0,4))},mat4toFrustumPlanes:function(a){var d=[[],[],[],[],[],[]];d[0]=c.planeNormInPlace([a[3]+a[0],a[7]+a[4],a[11]+a[8],a[15]+a[12]]);d[1]=c.planeNormInPlace([a[3]-a[0],a[7]-a[4],a[11]-a[8],a[15]-a[12]]);d[2]=c.planeNormInPlace([a[3]-a[1],a[7]-a[5],a[11]-a[9],a[15]-a[13]]);d[3]=c.planeNormInPlace([a[3]+a[1],a[7]+a[5],a[11]+a[9],a[15]+a[13]]);
d[4]=c.planeNormInPlace([a[3]+a[2],a[7]+a[6],a[11]+a[10],a[15]+a[14]]);d[5]=c.planeNormInPlace([a[3]-a[2],a[7]-a[6],a[11]-a[10],a[15]-a[14]]);return d},frustumHasSphere:function(a,c,e,f,g){if(0>g)throw Error("radius is negative");for(var h=0;6>h;h++){var k=a[h];if(k[3]+k[0]*c+k[1]*e+k[2]*f<-g)return!1}return!0},boxIsEmpty:function(a){return!(a[0]<=a[3]&&a[1]<=a[4]&&a[2]<=a[5])},frustumHasBox:function(a,d){if(c.boxIsEmpty(d))return!1;for(var e=0;6>e;e++){var f=a[e],g=f[3],h=f[0]*d[0],k=f[2]*d[2],l=
f[1]*d[1];if(0>=h+l+k+g&&0>=f[0]*d[3]+f[1]*d[4]+f[2]*d[5]+g&&0>=h+f[1]*d[4]+k+g&&0>=h+f[1]*d[4]+f[2]*d[5]+g&&0>=h+l+f[2]*d[5]+g&&0>=f[0]*d[3]+f[1]*d[4]+k+g&&0>=f[0]*d[3]+l+k+g&&0>=f[0]*d[3]+l+f[2]*d[5]+g)return!1}return!0},frustumHasPoint:function(a,c,e,f){for(var g=0;6>g;g++)if(0>=a[g][0]*c+a[g][1]*e+a[g][2]*f+a[g][3])return!1;return!0}};c.quatDot=c.vec4dot;c.quatNormInPlace=c.vec4normInPlace;c.quatNorm=c.vec4norm;c.quatLength=c.vec4length;c.quatScaleInPlace=c.vec4scaleInPlace;c.quatCopy=c.vec4copy;
c.PiTimes2=6.283185307179586;c.HalfPi=1.5707963267948966;c.PiDividedBy180=.017453292519943295;c.PiDividedBy360=.008726646259971648;c.Num360DividedByPi=114.59155902616465;c.Num180DividedByPi=57.29577951308232;c.PitchYawRoll=0;c.PitchRollYaw=1;c.YawPitchRoll=2;c.YawRollPitch=3;c.RollPitchYaw=4;c.RollYawPitch=5;c.quatInverse=c.quatInvert;a.GLMath=c}});(function(a,c){"function"===typeof define&&define.amd?define(["exports"],c):"object"===typeof exports?c(exports):c(a)})(this,function(a){if(!a.GLUtil){window.requestAnimationFrame||(window.requestAnimationFrame=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame,window.requestAnimationFrame||(window.requestAnimationFrame=function(a){window.setTimeout(function(){a(window.performance.now())},17)}));window.performance||(window.performance={});window.performance.now||
(window.performance.now=function(){return 1E3*(new Date).getTime()-window.performance._startTime},window.performance._startTime=1E3*(new Date).getTime());var c={renderLoop:function(a){a(window.performance.now());var c=function(e){window.requestAnimationFrame(c);a(e)};window.requestAnimationFrame(c)},createCanvasElement:function(a,c,e){var f=document.createElement("canvas");a&&a.appendChild(f);if(null===c||"undefined"===typeof c)f.width=Math.ceil(f.clientWidth)+"";else{if(0>c)throw Error("width negative");
f.width=Math.ceil(c)+""}if(null===e||"undefined"===typeof e)f.height=Math.ceil(f.clientHeight)+"";else{if(0>e)throw Error("height negative");f.height=Math.ceil(e)+""}return f},get3DOr2DContext:function(a){if(!a||!a.getContext)return null;var d=null,e={preserveDrawingBuffer:!0,alpha:!1};e.antialias=window.devicePixelRatio&&1<window.devicePixelRatio?!1:!0;try{d=a.getContext("webgl",e)}catch(f){d=null}if(!d)try{d=a.getContext("experimental-webgl",e)}catch(f){d=null}if(!d)try{d=a.getContext("moz-webgl",
e)}catch(f){d=null}if(!d)try{d=a.getContext("webkit-3d",e)}catch(f){d=null}if(!d)try{d=a.getContext("2d",e)}catch(f){d=null}c.is3DContext(d)&&(d.getExtension("OES_element_index_uint"),d.getExtension("OES_standard_derivatives"));return d},get3DContext:function(a,d){var e=c.get3DOr2DContext(a),f=null;!e&&window.WebGLShader?f="Failed to initialize graphics support required by this page.":window.WebGLShader&&!c.is3DContext(e)?f="This page requires WebGL, but it failed to start. Your computer might not support WebGL.":
e&&c.is3DContext(e)||(f="This page requires a WebGL-supporting browser.");return f?((d||window.alert)(f),null):e},is3DContext:function(a){return a&&"compileShader"in a},getPromiseResultsAll:function(a,d,e){return c.getPromiseResults(a,d,e).then(function(a){return 0<a.failures.length?Promise.reject(a):Promise.resolve(a.successes)})},getPromiseResults:function(a,c,e){function f(a,b,c){return function(d){a&&a(d);b.successes[c]=d;return!0}}function g(a,b,c){return function(d){a&&a(d);b.failures[c]=d;
return!0}}if(!a||0===a.length)return Promise.resolve({successes:[],failures:[],results:[]});for(var h={successes:[],failures:[],results:[]},k=[],l=0;l<a.length;l++){var m=l;k.push(a[l].then(f(c,h,m),g(e,h,m)))}return Promise.all(k).then(function(a){for(var b=0;b<h.successes.length;b++)"undefined"===typeof h.successes[b]&&(h.successes.splice(b,1),--b);for(b=0;b<h.failures.length;b++)"undefined"===typeof h.failures[b]&&(h.failures.splice(b,1),--b);h.results=a;return Promise.resolve(h)})},loadFileFromUrl:function(a,
c){var e=c||"text";return new Promise(function(c,d){var h=new XMLHttpRequest;h.onreadystatechange=function(h){h=h.target;if(4===h.readyState)if(200<=h.status&&300>h.status){var l="",l="xml"===e?h.responseXML:"json"===e?"response"in h?h.response:JSON.parse(h.responseText):"arraybuffer"===e?h.response:h.responseText+"";c({url:a,data:l})}else d({url:a})};h.onerror=function(c){d({url:a,error:c})};h.open("get",a,!0);h.responseType=e;h.send()})},getTimePosition:function(a,c,e){if("undefined"===typeof a.time||
null===a.time)return a.time=c,a.lastTime=c,0;if("undefined"===typeof a.lastTime||null===a.lastTime)a.lastTime=c;return 1*(c-a.time)%e/e},newFrames:function(a,c){if("undefined"===typeof a.time||null===a.time)return a.time=c,a.lastTime=c,0;if("undefined"===typeof a.lastTime||null===a.lastTime)return a.lastTime=c,0;var e=c-a.lastTime;a.lastTime=c;return 60*e/1E3}};(function(a){var c=function(a){var b=1*a[0],c=1*a[1],d=1*a[2],c=0>c?0:255<c?255:c,d=0>d?0:255<d?255:d;if(0===d)return[c,c,c];a=0;a=127.5>=
c?c*(255+d)/255:c+d-c*d/255;var e=2*c-a;if(0>b||360<=b)b=(b%360+360)%360;var h=b+120;360<=h&&(h-=360);c=60>h?e+(a-e)*h/60:180>h?a:240>h?e+(a-e)*(240-h)/60:e;h=b;d=60>h?e+(a-e)*h/60:180>h?a:240>h?e+(a-e)*(240-h)/60:e;h=b-120;0>h&&(h+=360);b=60>h?e+(a-e)*h/60:180>h?a:240>h?e+(a-e)*(240-h)/60:e;return[0>c?0:255<c?255:c,0>d?0:255<d?255:d,0>b?0:255<b?255:b]},e=function(a){function b(a){var c;return 255*(0>(c=parseFloat(a))?0:100<c?100:c)/100}function f(a){var b;return 255*(0>(b=parseFloat(a))?0:1<b?1:
b)}function n(a){var b;return 0>(b=parseInt(a,10))?0:255<b?255:b}function q(a){a=parseFloat(r[1]);if(0>a||360<=a)a=(a%360+360)%360;return a}var r=null;if(!a)return null;var p;if(null!==(r=/^#([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})([A-Fa-f0-9]{2})$/.exec(a)))return[parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16),255];if(null!==(r=/^rgb\(\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*\)$/.exec(a)))return[b(r[1]),b(r[2]),b(r[3]),255];if(null!==(r=/^rgb\(\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*\)$/.exec(a)))return[n(r[1]),
n(r[2]),n(r[3]),255];if(null!==(r=/^rgba\(\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?%)\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(a)))return[b(r[1]),b(r[2]),b(r[3]),f(r[4])];if(null!==(r=/^rgba\(\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+)\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(a)))return[n(r[1]),n(r[2]),n(r[3]),f(r[4])];if(null!==(r=/^#([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})([A-Fa-f0-9]{1})$/.exec(a))){var t=parseInt(r[1],16);a=parseInt(r[2],16);p=parseInt(r[3],
16);return[t+(t<<4),a+(a<<4),p+(p<<4),255]}if(null!==(r=/^hsl\(\s*([\+\-]?\d+(?:\.\d+)?)\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*\)$/.exec(a)))return a=c([q(r[1]),b(r[3]),b(r[2])]),[a[0],a[1],a[2],255];if(null!==(r=/^hsla\(\s*([\+\-]?\d+(?:\.\d+)?)\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)%\s*,\s*([\+\-]?\d+(?:\.\d+)?)\s*\)$/.exec(a)))return a=c([q(r[1]),b(r[3]),b(r[2])]),[a[0],a[1],a[2],f(r[4])];h();a=a.toLowerCase();0<=a.indexOf("grey")&&(a=a.replace("grey",
"gray"));p=g[a];return"string"===typeof p?e(p):"transparent"===a?[0,0,0,0]:null},f=function(a){a[0]=0>a[0]?0:Math.min(a[0],1);a[1]=0>a[1]?0:Math.min(a[1],1);a[2]=0>a[2]?0:Math.min(a[2],1);a[3]=0>a[3]?0:Math.min(a[3],1);return a};a.toGLColor=function(a,b,c,d){return null===a||"undefined"===typeof a?[0,0,0,0]:"string"===typeof a?(a=e(a)||[0,0,0,0],b=1/255,a[0]*=b,a[1]*=b,a[2]*=b,a[3]*=b,f(a)):"number"===typeof a&&"number"===typeof b&&"number"===typeof c?[a,b,c,"number"!==typeof d?1:d]:a.constructor===
Array?f([a[0]||0,a[1]||0,a[2]||0,"number"!==typeof a[3]?1:a[3]]):f(a||[0,0,0,0])};var g=null,h=function(){if(!g){var a="aliceblue f0f8ff antiquewhite faebd7 aqua 00ffff aquamarine 7fffd4 azure f0ffff beige f5f5dc bisque ffe4c4 black 000000 blanchedalmond ffebcd blue 0000ff blueviolet 8a2be2 brown a52a2a burlywood deb887 cadetblue 5f9ea0 chartreuse 7fff00 chocolate d2691e coral ff7f50 cornflowerblue 6495ed cornsilk fff8dc crimson dc143c cyan 00ffff darkblue 00008b darkcyan 008b8b darkgoldenrod b8860b darkgray a9a9a9 darkgreen 006400 darkkhaki bdb76b darkmagenta 8b008b darkolivegreen 556b2f darkorange ff8c00 darkorchid 9932cc darkred 8b0000 darksalmon e9967a darkseagreen 8fbc8f darkslateblue 483d8b darkslategray 2f4f4f darkturquoise 00ced1 darkviolet 9400d3 deeppink ff1493 deepskyblue 00bfff dimgray 696969 dodgerblue 1e90ff firebrick b22222 floralwhite fffaf0 forestgreen 228b22 fuchsia ff00ff gainsboro dcdcdc ghostwhite f8f8ff gold ffd700 goldenrod daa520 gray 808080 green 008000 greenyellow adff2f honeydew f0fff0 hotpink ff69b4 indianred cd5c5c indigo 4b0082 ivory fffff0 khaki f0e68c lavender e6e6fa lavenderblush fff0f5 lawngreen 7cfc00 lemonchiffon fffacd lightblue add8e6 lightcoral f08080 lightcyan e0ffff lightgoldenrodyellow fafad2 lightgray d3d3d3 lightgreen 90ee90 lightpink ffb6c1 lightsalmon ffa07a lightseagreen 20b2aa lightskyblue 87cefa lightslategray 778899 lightsteelblue b0c4de lightyellow ffffe0 lime 00ff00 limegreen 32cd32 linen faf0e6 magenta ff00ff maroon 800000 mediumaquamarine 66cdaa mediumblue 0000cd mediumorchid ba55d3 mediumpurple 9370d8 mediumseagreen 3cb371 mediumslateblue 7b68ee mediumspringgreen 00fa9a mediumturquoise 48d1cc mediumvioletred c71585 midnightblue 191970 mintcream f5fffa mistyrose ffe4e1 moccasin ffe4b5 navajowhite ffdead navy 000080 oldlace fdf5e6 olive 808000 olivedrab 6b8e23 orange ffa500 orangered ff4500 orchid da70d6 palegoldenrod eee8aa palegreen 98fb98 paleturquoise afeeee palevioletred d87093 papayawhip ffefd5 peachpuff ffdab9 peru cd853f pink ffc0cb plum dda0dd powderblue b0e0e6 purple 800080 rebeccapurple 663399 red ff0000 rosybrown bc8f8f royalblue 4169e1 saddlebrown 8b4513 salmon fa8072 sandybrown f4a460 seagreen 2e8b57 seashell fff5ee sienna a0522d silver c0c0c0 skyblue 87ceeb slateblue 6a5acd slategray 708090 snow fffafa springgreen 00ff7f steelblue 4682b4 tan d2b48c teal 008080 thistle d8bfd8 tomato ff6347 turquoise 40e0d0 violet ee82ee wheat f5deb3 white ffffff whitesmoke f5f5f5 yellow ffff00 yellowgreen 9acd32".split(" ");
g={};for(var b=0;b<a.length;b+=2)g[a[b]]="#"+a[b+1]}}})(c);c._toContext=function(a){return a&&a.getContext?a.getContext():a};c._isPowerOfTwo=function(a){if(Math.floor(a)!==a||0>=a)return!1;for(;1<a&&0===(a&1);)a>>=1;return 1===a};c._isIdentityExceptTranslate=function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&1===a[15]};a.Lights=Lights;a.LightSource=LightSource;a.Texture=Texture;a.Material=Material;a.Scene3D=
Scene3D;a.GLUtil=c}});GLUtil._MaterialBinder=function(a){this.mshade=a};GLUtil._MaterialBinder._textureSizeZeroZero=[0,0];
GLUtil._MaterialBinder.prototype.bind=function(a,c,b){if(!this.mshade)return this;4!==this.mshade.diffuse.length&&console.warn("creating new diffuse array");3!==this.mshade.ambient.length&&console.warn("creating new ambient array");3!==this.mshade.specular.length&&console.warn("creating new specular array");3!==this.mshade.emission.length&&console.warn("creating new emission array");var d={textureSize:GLUtil._MaterialBinder._textureSizeZeroZero,md:4===this.mshade.diffuse.length?this.mshade.diffuse:
[this.mshade.diffuse[0],this.mshade.diffuse[1],this.mshade.diffuse[2],4>this.mshade.diffuse.length?1:this.mshade.diffuse[3]]};this.mshade.basic||(d.mshin=this.mshade.shininess,d.ma=3===this.mshade.ambient.length?this.mshade.ambient:[this.mshade.ambient[0],this.mshade.ambient[1],this.mshade.ambient[2]],d.ms=3===this.mshade.specular.length?this.mshade.specular:[this.mshade.specular[0],this.mshade.specular[1],this.mshade.specular[2]],d.me=3===this.mshade.emission.length?this.mshade.emission:[this.mshade.emission[0],
this.mshade.emission[1],this.mshade.emission[2]]);a.setUniforms(d);GLUtil._MaterialBinder.bindTexture(this.mshade.texture,c,a,0,b);GLUtil._MaterialBinder.bindTexture(this.mshade.specularMap,c,a,1,b);GLUtil._MaterialBinder.bindTexture(this.mshade.normalMap,c,a,2,b);return this};
GLUtil._LoadedTexture=function(a,c){this.context=c=GLUtil._toContext(c);this.loadedTexture=c.createTexture();c.activeTexture(c.TEXTURE0);c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,1);c.bindTexture(c.TEXTURE_2D,this.loadedTexture);"src"in a.image?c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a.image):c.texImage2D(c.TEXTURE_2D,0,c.RGBA,a.width,a.height,0,c.RGBA,c.UNSIGNED_BYTE,a.image);GLUtil._isPowerOfTwo(a.width)&&GLUtil._isPowerOfTwo(a.height)?c.generateMipmap(c.TEXTURE_2D):(c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE))};GLUtil._LoadedTexture.prototype.dispose=function(){this.loadedTexture&&this.context.deleteTexture(this.loadedTexture)};
GLUtil._MaterialBinder.bindTexture=function(a,c,b,d,e){if(a){var f=a instanceof FrameBuffer,g=null;if(!f)if("undefined"!==typeof a.image&&null!==a.image||0!==a.loadStatus)g=e.mapTexture(a,c);else{var h=this;a.loadImage().then(function(a){h.bind(b)});return}if(null!=g||f){var k={};0===d&&(k.sampler=d,k.textureSize=[a.width,a.height]);1===d&&(k.specularMap=d);2===d&&(k.normalMap=d);b.setUniforms(k);c.activeTexture(c.TEXTURE0+d);f?(c.bindTexture(c.TEXTURE_2D,a.colorTexture),a.colorTexture&&(c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE))):(c.bindTexture(c.TEXTURE_2D,g.loadedTexture),e._setMaxAnisotropy(c),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),d=c.CLAMP_TO_EDGE,GLUtil._isPowerOfTwo(a.width)&&GLUtil._isPowerOfTwo(a.height)?(a.clamp||(d=c.REPEAT),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,
c.LINEAR_MIPMAP_LINEAR)):c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,d),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,d))}}};GLUtil._LightsBinder=function(a){this.lights=a};GLUtil._LightsBinder.emptyW1=[0,0,0,1];GLUtil._LightsBinder.emptyW0=[0,0,0,0];GLUtil._LightsBinder.emptyAtten=[1,0,0,0];
GLUtil._LightsBinder.prototype.bind=function(a,c){var b=this.lights;if(!b||!a)return this;var d={};d.sceneAmbient=3===b.sceneAmbient.length?b.sceneAmbient:b.sceneAmbient.slice(0,3);for(var e=0;e<b.lights.length;e++){var f=b.lights[e],g="lights["+e+"]";d[g+".diffuse"]=4===f.diffuse.length?f.diffuse:[f.diffuse[0],f.diffuse[1],f.diffuse[2],1];d[g+".specular"]=4===f.specular.length?f.specular:[f.specular[0],f.specular[1],f.specular[2],1];var h=GLMath.mat4transform(c,b.lights[e].position);d[g+".position"]=
h;d[g+".radius"]=[Math.max(0,f.radius*f.radius*f.radius*f.radius),0,0,0]}for(e=b.lights.length;e<Lights.MAX_LIGHTS;e++)g="lights["+e+"]",d[g+".diffuse"]=GLUtil._LightsBinder.emptyW1,d[g+".specular"]=GLUtil._LightsBinder.emptyW1,d[g+".position"]=GLUtil._LightsBinder.emptyW0,d[g+".radius"]=GLUtil._LightsBinder.emptyW0;a.setUniforms(d);return this};var BufferedSubMesh=function(a,c){var b=a instanceof SubMeshBuffer?a:new SubMeshBuffer(a);this.smb=b;this.verts=c.createBuffer();if(!this.verts)throw Error("can't create buffer");this.indices=c.createBuffer();if(!this.indices)throw Error("can't create face buffer");this.arrayObjectExt=c.getExtension("OES_vertex_array_object");this.arrayObjectExtContext=c;this.vao=null;this.arrayObjectExt&&(this.vao=this.arrayObjectExt.createVertexArrayOES());c.bindBuffer(c.ARRAY_BUFFER,this.verts);c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,
this.indices);c.bufferData(c.ARRAY_BUFFER,b.vertices,c.STATIC_DRAW);c.bufferData(c.ELEMENT_ARRAY_BUFFER,b.indices,c.STATIC_DRAW);var d=c.UNSIGNED_SHORT;4===b.indexBufferSize?d=c.UNSIGNED_INT:1===b.indexBufferSize&&(d=c.UNSIGNED_BYTE);this.type=d;this.context=c;this._lastKnownProgram=null;this._attribLocations=[]};BufferedSubMesh.prototype._getVaoExtension=function(a){return this.arrayObjectExtContext==a?this.arrayObjectExt:a.getExtension("OES_vertex_array_object")};
function BufferedMesh(a,c){this.subMeshes=[];this.context=GLUtil._toContext(c);if(a instanceof MeshBuffer){this._bounds=a._bounds;for(var b=0;b<a.subMeshes.length;b++)this.subMeshes.push(new BufferedSubMesh(a.subMeshes[b],this.context))}else for(this._bounds=a.getBoundingBox(),b=0;b<a.subMeshes.length;b++){var d=a.subMeshes[b];0!==d.indices.length&&this.subMeshes.push(new BufferedSubMesh(d,this.context))}}BufferedMesh.prototype._getBounds=function(){return this._bounds};
BufferedMesh.prototype.getContext=function(){return this.context};BufferedMesh.prototype.getFormat=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a|=this.subMeshes[c].smb.format;return a};BufferedMesh.prototype.draw=function(a){for(var c=0;c<this.subMeshes.length;c++)this.subMeshes[c].draw(a)};BufferedMesh.prototype.dispose=function(){for(var a=0;a<this.subMeshes.length;a++)this.subMeshes[a].dispose();this.subMeshes=[]};
BufferedSubMesh.prototype.dispose=function(){null!==this.verts&&this.context.deleteBuffer(this.verts);null!==this.indices&&this.context.deleteBuffer(this.indices);null!==this.vao&&this.arrayObjectExt.deleteVertexArrayOES(this.vao);this._lastKnownProgram=this.vao=this.smb=this.indices=this.verts=null;this._attribLocations=[]};
BufferedSubMesh.prototype._getAttribLocations=function(a,c){if(this._lastKnownProgram!=a){this._lastKnownProgram=a;this._attribLocations=[a.get("position"),a.get("normal"),a.get("colorAttr"),a.get("uv"),a.get("tangent"),a.get("bitangent")];for(var b=0;6>b;b++)null==this._attribLocations[b]&&(this._attribLocations[b]=-1);return!0}return!1};
BufferedSubMesh.prototype._prepareDraw=function(a,c){var b=this._getAttribLocations(a,c),d=this._getVaoExtension(c);this.vao?d.bindVertexArrayOES(this.vao):b=!0;if(b)for(c.bindBuffer(c.ARRAY_BUFFER,this.verts),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,this.indices),b=0;b<this._attribLocations.length;b++)d=this._attribLocations[b],0<=d&&(0<=this.smb._attribsUsed[b]?(c.enableVertexAttribArray(d),c.vertexAttribPointer(d,this.smb._sizes[b],c.FLOAT,!1,4*this.smb._stride,4*this.smb._attribsUsed[b])):c.disableVertexAttribArray(d));
a.setUniforms({useColorAttr:0<=this.smb._attribsUsed[2]?1:0})};BufferedSubMesh.prototype.draw=function(a){var c=a.getContext();if(null===this.verts||null===this.face)throw Error("mesh buffer disposed");if(c!==this.context)throw Error("can't bind mesh: context mismatch");this._prepareDraw(a,c);a=c.TRIANGLES;0!==(this.smb.format&Mesh.LINES_BIT)&&(a=c.LINES);0!==(this.smb.format&Mesh.POINTS_BIT)&&(a=c.POINTS);c.drawElements(a,this.smb.facesLength,this.type,0);c=this._getVaoExtension(c);this.vao&&c.bindVertexArrayOES(null)};
BufferedMesh.prototype.vertexCount=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a+=this.subMeshes[c].smb.numVertices;return a};BufferedMesh.prototype.primitiveCount=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a+=this.subMeshes[c].smb.primitiveCount();return a};BufferedMesh._MeshLoader=function(){this.meshes=[]};
BufferedMesh._MeshLoader.prototype.draw=function(a,c){if(a instanceof BufferedMesh)a.draw(c);else{for(var b=c.getContext(),d=0;d<this.meshes.length;d++){var e=this.meshes[d];if(e[0]==a&&e[1]==b){e[2].draw(c);return}}d=new BufferedMesh(a,c);this.meshes.push([a,b,d]);d.draw(c)}};BufferedMesh._MeshLoader.prototype.dispose=function(){for(var a=0;a<this.meshes.length;a++)this.meshes[a][2].dispose();this.meshes=[]};(function(a){var c=function(a,b,c){if("undefined"===typeof b&&"undefined"===typeof c)this.uoffset=0,this.umul=1;else{if(b===c)throw Error("u1 and u2 can't be equal");this.uoffset=b;this.umul=1/(c-b)}this.evaluator=d.clamped(a,a.length-1)};c.prototype.evaluate=function(a){return this.evaluator.evaluate((a-this.uoffset)*this.umul)};var b=function(a,b,c,d,f){if("undefined"===typeof b&&"undefined"===typeof c&&"undefined"===typeof d&&"undefined"===typeof f)this.uoffset=0,this.umul=1,this.voffset=0,this.vmul=
1;else{if(b===c)throw Error("u1 and u2 can't be equal");if(d===f)throw Error("v1 and v2 can't be equal");this.uoffset=b;this.umul=1/(c-b);this.voffset=d;this.vmul=1/(f-d)}this.evaluator=e.clamped(a,a[0].length-1,a.length-1)};b.prototype.evaluate=function(a,b,c){return this.evaluator.evaluate((a-this.uoffset)*this.umul,(b-this.voffset)*this.vmul)};var d=function(a,b,c){if(0>=a.length)throw Error();if(!b)throw Error();this.bits=c||0;c=b.length-a.length;if(2>c||c>a.length)throw Error();d._checkKnots(b);
this.cplen=a[0].length;c=1;0!==(this.bits&(d.WEIGHTED_BIT|d.DIVIDE_BIT))&&(c=2);0!==(this.bits&d.WEIGHTED_BIT)&&this.cplen--;if(this.cplen<c)throw Error();this.knots=b;this.buffer=[];this.controlPoints=a};d.WEIGHTED_BIT=1;d.DIVIDE_BIT=2;d.HOMOGENEOUS_BIT=4;d.WEIGHTED_DIVIDE_BITS=3;d._checkKnots=function(a){for(var b=1;b<a.length;b++)if(a[b]<a[b-1])throw Error();if(a[0]===a[a.length-1])throw Error();};d._getFactors=function(a,b,c,d,e){for(var f=1,g=0;g<d;g++)e[g]=0;if(b===a[0])e[0]=1;else if(b===a[a.length-
1])e[d-1]=1;else{d=-1;for(g=0;g<=a.length;g++)if(a[g]<=b&&b<a[g+1]){d=g;break}if(!(0>d)){var p=[],f=d-1;p[d]=1;for(var t=2;t<=c;t++,f--){for(g=f;g<=d;g++){var u=0,v=0,y=g<=f?0:p[g],w=g>=d?0:p[g+1];0!==y&&(v=a[g+t-1]-a[g],u+=0===v?0:y*(b-a[g])/v);0!==w&&(y=a[g+t],v=y-a[g+1],u+=0===v?0:w*(y-b)/v);e[g]=u}if(t<c)for(g=f;g<=d;g++)p[g]=e[g]}}}};d.prototype.evaluate=function(a){var b=this.controlPoints.length,c=this.knots.length-b;a=this.knots[c-1]+a*(this.knots[b]-this.knots[c-1]);d._getFactors(this.knots,
a,c,b,this.buffer);a=[];var e,f;if(0!==(this.bits&d.WEIGHTED_BIT)){var g=0;for(e=0;e<b;e++)g+=this.buffer[e]*this.controlPoints[e][this.cplen];for(var r=0!==(this.bits&d.HOMOGENEOUS_BIT),c=0;c<this.cplen+1;c++){for(e=f=0;e<b;e++){var p=this.buffer[e];r||(p*=this.controlPoints[e][this.cplen]);f+=this.controlPoints[e][c]*p}a[c]=f/g}if(0!==(this.bits&d.DIVIDE_BIT)){for(c=0;c<this.cplen;c++)a[c]/=a[this.cplen];a=a.slice(0,this.cplen)}}else{a=[];for(c=0;c<this.cplen;c++){for(e=f=0;e<b;e++)f+=this.controlPoints[e][c]*
this.buffer[e];a[c]=f}if(0!==(this.bits&d.DIVIDE_BIT)){for(c=0;c<this.cplen-1;c++)a[c]/=a[this.cplen-1];a=a.slice(0,this.cplen-1)}}return a};var e=function(a,b,c,e){var f=a.length;if(0>=f)throw Error();var g=a[0].length;if(0>=g)throw Error();var r=a[0][0].length,p=1;this.bits=e||0;0!==(this.bits&(d.WEIGHTED_BIT|d.DIVIDE_BIT))&&(p=2);0!==(this.bits&(d.WEIGHTED_BIT|d.HOMOGENEOUS_BIT))&&r--;if(r<p)throw Error();if(!b||!c)throw Error();this.orderU=b.length-g;this.orderV=c.length-f;this.vcplen=f;this.ucplen=
g;this.cplen=r;if(2>this.orderU||this.orderU>g)throw Error();if(2>this.orderV||this.orderV>f)throw Error();d._checkKnots(b);d._checkKnots(c);this.knotsU=b;this.knotsV=c;this.bufferU=[];this.bufferV=[];this.controlPoints=a};d.clamped=function(a,b,c){return new d(a,d.clampedKnots(a.length,b),c)};d.uniform=function(a,b,c){return new d(a,d.uniformKnots(a.length,b),c)};e.clamped=function(a,b,c,f){return new e(a,d.clampedKnots(a[0].length,b),d.clampedKnots(a.length,c),f)};e.uniform=function(a,b,c,f){return new e(a,
d.uniformKnots(a[0].length,b),d.uniformKnots(a.length,c),f)};d.uniformKnots=function(a,b){"object"===typeof a&&(a=a.length);if(null===b||"undefined"===typeof b)b=3;if(a<b+1)throw Error("too few control points for degree "+b+" curve");for(var c=b+1,d=[],e=0;e<a+c;e++)d.push(e);return d};d.clampedKnots=function(a,b){"object"===typeof a&&(a=a.length);if(null===b||"undefined"===typeof b)b=3;if(a<b+1)throw Error("too few control points for degree "+b+" curve");for(var c=b+1,d=a-c,e=[],f=0;f<c;f++)e.push(0);
for(f=0;f<d;f++)e.push(f+1);for(f=0;f<c;f++)e.push(d+1);return e};e.prototype.evaluate=function(a,b){a=this.knotsU[this.orderU-1]+a*(this.knotsU[this.ucplen]-this.knotsU[this.orderU-1]);b=this.knotsV[this.orderV-1]+b*(this.knotsV[this.vcplen]-this.knotsV[this.orderV-1]);var c=this.bufferU,e=this.bufferV,f,g,r,p,t;d._getFactors(this.knotsU,a,this.orderU,this.ucplen,this.bufferU);d._getFactors(this.knotsV,b,this.orderV,this.vcplen,this.bufferV);var u=[];if(0!==(this.bits&d.WEIGHTED_BIT)){var v=0,y=
0!==(this.bits&d.HOMOGENEOUS_BIT);for(f=0;f<this.ucplen;f++)for(g=0;g<this.vcplen;g++)r=c[f]*e[g]*this.controlPoints[g][f][this.cplen],v+=r;for(p=0;p<this.cplen+1;p++){for(f=v=t=0;f<this.ucplen;f++)for(g=0;g<this.vcplen;g++)r=c[f]*e[g],y||(r*=this.controlPoints[g][f][this.cplen]),t+=this.controlPoints[g][f][p]*r;u[p]=0===v?t:t/v}if(0!==(this.bits&d.DIVIDE_BIT)){for(p=0;p<this.cplen;p++)u[p]/=u[this.cplen];u=u.slice(0,this.cplen)}}else{for(p=0;p<this.cplen;p++){for(f=t=0;f<this.ucplen;f++)for(g=0;g<
this.vcplen;g++)t+=this.controlPoints[g][f][p]*c[f]*e[g];u[p]=t}if(0!==(this.bits&d.DIVIDE_BIT)){for(p=0;p<this.cplen-1;p++)u[p]/=u[this.cplen-1];u=u.slice(0,this.cplen-1)}}return u};var f=function(){this.vertexCurve=this.texCoordCurve=this.normalCurve=this.colorCurve=null};f.prototype.vertex=function(a){this.vertexCurve=a;return this};f.prototype.normal=function(a){this.normalCurve=a;return this};f.prototype.color=function(a){this.colorCurve=a;return this};f.prototype.texCoord=function(a){this.texCoordCurve=
a;return this};f.prototype.evalOne=function(a,b){var c=null,d=null,e=null;this.colorCurve&&(c=this.colorCurve.evaluate(b));this.texCoordCurve&&(e=this.texCoordCurve.evaluate(b),1===e.length&&e.push(0));this.normalCurve&&(d=this.normalCurve.evaluate(b));if(this.vertexCurve){var f=c?a.color.slice(0,3):null,g=d?a.normal.slice(0,3):null,p=e?a.texCoord.slice(0,2):null;c&&a.color3(c[0],c[1],c[2]);d&&a.normal3(d[0],d[1],d[2]);e&&a.texCoord2(e[0],e[1]);c=this.vertexCurve.evaluate(b);2===c.length?a.vertex3(c[0],
c[1],0):a.vertex3(c[0],c[1],c[2]);f&&a.color3(f[0],f[1],f[2]);g&&a.normal3(g[0],g[1],g[2]);p&&a.texCoord2(p[0],p[1])}return this};f.prototype.evalCurve=function(a,b,c,d,e){"undefined"===typeof c&&(c=24);if(0>=c)throw Error("invalid n");"undefined"===typeof d&&"undefined"===typeof e&&(d=0,e=1);if(null===b||"undefined"===typeof b)b=Mesh.LINES;if(b===Mesh.POINTS)a.mode(Mesh.POINTS);else if(b===Mesh.LINES)a.mode(Mesh.LINE_STRIP);else return this;b=(e-d)/c;for(e=0;e<=c;e++)this.evalOne(a,d+e*b);return this};
var g=function(){this.vertexSurface=this.texCoordSurface=this.normalSurface=this.colorSurface=null;this.autoNormal=!1};g.prototype.setAutoNormal=function(a){this.autoNormal=!!a;return this};g.prototype.vertex=function(a){this.vertexSurface=a;return this};g.prototype.normal=function(a){this.normalSurface=a;return this};g.prototype.color=function(a){this.colorSurface=a;return this};g.prototype.texCoord=function(a){this.texCoordSurface=a;return this};g.prototype.evalOne=function(a,b,c){var d=[];this._saveValues(a,
d,0);this._record(b,c,d,8);this._playBack(a,d,8);this._restoreValues(a,d,0);return this};g.prototype._recordAndPlayBack=function(a,b,c,d,e){this._record(b,c,d,e);this._playBack(a,d,e)};g.prototype._saveValues=function(a,b,c){this.colorSurface&&(b[c+3]=a.color[0],b[c+4]=a.color[1],b[c+5]=a.color[2]);if(this.normalSurface||this.autoNormal)b[c+0]=a.normal[0],b[c+1]=a.normal[1],b[c+2]=a.normal[2];this.texCoordSurface&&(b[c+6]=a.texCoord[0],b[c+7]=a.texCoord[1])};g.prototype._restoreValues=function(a,
b,c){this.colorSurface&&a.color3(b[c+3],b[c+4],b[c+5]);(this.normalSurface||this.autoNormal)&&a.normal3(b[c+0],b[c+1],b[c+2]);this.texCoordSurface&&a.texCoord2(b[c+6],b[c+7])};g.prototype._record=function(a,b,c,d){var e=null;this.colorSurface&&(e=this.colorSurface.evaluate(a,b),c[d+6]=e[0],c[d+7]=e[1],c[d+8]=e[2]);this.texCoordSurface&&(e=this.texCoordSurface.evaluate(a,b),c[d+9]=e[0],c[d+10]=1>=e.length?0:e[1]);this.normalSurface&&!this.autoNormal&&(e=this.normalSurface.evaluate(a,b),c[d+3]=e[0],
c[d+4]=e[1],c[d+5]=e[2]);if(this.vertexSurface&&(e=this.vertexSurface.evaluate(a,b),c[d]=e[0],c[d+1]=e[1],c[d+2]=e[2],this.autoNormal)){var f=1E-5,g=1E-5,p=this.vertexSurface.evaluate(a+f,b);0===p[0]&&0===p[1]&&0===p[2]&&(f=-f,p=this.vertexSurface.evaluate(a+f,b));var t=this.vertexSurface.evaluate(a,b+g);0===t[0]&&0===t[1]&&0===t[2]&&(g=-g,t=this.vertexSurface.evaluate(a,b+g));GLMath.vec3subInPlace(t,e);GLMath.vec3subInPlace(p,e);GLMath.vec3scaleInPlace(p,1/f);GLMath.vec3scaleInPlace(t,1/g);GLMath.vec3normInPlace(p);
GLMath.vec3normInPlace(t);0===GLMath.vec3length(p)?p=t:0!==GLMath.vec3length(t)?(p=GLMath.vec3cross(p,t),GLMath.vec3normInPlace(p)):p[2]===e[2]&&(p=[0,0,1]);c[d+3]=p[0];c[d+4]=p[1];c[d+5]=p[2]}};g.prototype._playBack=function(a,b,c){this.vertexSurface&&(this.colorSurface&&a.color3(b[c+6],b[c+7],b[c+8]),(this.normalSurface||this.autoNormal)&&a.normal3(b[c+3],b[c+4],b[c+5]),this.texCoordSurface&&a.texCoord2(b[c+9],b[c+10]),a.vertex3(b[c+0],b[c+1],b[c+2]))};g.prototype.evalSurface=function(a,b,c,d,e,
f,g,p){"undefined"===typeof c&&(c=24);"undefined"===typeof d&&(d=24);if(0>=c)throw Error("invalid un");if(0>=d)throw Error("invalid vn");if(null===b||"undefined"===typeof b)b=Mesh.TRIANGLES;"undefined"===typeof g&&"undefined"===typeof p&&(g=0,p=1);"undefined"===typeof e&&"undefined"===typeof f&&(e=0,f=1);f=(f-e)/c;p=(p-g)/d;var t,u,v;if(b===Mesh.TRIANGLES){var y=[],w=[];this._saveValues(a,y,0);for(b=0;b<d;b++)for(a.mode(Mesh.TRIANGLE_STRIP),v=t=0;t<=c;t++,v+=11)u=t*f+e,0===b?this._recordAndPlayBack(a,
u,b*p+g,y,8):this._playBack(a,w,v),b===d-1?this._recordAndPlayBack(a,u,(b+1)*p+g,y,8):this._recordAndPlayBack(a,u,(b+1)*p+g,w,v);this._restoreValues(a,y,0)}else if(b===Mesh.POINTS)for(a.mode(Mesh.POINTS),b=0;b<=d;b++)for(t=0;t<=c;t++)u=t*f+e,this.evalOne(a,u,b*p+g);else if(b===Mesh.LINES){for(b=0;b<=d;b++)for(a.mode(Mesh.LINE_STRIP),t=0;t<=c;t++)u=t*f+e,this.evalOne(a,u,b*p+g);for(b=0;b<=c;b++)for(a.mode(Mesh.LINE_STRIP),t=0;t<=d;t++)this.evalOne(a,b*f+e,t*p+g)}return this};a.SurfaceEval=g;a.CurveEval=
f;a.BezierCurve=c;a.BezierSurface=b;a.BSplineCurve=d;a.BSplineSurface=e})(this);function FrameBuffer(a,c,b){if(0>c||0>b)throw Error("width or height negative");this.context=a=a.getContext?a.getContext():a;this.textureUnit=3;this._init(a,c,b)}
FrameBuffer.prototype._init=function(a,c,b){this.buffer=a.createFramebuffer();this.colorTexture=a.createTexture();this.width=Math.ceil(c);this.height=Math.ceil(b);this.context.activeTexture(this.context.TEXTURE0+this.textureUnit);this.context.bindTexture(this.context.TEXTURE_2D,this.colorTexture);this.context.pixelStorei(this.context.UNPACK_FLIP_Y_WEBGL,1);this.context.texImage2D(this.context.TEXTURE_2D,0,this.context.RGBA,this.width,this.height,0,this.context.RGBA,this.context.UNSIGNED_BYTE,null);
this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MAG_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_MIN_FILTER,this.context.NEAREST);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_S,this.context.CLAMP_TO_EDGE);this.context.texParameteri(this.context.TEXTURE_2D,this.context.TEXTURE_WRAP_T,this.context.CLAMP_TO_EDGE);this.depthbuffer=this.context.createRenderbuffer();c=this.context.getParameter(a.FRAMEBUFFER_BINDING);
this.context.bindFramebuffer(a.FRAMEBUFFER,this.buffer);this.context.bindRenderbuffer(a.RENDERBUFFER,this.depthbuffer);this.context.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.width,this.height);this.context.bindFramebuffer(a.FRAMEBUFFER,c)};FrameBuffer.prototype.resize=function(a,c){a=Math.ceil(a);c=Math.ceil(c);if(a!=this.width||c!=this.height)this.dispose(),this._init(this.context,a,c);return this};FrameBuffer.prototype.getContext=function(){return this.context};
FrameBuffer.prototype.bind=function(){this.context.activeTexture(this.context.TEXTURE0+this.textureUnit);this.context.bindFramebuffer(this.context.FRAMEBUFFER,this.buffer);this.context.framebufferTexture2D(this.context.FRAMEBUFFER,this.context.COLOR_ATTACHMENT0,this.context.TEXTURE_2D,this.colorTexture,0);this.context.framebufferRenderbuffer(this.context.FRAMEBUFFER,this.context.DEPTH_ATTACHMENT,this.context.RENDERBUFFER,this.depthbuffer);return this};
FrameBuffer.prototype.unbind=function(){this.context.framebufferTexture2D(this.context.FRAMEBUFFER,this.context.COLOR_ATTACHMENT0,this.context.TEXTURE_2D,null,0);this.context.framebufferRenderbuffer(this.context.FRAMEBUFFER,this.context.DEPTH_ATTACHMENT,this.context.RENDERBUFFER,null);this.context.bindFramebuffer(this.context.FRAMEBUFFER,null)};
FrameBuffer.prototype.dispose=function(){null!==this.buffer&&(this.context.getParameter(this.context.FRAMEBUFFER_BINDING)==this.buffer&&this.unbind(),this.context.deleteFramebuffer(this.buffer));null!==this.depthbuffer&&this.context.deleteRenderbuffer(this.depthbuffer);null!==this.colorTexture&&this.context.deleteTexture(this.colorTexture);this.colorTexture=this.depthbuffer=this.buffer=null};function Lights(){this.lights=[];this.sceneAmbient=[.2,.2,.2]}Lights.prototype.setDefaults=function(){this.lights=[(new LightSource).setParams({ambient:[0,0,0,1],position:[0,0,1,0],diffuse:[1,1,1,1],specular:[1,1,1],radius:0})];this.sceneAmbient=[.2,.2,.2]};Lights.MAX_LIGHTS=3;Lights._createNewLight=function(a){var c=new LightSource;0!==a&&(c.diffuse=[0,0,0,0],c.specular=[0,0,0]);return c};Lights.prototype.getCount=function(){return this.lights.length};
Lights.prototype.getLight=function(a){var c=this.lights.length;this.lights[a]||(this.lights[a]=Lights._createNewLight(a));if(2<=this.lights.length-c)for(;c<this.lights.length;c++)this.lights[c]||(this.lights[c]=Lights._createNewLight(c));return this.lights[a]};Lights.prototype.setParams=function(a,c){this.getLight(a).setParams(c);return this};
Lights.prototype.setDirectionalLight=function(a,c,b,d){c=this.setParams(a,{position:[c[0],c[1],c[2],0]});null!=b&&(c=c.setParams(a,{diffuse:b}));null!=d&&(c=c.setParams(a,{specular:d}));return c};Lights.prototype.setPointLight=function(a,c,b,d){c=this.setParams(a,{position:[c[0],c[1],c[2],1]});null!=b&&(c=c.setParams(a,{diffuse:b}));null!=d&&(c=c.setParams(a,{specular:d}));return c};Lights.prototype.setAmbient=function(a,c,b,d){this.sceneAmbient=GLUtil.toGLColor(a,c,b,d);return this};function LightSource(a,c,b,d){this.ambient=c||[0,0,0,1];this.position=a?[a[0],a[1],a[2],1]:[0,0,1,0];this.diffuse=b||[1,1,1,1];this.specular=d||[1,1,1];this.radius=0}
LightSource.prototype.setParams=function(a){"undefined"!==typeof a.ambient&&"undefined"!==typeof a.ambient&&"undefined"!==typeof a.ambient&&null!==a.ambient&&(this.ambient=GLUtil.toGLColor(a.ambient),this.ambient=this.ambient.slice(0,4));if("undefined"!==typeof a.position&&"undefined"!==typeof a.position&&"undefined"!==typeof a.position&&null!==a.position){var c=a.position;this.position=[c[0],c[1],c[2],null===c[3]?0:c[3]]}"undefined"!==typeof a.specular&&"undefined"!==typeof a.specular&&"undefined"!==
typeof a.specular&&null!==a.specular&&(this.specular=GLUtil.toGLColor(a.specular));"undefined"!==typeof a.diffuse&&"undefined"!==typeof a.diffuse&&"undefined"!==typeof a.diffuse&&null!==a.diffuse&&(this.diffuse=GLUtil.toGLColor(a.diffuse));"undefined"!=typeof a.radius&&(this.radius=a.radius);return this};function Material(a,c,b,d,e){null!==a&&"undefined"!==typeof a&&(a=GLUtil.toGLColor(a));null!==c&&"undefined"!==typeof c&&(c=GLUtil.toGLColor(c));null!==b&&"undefined"!==typeof b&&(b=GLUtil.toGLColor(b));null!==e&&"undefined"!==typeof e&&(e=GLUtil.toGLColor(e));this.shininess=null===d||"undefined"===typeof d?0:Math.min(Math.max(0,d),128);this.ambient=a?a.slice(0,3):[.2,.2,.2];this.diffuse=c?c.slice(0,c.length):[.8,.8,.8,1];this.specular=b?b.slice(0,3):[0,0,0];this.emission=e?e.slice(0,3):[0,0,0];this.normalMap=
this.specularMap=this.texture=null;this.basic=!1;this.shader=null}Material.prototype.copy=function(){return(new Material(this.ambient.slice(0,this.ambient.length),this.diffuse.slice(0,this.diffuse.length),this.specular.slice(0,this.specular.length),this.shininess,this.emission.slice(0,this.emission.length))).setParams({texture:this.texture,specularMap:this.specularMap,normalMap:this.normalMap,basic:this.basic,shader:this.shader})};
Material.prototype.setParams=function(a){var c;"undefined"!==typeof a.ambient&&null!==a.ambient&&(this.ambient=GLUtil.toGLColor(a.ambient),3<this.ambient.length&&(this.ambient=this.ambient.slice(0,3)));"undefined"!==typeof a.diffuse&&null!==a.diffuse&&(this.diffuse=GLUtil.toGLColor(a.diffuse),4<this.diffuse.length&&(this.diffuse=this.diffuse.slice(0,4)));"undefined"!==typeof a.specular&&null!==a.specular&&(this.specular=GLUtil.toGLColor(a.specular),3<this.specular.length&&(this.specular=this.specular.slice(0,
3)));"undefined"!==typeof a.emission&&null!==a.emission&&(this.emission=GLUtil.toGLColor(a.emission),3<this.emission.length&&(this.emission=this.emission.slice(0,3)));"undefined"!==typeof a.shininess&&null!==a.shininess&&(this.shininess=a.shininess);"undefined"!==typeof a.texture&&null!==a.texture&&(c=a.texture,this.texture="string"===typeof c?new Texture(c):c);"undefined"!==typeof a.specularMap&&null!==a.specularMap&&(c=a.specularMap,this.specularMap="string"===typeof c?new Texture(c):c);"undefined"!==
typeof a.normalMap&&null!==a.normalMap&&(c=a.normalMap,this.normalMap="string"===typeof c?new Texture(c):c);"undefined"!=typeof a.basic&&null!==a.basic&&(this.basic=a.basic);"undefined"!=typeof a.shader&&null!==a.shader&&(this.shader=a.shader);return this};Material.fromColor=function(a,c,b,d){a=GLUtil.toGLColor(a,c,b,d);return new Material(a,a)};Material.fromTexture=function(a){return(new Material).setParams({texture:a})};Material.forShader=function(a){return(new Material).setParams({shader:a})};var SubMesh=function(a,c,b){this._initialize(a,c,b)};function Mesh(a,c,b){this.subMeshes=null!==a&&"undefined"!==typeof a?[new SubMesh(a,c,b)]:[];this._elementsDefined=0;this.currentMode=-1;this.normal=[0,0,0];this.color=[0,0,0];this.tangent=[0,0,0];this.bitangent=[0,0,0];this.texCoord=[0,0]}Mesh._primitiveType=function(a){return a===Mesh.LINES||a===Mesh.LINE_STRIP?Mesh.LINES:a===Mesh.POINTS?Mesh.POINTS:Mesh.TRIANGLES};
Mesh._isCompatibleMode=function(a,c){return a===c||Mesh._primitiveType(a)===Mesh._primitiveType(c)?!0:!1};Mesh._recalcNormalsStart=function(a,c,b,d,e,f){for(b=0;b<a.length;b+=d)if(a[b+e]=0,a[b+e+1]=0,a[b+e+2]=0,!f){var g=[a[b],a[b+1],a[b+2]];c[g]?c[g].push(b+e):c[g]=[b+e]}};
Mesh._recalcNormalsFinish=function(a,c,b,d,e,f){b=[];var g=0;if(!f)for(var h in c){var k=c[h];if(k&&k.constructor===Array&&2<=k.length){f=k[0];var l=a[f],m=a[f+1],n=a[f+2];b[0]=l;b[1]=m;b[2]=n;g=3;for(f=1;f<k.length;f++){for(var q=!1,r=a[k[f]],p=a[k[f]+1],t=a[k[f]+2],u=0;u<g;u+=3)if(r===b[u]&&p===b[u+1]&&t===b[u+2]){q=!0;break}q||(b[g++]=r,b[g++]=p,b[g++]=t,l+=r,m+=p,n+=t)}for(f=0;f<k.length;f++)a[k[f]]=l,a[k[f]+1]=m,a[k[f]+2]=n}}for(f=0;f<a.length;f+=d)if(h=a[f+e],b=a[f+e+1],g=a[f+e+2],c=Math.sqrt(h*
h+b*b+g*g))c=1/c,a[f+e]=h*c,a[f+e+1]=b*c,a[f+e+2]=g*c};
Mesh._recalcNormals=function(a,c,b,d,e,f){f=f?-1:1;var g={},h;Mesh._recalcNormalsStart(a,g,c,b,d,e);for(var k=0;k<c.length;k+=3){var l=c[k]*b,m=c[k+1]*b,n=c[k+2]*b;h=[a[l]-a[n],a[l+1]-a[n+1],a[l+2]-a[n+2]];var q=[a[m]-a[n],a[m+1]-a[n+1],a[m+2]-a[n+2]],r=h[1]*q[2]-h[2]*q[1],p=h[2]*q[0]-h[0]*q[2],q=h[0]*q[1]-h[1]*q[0];h=Math.sqrt(r*r+p*p+q*q);0!==h&&(h=1/h,h*=f,r*=h,p*=h,q*=h,a[l+d]+=r,a[l+d+1]+=p,a[l+d+2]+=q,a[m+d]+=r,a[m+d+1]+=p,a[m+d+2]+=q,a[n+d]+=r,a[n+d+1]+=p,a[n+d+2]+=q)}Mesh._recalcNormalsFinish(a,
g,c,b,d,e)};Mesh.prototype.mode=function(a){if(0>a)throw Error("invalid mode");if(-1!==this.currentMode&&Mesh._isCompatibleMode(this.currentMode,a))this.subMeshes[this.subMeshes.length-1].newPrimitive();else{var c=0,b=Mesh._primitiveType(a);b===Mesh.LINES?c|=Mesh.LINES_BIT:b===Mesh.POINTS&&(c|=Mesh.POINTS_BIT);this.subMeshes.push(new SubMesh([],[],c))}this.currentMode=a;return this};
Mesh.prototype.merge=function(a){for(var c=this.subMeshes[this.subMeshes.length-1],b=c?c.attributeBits&Mesh.PRIMITIVES_BITS:0,d=0;d<a.subMeshes.length;d++){var e=a.subMeshes[d];if(0!==e.indices.length)if(!c||(e.attributeBits&Mesh.PRIMITIVES_BITS)!==b||196605<c.vertices.length+e.vertices.length||c.attributeBits!==e.attributeBits)c=new SubMesh(e.vertices.slice(0,e.vertices.length),e.indices.slice(0,e.indices.length),e.attributeBits),this.subMeshes.push(c),b=c.attributeBits&Mesh.PRIMITIVES_BITS;else{var f=
c.vertexCount(),d=c.indices.length;c.vertices.push.apply(c.vertices,e.vertices);for(c.indices.push.apply(c.indices,e.indices);d<c.indices.length;d++)c.indices[d]+=f}}c.newPrimitive();return this};Mesh.prototype.normal3=function(a,c,b){"number"===typeof a&&"number"===typeof c&&"number"===typeof b?(this.normal[0]=a,this.normal[1]=c,this.normal[2]=b):(this.normal[0]=a[0],this.normal[1]=a[1],this.normal[2]=a[2]);this._elementsDefined|=Mesh.NORMALS_BIT;return this};
Mesh.prototype.tangent3=function(a,c,b){"number"===typeof a&&"number"===typeof c&&"number"===typeof b?(this.tangent[0]=a,this.tangent[1]=c,this.tangent[2]=b):(this.tangent[0]=a[0],this.tangent[1]=a[1],this.tangent[2]=a[2]);this._elementsDefined|=Mesh.TANGENTS_BIT;return this};
Mesh.prototype.bitangent3=function(a,c,b){"number"===typeof a&&"number"===typeof c&&"number"===typeof b?(this.bitangent[0]=a,this.bitangent[1]=c,this.bitangent[2]=b):(this.bitangent[0]=a[0],this.bitangent[1]=a[1],this.bitangent[2]=a[2]);this._elementsDefined|=Mesh.BITANGENTS_BIT;return this};Mesh.prototype.transform=function(a){for(var c=0;c<this.subMeshes.length;c++)this.subMeshes[c].transform(a);return this};
Mesh.prototype.color3=function(a,c,b){"string"===typeof a?(a=GLUtil.toGLColor(a),this.color[0]=a[0],this.color[1]=a[1],this.color[2]=a[2]):"number"===typeof a&&"number"===typeof c&&"number"===typeof b?(this.color[0]=a,this.color[1]=c,this.color[2]=b):(this.color[0]=a[0],this.color[1]=a[1],this.color[2]=a[2]);this._elementsDefined|=Mesh.COLORS_BIT;return this};
Mesh.prototype.texCoord2=function(a,c){"number"===typeof a&&"number"===typeof c?(this.texCoord[0]=a,this.texCoord[1]=c):(this.texCoord[0]=a[0],this.texCoord[1]=a[1]);this._elementsDefined|=Mesh.TEXCOORDS_BIT;return this};
Mesh.prototype.vertex3=function(a,c,b){0===this.subMeshes.length&&this.subMeshes.push(new SubMesh);var d=this.subMeshes[this.subMeshes.length-1];null===a||"undefined"===typeof a||null!==c&&"undefined"!==typeof c||null!==b&&"undefined"!==typeof b?d.vertex3(a,c,b,this):"number"!==typeof a?d.vertex3(a[0],a[1],a[2],this):d.vertex3(a,a,a,this);return this};
Mesh.prototype.vertex2=function(a,c){return null===a||"undefined"===typeof a||null!==c&&"undefined"!==typeof c?this.vertex3(a,c,0):"number"!==typeof a?this.vertex3(a[0],a[1],0):this.vertex3(a,a,0)};Mesh.prototype.setColor3=function(a,c,b){var d=a;"string"===typeof a&&(a=GLUtil.toGLColor(a),d=a[0],c=a[1],b=a[2]);for(a=0;a<this.subMeshes.length;a++)this.subMeshes[a].setColor3(d,c,b);return this};
Mesh.prototype.recalcTangents=function(){for(var a=0;a<this.subMeshes.length;a++)this.subMeshes[a].primitiveType()===Mesh.TRIANGLES&&this.subMeshes[a].recalcTangents();return this};Mesh.prototype.recalcNormals=function(a,c){for(var b=0;b<this.subMeshes.length;b++){var d=this.subMeshes[b].primitiveType();d!==Mesh.POINTS&&d!==Mesh.LINES&&this.subMeshes[b].recalcNormals(a,c)}return this};
Mesh.prototype.normalizeNormals=function(){for(var a=0;a<this.subMeshes.length;a++){var c=this.subMeshes[a].getStride(),b=this.subMeshes[a].vertices,d=Mesh._normalOffset(this.subMeshes[a].attributeBits);if(!(0>d))for(a=0;a<b.length;a+=c){var e=b[a+d],f=b[a+d+1],g=b[a+d+2],e=Math.sqrt(e*e+f*f+g*g);0!==e&&(e=1/e,b[a+d]*=e,b[a+d+1]*=e,b[a+d+2]*=e)}}return this};Mesh.prototype.toWireFrame=function(){for(var a=new Mesh,c=0;c<this.subMeshes.length;c++)a.subMeshes.push(this.subMeshes[c].toWireFrame());return a};
Mesh.prototype.setVertex=function(a,c,b,d){if(0>a)return this;"undefined"===typeof b&&"undefined"===typeof d&&(b=c[1],d=c[2],c=c[0]);for(var e=0,f=0;f<this.subMeshes.length;f++){var g=this.subMeshes[f],h=g.vertexCount(),h=e+h;if(a<h){a-=e;a*=g.getStride();g.vertices[a]=c;g.vertices[a+1]=b;g.vertices[a+2]=d;break}e=h}return this};
Mesh.prototype.setVertexNormal=function(a,c,b,d){if(0>a)return this;var e=0;"undefined"===typeof b&&"undefined"===typeof d&&(b=c[1],d=c[2],c=c[0]);for(var f=0;f<this.subMeshes.length;f++){var g=this.subMeshes[f],h=g.vertexCount(),h=e+h;if(a<h){a-=e;g._rebuildVertices(Mesh.NORMALS_BIT);a*=g.getStride();a+=Mesh._normalOffset(g.attributeBits);g.vertices[a]=c;g.vertices[a+1]=b;g.vertices[a+2]=d;break}e=h}return this};
Mesh.prototype.getVertex=function(a){if(0>a)return null;for(var c=0,b=0;b<this.subMeshes.length;b++){var d=this.subMeshes[b],e=d.vertexCount(),e=c+e;if(a<e)return a-=c,a*=d.getStride(),d.vertices.slice(a,a+3);c=e}return null};
Mesh.prototype.getVertexNormal=function(a){for(var c=0,b=0;b<this.subMeshes.length;b++){var d=this.subMeshes[b],e=d.vertexCount(),e=c+e;if(a<e)return 0!==(d.attributeBits&Mesh.NORMALS_BIT)?(a-=c,a*=d.getStride(),a+=Mesh._normalOffset(d.attributeBits),d.vertices.slice(a,a+3)):[0,0,0];c=e}return null};Mesh.prototype.vertexCount=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a+=this.subMeshes[c].vertexCount();return a};
Mesh.prototype.primitiveCount=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a+=this.subMeshes[c].primitiveCount();return a};
SubMesh.prototype._initialize=function(a,c,b){this.vertices=a||[];this.indices=c||[];this.startIndex=0;a=b&Mesh.PRIMITIVES_BITS;if(0!==a&&a!==Mesh.LINES_BIT&&a!==Mesh.POINTS_BIT)throw Error("invalid format");this.attributeBits=null===b||"undefined"===typeof b?0:b;this.vertexCount=function(){return this.vertices.length/this.getStride()};this.getStride=function(){return Mesh._getStride(this.attributeBits)};this.newPrimitive=function(a){this.startIndex=this.vertices.length;return this};this.primitiveType=
function(){var a=Mesh.TRIANGLES;0!==(this.attributeBits&Mesh.LINES_BIT)&&(a=Mesh.LINES);0!==(this.attributeBits&Mesh.POINTS_BIT)&&(a=Mesh.POINTS);return a};this._rebuildVertices=function(a){var b=this.attributeBits;a=b|a&Mesh.ATTRIBUTES_BITS;if(a!==b){for(var c=this.getStride(),g,h,k,l=[],m=0;m<this.vertices.length;m+=c){var n=m+3;l.push(this.vertices[m],this.vertices[m+1],this.vertices[m+2]);0!==(a&Mesh.NORMALS_BIT)&&(0!==(b&Mesh.NORMALS_BIT)?(g=this.vertices[n],h=this.vertices[n+1],k=this.vertices[n+
2],n+=3,l.push(g,h,k)):l.push(0,0,0));0!==(a&Mesh.COLORS_BIT)&&(0!==(b&Mesh.COLORS_BIT)?(g=this.vertices[n],h=this.vertices[n+1],k=this.vertices[n+2],n+=3,l.push(g,h,k)):l.push(0,0,0));0!==(a&Mesh.TEXCOORDS_BIT)&&(0!==(b&Mesh.TEXCOORDS_BIT)?(g=this.vertices[n],h=this.vertices[n+1],n+=2,l.push(g,h)):l.push(0,0));0!==(a&Mesh.TANGENTS_BIT)&&(0!==(b&Mesh.TANGENTS_BIT)?(g=this.vertices[n],h=this.vertices[n+1],k=this.vertices[n+2],n+=3,l.push(g,h,k)):l.push(0,0,0));0!==(a&Mesh.BITANGENTS_BIT)&&(0!==(b&
Mesh.BITANGENTS_BIT)?(g=this.vertices[n],h=this.vertices[n+1],k=this.vertices[n+2],l.push(g,h,k)):l.push(0,0,0))}this.vertices=l;this.attributeBits=a}};this._setTriangle=function(a,b,c,g,h){var k=c*b,l=g*b,m=h*b,n=0,q=this.vertices;for(a-=b;0<=a&&16>n;a-=b,n++){for(var r=7,p=0;p<b&&0!==r;p++)0!==(r&1)&&q[k+p]!==q[a+p]&&(r&=-2),0!==(r&2)&&q[l+p]!==q[a+p]&&(r&=-3),0!==(r&4)&&q[m+p]!==q[a+p]&&(r&=-5);if(0!==(r&1)){c=a/b;k=c*b;break}if(0!==(r&2)){g=a/b;l=g*b;break}if(0!==(r&4)){h=a/b;m=h*b;break}}q[k]===
q[l]&&q[k+1]===q[l+1]&&q[k+2]===q[l+2]||q[k]===q[m]&&q[k+1]===q[m+1]&&q[k+2]===q[m+2]||q[l]===q[m]&&q[l+1]===q[m+1]&&q[l+2]===q[m+2]||this.indices.push(c,g,h)};this.vertex3=function(a,b,c,g){var h=g.currentMode;if(-1===h)throw Error("mode() not called");this._rebuildVertices(g._elementsDefined);var k=this.vertices.length;this.vertices.push(a,b,c);0!==(this.attributeBits&Mesh.NORMALS_BIT)&&this.vertices.push(g.normal[0],g.normal[1],g.normal[2]);0!==(this.attributeBits&Mesh.COLORS_BIT)&&this.vertices.push(g.color[0],
g.color[1],g.color[2]);0!==(this.attributeBits&Mesh.TEXCOORDS_BIT)&&this.vertices.push(g.texCoord[0],g.texCoord[1]);0!==(this.attributeBits&Mesh.TANGENTS_BIT)&&this.vertices.push(g.tangent[0],g.tangent[1],g.tangent[2]);0!==(this.attributeBits&Mesh.BITANGENTS_BIT)&&this.vertices.push(g.bitangent[0],g.bitangent[1],g.bitangent[2]);a=this.getStride();h===Mesh.QUAD_STRIP&&this.vertices.length-this.startIndex>=4*a&&0===(this.vertices.length-this.startIndex)%(2*a)?(h=this.vertices.length/a-4,this._setTriangle(k,
a,h,h+1,h+2),this._setTriangle(k,a,h+2,h+1,h+3)):h===Mesh.QUADS&&0===(this.vertices.length-this.startIndex)%(4*a)?(h=this.vertices.length/a-4,this._setTriangle(k,a,h,h+1,h+2),this._setTriangle(k,a,h,h+2,h+3)):h===Mesh.TRIANGLES&&0===(this.vertices.length-this.startIndex)%(3*a)?(h=this.vertices.length/a-3,this._setTriangle(k,a,h,h+1,h+2)):h===Mesh.LINES&&0===(this.vertices.length-this.startIndex)%(2*a)?(h=this.vertices.length/a-2,this.indices.push(h,h+1)):h===Mesh.TRIANGLE_FAN&&this.vertices.length-
this.startIndex>=3*a?(h=this.vertices.length/a-2,b=this.startIndex/a,this._setTriangle(k,a,b,h,h+1)):h===Mesh.LINE_STRIP&&this.vertices.length-this.startIndex>=2*a?(h=this.vertices.length/a-2,this.indices.push(h,h+1)):h===Mesh.POINTS?(h=this.vertices.length/a-1,this.indices.push(h)):h===Mesh.TRIANGLE_STRIP&&this.vertices.length-this.startIndex>=3*a&&(h=this.vertices.length/a-3,b=this.startIndex/a,0===(h-b&1)?this._setTriangle(k,a,h,h+1,h+2):this._setTriangle(k,a,h+1,h,h+2));return this}};
SubMesh.prototype.makeRedundant=function(){for(var a=[],c=this.getStride(),b=this.indices.length,d=0;d<b;d++){var e=this.indices[d];if(a[e]){for(var f=e*c,g=this.vertices.length/c,h=0;h<c;h++)this.vertices.push(this.vertices[f+h]);this.indices[d]=g}a[e]=!0}return this};SubMesh.prototype.primitiveCount=function(){return 0!==(this.attributeBits&Mesh.LINES_BIT)?Math.floor(this.indices.length/2):0!==(this.attributeBits&Mesh.POINTS_BIT)?this.indices.length:Math.floor(this.indices.length/3)};
SubMesh.prototype.toWireFrame=function(){function a(a,b,c,d){if(c<d){var e=c;c=d;d=e}(e=b[c])?0>e.indexOf(d)&&(e.push(d),a.push(c,d)):(b[c]=[d],a.push(c,d))}if(0!==(this.attributeBits&Mesh.PRIMITIVES_BITS))return this;for(var c=[],b={},d=0;d<this.indices.length;d+=3){var e=this.indices[d],f=this.indices[d+1],g=this.indices[d+2];a(c,b,e,f);a(c,b,f,g);a(c,b,g,e)}return new SubMesh(this.vertices,c,this.attributeBits|Mesh.LINES_BIT)};
SubMesh._isIdentityInUpperLeft=function(a){return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[8]&&0===a[9]&&1===a[10]?!0:!1};
SubMesh.prototype.transform=function(a){var c=this.getStride(),b=this.vertices,d=!SubMesh._isIdentityInUpperLeft(a),e=Mesh._normalOffset(this.attributeBits),f=null;0<=e&&d&&(f=GLMath.mat4inverseTranspose3(a));for(var g=0;g<b.length;g+=c){var h=GLMath.mat4transform(a,b[g],b[g+1],b[g+2],1);b[g]=h[0];b[g+1]=h[1];b[g+2]=h[2];0<=e&&d&&(h=GLMath.mat3transform(f,b[g+e],b[g+e+1],b[g+e+2]),GLMath.vec3normInPlace(h),b[g+e]=h[0],b[g+e+1]=h[1],b[g+e+2]=h[2])}this.newPrimitive();return this};
Mesh.prototype.reverseWinding=function(){for(var a=0;a<this.subMeshes.length;a++)this.subMeshes[a].reverseWinding();return this};
Mesh.prototype.enumPrimitives=function(a){for(var c=0;c<this.subMeshes.length;c++){var b=this.subMeshes[c],d=b.primitiveType(),e=Mesh._normalOffset(b.attributeBits),f=Mesh._colorOffset(b.attributeBits),g=Mesh._texCoordOffset(b.attributeBits),h=b.getStride(),k=b.vertices,l=3;d===Mesh.LINES&&(l=2);d===Mesh.POINTS&&(l=1);for(d=0;d<b.indices.length;d+=l){for(var m=[],n=0;n<l;n++){var q=b.indices[d+n]*h,r={};r.position=[k[q],k[q+1],k[q+2]];0<=e&&(r.normal=[k[q+e],k[q+e+1],k[q+e+2]]);0<=f&&(r.color=[k[q+
f],k[q+f+1],k[q+f+2]]);0<=g&&(r.uv=[k[q+g],k[q+g+1]]);m.push(r)}a(m)}}return this};
Mesh.prototype.getBoundingBox=function(){for(var a=!0,c=Number.POSITIVE_INFINITY,c=[c,c,c,-c,-c,-c],b=0;b<this.subMeshes.length;b++)for(var d=this.subMeshes[b],e=d.getStride(),f=d.vertices,g=0;g<d.indices.length;g++){var h=d.indices[g]*e;a?(a=!1,c[0]=c[3]=f[h],c[1]=c[4]=f[h+1],c[2]=c[5]=f[h+2]):(c[0]=Math.min(c[0],f[h]),c[3]=Math.max(c[3],f[h]),c[1]=Math.min(c[1],f[h+1]),c[4]=Math.max(c[4],f[h+1]),c[2]=Math.min(c[2],f[h+2]),c[5]=Math.max(c[5],f[h+2]))}return c};
Mesh._findTangentAndBitangent=function(a,c,b,d,e){var f=a[b]-a[c],g=a[b+1]-a[c+1],h=a[b+2]-a[c+2],k=a[d]-a[c],l=a[d+1]-a[c+1],m=a[d+2]-a[c+2],n=a[b+e]-a[c+e],q=a[b+e+1]-a[c+e+1];b=a[d+e]-a[c+e];a=a[d+e+1]-a[c+e+1];c=n*a-q*b;if(0===c)return[0,0,0,0,0,0];c=1/c;q=-q;b=-b;return[(a*f+q*k)*c,(a*g+q*l)*c,(a*h+q*m)*c,(b*f+n*k)*c,(b*g+n*l)*c,(b*h+n*m)*c]};
Mesh._recalcTangentsInternal=function(a,c,b,d,e,f){for(var g=[0,0,0],h=0;h<c.length;h+=3){g[0]=c[h]*b;g[1]=c[h+1]*b;g[2]=c[h+2]*b;for(var k=Mesh._findTangentAndBitangent(a,g[0],g[1],g[2],d),l=0;3>l;l++){var m=k,n=g[l],q=a[n+e],r=a[n+e+1],p=a[n+e+2],t=m[0]*q+m[1]*r+m[2]*p,t=GLMath.vec3normInPlace([m[0]-t*q,m[1]-t*r,m[2]-t*p]),u=m[3]*q+m[4]*r+m[5]*p,v=m[3]*t[0]+m[4]*t[1]+m[5]*t[2],m=GLMath.vec3normInPlace([m[3]-u*q-v*t[0],m[4]-u*r-v*t[1],m[5]-u*p-v*t[2]]);a[n+f]=t[0];a[n+f+1]=t[1];a[n+f+2]=t[2];a[n+
f+3]=m[0];a[n+f+4]=m[1];a[n+f+5]=m[2]}}};SubMesh.prototype.recalcTangents=function(){var a=Mesh.TANGENTS_BIT|Mesh.BITANGENTS_BIT,c=0!==(this.attributeBits&Mesh.ATTRIBUTES_BITS&~a),b=Mesh._texCoordOffset(this.attributeBits),d=Mesh._normalOffset(this.attributeBits);if(0>b||0>d)return this;this._rebuildVertices(a);c&&this.makeRedundant();this.primitiveType()===Mesh.TRIANGLES&&(a=Mesh._tangentOffset(this.attributeBits),Mesh._recalcTangentsInternal(this.vertices,this.indices,this.getStride(),b,d,a));return this};
Mesh.prototype.reverseNormals=function(){for(var a=0;a<this.subMeshes.length;a++){var c=this.subMeshes[a].getStride(),b=this.subMeshes[a].vertices,d=Mesh._normalOffset(this.subMeshes[a].attributeBits);if(!(0>d))for(a=0;a<b.length;a+=c){var e=b[a+d+1],f=b[a+d+2];b[a+d]=-b[a+d];b[a+d+1]=-e;b[a+d+2]=-f}}return this};
SubMesh.prototype.reverseWinding=function(){if(0!==(this.attributeBits&Mesh.PRIMITIVES_BITS))return this;for(var a=0;a<this.indices.length;a+=3){var c=this.indices[a+2];this.indices[a+2]=this.indices[a+1];this.indices[a+1]=c}return this};
SubMesh.prototype.recalcNormals=function(a,c){var b=0!==(this.attributeBits&Mesh.ATTRIBUTES_BITS&~Mesh.NORMALS_BIT);this._rebuildVertices(Mesh.NORMALS_BIT);(b||a)&&this.makeRedundant();b=this.primitiveType();b!==Mesh.LINES&&b!==Mesh.POINTS&&Mesh._recalcNormals(this.vertices,this.indices,this.getStride(),3,a,c);return this};
SubMesh.prototype.setColor3=function(a,c,b){this._rebuildVertices(Mesh.COLORS_BIT);for(var d=this.getStride(),e=Mesh._colorOffset(this.attributeBits);e<this.vertices.length;e+=d)this.vertices[e]=a,this.vertices[e+1]=c,this.vertices[e+2]=b;return this};Mesh._getStride=function(a){var c=[3,6,6,9,5,8,8,11][a&(Mesh.NORMALS_BIT|Mesh.COLORS_BIT|Mesh.TEXCOORDS_BIT)];0!==(a&Mesh.TANGENTS_BIT)&&(c+=3);0!==(a&Mesh.BITANGENTS_BIT)&&(c+=3);return c};
Mesh._normalOffset=function(a){return[-1,3,-1,3,-1,3,-1,3][a&(Mesh.NORMALS_BIT|Mesh.COLORS_BIT|Mesh.TEXCOORDS_BIT)]};Mesh._tangentOffset=function(a){var c=3;if(0===(a&Mesh.TANGENTS_BIT))return-1;0!==(a&Mesh.NORMALS_BIT)&&(c+=3);0!==(a&Mesh.COLORS_BIT)&&(c+=3);0!==(a&Mesh.TEXCOORDS_BIT)&&(c+=2);return c};
Mesh._bitangentOffset=function(a){var c=3;if(0===(a&Mesh.BITANGENTS_BIT))return-1;0!==(a&Mesh.NORMALS_BIT)&&(c+=3);0!==(a&Mesh.COLORS_BIT)&&(c+=3);0!==(a&Mesh.TEXCOORDS_BIT)&&(c+=2);0!==(a&Mesh.TANGENTS_BIT)&&(c+=3);return c};Mesh._colorOffset=function(a){return[-1,-1,3,6,-1,-1,3,6][a&(Mesh.NORMALS_BIT|Mesh.COLORS_BIT|Mesh.TEXCOORDS_BIT)]};Mesh._texCoordOffset=function(a){return[-1,-1,-1,-1,3,6,6,9][a&(Mesh.NORMALS_BIT|Mesh.COLORS_BIT|Mesh.TEXCOORDS_BIT)]};Mesh.ATTRIBUTES_BITS=255;
Mesh.PRIMITIVES_BITS=768;Mesh.NORMALS_BIT=1;Mesh.COLORS_BIT=2;Mesh.TEXCOORDS_BIT=4;Mesh.TANGENTS_BIT=8;Mesh.BITANGENTS_BIT=16;Mesh.LINES_BIT=256;Mesh.POINTS_BIT=512;Mesh.TRIANGLES=4;Mesh.QUAD_STRIP=8;Mesh.QUADS=7;Mesh.LINES=1;Mesh.TRIANGLE_FAN=6;Mesh.TRIANGLE_STRIP=5;Mesh.LINE_STRIP=3;Mesh.POINTS=0;this.Mesh=Mesh;var SubMeshBuffer=function(a){this.vertices=new Float32Array(a.vertices);65536<=a.vertices.length||65536<=a.indices.length?(this.indexBufferSize=4,this.indices=new Uint32Array(a.indices)):256>=a.vertices.length&&256>=a.indices.length?(this.indexBufferSize=1,this.indices=new Uint8Array(a.indices)):(this.indexBufferSize=2,this.indices=new Uint16Array(a.indices));this.numVertices=a.vertices.length/a.getStride();this.facesLength=a.indices.length;this.format=a.attributeBits;this._stride=Mesh._getStride(this.format);
this._attribsUsed=[0,Mesh._normalOffset(this.format),Mesh._colorOffset(this.format),Mesh._texCoordOffset(this.format),Mesh._tangentOffset(this.format),Mesh._bitangentOffset(this.format)];this._sizes=[3,3,3,2,3,3]};SubMeshBuffer.prototype.primitiveCount=function(){return 0!==(this.format&Mesh.LINES_BIT)?Math.floor(this.facesLength/2):0!==(this.format&Mesh.POINTS_BIT)?this.facesLength:Math.floor(this.facesLength/3)};
function MeshBuffer(a){this.subMeshes=[];this._bounds=a.getBoundingBox();for(var c=0;c<a.subMeshes.length;c++){var b=a.subMeshes[c];0!==b.indices.length&&this.subMeshes.push(new SubMeshBuffer(b))}}MeshBuffer.prototype._getBounds=function(){return this._bounds};MeshBuffer.prototype.getFormat=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a|=this.subMeshes[c].format;return a};
MeshBuffer.prototype.vertexCount=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a+=this.subMeshes[c].numVertices;return a};MeshBuffer.prototype.primitiveCount=function(){for(var a=0,c=0;c<this.subMeshes.length;c++)a+=this.subMeshes[c].primitiveCount();return a};var Meshes={createBox:function(a,c,b,d){a*=.5;c*=.5;b*=.5;a=[-a,-c,b,-1,0,0,1,0,-a,c,b,-1,0,0,1,1,-a,c,-b,-1,0,0,0,1,-a,-c,-b,-1,0,0,0,0,a,-c,-b,1,0,0,1,0,a,c,-b,1,0,0,1,1,a,c,b,1,0,0,0,1,a,-c,b,1,0,0,0,0,a,-c,-b,0,-1,0,1,0,a,-c,b,0,-1,0,1,1,-a,-c,b,0,-1,0,0,1,-a,-c,-b,0,-1,0,0,0,a,c,b,0,1,0,1,0,a,c,-b,0,1,0,1,1,-a,c,-b,0,1,0,0,1,-a,c,b,0,1,0,0,0,-a,-c,-b,0,0,-1,1,0,-a,c,-b,0,0,-1,1,1,a,c,-b,0,0,-1,0,1,a,-c,-b,0,0,-1,0,0,a,-c,b,0,0,1,1,0,a,c,b,0,0,1,1,1,-a,c,b,0,0,1,0,1,-a,-c,b,0,0,1,0,0];if(d)for(d=
0;d<a.length;d+=8)a[d+3]=-a[d+3],a[d+4]=-a[d+4],a[d+5]=-a[d+5];return new Mesh(a,[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],Mesh.NORMALS_BIT|Mesh.TEXCOORDS_BIT)},createCylinder:function(a,c,b,d,e,f,g){var h=new Mesh;if(null===d||"undefined"===typeof d)d=32;if(null===e||"undefined"===typeof e)e=1;if(2>=d)throw Error("too few slices");if(1>e)throw Error("too few stacks");if(0>b)throw Error("negative height");if(0>=a&&0>=c||0===b)return h;for(var k=
g?-1:1,l=[0,1],m=[0],n=GLMath.PiTimes2,q=1;q<d;q++){var r=1*q/d,p=n*r,t=Math.cos(p);l.push(0<=p&&6.283185307179586>p?3.141592653589793>=p?Math.sqrt(1-t*t):-Math.sqrt(1-t*t):Math.sin(p),t);m.push(r)}l.push(0,1);m.push(1);d*=2;if(0<b)for(n=0,r=a,q=0,a===c?(t=0,p=k):(q=Math.atan2(a-c,b),p=Math.cos(q),t=0<=q&&6.283185307179586>q?3.141592653589793>=q?Math.sqrt(1-p*p):-Math.sqrt(1-p*p):Math.sin(q),t*=k,p*=k),k=1/e,q=0;q<e;q++){var u=n,v=q+1==e?1:(q+1)*k,y=b*u,w=b*v,B=r,z=a+(c-a)*v,n=v,r=z;h.mode(Mesh.TRIANGLE_STRIP);
h.texCoord2(1,u);h.normal3(0,p,t);h.vertex3(0,B,y);h.texCoord2(1,v);h.normal3(0,p,t);h.vertex3(0,z,w);for(var C=2,I=1;C<=d;C+=2,I++){var x=m[I],A,D;A=l[C];D=l[C+1];h.texCoord2(1-x,u);h.normal3(A*p,D*p,t);h.vertex3(A*B,D*B,y);h.texCoord2(1-x,v);h.normal3(A*p,D*p,t);h.vertex3(A*z,D*z,w)}}return f?h.recalcNormals(f,g):h},createLathe:function(a,c,b,d){var e=new Mesh;if(4>a.length)throw Error("too few points");if(null===c||"undefined"===typeof c)c=32;if(2>=c)throw Error("too few slices");if(0!=a.length%
1)throw Error("points array length is not an even number");for(var f=0;f<a.length;f+=2)if(0>a[f<<1])throw Error("point's x is less than 0");for(var g=[0,1],h=[0],k=GLMath.PiTimes2,f=1;f<c;f++){var l=1*f/c,m=k*l,n=Math.cos(m);g.push(0<=m&&6.283185307179586>m?3.141592653589793>=m?Math.sqrt(1-n*n):-Math.sqrt(1-n*n):Math.sin(m),n);h.push(l)}g.push(0,1);h.push(1);c*=2;for(var q=0,k=a.length/2-1,l=1/k,f=0;f<k;f++){var m=q,n=f+1==k?1:(f+1)*l,q=f<<1,r=a[q+1],p=a[q+3],t=Math.min(r,p),r=Math.max(r,p),p=a[q],
u=a[q+2],q=n;e.mode(Mesh.TRIANGLE_STRIP);e.texCoord2(1,m);e.vertex3(0,p,t);e.texCoord2(1,n);e.vertex3(0,u,r);for(var v=2,y=1;v<=c;v+=2,y++){var w=h[y],B,z;B=g[v];z=g[v+1];e.texCoord2(1-w,m);e.vertex3(B*p,z*p,t);e.texCoord2(1-w,n);e.vertex3(B*u,z*u,r)}}return e.recalcNormals(b,d)},createClosedCylinder:function(a,c,b,d,e,f,g){e=Meshes.createCylinder(a,c,b,d,e,f,g);a=Meshes.createDisk(0,a,d,2,!g).reverseWinding();c=Meshes.createDisk(0,c,d,2,g);c.transform(GLMath.mat4translated(0,0,b));return e.merge(a).merge(c)},
createDisk:function(a,c,b,d,e){return Meshes.createPartialDisk(a,c,b,d,0,360,e)},createPartialDisk:function(a,c,b,d,e,f,g){var h=new Mesh;if(null===b||"undefined"===typeof b)b=32;if(null===d||"undefined"===typeof d)d=1;if(null===e||"undefined"===typeof e)e=0;if(null===f||"undefined"===typeof f)f=360;if(2>=b)throw Error("too few slices");if(1>d)throw Error("too few loops");if(a>c)throw Error("inner greater than outer");0>a&&(a=0);0>c&&(c=0);if(0===c||0===f)return h;var k=360===f&&0===e,l=0>f?-1:1;
0>f&&(f=-f);f%=360;0===f&&(f=360);var m=[],n=[],q=GLMath.PiTimes2;f=360===f?q:f*GLMath.PiDividedBy180;e*=GLMath.PiDividedBy180;0>l&&(f=-f);for(l=0;l<=b;l++){var r=1*l/b,p=1===r&&f===q?e:e+f*r,p=0>p?q- -p%q:p%q,t=Math.cos(p);m.push(0<=p&&6.283185307179586>p?3.141592653589793>=p?Math.sqrt(1-t*t):-Math.sqrt(1-t*t):Math.sin(p),t);n.push(r)}k&&(m[0]=0,m[1]=1,m[m.length-1]=1,m[m.length-2]=0,n[0]=0,n[n.length-1]=1);b*=2;e=c-a;k=a;g?h.normal3(0,0,-1):h.normal3(0,0,1);for(l=0;l<d;l++){g=k;n=a+(l+1)/d*e;q=
g/c;f=n/c;k=n;r=0===l&&0===a;h.mode(r?Mesh.TRIANGLE_FAN:Mesh.TRIANGLE_STRIP);var u;if(r)for(p=b/2,r=b,u=p;0<=r;r-=2,u--)p=m[r],t=m[r+1],r===b&&(h.texCoord2(.5*(1+p*q),.5*(1+t*q)),h.vertex3(p*g,t*g,0)),h.texCoord2(.5*(1+p*f),.5*(1+t*f)),h.vertex3(p*n,t*n,0);else for(u=r=0;r<=b;r+=2,u++)p=m[r],t=m[r+1],h.texCoord2(.5*(1+p*f),.5*(1+t*f)),h.vertex3(p*n,t*n,0),h.texCoord2(.5*(1+p*q),.5*(1+t*q)),h.vertex3(p*g,t*g,0)}return h},createTorus:function(a,c,b,d,e,f){var g=new Mesh;if(null===d||"undefined"===typeof d)d=
16;if(null===b||"undefined"===typeof b)b=16;if(3>d)throw Error("crosswise is less than 3");if(3>b)throw Error("lengthwise is less than 3");if(0>a||0>c)throw Error("inner or outer is less than 0");if(0===c||0===a)return g;for(var h=GLMath.PiTimes2,k=[],l=[],m,n,q=0;q<d;q++)n=q*h/d,m=Math.cos(n),n=0<=n&&6.283185307179586>n?3.141592653589793>=n?Math.sqrt(1-m*m):-Math.sqrt(1-m*m):Math.sin(n),k.push(n,m);k.push(k[0]);k.push(k[1]);for(q=0;q<b;q++)n=q*h/b,m=Math.cos(n),n=0<=n&&6.283185307179586>n?3.141592653589793>=
n?Math.sqrt(1-m*m):-Math.sqrt(1-m*m):Math.sin(n),l.push(n,m);l.push(l[0]);l.push(l[1]);for(h=0;h<b;h++){m=h/b;var r=(h+1)/b,p=l[2*h],t=l[2*h+1],u=l[2*h+2],v=l[2*h+3];g.mode(Mesh.TRIANGLE_STRIP);for(q=0;q<=d;q++){n=q/d;var y=k[2*q],w=k[2*q+1],B=w*(c+v*a),z=y*(c+v*a),C=u*a,I=v*w,x=v*y,A=u;g.normal3(I,x,A);g.texCoord2(n,r);g.vertex3(B,z,C);B=w*(c+t*a);z=y*(c+t*a);C=p*a;I=t*w;x=t*y;A=p;g.normal3(I,x,A);g.texCoord2(n,m);g.vertex3(B,z,C)}}return e?g.recalcNormals(e,f):g},createPlane:function(a,c,b,d,e){var f=
new Mesh;if(null===a||"undefined"===typeof a)a=1;if(null===c||"undefined"===typeof c)c=1;if(null===b||"undefined"===typeof b)b=1;if(null===d||"undefined"===typeof d)d=1;if(0>a||0>c)throw Error("width or height is less than 0");if(0>=d||0>=b)throw Error("widthDiv or heightDiv is 0 or less");if(0===a||0===c)return f;var g=.5*-a,h=.5*-c;e?f.normal3(0,0,-1):f.normal3(0,0,1);for(e=0;e<d;e++){f.mode(Mesh.TRIANGLE_STRIP);var k=e/d,l=(e+1)/d,m=h+c*k,n=h+c*l;f.texCoord2(0,l);f.vertex3(g,n,0);f.texCoord2(0,
k);f.vertex3(g,m,0);for(var q=0;q<b;q++){var r=(q+1)/b,p=g+a*r;f.texCoord2(r,l);f.vertex3(p,n,0);f.texCoord2(r,k);f.vertex3(p,m,0)}}return f},createSphere:function(a,c,b,d,e){return Meshes._createCapsule(a,0,c,b,1,d,e)},createCapsule:function(a,c,b,d,e,f,g){if(null===d||"undefined"===typeof d)d=8;if(1>d)throw Error("too few stacks");return Meshes._createCapsule(a,c,b,2*d,e,f,g)},_createCapsule:function(a,c,b,d,e,f,g){function h(a,b,c,d,e,f){a.normal3(c*b,d*b,e*b);a.vertex3(c,d,e+f)}var k=new Mesh;
if(null===b||"undefined"===typeof b)b=16;if(null===d||"undefined"===typeof d)d=16;if(null===e||"undefined"===typeof e)e=1;if(null===a||"undefined"===typeof a)a=1;if(null===c||"undefined"===typeof c)c=1;if(2>d)throw Error("too few stacks");if(2>=b)throw Error("too few slices");if(1>e&&0<c)throw Error("too few middle stacks");if(0>c)throw Error("negative length");if(0>a)throw Error("negative radius");if(0===a)return k;for(var l=.5*c,m=d/2,n=g?-1:1,q=[0,1],r=[],p=[],t=[0],u,v,y=GLMath.PiTimes2,w=1;w<
b;w++){var B=1*w/b;u=y*B;var z=Math.cos(u);u=0<=u&&6.283185307179586>u?3.141592653589793>=u?Math.sqrt(1-z*z):-Math.sqrt(1-z*z):Math.sin(u);q.push(u,z);t.push(B)}q.push(0,1);t.push(1);y=2*a;y/=y+c;B=[];for(w=1;w<d;w++){var C=1*w/d;u=Math.PI*C;z=Math.cos(u);u=0<=u&&6.283185307179586>u?3.141592653589793>=u?Math.sqrt(1-z*z):-Math.sqrt(1-z*z):Math.sin(u);r.push(u);B.push(-z);p.push(C)}r.push(0);p.push(1);B.push(1);b*=2;for(var z=-1,I=u=0,w=0;w<d;w++){var x=B[w],A=p[w];v=a*z;var C=a*x,D=w<m?-l:l,J=u,F=
a*r[w],L=I,M=A;0<c&&(L=w<m?I*y:1-(1-I)*y,M=w<m?A*y:1-(1-A)*y);z=x;I=A;u=F;w===d-1||0===w?k.mode(Mesh.TRIANGLES):(k.mode(Mesh.TRIANGLE_STRIP),k.texCoord2(1,L),h(k,n,0,J,v,D),k.texCoord2(1,M),h(k,n,0,F,C,D));for(var K=0,N=0,G=1,E,H,A=2,O=1;A<=b;A+=2,O++)x=t[O],w===d-1?(E=K+.5*(x-K),k.texCoord2(1-K,L),h(k,n,N*J,G*J,v,D),k.texCoord2(1-E,M),h(k,n,0,F,C,D),E=q[A],H=q[A+1],k.texCoord2(1-x,L),h(k,n,E*J,H*J,v,D),N=E,G=H,K=x):0===w?(E=K+.5*(x-K),k.texCoord2(1-E,L),h(k,n,0,J,v,D),k.texCoord2(1-K,M),h(k,n,N*
F,G*F,C,D),E=q[A],H=q[A+1],k.texCoord2(1-x,M),h(k,n,E*F,H*F,C,D),N=E,G=H,K=x):(E=q[A],H=q[A+1],k.texCoord2(1-x,L),h(k,n,E*J,H*J,v,D),k.texCoord2(1-x,M),h(k,n,E*F,H*F,C,D));if(w+1===m&&0<c)for(D=.5*y,J=2*l,K=1-D,N=1-y,G=0;G<e;G++){v=-l+(0===G?0:J*G/e);var P=G===e-1?l:-l+J*(G+1)/e,L=D+(0===G?0:N*G/e),M=G===e-1?K:D+N*(G+1)/e;k.mode(Mesh.TRIANGLE_STRIP);k.texCoord2(1,L);h(k,n,0,F,C,v);k.texCoord2(1,M);h(k,n,0,F,C,P);A=2;for(O=1;A<=b;A+=2,O++)x=t[O],E=q[A],H=q[A+1],k.texCoord2(1-x,L),h(k,n,E*F,H*F,C,v),
k.texCoord2(1-x,M),h(k,n,E*F,H*F,C,P)}}return f?k.recalcNormals(f,g):k.normalizeNormals()},createPointedStar:function(a,c,b,d){var e=new Mesh;if(2>a||0>c||0>b||0>=c&&0>=b)return e;e.mode(Mesh.TRIANGLE_FAN);var f=0,g=0,h=GLMath.PiTimes2,k=1/(2*a),l=1/Math.max(c,b);e.normal3(0,0,d?-1:1).texCoord2(.5,.5).vertex2(0,0);for(d=0;d<2*a;d++){var m=h*d*k,n=Math.cos(m),q=0===(d&1)?c:b,m=-(0<=m&&6.283185307179586>m?3.141592653589793>=m?Math.sqrt(1-n*n):-Math.sqrt(1-n*n):Math.sin(m))*q,n=n*q,q=.5*(1+m*l),r=.5*
(1+n*l);0===d&&(f=m,g=n);e.texCoord2(q,r).vertex2(m,n)}e.texCoord2(.5*(1+f*l),.5*(1+g*l)).vertex2(f,g);return e}};this.Meshes=Meshes;function RenderPass3D(a,c){this.subScene=a;this.clearStencil=this.clearDepth=this.clearColor=!0;this.frameBuffer=null;this.setParams(c)}RenderPass3D.prototype.setParams=function(a){a&&("undefined"!==typeof a.clearColor&&(this.clearColor=a.clearColor),"undefined"!==typeof a.clearDepth&&(this.clearDepth=a.clearDepth),"undefined"!==typeof a.clearStencil&&(this.clearStencil=a.clearStencil),"undefined"!==typeof a.frameBuffer&&(this.frameBuffer=a.frameBuffer))};function Scene3D(a){var c=a;"function"===typeof a.getContext&&(c=HTMLCanvasElement&&c.constructor===HTMLCanvasElement?GLUtil.get3DContext(a):GLUtil._toContext(c));this.context=c;this.textureCache={};this._textureLoader=new TextureLoader;this._meshLoader=new BufferedMesh._MeshLoader;this._renderedOutsideScene=!1;this.shapes=[];this._errors=!0;this._frontFace=Scene3D.CCW;this._cullFace=Scene3D.NONE;this.clearColor=[0,0,0,1];this.fboFilter=null;this._subScene=new Subscene3D;this._subScene.getLights().setDefaults();
this._programs=new Scene3D.ProgramCache;this.useDevicePixelRatio=!1;this._pixelRatio=1;this.autoResize=!0;this.width=Math.ceil(1*this.context.canvas.clientWidth);this.height=Math.ceil(1*this.context.canvas.clientHeight);this.context.canvas.width=this.width;this.context.canvas.height=this.height;if(this._is3d=GLUtil.is3DContext(this.context))this._programs.getProgram(Scene3D.LIGHTING_ENABLED|Scene3D.SPECULAR_ENABLED|Scene3D.SPECULAR_MAP_ENABLED,this.context),this.context.viewport(0,0,this.width,this.height),
this.context.enable(this.context.BLEND),this.context.blendFunc(this.context.SRC_ALPHA,this.context.ONE_MINUS_SRC_ALPHA),this.context.enable(this.context.DEPTH_TEST),this.context.depthFunc(this.context.LEQUAL),this.context.disable(this.context.CULL_FACE),this.context.clearDepth(1),this._setClearColor(),this._setFace()}Scene3D.prototype.getCanvas=function(){return this.context.canvas};Scene3D.LIGHTING_ENABLED=1;Scene3D.SPECULAR_MAP_ENABLED=2;Scene3D.NORMAL_ENABLED=4;Scene3D.SPECULAR_ENABLED=8;
Scene3D.TEXTURE_ENABLED=16;Scene3D._materialToFlags=function(a){var c;c=0|(a.basic?0:Scene3D.LIGHTING_ENABLED);c|=0!=a.specular[0]||0!=a.specular[1]||0!=a.specular[2]?Scene3D.SPECULAR_ENABLED:0;c|=a.specularMap?Scene3D.SPECULAR_MAP_ENABLED:0;c|=a.normalMap?Scene3D.NORMAL_ENABLED:0;return c|=a.texture?Scene3D.TEXTURE_ENABLED:0};Scene3D.ProgramCache=function(){this._programs=[];this._customPrograms=[]};
Scene3D.ProgramCache.prototype.getCustomProgram=function(a,c){if(!c)throw Error();if(a instanceof ShaderProgram)return a;for(var b=0;b<this._customPrograms.length;b++){var d=this._customPrograms[b];if(d[0]==a&&d[1]==c)return d[2]._update(),d[2]}b=ShaderProgram._fromShaderInfo(c,a);this._customPrograms.push([a,c,b]);return b};
Scene3D.ProgramCache.prototype.getProgram=function(a,c){if(!c)throw Error();var b=this._programs[a];if(b)for(var d=0;d<b.length;d++){if(b[d][0]==c)return b[d][1]}else this._programs[a]=[];b="";0!=(a&Scene3D.LIGHTING_ENABLED)&&(b+="#define SHADING\n");0!=(a&Scene3D.SPECULAR_ENABLED)&&(b+="#define SPECULAR\n");0!=(a&Scene3D.NORMAL_ENABLED)&&(b+="#define NORMAL_MAP\n");0!=(a&Scene3D.TEXTURE_ENABLED)&&(b+="#define TEXTURE\n");0!=(a&Scene3D.SPECULAR_MAP_ENABLED)&&(b+="#define SPECULAR_MAP\n#define SPECULAR\n");
b=new ShaderProgram(c,b+ShaderProgram.getDefaultVertex(),b+ShaderProgram.getDefaultFragment());this._programs[a].push([c,b]);return b};Scene3D.prototype.getContext=function(){return this.context};Scene3D.NONE=0;Scene3D.BACK=1;Scene3D.FRONT=2;Scene3D.FRONT_AND_BACK=3;Scene3D.CCW=0;Scene3D.CW=1;Scene3D.prototype.cullFace=function(a){this._cullFace=a===Scene3D.BACK||a===Scene3D.FRONT||a===Scene3D.FRONT_AND_BACK?a:0;return this};
Scene3D.prototype._setFace=function(){if(this._is3d)return this._cullFace===Scene3D.BACK?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.BACK)):this._cullFace===Scene3D.FRONT?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.FRONT)):this._cullFace===Scene3D.FRONT_AND_BACK?(this.context.enable(this.context.CULL_FACE),this.context.cullFace(this.context.FRONT_AND_BACK)):this.context.disable(this.context.CULL_FACE),this._frontFace===Scene3D.CW?
this.context.frontFace(this.context.CW):this.context.frontFace(this.context.CCW),this};Scene3D.prototype.frontFace=function(a){this._frontFace=a===Scene3D.CW?a:0;return this};Scene3D.prototype.setAutoResize=function(a){this.autoResize=!!a;return this};
Scene3D.prototype.setUseDevicePixelRatio=function(a){var c=!!this.useDevicePixelRatio;this._pixelRatio=(this.useDevicePixelRatio=!!a)&&window.devicePixelRatio?window.devicePixelRatio:1;c!==this.useDevicePixelRatio&&this.setDimensions(this.width,this.height);return this};Scene3D.prototype.getClearColor=function(){return this.clearColor.slice(0,4)};Scene3D.prototype.useProgram=function(a){console.warn("The 'useProgram' method is obsolete.  Instead of this method, use the 'setShader' program of individual shapes to set the shader programs they use.")};
Scene3D.prototype.setDimensions=function(a,c){if(0>a||0>c)throw Error("width or height negative");this.width=Math.ceil(a);this.height=Math.ceil(c);this.context.canvas.width=this.width*this._pixelRatio;this.context.canvas.height=this.height*this._pixelRatio;this._is3d&&this.context.viewport(0,0,this.width*this._pixelRatio,this.height*this._pixelRatio);"undefined"!==typeof this.fbo&&this.fbo&&(this.fbo.dispose(),this.fbo=this.createBuffer(),this.fboQuad&&this.fboQuad.setMaterial(this.fbo))};
Scene3D.prototype.getWidth=function(){return this.width};Scene3D.prototype.getHeight=function(){return this.height};Scene3D.prototype.getAspect=function(){var a=this.getHeight();return 0>=a?1:this.getWidth()/a};Scene3D.prototype.getClientWidth=function(){return this.context.canvas.clientWidth};Scene3D.prototype.getClientHeight=function(){return this.context.canvas.clientHeight};Scene3D.prototype.getClientAspect=function(){var a=this.getClientHeight();return 0>=a?1:this.getClientWidth()/a};
Scene3D.prototype.createBuffer=function(){return new FrameBuffer(this.context,this.getWidth(),this.getHeight())};Scene3D.prototype.getProjectionMatrix=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene._projectionMatrix.slice(0,16)};
Scene3D.prototype.getViewMatrix=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._viewMatrix.slice(0,16)};Scene3D.prototype.setPerspective=function(a,c,b,d){return this.setProjectionMatrix(GLMath.mat4perspective(a,c,b,d))};
Scene3D.prototype.setOrthoAspect=function(a,c,b,d,e,f,g){if(null===g||"undefined"===typeof g)g=this.getClientAspect();0===g&&(g=1);return this.setProjectionMatrix(GLMath.mat4orthoAspect(a,c,b,d,e,f,g))};Scene3D.prototype.setOrtho2DAspect=function(a,c,b,d,e){return this.setOrthoAspect(a,c,b,d,-1,1,e)};Scene3D.prototype.setFrustum=function(a,c,b,d,e,f){return this.setProjectionMatrix(GLMath.mat4frustum(a,c,d,b,e,f))};
Scene3D.prototype.setOrtho=function(a,c,b,d,e,f){return this.setProjectionMatrix(GLMath.mat4ortho(a,c,b,d,e,f))};Scene3D.prototype.setOrtho2D=function(a,c,b,d){return this.setProjectionMatrix(GLMath.mat4ortho(a,c,b,d,-1,1))};Scene3D.prototype._setClearColor=function(){this._is3d&&this.context.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]);return this};Scene3D.prototype.setClearColor=function(a,c,b,d){this.clearColor=GLUtil.toGLColor(a,c,b,d);return this._setClearColor()};
Scene3D.prototype.loadTexture=function(a){return this._textureLoader.loadTexture(a)};Scene3D.prototype.loadAndMapTexture=function(a){var c=null;if(a.constructor===Texture)return this.loadAndMapTexture(a.name);var c=this.loadTexture(a),b=this;return c.then(function(a){b._textureLoader.mapTexture(a,b);return a})};Scene3D.prototype.loadAndMapTextures=function(a,c,b){for(var d=[],e=0;e<a.length;e++)d.push(this.loadAndMapTexture(a[e]));return GLUtil.getPromiseResults(d,c,b)};
Scene3D.prototype.clear=function(){this._is3d&&this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT|this.context.STENCIL_BUFFER_BIT)};Scene3D.prototype.clearDepth=function(){this._is3d&&this.context.clear(this.context.DEPTH_BUFFER_BIT)};Scene3D.prototype.vertexCount=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.vertexCount()};
Scene3D.prototype.primitiveCount=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.primitiveCount()};Scene3D.prototype.setProjectionMatrix=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.setProjectionMatrix(a);return this};
Scene3D.prototype.setViewMatrix=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.setViewMatrix(a);return this};Scene3D.prototype.setLookAt=function(a,c,b){return this.setViewMatrix(GLMath.mat4lookat(a,c,b))};
Scene3D.prototype.addShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.addShape(a);return this};Scene3D.prototype.makeShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return new Shape(a)};
Scene3D.prototype.removeShape=function(a){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this._subScene.removeShape(a);return this};Scene3D.prototype.getLights=function(){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");return this._subScene.getLights()};
Scene3D.prototype.setDirectionalLight=function(a,c,b,d){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setDirectionalLight(a,c,b,d);return this};Scene3D.prototype.setLightParams=function(a,c){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setParams(a,c);return this};
Scene3D.prototype.setAmbient=function(a,c,b,d){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setAmbient(a,c,b,d);return this};Scene3D.prototype.setPointLight=function(a,c,b,d){if(this._errors)throw Error();if(this._renderedOutsideScene)throw Error("A non-default scene has been rendered, so this method is disabled.");this.getLights().setPointLight(a,c,b,d);return this};
Scene3D.prototype._clearForPass=function(a){var c=0;a.clearColor&&(c|=this.context.COLOR_BUFFER_BIT);a.clearDepth&&(c|=this.context.DEPTH_BUFFER_BIT);a.clearStencil&&(c|=this.context.STENCIL_BUFFER_BIT);this._is3d&&0!=c&&this.context.clear(c)};
Scene3D.prototype.render=function(a){if(a instanceof Subscene3D)return this.render([new RenderPass3D(a)]);if(this.autoResize){var c=this.context.canvas;c.height===Math.ceil(c.clientHeight)*this._pixelRatio&&c.width===Math.ceil(c.clientWidth)*this._pixelRatio||this.setDimensions(c.clientWidth,c.clientHeight)}this._setFace();if(null==a)this._is3d&&this.context.clear(this.context.COLOR_BUFFER_BIT|this.context.DEPTH_BUFFER_BIT),this._subScene.render();else{this._renderedOutsideScene=!0;for(var c=this.getClientWidth(),
b=this.getClientHeight(),d=0;d<a.length;d++){var e=a[d];e.frameBuffer&&e.frameBuffer.bind();this._clearForPass(e);a[d].subScene.resize(c,b);a[d].subScene.render(this);e.frameBuffer&&e.frameBuffer.unbind()}}this._is3d&&this.context.flush();return this};Scene3D.prototype.useFilter=function(a){console.warn("The useFilter method has no effect. Use the {@link Subscene3D.forFilter} method to create a subscene for rendering filter effects from a frame buffer.");return this};
Scene3D.supportsDerivatives=function(a){a=a.getContext?a.getContext():a;return a.getExtension("OES_standard_derivatives")?!0:!1};function ShaderInfo(a,c){if(null===a||"undefined"===typeof a)a=ShaderProgram.getDefaultVertex();if(null===c||"undefined"===typeof c)c=ShaderProgram.getDefaultFragment();this.vertexShader=a;this.fragmentShader=c;this.uniformValues={}}ShaderInfo.prototype.copy=function(){var a=new ShaderInfo(this.vertexShader,this.fragmentShader);a.setUniforms(this.uniformValues);return a};ShaderInfo.prototype.setUniforms=function(a){ShaderInfo._setUniformsInternal(a,this.uniformValues,null);return this};
ShaderInfo._setUniformInternal=function(a,c,b,d){isCurrentProgram=null;a=a[b];var e=c[b];if("number"===typeof a){var f=!1;null===e||"undefined"===typeof e?(c[b]=e=a,f=!0):e!==a&&(e=a,c[b]=a,f=!0);f&&d&&(d[b]=e)}else if(3===a.length)if(!e)c[b]=a.slice(0,a.length),d&&(d[b]=a.slice(0,a.length));else{if(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2])e[0]=a[0],e[1]=a[1],e[2]=a[2],d&&(d[b]=e.slice(0,e.length))}else if(2===a.length)if(!e)c[b]=a.slice(0,a.length),d&&(d[b]=a.slice(0,a.length));else{if(e[0]!==a[0]||
e[1]!==a[1])e[0]=a[0],e[1]=a[1],d&&(d[b]=e.slice(0,e.length))}else if(4===a.length)if(!e)c[b]=a.slice(0,a.length),d&&(d[b]=a.slice(0,a.length));else{if(e[0]!==a[0]||e[1]!==a[1]||e[2]!==a[2]||e[3]!==a[3])e[0]=a[0],e[1]=a[1],e[2]=a[2],e[3]=a[3],d&&(d[b]=e.slice(0,e.length))}else 16===a.length?e?ShaderInfo._copyIfDifferent(a,e,16)&&d&&(d[b]=e.slice(0,e.length)):(c[b]=a.slice(0,a.length),d&&(d[b]=a.slice(0,a.length))):9===a.length&&(e?ShaderInfo._copyIfDifferent(a,e,9)&&d&&(d[b]=e.slice(0,e.length)):
(c[b]=a.slice(0,a.length),d&&(d[b]=a.slice(0,a.length))))};ShaderInfo._setUniformsInternal=function(a,c,b){var d;if("undefined"!==typeof Object.keys)for(var e=Object.keys(a),f=0;f<e.length;f++)d=e[f],ShaderInfo._setUniformInternal(a,c,d,b);else for(d in a)ShaderInfo._setUniformInternal(a,c,d,b)};function ShaderProgram(a,c,b){this._init(a,new ShaderInfo(c,b))}ShaderProgram._fromShaderInfo=function(a,c){var b=new ShaderProgram(null);b._init(a,c);return b};
ShaderProgram.prototype._init=function(a,c){if(a&&(a=a.getContext?a.getContext():a,this.shaderInfo=c,this.context=a,this.prog=ShaderProgram._compileShaders(a,c.vertexShader,c.fragmentShader),this.uniformValues={},this.actives={},this.attributes=[],this.uniformTypes={},this.savedUniforms={},ShaderInfo._setUniformsInternal(this.shaderInfo.uniformValues,this.uniformValues,this.savedUniforms),this.CURRENT_PROGRAM=35725,this.FLOAT=5126,"undefined"!==typeof this.prog&&null!==this.prog)){for(var b=null,
d={},e=a.getProgramParameter(this.prog,a.ACTIVE_ATTRIBUTES),f=0;f<e;++f)if(b=a.getActiveAttrib(this.prog,f),null!==b&&"undefined"!==typeof b){var b=b.name,g=a.getAttribLocation(this.prog,b);0<=g&&(this.attributes.push(g),d[b]=g)}e=a.getProgramParameter(this.prog,a.ACTIVE_UNIFORMS);for(f=0;f<e;++f)g=this.context.getActiveUniform(this.prog,f),null!==g&&"undefined"!==typeof g&&(b=g.name,d[b]=this.context.getUniformLocation(this.prog,b),this.uniformTypes[b]=g.type);this.actives=d}};
ShaderProgram.prototype.dispose=function(){this.program&&this.context.deleteProgram(this.program);this.program=this.context=null;this.actives={};this.attributes={};this.uniformTypes={}};ShaderProgram.prototype.getContext=function(){return this.context};
ShaderProgram.prototype._setUniformInternal=function(a,c){var b=this.get(c);if(null!==b&&"undefined"!==typeof b){var d=a[c];"number"===typeof d?this.uniformTypes[c]===this.FLOAT?this.context.uniform1f(b,d):this.context.uniform1i(b,d):3===d.length?this.context.uniform3fv(b,d):2===d.length?this.context.uniform2fv(b,d):4===d.length?this.context.uniform4fv(b,d):16===d.length?this.context.uniformMatrix4fv(b,!1,d):9===d.length&&this.context.uniformMatrix3fv(b,!1,d)}};
ShaderProgram.prototype.get=function(a){a=this.actives[a];return null===a||"undefined"===typeof a?null:a};ShaderProgram.prototype.getUniform=function(a){var c="string"===typeof a?this.get(a):a;if(null===c||"number"===typeof c)return null;a=this.uniformValues[a];return null===a||"undefined"===typeof a?this.context.getUniform(this.program,c):a instanceof Array?a.slice(0,a.length):a};
ShaderProgram.prototype._setSavedUniforms=function(){var a,c=0;if("undefined"!==typeof Object.keys)for(var b=Object.keys(this.savedUniforms),c=b.length,d=0;d<c;d++)a=b[d],this._setUniformInternal(this.savedUniforms,a);else for(a in this.savedUniforms)this._setUniformInternal(this.savedUniforms,a),c++;return c};ShaderProgram.prototype.use=function(){this.context.useProgram(this.prog);0<this._setSavedUniforms()&&(this.savedUniforms={});return this};
ShaderProgram.prototype._update=function(){ShaderInfo._setUniformsInternal(this.shaderInfo.uniformValues,this.uniformValues,this.savedUniforms);return this};ShaderProgram.prototype.setUniforms=function(a){ShaderInfo._setUniformsInternal(a,this.uniformValues,this.savedUniforms);this.context.getParameter(this.CURRENT_PROGRAM)===this.prog&&0<this._setSavedUniforms()&&(this.savedUniforms={});return this};
ShaderInfo._copyIfDifferent=function(a,c,b){for(var d=0;d<b;d++)if(a[d]!==c[d]){c[d]=a[d];for(d+=1;d<b;d++)c[d]=a[d];return!0}return!1};
ShaderProgram._compileShaders=function(a,c,b){function d(a,b,c){var d=a.createShader(b);a.shaderSource(d,c);a.compileShader(d);if(!a.getShaderParameter(d,a.COMPILE_STATUS)){c=c.split("\n");for(var e=0;e<c.length;e++)c[e]="/* "+(e+1)+" */   "+c[e];console.log(c.join("\n"));console.log((b===a.VERTEX_SHADER?"vertex: ":"fragment: ")+a.getShaderInfoLog(d));return null}return d}c=c&&0!==c.length?d(a,a.VERTEX_SHADER,c):null;b=b&&0!==b.length?d(a,a.FRAGMENT_SHADER,b):null;var e=null;null!==c&&"undefined"!==
typeof c&&null!==b&&"undefined"!==typeof b&&(e=a.createProgram(),a.attachShader(e,c),a.attachShader(e,b),a.linkProgram(e),a.getProgramParameter(e,a.LINK_STATUS)||(console.log("link: "+a.getProgramInfoLog(e)),a.deleteProgram(e),e=null),a.detachShader(e,c),a.detachShader(e,b));null!==c&&"undefined"!==typeof c&&a.deleteShader(c);null!==b&&"undefined"!==typeof b&&a.deleteShader(b);return e};ShaderProgram.fragmentShaderHeader=function(){return"#ifdef GL_ES\n#ifndef GL_FRAGMENT_PRECISION_HIGH\nprecision mediump float;\n#else\nprecision highp float;\n#endif\n#endif\n"};
ShaderProgram.makeEffectFragment=function(a){var c=ShaderProgram.fragmentShaderHeader(),c=c+"uniform sampler2D sampler;\nuniform vec2 textureSize;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n"+a;return c+="\n\nvoid main(){\n // normalize coordinates to 0..1\n vec2 uv=gl_FragCoord.xy/textureSize.xy;\n gl_FragColor=textureEffect(sampler,uv,textureSize);\n}"};
ShaderProgram.makeCopyEffect=function(){var a=ShaderProgram.fragmentShaderHeader(),a=a+"uniform sampler2D sampler;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n\n\nvoid main(){\n gl_FragColor=texture2D(sampler,uvVar);\n}";return new ShaderInfo(ShaderProgram.getBasicVertex(),a)};ShaderProgram.makeEffect=function(a,c){return new ShaderInfo(ShaderProgram.getBasicVertex(),ShaderProgram.makeEffectFragment(c))};ShaderProgram.getInvertEffect=function(){return ShaderProgram.makeEffect(null,"vec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize){\n vec4 color=texture2D(sampler,uvCoord);\n vec4 ret; ret.xyz=vec3(1.0,1.0,1.0)-color.xyz; ret.w=color.w; return ret;\n}")};
ShaderProgram.getEdgeDetectEffect=function(){return ShaderProgram.makeEffect(null,"float luma(vec3 color) {\n return 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b;\n}\nconst vec4 edge_color=vec4(0.,0,0,1);\nconst vec4 back_color=vec4(1.,1,1,1);\nvec4 textureEffect(sampler2D sampler, vec2 uvCoord, vec2 textureSize){\nfloat dx = 1.0 / float(textureSize.x);\nfloat dy = 1.0 / float(textureSize.y);\nfloat s00 = luma(texture2D(sampler, uvCoord + vec2(-dx,dy)).rgb);\nfloat s10 = luma(texture2D(sampler, uvCoord + vec2(-dx,0.0)).rgb);\nfloat s20 = luma(texture2D(sampler, uvCoord + vec2(-dx,-dy)).rgb);\nfloat s01 = luma(texture2D(sampler, uvCoord + vec2(0.0,dy)).rgb);\nfloat s21 = luma(texture2D(sampler, uvCoord + vec2(0.0,-dy)).rgb);\nfloat s02 = luma(texture2D(sampler, uvCoord + vec2(dx, dy)).rgb);\nfloat s12 = luma(texture2D(sampler, uvCoord + vec2(dx, 0.0)).rgb);\nfloat s22 = luma(texture2D(sampler, uvCoord + vec2(dx, -dy)).rgb);\nfloat sx = s00 + 2.0 * s10 + s20 - (s02 + 2.0 * s12 + s22);\nfloat sy = s00 + 2.0 * s01 + s02 - (s20 + 2.0 * s21 + s22);\nfloat dist = sx * sx + sy * sy;\nif(dist > 0.4) {\nreturn edge_color;\n} else {\nreturn back_color;\n}}")};
ShaderProgram.getBasicVertex=function(){};ShaderProgram.getDefaultVertex=function(){return"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nattribute vec3 colorAttr;\nattribute vec3 tangent;\nattribute vec3 bitangent;\nuniform mat4 projection;\nuniform mat4 modelViewMatrix;\n#ifdef SHADING\nuniform mat3 normalMatrix; /* internal */\n#ifdef NORMAL_MAP\nuniform mat4 world;\nvarying mat3 tbnMatrixVar;\n#endif\nvarying vec4 viewPositionVar;\nvarying vec3 transformedNormalVar;\n#endif\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\nvoid main(){\nvec4 positionVec4;\npositionVec4.w=1.0;\npositionVec4.xyz=position;\ngl_PointSize=1.0;\ngl_Position=(projection*modelViewMatrix)*positionVec4;\ncolorAttrVar=colorAttr;\nuvVar=uv;\n#ifdef SHADING\ntransformedNormalVar=normalize(normalMatrix*normal);\n#ifdef NORMAL_MAP\ntbnMatrixVar=mat3(normalize(vec3(world*vec4(tangent,0.0))),\n   normalize(bitangent),transformedNormalVar);\n#endif\nviewPositionVar=modelViewMatrix*positionVec4;\n#endif\n}"};
ShaderProgram.getDefaultFragment=function(){var a,c=ShaderProgram.fragmentShaderHeader()+"uniform vec4 md;\n#ifdef SHADING\nstruct light {\n vec4 position; /* source light direction/position, in camera/eye space */\n vec4 diffuse; /* source light diffuse color */\n#ifdef SPECULAR\n vec4 specular; /* source light specular color */\n#endif\n vec4 radius; /* light radius */\n};\nuniform vec3 sceneAmbient;\nuniform light lights["+Lights.MAX_LIGHTS+"];\nuniform vec3 ma;\nuniform vec3 me;\n#ifdef SPECULAR\nuniform vec3 ms;\nuniform float mshin;\n#ifdef SPECULAR_MAP\nuniform sampler2D specularMap;\n#endif\n#ifdef NORMAL_MAP\nuniform sampler2D normalMap;\n#endif\n#endif\n#endif\n#ifdef TEXTURE\nuniform sampler2D sampler;\n#endif\nuniform float useColorAttr;\nvarying vec2 uvVar;\nvarying vec3 colorAttrVar;\n#ifdef SHADING\nvarying vec4 viewPositionVar;\nvarying vec3 transformedNormalVar;\n#ifdef NORMAL_MAP\nvarying mat3 tbnMatrixVar;\n#endif\nvec4 calcLightPower(light lt, vec4 vertexPosition){\n vec3 sdir;\n float attenuation;\n if(lt.position.w == 0.0){ /* directional light */\n  sdir=normalize((lt.position).xyz);\n  attenuation=1.0;\n } else { /* point light */\n  vec3 vertexToLight=(lt.position-vertexPosition).xyz;\n  float dsSquared=dot(vertexToLight,vertexToLight);\n  sdir=inversesqrt(dsSquared)*vertexToLight;\n  if(lt.radius.x == 0.0) {\n    attenuation=1.0; /* Unlimited extent */\n  } else {\n   float radiusPow4=lt.radius.x; /* Radius is light's radius to power of 4 */\n   float distPow4=dsSquared*dsSquared;\n   float attenDivisor=max(0.0001,dsSquared);\n   float cut=clamp(1.0-distPow4/radiusPow4,0.0,1.0);\n   attenuation=(cut*cut)/attenDivisor;\n  }\n }\n return vec4(sdir,attenuation);\n}\n#endif\nvoid main(){\n vec4 tmp;\n vec3 normal;\n tmp.w=1.0;\n tmp.xyz=colorAttrVar;\n#ifdef TEXTURE\n vec4 baseColor=mix(\n   texture2D(sampler,uvVar),\n   tmp, useColorAttr);\n#else\n vec4 baseColor=mix(\n   md,\n   tmp, useColorAttr);\n#endif\n#ifdef SHADING\n#ifdef NORMAL_MAP\nnormal = normalize(tbnMatrixVar*(2.0*texture2D(normalMap,uvVar).rgb - vec3(1.0)));\n#else\nnormal = normalize(transformedNormalVar);\n#endif\nvec4 lightPower["+
Lights.MAX_LIGHTS+"];\nfloat lightCosines["+Lights.MAX_LIGHTS+"];\n",c=c+"if(baseColor.a == 0.0)discard;\nvec3 materialAmbient=ma; /* ambient*/\nvec3 lightedColor=sceneAmbient*materialAmbient; /* ambient*/\n // diffuse\n vec3 materialDiffuse=baseColor.rgb;\n";for(a=0;a<Lights.MAX_LIGHTS;a++)c+="lightPower["+a+"]=calcLightPower(lights["+a+"],viewPositionVar);\n",c+=" /* Lambert diffusion term */\n",c+="lightCosines["+a+"]=clamp(dot(normal,lightPower["+a+"].xyz),0.0,1.0);\n",c+="lightedColor+=lights["+
a+"].diffuse.xyz*lightCosines["+a+"]*\n",c+="   lightPower["+a+"].w*materialDiffuse;\n";c+="#ifdef SPECULAR\nbool spectmp;\nvec3 materialSpecular=ms;\n#ifdef SPECULAR_MAP\nmaterialSpecular*=texture2D(specularMap,uvVar).rgb;\n#endif\n// specular reflection\nif(materialSpecular.x!=0. || materialSpecular.y!=0. || materialSpecular.z!=0.){\nvec3 viewDirection=normalize((-viewPositionVar).xyz);\n";for(a=0;a<Lights.MAX_LIGHTS;a++)c+="  spectmp = lightCosines["+a+"] > 0.0;\n  if (spectmp) {\n    /* Blinn-Phong specular term */\n    float specular=clamp(dot(normalize(viewDirection+lightPower["+
a+"].xyz),normal),0.0,1.0);\n    specular=pow(specular,mshin);\n    lightedColor+=materialSpecular*specular*lightPower["+a+"].w*lights["+a+"].specular.xyz;\n  }\n";c+="}\n#endif\n";return c+=" // emission\n lightedColor+=me;\n baseColor=vec4(lightedColor,baseColor.a);\n#endif\n gl_FragColor=baseColor;\n}"};function Shape(a){if(null===a||"undefined"===typeof a)throw Error("mesh is null");a instanceof Mesh?this.bufferedMesh=new MeshBuffer(a):(!Shape._bufferedMeshWarning&&a instanceof BufferedMesh&&(console.warn("Using a BufferedMesh in Shape objects is deprecated."),Shape._bufferedMeshWarning=!0),this.bufferedMesh=a);this.transform=new Transform;this.material=new Material;this.parent=null;this.visible=!0}Shape._bufferedMeshWarning=!1;
Shape.prototype.vertexCount=function(){return this.bufferedMesh?this.bufferedMesh.vertexCount():0};Shape.prototype.primitiveCount=function(){return this.bufferedMesh?this.bufferedMesh.primitiveCount():0};Shape.prototype.setVisible=function(a){this.visible=!!a;return this};Shape.prototype.getVisible=function(){return this.visible};Shape.prototype.setColor=function(a,c,b,d){a=GLUtil.toGLColor(a,c,b,d);return this.setMaterialParams({ambient:a,diffuse:a})};Shape.prototype.setTexture=function(a){return this.setMaterialParams({texture:a})};
Shape.prototype.setShader=function(a){return this.setMaterialParams({shader:a})};Shape.prototype.setMaterialParams=function(a){this.material?this.material.setParams(a):this.material=(new Material).setParams(a);return this};Shape.prototype.setTextureAndColor=function(a,c,b,d,e){c=GLUtil.toGLColor(c,b,d,e);return this.setMaterialParams({texture:a,ambient:c,diffuse:c})};Shape.prototype.setMaterial=function(a){this.material=a;return this};
Shape.prototype.copy=function(){var a=new Shape(this.bufferedMesh);a.material=this.material.copy();a.transform=this.getTransform().copy();return a};Shape.prototype.getTransform=function(){return this.transform};
Shape.prototype.getBounds=function(){if(!this.bufferedMesh)return[0,0,0,-1,-1,-1];var a=this.bufferedMesh._getBounds(),c=this.getMatrix();if(GLMath.mat4isIdentity(c))return a.slice(0,6);var b=GLMath.mat4transformVec3(c,a[0],a[1],a[2]),a=GLMath.mat4transformVec3(c,a[3],a[4],a[5]);return[Math.min(b[0],a[0]),Math.min(b[1],a[1]),Math.min(b[2],a[2]),Math.max(b[0],a[0]),Math.max(b[1],a[1]),Math.max(b[2],a[2])]};
Shape.prototype.isCulled=function(a){return this.bufferedMesh&&this.visible?!GLMath.frustumHasBox(a,this.getBounds()):!0};Shape.prototype.setTransform=function(a){this.transform=a.copy();return this};Shape.prototype.setScale=function(a,c,b){this.getTransform().setScale(a,c,b);return this};Shape.prototype.setPosition=function(a,c,b){this.getTransform().setPosition(a,c,b);return this};Shape.prototype.setQuaternion=function(a){this.getTransform().setQuaternion(a);return this};
Shape.prototype.getMatrix=function(){var a=this.getTransform(),c=a.isIdentity();if(null!==this.parent)var b=this.parent.getMatrix(),a=c?b:GLMath.mat4isIdentity(b)?a.getMatrix():GLMath.mat4multiply(b,a.getMatrix());else a=a.getMatrix();return a};function ShapeGroup(){this.shapes=[];this.parent=null;this.visible=!0;this.transform=new Transform}ShapeGroup.prototype.addShape=function(a){a.parent=this;this.shapes.push(a);return this};ShapeGroup.prototype.setVisible=function(a){this.visible=!!a;return this};ShapeGroup.prototype.getVisible=function(){return this.visible};ShapeGroup.prototype.getTransform=function(){return this.transform};
ShapeGroup.prototype.getMatrix=function(){var a=this.getTransform(),c=a.isIdentity();if(null!==this.parent)var b=this.parent.getMatrix(),a=c?GLMath.mat4multiply(b,a.getMatrix()):GLMath.mat4isIdentity(b)?a.getMatrix():b;else a=a.getMatrix();return a};ShapeGroup.prototype.setTransform=function(a){this.transform=a.copy();return this};ShapeGroup.prototype.setMaterial=function(a){for(var c=0;c<this.shapes.length;c++)this.shapes[c].setMaterial(a);return this};
ShapeGroup.prototype.setTexture=function(a){for(var c=0;c<this.shapes.length;c++)this.shapes[c].setTexture(a);return this};ShapeGroup.prototype.setShader=function(a){for(var c=0;c<this.shapes.length;c++)this.shapes[c].setShader(a);return this};ShapeGroup.prototype.setMaterialParams=function(a){for(var c=0;c<this.shapes.length;c++)this.shapes[c].setMaterialParams(a);return this};
ShapeGroup.prototype.removeShape=function(a){for(var c=0;c<this.shapes.length;c++)this.shapes[c]===a&&(this.shapes.splice(c,1),c--);return this};
ShapeGroup.prototype.getBounds=function(){for(var a=[0,0,0,0,0,0],c=!0,b=0;b<this.shapes.length;b++){var d=this.shapes[b].getBounds();GLMath.boxIsEmpty(d)||(c?(a[0]=d[0],a[1]=d[1],a[2]=d[2],a[3]=d[3],a[4]=d[4],a[5]=d[5],c=!1):(a[0]=Math.min(d[0],a[0]),a[1]=Math.min(d[1],a[1]),a[2]=Math.min(d[2],a[2]),a[3]=Math.max(d[3],a[3]),a[4]=Math.max(d[4],a[4]),a[5]=Math.max(d[5],a[5])))}return c?[0,0,0,-1,-1,-1]:a};
ShapeGroup.prototype.vertexCount=function(){for(var a=0,c=0;c<this.shapes.length;c++)a+=this.shapes[c].vertexCount();return a};ShapeGroup.prototype.primitiveCount=function(){for(var a=0,c=0;c<this.shapes.length;c++)a+=this.shapes[c].primitiveCount();return a};ShapeGroup.prototype.setPosition=function(a,c,b){this.transform.setPosition(a,c,b);return this};ShapeGroup.prototype.setQuaternion=function(a){this.transform.setQuaternion(a);return this};
ShapeGroup.prototype.setScale=function(a,c,b){this.transform.setScale(a,c,b);return this};function Subscene3D(){this._projectionMatrix=GLMath.mat4identity();this._viewMatrix=GLMath.mat4identity();this.lights=new Lights;this._frustum=this._projectionUpdater=null;this.shapes=[]}Subscene3D._PerspectiveView=function(a,c,b,d){this.fov=c;this.near=b;this.far=d;this.scene=a;this.lastAspect=null;this.update=function(a,b){var c=1*a/b;c!=this.lastAspect&&(this.lastAspect=c,this.scene.setProjectionMatrix(GLMath.mat4perspective(this.fov,c,this.near,this.far)))};this.update()};
Subscene3D._OrthoView=function(a,c,b,d,e,f,g){this.a=c;this.b=b;this.c=d;this.d=e;this.e=f;this.f=g;this.scene=a;this.lastAspect=null;this.update=function(a,b){var c=1*a/b;c!=this.lastAspect&&(this.lastAspect=c,this.scene.setProjectionMatrix(GLMath.mat4orthoAspect(this.a,this.b,this.c,this.d,this.e,this.f,c)))};this.update()};
Subscene3D._setupMatrices=function(a,c,b,d,e){var f={};e&&(f.view=b,f.projection=c,f.viewMatrix=b,f.projectionMatrix=c,viewInvW=a.get("projView"),null!==viewInvW&&"undefined"!==typeof viewInvW&&(c=GLMath.mat4multiply(c,b),f.projView=c));c=GLMath.mat4inverseTranspose3(d);f.world=d;f.modelMatrix=d;f.normalMatrix=c;c=a.get("modelViewMatrix");null!==c&&"undefined"!==typeof c&&(GLUtil._isIdentityExceptTranslate(b)?(d=d.slice(0,16),d[12]+=b[12],d[13]+=b[13],d[14]+=b[14]):d=GLMath.mat4multiply(b,d),f.modelViewMatrix=
d,c=GLMath.mat4inverseTranspose3(d),f.world=d,f.modelMatrix=d,f.normalMatrix=c);a.setUniforms(f)};Subscene3D._isSameMatrix=function(a,c){return a[0]==c[0]&&a[1]==c[1]&&a[2]==c[2]&&a[3]==c[3]&&a[4]==c[4]&&a[5]==c[5]&&a[6]==c[6]&&a[7]==c[7]&&a[8]==c[8]&&a[9]==c[9]&&a[10]==c[10]&&a[11]==c[11]&&a[12]==c[12]&&a[13]==c[13]&&a[14]==c[14]&&a[15]==c[15]};
Subscene3D.prototype.setProjectionMatrix=function(a){Subscene3D._isSameMatrix(this._projectionMatrix,a)||(this._projectionMatrix=a.slice(0,16),this._frustum=null);return this};Subscene3D.prototype.perspectiveAspect=function(a,c,b){this._projectionUpdater=new Subscene3D._PerspectiveView(this,a,c,b);return this};Subscene3D.prototype.setLookAt=function(a,c,b){return this.setViewMatrix(GLMath.mat4lookat(a,c,b))};
Subscene3D.prototype.orthoAspect=function(a,c,b,d,e,f){this._projectionUpdater=new Subscene3D._OrthoView(this,a,c,b,d,e,f);return this};Subscene3D.prototype.ortho2DAspect=function(a,c,b,d){this._projectionUpdater=new Subscene3D._OrthoView(this,a,c,b,d,-1,1);return this};Subscene3D.prototype.setViewMatrix=function(a){Subscene3D._isSameMatrix(this._viewMatrix,a)||(this._viewMatrix=a.slice(0,16),this._frustum=null);return this};
Subscene3D.prototype.getProjectionMatrix=function(){return this._projectionMatrix.slice(0,16)};Subscene3D.prototype.getViewMatrix=function(){return this._viewMatrix.slice(0,16)};Subscene3D.prototype._getFrustum=function(){if(null==this._frustum){var a=GLMath.mat4multiply(this._projectionMatrix,this._viewMatrix);this._frustum=GLMath.mat4toFrustumPlanes(a)}return this._frustum};Subscene3D.prototype.getLights=function(){return this.lights};
Subscene3D.prototype.addShape=function(a){a.parent=null;this.shapes.push(a);return this};Subscene3D.prototype.vertexCount=function(){for(var a=0,c=0;c<this.shapes.length;c++)a+=this.shapes[c].vertexCount();return a};Subscene3D.prototype.primitiveCount=function(){for(var a=0,c=0;c<this.shapes.length;c++)a+=this.shapes[c].primitiveCount();return a};Subscene3D.prototype.removeShape=function(a){for(var c=0;c<this.shapes.length;c++)this.shapes[c]===a&&(this.shapes.splice(c,1),c--);return this};
Subscene3D.prototype._renderShape=function(a,c){if(a.constructor===ShapeGroup){if(a.visible)for(var b=0;b<a.shapes.length;b++)this._renderShape(a.shapes[b],c)}else if(a.visible&&!a.isCulled(this._getFrustum())){var b=null,b=a.material instanceof Material?a.material.shader?c.scene._programs.getCustomProgram(a.material.shader,c.context):c.scene._programs.getProgram(Scene3D._materialToFlags(a.material),c.context):c.scene._programs.getProgram(0,c.context),d=!1;c.prog!=b&&(b.use(),d=!0,(new GLUtil._LightsBinder(this.lights)).bind(b,
this._viewMatrix),c.prog=b);Subscene3D._setupMatrices(b,this._projectionMatrix,this._viewMatrix,a.getMatrix(),d);Subscene3D._getMaterialBinder(a.material).bind(b,c.context,c.scene._textureLoader);c.scene._meshLoader.draw(a.bufferedMesh,b)}};Subscene3D.prototype.resize=function(a,c){this._projectionUpdater&&this._projectionUpdater.update(a,c)};Subscene3D.prototype.render=function(a){var c={};c.scene=a;c.context=a.getContext();for(a=0;a<this.shapes.length;a++)this._renderShape(this.shapes[a],c);return this};
Subscene3D.forFilter=function(a,c,b){null==b&&(b=ShaderProgram.makeCopyEffect(a));a=new Subscene3D(a);var d=new Mesh([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0],[0,1,2,2,1,3],Mesh.TEXCOORDS_BIT),d=new Shape(d);d.setTexture(c);d.setShader(b);a.addShape(d);return a};Subscene3D._getMaterialBinder=function(a){return a&&a instanceof Material?new GLUtil._MaterialBinder(a):{bind:function(a){}}};var Texture=function(a){this.image=null;this.loadStatus=0;this.name=a;this.width=0;this.clamp=!1;this.height=0};Texture.prototype.setClamp=function(a){this.clamp=a;return this};Texture.loadTexture=function(a,c){if(c&&c[a])return Promise.resolve(c[a]);var b=new Texture(a);c&&(c[a]=b);return b.loadImage().then(function(a){return a},function(a){return Promise.reject(a.name)})};
Texture.fromUint8Array=function(a,c,b){if(0>c)throw Error("width less than 0");if(0>b)throw Error("height less than 0");if(a.length<c*b*4)throw Error("array too short for texture");var d=new Texture("");d.image=a;d.width=Math.ceil(c);d.height=Math.ceil(b);d.loadStatus=2;return d};
Texture.loadTga=function(a){return GLUtil.loadFileFromUrl(a,"arraybuffer").then(function(a){var b=new DataView(a.data);b.getUint8(0);b.getUint8(1);var d=b.getUint8(2);if(2!==d&&3!==d)return Promise.reject(Error("unsupported image type"));var e=b.getUint16(8,!0),f=b.getUint16(10,!0);if(0!==e||0!==f)return Promise.reject(Error("unsupported origins"));e=b.getUint16(12,!0);f=b.getUint16(14,!0);if(0===e||0===f)return Promise.reject(Error("invalid width or height"));var g=b.getUint8(16);if(!(32===g&&2===
d||24===g&&2===d||8===g&&3===d))return Promise.reject(Error("unsupported pixelsize"));var h=e*f;if(h>a.data.length)return Promise.reject(Error("size too big"));var k=new Uint8Array(4*h),l=18,m=0;if(32===g&&2===d)for(m=d=0;d<h;d++,m+=4)k[m+2]=b.getUint8(l),k[m+1]=b.getUint8(l+1),k[m]=b.getUint8(l+2),k[m+3]=b.getUint8(l+3),l+=4;else if(24===g&&2===d)for(m=d=0;d<h;d++,m+=4)k[m+2]=b.getUint8(l),k[m+1]=b.getUint8(l+1),k[m]=b.getUint8(l+2),k[m+3]=255,l+=3;else if(8===g&&3===d)for(m=d=0;d<h;d++,m+=4)g=b.getUint8(l),
k[m]=g,k[m+1]=g,k[m+2]=g,k[m+3]=255,l++;a.data=null;return{width:e,height:f,image:k}})};
Texture.prototype.loadImage=function(){if(null!==this.image)return Promise.resolve(this);var a=this,c=this.name;a.loadStatus=1;return/\.tga$/i.test(c)?Texture.loadTga(c).then(function(b){a.image=b.image;a.width=b.width;a.height=b.height;a.loadStatus=2;return a},function(b){a.loadStatus=-1;return Promise.reject({name:c,error:b})}):new Promise(function(b,d){var e=new Image;e.onload=function(c){c=c.target;a.image=c;a.width=c.width;a.height=c.height;a.loadStatus=2;e.onload=null;e.onerror=null;b(a)};e.onerror=
function(b){a.loadStatus=-1;e.onload=null;e.onerror=null;d({name:c,error:b})};e.src=c})};Texture.prototype.dispose=function(){this.height=this.width=0;this.name="";this.image&&("undefined"!==typeof image.onload&&null!==image.onload&&(image.onload=null),"undefined"!==typeof image.onerror&&null!==image.onerror&&(image.onerror=null));this.image=null;this.clamp=!1;this.loadStatus=0};Texture.prototype.getName=function(){return name};function TextureLoader(){this.loadedTextures=[];this.textureImages={};this.maxAnisotropy=[]}TextureLoader.prototype.getTexture=function(a){return this.textureImages[a]||null};TextureLoader.prototype.loadTexture=function(a){return Texture.loadTexture(a,this.textureImages)};
TextureLoader.prototype._setMaxAnisotropy=function(a){a=a.getContext?a.getContext():a;for(var c=this.maxAnisotropy,b=0;b<c.length;b++)if(c[b][0]==a)if(0<=c[b][2])a.texParameteri(a.TEXTURE_2D,c[b][2],c[b][1]);else return;var d=a.getExtension("EXT_texture_filter_anisotropic")||a.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||a.getExtension("MOZ_EXT_texture_filter_anisotropic");if(d)return b=d.TEXTURE_MAX_ANISOTROPY_EXT,d=a.getParameter(d.MAX_TEXTURE_MAX_ANISOTROPY_EXT),c.push([a,d,b]),a.texParameteri(a.TEXTURE_2D,
b,d),d;c.push([a,1,-1,null]);return 1};TextureLoader.prototype.loadTexturesAll=function(a,c,b){for(var d=[],e=0;e<a.length;e++)d.push(this.loadTexture(a[e]));return GLUtil.getPromiseResultsAll(d,c,b)};TextureLoader.prototype.loadAndMapTexture=function(a,c){c=c.getContext?c.getContext():c;var b=this;return this.loadTexture(a).then(function(a){b.mapTexture(a,c);return Promise.resolve(a)})};
TextureLoader.prototype.loadAndMapTexturesAll=function(a,c,b,d){c=c.getContext?c.getContext():c;for(var e=[],f=0;f<a.length;f++)e.push(this.loadAndMapTexture(a[f],c));return GLUtil.getPromiseResultsAll(e,b,d)};TextureLoader.prototype.mapTextures=function(a,c){c=c.getContext?c.getContext():c;for(var b=0;b<a.length;b++)this.mapTexture(a[b],c);return this};
TextureLoader.prototype.mapTexture=function(a,c){c=c.getContext?c.getContext():c;for(var b=this.loadedTextures,d=0;d<b.length;d++)if(b[d][0]==a&&b[d][1]==c)return b[d][2];d=new GLUtil._LoadedTexture(a,c);b.push([a,c,d]);return d};TextureLoader.prototype.dispose=function(){for(var a in this.textureImages)this.textureImages[a].dispose();for(a=0;a<lt.length;a++)this.loadedTextures[a][2].dispose();this.textureImages={};this.loadedTextures=[];this.maxAnisotropy=[]};function Transform(){this.scale=[1,1,1];this.position=[0,0,0];this.rotation=GLMath.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;this.matrix=GLMath.mat4identity()}Transform.prototype.getScale=function(){return this.complexMatrix?[this.matrix[0],this.matrix[5],this.matrix[10]]:this.scale.slice(0,3)};Transform.prototype.getPosition=function(){return this.complexMatrix?[this.matrix[12],this.matrix[13],this.matrix[14]]:this.position.slice(0,3)};
Transform.prototype.getQuaternion=function(){return this.complexMatrix?GLMath.quatNormInPlace(GLMath.quatFromMat4(this.matrix)):this.rotation.slice(0,4)};Transform.prototype.reset=function(){this.matrix=GLMath.mat4identity();this.position=[0,0,0];this.scale=[1,1,1];this.rotation=GLMath.quatIdentity();this._matrixDirty=this.complexMatrix=!1;this._isIdentity=!0;return this};
Transform.prototype.setMatrix=function(a){this._matrixDirty=!1;this.complexMatrix=!0;this.matrix=a.slice(0,16);this.position=[this.matrix[12],this.matrix[13],this.matrix[14]];this.rotation=GLMath.quatFromMat4(this.matrix);this.rotation=GLMath.quatNormInPlace(this.rotation);this.scale=[this.matrix[0],this.matrix[5],this.matrix[10]];this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&
1===a[15];return this};Transform.prototype.isIdentity=function(){if(this._matrixDirty)if(this.complexMatrix)this.getMatrix();else return 0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2]&&GLMath.quatIsIdentity(this.rotation);return this._isIdentity};Transform.prototype.resetTransform=function(){return this.resetTransform()};
Transform.prototype.setScale=function(a,c,b){if(this.complexMatrix)return this;this.scale=null===a||"undefined"===typeof a||null!==c&&"undefined"!==typeof c||null!==b&&"undefined"!==typeof b?[a,c,b]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];this._matrixDirty=!0;return this};
Transform.prototype.setPosition=function(a,c,b){if(this.complexMatrix)return this;this.position=null===a||"undefined"===typeof a||null!==c&&"undefined"!==typeof c||null!==b&&"undefined"!==typeof b?[a,c,b]:"number"!==typeof a?[a[0],a[1],a[2]]:[a,a,a];this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];this._matrixDirty=!0;return this};
Transform.prototype.movePosition=function(a,c,b){if(this.complexMatrix)return this;null===a||"undefined"===typeof a||null!==c&&"undefined"!==typeof c||null!==b&&"undefined"!==typeof b?(this.position[0]+=a,this.position[1]+=c,this.position[2]+=b):"number"!==typeof a?(this.position[0]+=a[0],this.position[1]+=a[1],this.position[2]+=a[2]):(this.position[0]+=a,this.position[1]+=a,this.position[2]+=a);this._isIdentity=this._isIdentity&&0===this.position[0]&&0===this.position[1]&&0===this.position[2];this._matrixDirty=
!0;return this};Transform.prototype.setQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=a.slice(0,4);GLMath.quatNormInPlace(this.rotation);this._matrixDirty=!0;return this};Transform.prototype.setOrientation=function(a,c,b,d){return this.setQuaternion(GLMath.quatFromAxisAngle(a,c,b,d))};Transform.prototype.multQuaternion=function(a){if(this.complexMatrix)return this;this.rotation=GLMath.quatNormInPlace(GLMath.quatMultiply(this.rotation,a));this._matrixDirty=!0;return this};
Transform.prototype.multOrientation=function(a,c,b,d){return this.multQuaternion(GLMath.quatFromAxisAngle(a,c,b,d))};
Transform.prototype.getMatrix=function(){if(this._matrixDirty)if(this._matrixDirty=!1,GLMath.quatIsIdentity(this.rotation))this.matrix=[this.scale[0],0,0,0,0,this.scale[1],0,0,0,0,this.scale[2],0,this.position[0],this.position[1],this.position[2],1],this._isIdentity=0===this.position[0]&&0===this.position[1]&&0===this.position[2]&&1===this.scale[0]&&1===this.scale[1]&&1===this.scale[2];else{this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,this.position[0],this.position[1],this.position[2],1];this.matrix=GLMath.mat4multiply(this.matrix,
GLMath.quatToMat4(this.rotation));GLMath.mat4scaleInPlace(this.matrix,this.scale);var a=this.matrix;this._isIdentity=1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]}else if(this._isIdentity)return GLMath.mat4identity();return this.matrix.slice(0,16)};
Transform.prototype.copy=function(){var a=new Transform;a.scale=this.scale.slice(0,this.scale.length);a.position=this.position.slice(0,this.scale.length);a.complexMatrix=this.complexMatrix;a._matrixDirty=this._matrixDirty;a.matrix=this.matrix.slice(0,this.matrix.length);return a};
